<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT Connection Test (Working)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .test-section {
            background-color: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success { background-color: #2d5a2d; }
        .status.error { background-color: #5a2d2d; }
        .status.warning { background-color: #5a4d2d; }
        .status.info { background-color: #2d4d5a; }
        button {
            background-color: #4a4a4a;
            color: white;
            border: 1px solid #666;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #5a5a5a;
        }
        .log {
            background-color: #1a1a1a;
            border: 1px solid #333;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üîå MQTT Connection Test (Working)</h1>
    
    <div class="test-section">
        <h2>üì° MQTT Broker Test</h2>
        <div id="mqtt-status" class="status info">Loading MQTT library...</div>
        <button onclick="testMQTTConnection()">Test MQTT Connection</button>
        <button onclick="testAllBrokers()">Test All Brokers</button>
    </div>

    <div class="test-section">
        <h2>üìã Test Log</h2>
        <div id="test-log" class="log">Test log will appear here...</div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <!-- Load MQTT library via script tag with proper UMD build -->
    <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
    
    <script>
        // MQTT broker URLs (same as in the fixed configuration)
        const brokerUrls = [
            'wss://mqtt.eclipseprojects.io:443/mqtt',
            'wss://broker.emqx.io:8084/mqtt',
            'wss://broker-cn.emqx.io:8084/mqtt',
            'wss://broker.hivemq.com:8884/mqtt',
            'wss://test.mosquitto.org:8081/mqtt'
        ];

        function log(message) {
            const logElement = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = 'Test log cleared...\n';
        }

        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('mqtt-status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        async function testMQTTConnection() {
            log('üß™ Testing MQTT connection with improved configuration...');
            updateStatus('Testing MQTT connection...', 'info');

            // Generate a unique client ID (same as in the fix)
            const timestamp = Date.now();
            const randomId = Math.random().toString(36).substring(2, 15);
            const sessionId = Math.random().toString(36).substring(2, 15);
            const mqttClientId = `trystero-test-${timestamp}-${randomId}-${sessionId}`;

            log(`Generated client ID: ${mqttClientId}`);

            // Try the first broker (mqtt.eclipseprojects.io)
            const testUrl = brokerUrls[0];
            log(`Testing connection to: ${testUrl}`);

            try {
                const client = mqtt.connect(testUrl, {
                    clientId: mqttClientId,
                    clean: true,
                    connectTimeout: 10000,
                    reconnectPeriod: 3000,
                    keepalive: 60,
                    protocolVersion: 4,
                    reschedulePings: true,
                    queueQoSZero: false,
                    username: undefined,
                    password: undefined,
                    will: {
                        topic: `trystero/disconnect/${mqttClientId}`,
                        payload: JSON.stringify({ clientId: mqttClientId, timestamp: Date.now() }),
                        qos: 0,
                        retain: false
                    }
                });

                const connectionPromise = new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        log('‚ùå Connection timeout after 15 seconds');
                        client.end();
                        reject(new Error('Connection timeout'));
                    }, 15000);

                    client.on('connect', () => {
                        clearTimeout(timeout);
                        log('‚úÖ MQTT connected successfully!');
                        log(`Connected to: ${testUrl}`);
                        log(`Client ID: ${mqttClientId}`);
                        resolve(true);
                    });

                    client.on('error', (err) => {
                        clearTimeout(timeout);
                        log(`‚ùå MQTT connection error: ${err.message}`);
                        
                        if (err.message && err.message.includes('Not authorized')) {
                            log('‚ö†Ô∏è Broker rejected connection - may require authentication');
                        } else if (err.message && err.message.includes('Connection refused')) {
                            log('‚ö†Ô∏è Broker refused connection - may be down or overloaded');
                        }
                        
                        reject(err);
                    });

                    client.on('close', () => {
                        log('üîå MQTT connection closed');
                    });

                    client.on('offline', () => {
                        log('üì¥ MQTT client offline');
                    });
                });

                const result = await connectionPromise;
                if (result) {
                    updateStatus('‚úÖ MQTT connection successful!', 'success');
                    client.end();
                }

            } catch (error) {
                log(`‚ùå MQTT test failed: ${error.message}`);
                updateStatus(`‚ùå MQTT test failed: ${error.message}`, 'error');
            }
        }

        async function testAllBrokers() {
            log('üß™ Testing all MQTT brokers...');
            updateStatus('Testing all brokers...', 'info');

            let successCount = 0;
            let totalCount = brokerUrls.length;

            for (let i = 0; i < brokerUrls.length; i++) {
                const url = brokerUrls[i];
                log(`\n--- Testing broker ${i + 1}/${totalCount}: ${url} ---`);

                try {
                    const timestamp = Date.now();
                    const randomId = Math.random().toString(36).substring(2, 15);
                    const sessionId = Math.random().toString(36).substring(2, 15);
                    const mqttClientId = `trystero-test-${timestamp}-${randomId}-${sessionId}`;

                    const client = mqtt.connect(url, {
                        clientId: mqttClientId,
                        clean: true,
                        connectTimeout: 8000,
                        reconnectPeriod: 2000,
                        keepalive: 30,
                        protocolVersion: 4,
                        reschedulePings: true,
                        queueQoSZero: false
                    });

                    const result = await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            client.end();
                            reject(new Error('Connection timeout'));
                        }, 10000);

                        client.on('connect', () => {
                            clearTimeout(timeout);
                            log(`‚úÖ Successfully connected to ${url}`);
                            successCount++;
                            resolve(true);
                        });

                        client.on('error', (err) => {
                            clearTimeout(timeout);
                            log(`‚ùå Failed to connect to ${url}: ${err.message}`);
                            resolve(false);
                        });
                    });

                    client.end();

                } catch (error) {
                    log(`‚ùå Error testing ${url}: ${error.message}`);
                }
            }

            log(`\nüìä Test Results: ${successCount}/${totalCount} brokers working`);
            
            if (successCount > 0) {
                updateStatus(`‚úÖ ${successCount}/${totalCount} brokers working`, 'success');
            } else {
                updateStatus(`‚ùå No brokers working (${successCount}/${totalCount})`, 'error');
            }
        }

        // Initialize
        log('üîß MQTT Connection Test initialized');
        log('üìã Available brokers: ' + brokerUrls.join(', '));
        
        // Check if MQTT library loaded
        if (typeof mqtt !== 'undefined' && typeof mqtt.connect === 'function') {
            log('‚úÖ MQTT library loaded successfully');
            updateStatus('Ready to test MQTT connections', 'info');
        } else {
            log('‚ùå MQTT library failed to load');
            log('Available globals: ' + Object.keys(window).filter(k => k.toLowerCase().includes('mqtt')).join(', '));
            updateStatus('Failed to load MQTT library', 'error');
        }
    </script>
</body>
</html>
