<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DozedEnt - Multiplayer</title>
  
  <!-- Import Map for Trystero -->
  <script type="importmap">
    {
      "imports": {
        "trystero/torrent": "../node_modules/trystero/src/torrent.js",
        "trystero/firebase": "../node_modules/trystero/src/firebase.js",
        "trystero/ipfs": "../node_modules/trystero/src/ipfs.js",
        "trystero/mqtt": "../node_modules/trystero/src/mqtt.js",
        "trystero/supabase": "../node_modules/trystero/src/supabase.js",
        "trystero/nostr": "../node_modules/trystero/src/nostr.js"
      }
    }
  </script>
  
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" href="src/css/mobile.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      width: 100%;
      background: #05070b;
      color: #cfd6ff;
      font-family: "Segoe UI", Tahoma, sans-serif;
      -webkit-font-smoothing: antialiased;
      overflow: hidden;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    /* Lobby Container */
    #lobby-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #05070b 0%, #0a0e1a 50%, #05070b 100%);
      display: flex;
      flex-direction: column;
      z-index: 100;
    }

    #lobby-container.hidden {
      display: none;
    }

    /* Lobby Header */
    .lobby-header {
      background: linear-gradient(90deg, #1a2332 0%, #0d1420 100%);
      border-bottom: 2px solid #00d4ff;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
    }

    .lobby-header h1 {
      font-size: 2.5em;
      color: #00d4ff;
      text-shadow: 0 0 20px rgba(0, 212, 255, 0.8);
      margin-bottom: 10px;
    }

    .lobby-header p {
      font-size: 1.1em;
      color: #8899cc;
    }

    /* Lobby Content */
    .lobby-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 20px;
    }

    /* Room List Section */
    .room-list-section {
      background: rgba(13, 20, 32, 0.8);
      border: 2px solid #00d4ff40;
      border-radius: 10px;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .room-list-section h2 {
      color: #00d4ff;
      margin-bottom: 15px;
      font-size: 1.8em;
    }

    .room-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #00d4ff 0%, #0088cc 100%);
      border: none;
      border-radius: 6px;
      color: #05070b;
      font-weight: bold;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 212, 255, 0.6);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #667799 0%, #445566 100%);
      color: #cfd6ff;
      box-shadow: 0 4px 15px rgba(102, 119, 153, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(255, 68, 68, 0.4);
    }

    /* Room List */
    .room-list {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .room-item {
      background: linear-gradient(135deg, #1a2332 0%, #0d1420 100%);
      border: 2px solid #00d4ff40;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .room-item:hover {
      border-color: #00d4ff;
      box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
      transform: translateX(5px);
    }

    .room-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .room-name {
      font-size: 1.3em;
      color: #00d4ff;
      font-weight: bold;
    }

    .room-players {
      background: rgba(0, 212, 255, 0.2);
      padding: 4px 12px;
      border-radius: 12px;
      color: #00d4ff;
      font-weight: bold;
    }

    .room-info {
      display: flex;
      gap: 15px;
      color: #8899cc;
      font-size: 0.9em;
    }

    .room-info span {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    /* Sidebar */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* Player Info Section */
    .player-info-section {
      background: rgba(13, 20, 32, 0.8);
      border: 2px solid #00d4ff40;
      border-radius: 10px;
      padding: 20px;
    }

    .player-info-section h2 {
      color: #00d4ff;
      margin-bottom: 15px;
      font-size: 1.5em;
    }

    .player-name-input {
      width: 100%;
      padding: 12px;
      background: rgba(26, 35, 50, 0.8);
      border: 2px solid #00d4ff40;
      border-radius: 6px;
      color: #cfd6ff;
      font-size: 1em;
      margin-bottom: 10px;
    }

    .player-name-input:focus {
      outline: none;
      border-color: #00d4ff;
      box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
    }

    .player-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }

    .stat-item {
      background: rgba(26, 35, 50, 0.6);
      padding: 10px;
      border-radius: 6px;
      text-align: center;
    }

    .stat-value {
      font-size: 1.5em;
      color: #00d4ff;
      font-weight: bold;
    }

    .stat-label {
      font-size: 0.9em;
      color: #8899cc;
      margin-top: 5px;
    }

    /* Current Room Section */
    .current-room-section {
      background: rgba(13, 20, 32, 0.8);
      border: 2px solid #00ff8840;
      border-radius: 10px;
      padding: 20px;
      display: none;
    }

    .current-room-section.active {
      display: block;
    }

    .current-room-section h2 {
      color: #00ff88;
      margin-bottom: 15px;
      font-size: 1.5em;
    }

    .current-room-info {
      margin-bottom: 15px;
    }

    .current-room-info p {
      margin: 8px 0;
      color: #8899cc;
    }

    .current-room-info strong {
      color: #00ff88;
    }

    .player-list {
      margin-top: 15px;
    }

    .player-list h3 {
      color: #00ff88;
      margin-bottom: 10px;
    }

    .player-list-item {
      background: rgba(26, 35, 50, 0.6);
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .player-list-item .player-name {
      color: #cfd6ff;
    }

    .player-list-item .player-role {
      background: rgba(0, 255, 136, 0.2);
      padding: 4px 10px;
      border-radius: 12px;
      color: #00ff88;
      font-size: 0.85em;
    }

    .ready-button {
      margin-top: 15px;
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(135deg, #1a2332 0%, #0d1420 100%);
      border: 2px solid #00d4ff;
      border-radius: 10px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0, 212, 255, 0.5);
    }

    .modal-content h2 {
      color: #00d4ff;
      margin-bottom: 20px;
      font-size: 2em;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: #8899cc;
      margin-bottom: 8px;
      font-weight: bold;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      background: rgba(26, 35, 50, 0.8);
      border: 2px solid #00d4ff40;
      border-radius: 6px;
      color: #cfd6ff;
      font-size: 1em;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #00d4ff;
      box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }

    .modal-actions .btn {
      flex: 1;
    }

    /* Game Canvas */
    #game-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
    }

    #game-container.active {
      display: flex;
      flex-direction: column;
    }

    #demo-canvas {
      flex: 1;
      width: 100%;
      height: 100%;
      display: block;
      background: radial-gradient(circle at 50% 30%, #111a28 0%, #060810 70%, #030408 100%);
    }

    /* Mobile Controls */
    .mobile-controls {
      display: none;
    }

    /* Status Message */
    .status-message {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(13, 20, 32, 0.95);
      border: 2px solid #00d4ff;
      border-radius: 8px;
      padding: 15px 20px;
      color: #cfd6ff;
      box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4);
      z-index: 2000;
      display: none;
      max-width: 400px;
    }

    .status-message.active {
      display: block;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(120%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .status-message.success {
      border-color: #00ff88;
    }

    .status-message.error {
      border-color: #ff4444;
    }

    .status-message.warning {
      border-color: #ffaa00;
    }

    /* Loading Spinner */
    .loading {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 3000;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(0, 212, 255, 0.2);
      border-top-color: #00d4ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .lobby-content {
        grid-template-columns: 1fr;
      }

      .sidebar {
        order: -1;
      }

      .lobby-header h1 {
        font-size: 1.8em;
      }

      .room-controls {
        flex-direction: column;
      }

      .modal-content {
        padding: 20px;
      }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #667799;
    }

    .empty-state-icon {
      font-size: 4em;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 1.2em;
    }

    /* Network Quality Indicator */
    .network-indicator {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(13, 20, 32, 0.95);
      border: 2px solid #00d4ff40;
      border-radius: 8px;
      padding: 10px 15px;
      display: none;
      align-items: center;
      gap: 10px;
      z-index: 2000;
    }

    .network-indicator.active {
      display: flex;
    }

    .network-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #00ff88;
      box-shadow: 0 0 10px #00ff88;
    }

    .network-dot.warning {
      background: #ffaa00;
      box-shadow: 0 0 10px #ffaa00;
    }

    .network-dot.poor {
      background: #ff4444;
      box-shadow: 0 0 10px #ff4444;
    }
  </style>
</head>
<body>
  <!-- Loading Spinner -->
  <div class="loading" id="loading">
    <div class="spinner"></div>
  </div>

  <!-- Status Message -->
  <div class="status-message" id="status-message"></div>

  <!-- Network Quality Indicator -->
  <div class="network-indicator" id="network-indicator">
    <div class="network-dot" id="network-dot"></div>
    <span id="network-text">Connecting...</span>
  </div>

  <!-- Lobby Container -->
  <div id="lobby-container">
    <div class="lobby-header">
      <h1>🎮 DozedEnt Multiplayer</h1>
      <p>Join or create a room to play with others</p>
    </div>

    <div class="lobby-content">
      <!-- Room List Section -->
      <div class="room-list-section">
        <h2>Available Rooms</h2>
        <div class="room-controls">
          <button class="btn" id="create-room-btn">Create Room</button>
          <button class="btn btn-secondary" id="refresh-rooms-btn">Refresh</button>
          <button class="btn btn-secondary" id="quick-play-btn">Quick Play</button>
        </div>
        <div class="room-list" id="room-list">
          <div class="empty-state">
            <div class="empty-state-icon">🎲</div>
            <p>No rooms available. Create one to get started!</p>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Player Info -->
        <div class="player-info-section">
          <h2>Player Info</h2>
          <input 
            type="text" 
            class="player-name-input" 
            id="player-name-input" 
            placeholder="Enter your name..."
            maxlength="24"
          >
          <div class="player-stats">
            <div class="stat-item">
              <div class="stat-value" id="player-rating">1000</div>
              <div class="stat-label">Rating</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="player-games">0</div>
              <div class="stat-label">Games</div>
            </div>
          </div>
        </div>

        <div class="player-info-section">
          <h2>Network Settings</h2>
          <label style="color: #8899cc; display: block; margin-bottom: 8px;">Provider:</label>
          <select id="network-provider-select" class="player-name-input" style="cursor: pointer;">
            <option value="torrent">BitTorrent (Recommended)</option>
            <option value="firebase">Firebase (Requires config)</option>
            <option value="ipfs">IPFS (Decentralized)</option>
            <option value="mqtt">MQTT (Custom server)</option>
            <option value="supabase">Supabase (Modern)</option>
          </select>
          <div style="margin-top: 10px; color: #667799; font-size: 0.9em;">
            <span id="network-status">🟢 Connected</span>
          </div>
        </div>

        <!-- Current Room -->
        <div class="current-room-section" id="current-room-section">
          <h2>Current Room</h2>
          <div class="current-room-info">
            <p><strong>Room:</strong> <span id="current-room-name">-</span></p>
            <p><strong>Host:</strong> <span id="current-room-host">-</span></p>
            <p><strong>Mode:</strong> <span id="current-room-mode">-</span></p>
            <p><strong>Status:</strong> <span id="current-room-status">-</span></p>
          </div>
          <div class="player-list">
            <h3>Players (<span id="player-count">0</span>/<span id="max-players">4</span>)</h3>
            <div id="player-list-container"></div>
          </div>
          <div class="ready-button">
            <button class="btn" id="ready-btn">Ready</button>
            <button class="btn btn-danger" id="leave-room-btn">Leave Room</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Game Container -->
  <div id="game-container">
    <canvas id="demo-canvas" aria-label="DozedEnt multiplayer game canvas"></canvas>
    
    <!-- Orientation Overlay for Mobile - Enhanced UX -->
    <div id="orientation-overlay" role="dialog" aria-labelledby="orientation-title" aria-describedby="orientation-desc">
      <div class="overlay-content">
        <div class="rotation-icon" aria-hidden="true">📱➡️🔄</div>
        <h2 id="orientation-title">Rotate Your Device</h2>
        <p id="orientation-desc">Turn your device sideways for an immersive multiplayer experience with better controls and visibility.</p>
        <div class="tilt-indicator" aria-hidden="true">↻ Keep rotating...</div>
        <button id="overlay-start" aria-label="Start multiplayer game in fullscreen mode">
          🎮 Start Multiplayer
        </button>
        <p style="font-size: 0.85em; color: rgba(255, 255, 255, 0.6); margin-top: 20px;">
          ✨ Fullscreen · 🔒 Landscape Lock · 💡 Screen Always On
        </p>
      </div>
    </div>
    
    <!-- Mobile Controls -->
    <div class="mobile-controls" id="mobile-controls" style="display: none;">
      <div id="joystick" class="joystick">
        <div id="joystick-base" class="joystick-base">
          <div id="joystick-knob" class="joystick-knob"></div>
        </div>
      </div>
      
      <div id="actions" class="actions">
        <button class="action-btn" data-action="lightAttack" aria-label="Light Attack">
          <span class="btn-emoji">⚡</span>
          <div class="cooldown-overlay"></div>
        </button>
        <button class="action-btn" data-action="heavyAttack" aria-label="Heavy Attack">
          <span class="btn-emoji">💥</span>
          <div class="cooldown-overlay"></div>
        </button>
        <button class="action-btn" data-action="block" aria-label="Block">
          <span class="btn-emoji">🛡️</span>
          <div class="cooldown-overlay"></div>
        </button>
        <button class="action-btn" data-action="roll" aria-label="Roll">
          <span class="btn-emoji">🔄</span>
          <div class="cooldown-overlay"></div>
        </button>
        <button class="action-btn" data-action="special" aria-label="Special">
          <span class="btn-emoji">✨</span>
          <div class="cooldown-overlay"></div>
        </button>
      </div>
    </div>
  </div>

  <!-- Create Room Modal -->
  <div class="modal" id="create-room-modal">
    <div class="modal-content">
      <h2>Create New Room</h2>
      <form id="create-room-form">
        <div class="form-group">
          <label for="room-name-input">Room Name</label>
          <input type="text" id="room-name-input" placeholder="My Epic Battle" maxlength="50" required>
        </div>
        <div class="form-group">
          <label for="room-type-select">Room Type</label>
          <select id="room-type-select">
            <option value="public">Public</option>
            <option value="private">Private</option>
            <option value="ranked">Ranked</option>
          </select>
        </div>
        <div class="form-group">
          <label for="game-mode-select">Game Mode</label>
          <select id="game-mode-select">
            <option value="default">Default</option>
            <option value="deathmatch">Deathmatch</option>
            <option value="team">Team Battle</option>
            <option value="survival">Survival</option>
          </select>
        </div>
        <div class="form-group">
          <label for="max-players-input">Max Players</label>
          <input type="number" id="max-players-input" min="2" max="8" value="4" required>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn">Create</button>
          <button type="button" class="btn btn-secondary" id="cancel-create-btn">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Load Multiplayer System -->
  <script type="module" src="src/multiplayer/multiplayer-main.js"></script>
</body>
</html>