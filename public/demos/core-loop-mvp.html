<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DozedEnt ‚Äì Roguelike Combat Arena</title>
  <style>
    * { box-sizing: border-box; }
    
    @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:wght@600;700&family=Fira+Mono:wght@500;700&display=swap');
    
    html, body { 
      margin: 0; padding: 0; height: 100%; 
      background: #0d0d0d; 
      color: #d4c5b0; 
      font-family: 'Crimson Text', Georgia, serif;
      overflow: hidden;
    }
    
    #root { position: relative; height: 100%; width: 100%; }
    #gameCanvas { 
      display: block; 
      width: 100%; 
      height: 100%; 
      background: linear-gradient(135deg, #1a1410 0%, #0d0a08 100%);
      image-rendering: pixelated;
      box-shadow: inset 0 0 120px rgba(0, 0, 0, 0.8);
    }
    
    /* Overlay System */
    .overlay { 
      position: absolute; 
      inset: 0; 
      pointer-events: none;
      z-index: 10;
    }
    
    /* Top HUD - Glassmorphism */
    .hud {
      position: absolute;
      top: 16px;
      left: 16px;
      right: 16px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      pointer-events: none;
    }
    
    .panel {
      background: rgba(18, 12, 8, 0.92);
      backdrop-filter: blur(8px);
      border: 2px solid rgba(139, 101, 55, 0.4);
      border-radius: 4px;
      padding: 12px 16px;
      pointer-events: auto;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.8), inset 0 1px 0 rgba(139, 101, 55, 0.2);
      transition: all 0.2s ease;
    }
    
    .panel:hover {
      background: rgba(22, 16, 10, 0.95);
      border-color: rgba(139, 101, 55, 0.6);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.9), inset 0 1px 0 rgba(139, 101, 55, 0.3);
    }
    
    /* Stats Panel */
    .stats-panel {
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-width: 280px;
    }
    
    .stat-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .stat-label {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.7;
      min-width: 60px;
      font-family: 'Fira Mono', monospace;
      color: #b8986d;
    }
    
    .bar-container {
      flex: 1;
      height: 14px;
      background: rgba(10, 5, 2, 0.8);
      border-radius: 2px;
      overflow: hidden;
      border: 1px solid rgba(80, 60, 40, 0.6);
      position: relative;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.6);
    }
    
    .bar-fill {
      height: 100%;
      transition: width 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .bar-fill::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255, 255, 255, 0.1) 50%, 
        transparent 100%);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .hp-bar { 
      background: linear-gradient(90deg, #8b0000, #dc143c, #b22222);
      box-shadow: 0 0 8px rgba(220, 20, 60, 0.5);
    }
    .stamina-bar { 
      background: linear-gradient(90deg, #b8860b, #daa520, #ffd700);
      box-shadow: 0 0 8px rgba(218, 165, 32, 0.4);
    }
    
    .stat-value {
      font-size: 11px;
      font-weight: 700;
      opacity: 0.85;
      min-width: 75px;
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-family: 'Fira Mono', monospace;
      color: #d4c5b0;
    }
    
    /* Info Panel */
    .info-panel {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 200px;
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }
    
    .info-label {
      opacity: 0.65;
      font-weight: 600;
      color: #9a8570;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.5px;
    }
    
    .info-value {
      font-weight: 700;
      color: #d4a574;
      font-variant-numeric: tabular-nums;
      font-family: 'Fira Mono', monospace;
    }
    
    /* Controls - Bottom Right */
    .controls {
      position: absolute;
      right: 16px;
      bottom: 16px;
      display: flex;
      gap: 8px;
      pointer-events: none;
    }
    
    button {
      background: linear-gradient(180deg, #3a2a1a, #2a1e12);
      backdrop-filter: blur(8px);
      color: #d4c5b0;
      border: 2px solid #5a4a3a;
      padding: 10px 16px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 700;
      font-family: 'Fira Mono', monospace;
      pointer-events: auto;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(139, 101, 55, 0.3);
    }
    
    button:hover {
      background: linear-gradient(180deg, #4a3a2a, #3a2a1a);
      border-color: #7a6a5a;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.8), inset 0 1px 0 rgba(139, 101, 55, 0.4);
      color: #e6d4ba;
    }
    
    button:active {
      transform: translateY(1px);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.8), inset 0 2px 4px rgba(0, 0, 0, 0.4);
    }
    
    /* Run Info Badge */
    .status-badge {
      position: absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(180deg, rgba(26, 18, 10, 0.95), rgba(18, 12, 6, 0.95));
      backdrop-filter: blur(8px);
      color: #d4a574;
      padding: 8px 16px;
      border-radius: 3px;
      border: 2px solid rgba(139, 101, 55, 0.5);
      font-size: 13px;
      font-weight: 700;
      font-family: 'Crimson Text', serif;
      text-transform: uppercase;
      letter-spacing: 2px;
      pointer-events: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.8), inset 0 1px 0 rgba(139, 101, 55, 0.3);
    }
    
    .status-badge::before {
      content: '‚öî';
      margin-right: 8px;
      color: #8b6537;
    }
    
    .status-badge::after {
      content: '‚öî';
      margin-left: 8px;
      color: #8b6537;
    }
    
    /* Modal System */
    .modal {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      width: min(800px, 90vw);
      max-height: 85vh;
      background: linear-gradient(135deg, rgba(18, 12, 8, 0.98), rgba(12, 8, 5, 0.98));
      backdrop-filter: blur(20px);
      border: 3px solid #5a4a3a;
      border-radius: 4px;
      padding: 24px;
      display: none;
      pointer-events: auto;
      box-shadow: 0 24px 64px rgba(0, 0, 0, 0.9), inset 0 1px 0 rgba(139, 101, 55, 0.2);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow-y: auto;
    }
    
    .modal.active {
      display: block;
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }
    
    .modal h2 {
      margin: 0 0 8px 0;
      font-size: 32px;
      font-weight: 700;
      color: #d4a574;
      text-transform: uppercase;
      letter-spacing: 2px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      border-bottom: 2px solid rgba(139, 101, 55, 0.3);
      padding-bottom: 12px;
    }
    
    .modal h3 {
      margin: 0 0 16px 0;
      font-size: 22px;
      font-weight: 700;
      color: #c49860;
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }
    
    .modal-subtitle {
      color: #9a8570;
      font-size: 14px;
      margin-bottom: 20px;
      font-style: italic;
    }
    
    /* Help Modal */
    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }
    
    .control-item {
      background: rgba(26, 18, 10, 0.6);
      border: 2px solid rgba(90, 74, 58, 0.4);
      border-radius: 3px;
      padding: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s ease;
    }
    
    .control-item:hover {
      background: rgba(32, 24, 14, 0.8);
      border-color: rgba(139, 101, 55, 0.6);
    }
    
    .control-action {
      font-weight: 600;
      color: #d4c5b0;
      font-size: 14px;
    }
    
    .control-key {
      background: linear-gradient(180deg, #3a2a1a, #2a1e12);
      border: 2px solid #5a4a3a;
      border-radius: 3px;
      padding: 6px 12px;
      font-family: 'Fira Mono', monospace;
      font-weight: 700;
      font-size: 13px;
      color: #d4a574;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(139, 101, 55, 0.2);
    }
    
    /* Choice/Shop Cards */
    .choices, .shop {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      margin-top: 16px;
    }
    
    .card {
      background: rgba(26, 18, 10, 0.7);
      border: 2px solid rgba(90, 74, 58, 0.4);
      border-radius: 3px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    
    .card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(139, 101, 55, 0.15), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .card:hover {
      border-color: rgba(139, 101, 55, 0.7);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.8), inset 0 1px 0 rgba(139, 101, 55, 0.3);
      background: rgba(32, 24, 14, 0.9);
    }
    
    .card:hover::before {
      opacity: 1;
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 700;
      color: #d4a574;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .card-description {
      font-size: 14px;
      color: #b8a590;
      line-height: 1.6;
    }
    
    .modal-footer {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 2px solid rgba(90, 74, 58, 0.3);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .hud {
        flex-direction: column;
        top: 12px;
        left: 12px;
        right: 12px;
      }
      
      .stats-panel, .info-panel {
        min-width: auto;
        width: 100%;
      }
      
      .controls {
        bottom: 12px;
        right: 12px;
        left: 12px;
        justify-content: stretch;
      }
      
      button {
        flex: 1;
        padding: 12px 8px;
        font-size: 11px;
      }
      
      .modal {
        width: 94vw;
        padding: 20px;
      }
      
      .controls-grid,
      .choices,
      .shop {
        grid-template-columns: 1fr;
      }
    }
    
    /* Scrollbar Styling */
    .modal::-webkit-scrollbar {
      width: 10px;
    }
    
    .modal::-webkit-scrollbar-track {
      background: rgba(10, 5, 2, 0.6);
      border-left: 1px solid rgba(90, 74, 58, 0.3);
    }
    
    .modal::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #5a4a3a, #3a2a1a);
      border: 1px solid rgba(139, 101, 55, 0.4);
    }
    
    .modal::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #6a5a4a, #4a3a2a);
    }
    
    /* Roguelike flavor text */
    .flavor-text {
      font-style: italic;
      color: #9a8570;
      font-size: 13px;
      margin-top: 8px;
      opacity: 0.8;
    }
    
    /* Death counter / permadeath indicator */
    .death-counter {
      position: absolute;
      bottom: 16px;
      left: 16px;
      background: rgba(18, 12, 8, 0.92);
      border: 2px solid rgba(139, 69, 19, 0.6);
      border-radius: 3px;
      padding: 8px 12px;
      font-family: 'Fira Mono', monospace;
      font-size: 11px;
      color: #d4a574;
      pointer-events: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.8);
    }
    
    .death-counter::before {
      content: '‚ò†';
      margin-right: 6px;
      color: #8b4513;
    }
  </style>
</head>
<body>
  <div id="root">
    <canvas id="gameCanvas" width="1280" height="720"></canvas>
    <div class="overlay">
      <!-- Run Title Badge -->
      <div class="status-badge">Descent into Darkness</div>
      
      <!-- Top HUD -->
      <div class="hud">
        <!-- Stats Panel (Left) -->
        <div class="panel stats-panel">
          <div class="stat-row">
            <span class="stat-label">Vitality</span>
            <div class="bar-container">
              <div id="hpBar" class="bar-fill hp-bar" style="width: 100%"></div>
            </div>
            <span class="stat-value" id="hpText">100 / 100</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Endurance</span>
            <div class="bar-container">
              <div id="staminaBar" class="bar-fill stamina-bar" style="width: 100%"></div>
            </div>
            <span class="stat-value" id="staminaText">100 / 100</span>
          </div>
        </div>
        
        <!-- Run Info Panel (Right) -->
        <div class="panel info-panel">
          <div class="info-item">
            <span class="info-label">Depth</span>
            <span class="info-value" id="waveText">Floor 1</span>
          </div>
          <div class="info-item">
            <span class="info-label">Foes</span>
            <span class="info-value" id="enemiesText">0</span>
          </div>
          <div class="info-item">
            <span class="info-label">Status</span>
            <span class="info-value" id="phaseText">Battle</span>
          </div>
        </div>
        
        <!-- Run Stats Panel -->
        <div class="panel info-panel">
          <div class="info-item">
            <span class="info-label">Gold</span>
            <span class="info-value" id="goldText">0</span>
          </div>
          <div class="info-item">
            <span class="info-label">Essence</span>
            <span class="info-value" id="essenceText">0</span>
          </div>
          <div class="info-item">
            <span class="info-label">Time</span>
            <span class="info-value" id="runTimeText">0:00</span>
          </div>
        </div>
      </div>
      
      <!-- Death Counter (Roguelike Permadeath Tracking) -->
      <div class="death-counter" id="deathCounter">
        DEATHS: <span id="deathCount">0</span>
      </div>
      
      <!-- Phase-Specific Indicators -->
      <div id="curseIndicators" style="display: none; position: absolute; bottom: 60px; left: 16px; max-width: 300px;">
        <!-- Risk Phase Curses -->
      </div>
      
      <div id="escalationMeter" style="display: none; position: absolute; top: 100px; left: 50%; transform: translateX(-50%); background: rgba(18, 12, 8, 0.92); border: 2px solid rgba(139, 69, 19, 0.6); border-radius: 3px; padding: 8px 16px; pointer-events: none;">
        <!-- Escalate Phase Difficulty Indicator -->
      </div>
      
      <div id="minibossHealth" style="display: none; position: absolute; top: 70px; left: 50%; transform: translateX(-50%); width: 400px; background: rgba(18, 12, 8, 0.95); border: 2px solid rgba(139, 101, 55, 0.6); border-radius: 3px; padding: 12px; pointer-events: none;">
        <!-- Miniboss Health Bar -->
      </div>
      
      <!-- Bottom Controls -->
      <div class="controls">
        <button id="btnRestart" title="Begin a new run with different seed">‚ü≤ New Run</button>
        <button id="btnHelp" title="View combat instructions">? Guide</button>
        <button id="btnExport" title="Save run data">‚éò Save Run</button>
      </div>
      
      <!-- Help Modal -->
      <div id="helpModal" class="modal">
        <h2>Warrior's Guide</h2>
        <p class="modal-subtitle">Learn the ancient art of combat to survive the depths</p>
        
        <div class="controls-grid">
          <div class="control-item">
            <span class="control-action">Navigate Dungeon</span>
            <span class="control-key">WASD</span>
          </div>
          <div class="control-item">
            <span class="control-action">Alternative Movement</span>
            <span class="control-key">Arrows</span>
          </div>
          <div class="control-item">
            <span class="control-action">Quick Strike</span>
            <span class="control-key">J</span>
          </div>
          <div class="control-item">
            <span class="control-action">Power Strike</span>
            <span class="control-key">L</span>
          </div>
          <div class="control-item">
            <span class="control-action">Raise Shield</span>
            <span class="control-key">Shift</span>
          </div>
          <div class="control-item">
            <span class="control-action">Evasive Roll</span>
            <span class="control-key">Space</span>
          </div>
          <div class="control-item">
            <span class="control-action">Battle Art</span>
            <span class="control-key">K</span>
          </div>
          <div class="control-item">
            <span class="control-action">Select Choice</span>
            <span class="control-key">1 / 2 / 3</span>
          </div>
          <div class="control-item">
            <span class="control-action">Pause Game</span>
            <span class="control-key">P / ESC</span>
          </div>
        </div>
        
        <p class="flavor-text" style="margin-top: 20px;">
          "Those who enter the depths must be swift and deliberate. Hesitation breeds death, 
          but recklessness invites it. Master these techniques, warrior, for they are your only 
          companions in the darkness below."
        </p>
        
        <div class="modal-footer">
          <button id="btnCloseHelp">I Understand</button>
        </div>
      </div>
      
      <!-- Choice Modal (for upgrades) -->
      <div id="choiceModal" class="modal"></div>
      
      <!-- Shop Modal (for purchases) -->
      <div id="shopModal" class="modal"></div>
    </div>
  </div>
  <script type="module">
    import { startMVPDemo } from '../src/game/loop/MVPLoop.js';
    
    // Cache-busting: Force WASM reload
    console.log('[Roguelike] üîÑ WASM build timestamp:', new Date(1731626079000).toLocaleString());
    
    // Initialize demo with roguelike UI
    (async () => {
      try {
        console.log('[Roguelike] ‚öîÔ∏è Descending into darkness...');
        console.log('[Roguelike] ‚úì WASM-powered dungeon generation');
        console.log('[Roguelike] ‚úì Deterministic procedural generation');
        console.log('[Roguelike] ‚úì Permadeath enabled - Every run matters');
        
        // Track deaths across runs (localStorage for persistence)
        let deathCount = parseInt(localStorage.getItem('dozedent_deaths') || '0', 10);
        document.getElementById('deathCount').textContent = deathCount;
        
        // Start game with roguelike UI configuration
        const gameLoop = await startMVPDemo({
          canvasId: 'gameCanvas',
          recordingEnabled: true,
          ui: {
            // Bar elements (for width updates)
            hpBar: 'hpBar',
            staminaBar: 'staminaBar',
            
            // Text elements (for value updates)
            hpText: 'hpText',
            staminaText: 'staminaText',
            phaseText: 'phaseText',
            waveText: 'waveText',
            enemiesText: 'enemiesText',
            
            // Modals
            helpModal: 'helpModal',
            choiceModal: 'choiceModal',
            shopModal: 'shopModal',
            
            // Controls
            btnHelp: 'btnHelp',
            btnCloseHelp: 'btnCloseHelp',
            btnRestart: 'btnRestart'
          }
        });
        
        console.log('[Roguelike] ‚úÖ Dungeon generated. The darkness awaits...');
        
        // Global state tracking
        let runStartTime = Date.now();
        let lastPhase = '';
        
        // Choice/Shop mapping data
        const choiceNames = {
          0: 'Warrior\'s Vigor',
          1: 'Swift Reflexes',
          2: 'Iron Will',
          3: 'Berserker Rage',
          4: 'Divine Protection',
          5: 'Vampiric Touch'
        };
        
        const choiceDescriptions = {
          0: 'Increase maximum health by 20. A warrior\'s body is their fortress.',
          1: 'Increase movement speed by 15%. Strike like lightning, vanish like wind.',
          2: 'Increase stamina regeneration by 25%. Endurance wins battles.',
          3: 'Deal 30% more damage when below 50% HP. Fury fuels the desperate.',
          4: 'Block reduces damage by 10% more. Faith is the strongest shield.',
          5: 'Heal 15% of damage dealt. The life of your foes becomes yours.'
        };
        
        // Helper Functions
        const getChoiceName = (type) => choiceNames[type] || `Unknown Boon ${type}`;
        const getChoiceDesc = (type) => choiceDescriptions[type] || 'Mysterious power awaits...';
        
        const getChoiceRarity = (rarity) => {
          const rarities = ['Common', 'Uncommon', 'Rare', 'Epic', 'Legendary'];
          return rarities[rarity] || 'Common';
        };
        
        const formatTime = (ms) => {
          const seconds = Math.floor(ms / 1000);
          const minutes = Math.floor(seconds / 60);
          const secs = seconds % 60;
          return `${minutes}:${secs.toString().padStart(2, '0')}`;
        };
        
        // Modal Population Functions
        const populateChoiceModal = () => {
          const modal = document.getElementById('choiceModal');
          if (!gameLoop || !gameLoop.wasmModule) {
            return;
          }
          
          const wasmModule = gameLoop.wasmModule;
          const choiceCount = wasmModule.get_choice_count?.() || 3;
          
          let choicesHtml = '';
          for (let i = 0; i < Math.min(choiceCount, 3); i++) {
            const id = wasmModule.get_choice_id?.(i) ?? i;
            const type = wasmModule.get_choice_type?.(i) ?? i;
            const rarity = wasmModule.get_choice_rarity?.(i) ?? 0;
            
            choicesHtml += `
              <div class="card" onclick="selectChoice(${id})" data-choice-key="${i + 1}">
                <div class="card-title">${getChoiceName(type)}</div>
                <div class="card-description">${getChoiceDesc(type)}</div>
                <div class="flavor-text" style="margin-top: 8px; opacity: 0.7; font-size: 12px;">
                  ${getChoiceRarity(rarity)} ‚Ä¢ Press ${i + 1} to select
                </div>
              </div>
            `;
          }
          
          modal.innerHTML = `
            <h2>Choose Your Boon</h2>
            <p class="modal-subtitle">The dungeon grants you power. Choose wisely.</p>
            <div class="choices">
              ${choicesHtml}
            </div>
          `;
        };
        
        const populateShopModal = () => {
          const modal = document.getElementById('shopModal');
          if (!gameLoop || !gameLoop.wasmModule) {
            return;
          }
          
          const wasmModule = gameLoop.wasmModule;
          const gold = wasmModule.get_gold?.() ?? 0;
          const essence = wasmModule.get_essence?.() ?? 0;
          const itemCount = wasmModule.get_shop_item_count?.() || 3;
          
          let shopHtml = '';
          for (let i = 0; i < itemCount; i++) {
            const cost = 50 + (i * 25);
            const canBuy = gold >= cost;
            
            shopHtml += `
              <div class="card ${canBuy ? '' : 'disabled'}" 
                   onclick="${canBuy ? `purchaseShopItem(${i})` : ''}"
                   style="${canBuy ? '' : 'opacity: 0.5; cursor: not-allowed;'}">
                <div class="card-title">Shop Item ${i + 1}</div>
                <div class="card-description">
                  A mysterious merchant's offering. Perhaps it will aid you in the depths below.
                </div>
                <div class="flavor-text" style="margin-top: 8px; opacity: 0.9; font-size: 13px; color: #daa520;">
                  üí∞ ${cost} Gold ${canBuy ? '' : '(Insufficient)'}
                </div>
              </div>
            `;
          }
          
          modal.innerHTML = `
            <h2>Merchant's Wares</h2>
            <p class="modal-subtitle">
              Gold: <span style="color: #daa520;">${gold}</span> ‚Ä¢ 
              Essence: <span style="color: #9370db;">${essence}</span>
            </p>
            <div class="shop">
              ${shopHtml}
            </div>
            <div class="modal-footer">
              <button onclick="closeShopModal()">Leave Merchant</button>
            </div>
          `;
        };
        
        // Selection Handlers
        window.selectChoice = (choiceId) => {
          if (gameLoop && gameLoop.wasmModule && gameLoop.wasmModule.commit_choice) {
            gameLoop.wasmModule.commit_choice(choiceId);
            document.getElementById('choiceModal').classList.remove('active');
            console.log('[Roguelike] üéÅ Choice selected:', choiceId);
          }
        };
        
        window.purchaseShopItem = (index) => {
          if (gameLoop && gameLoop.wasmModule && gameLoop.wasmModule.buy_shop_item) {
            gameLoop.wasmModule.buy_shop_item(index);
            console.log('[Roguelike] üí∞ Purchased item:', index);
            populateShopModal();
          }
        };
        
        window.closeShopModal = () => {
          document.getElementById('shopModal').classList.remove('active');
        };
        
        // Enhanced UI Update Loop
        const updateUI = () => {
          try {
            if (gameLoop && gameLoop.getState) {
              const state = gameLoop.getState();
              
              // Update HP
              const hpBar = document.getElementById('hpBar');
              const hpText = document.getElementById('hpText');
              if (hpBar && state.player) {
                const hpPercent = (state.player.hp / state.player.maxHp) * 100;
                hpBar.style.width = `${hpPercent}%`;
                if (hpText) {
                  hpText.textContent = `${Math.round(state.player.hp)} / ${state.player.maxHp}`;
                }
              }
              
              // Update Stamina
              const staminaBar = document.getElementById('staminaBar');
              const staminaText = document.getElementById('staminaText');
              if (staminaBar && state.player) {
                const staminaPercent = (state.player.stamina / state.player.maxStamina) * 100;
                staminaBar.style.width = `${staminaPercent}%`;
                if (staminaText) {
                  staminaText.textContent = `${Math.round(state.player.stamina)} / ${state.player.maxStamina}`;
                }
              }
              
              // Update roguelike game info
              const phaseText = document.getElementById('phaseText');
              const waveText = document.getElementById('waveText');
              const enemiesText = document.getElementById('enemiesText');
              
              // Translate phase to roguelike terminology
              const currentPhase = state.phase?.toLowerCase() || 'combat';
              if (phaseText) {
                const phaseMap = {
                  'explore': 'Exploring',
                  'fight': 'Battle',
                  'choose': 'Respite',
                  'powerup': 'Empowered',
                  'risk': 'Cursed',
                  'escalate': 'Crisis',
                  'cashout': 'Merchant',
                  'reset': 'Recovering'
                };
                phaseText.textContent = phaseMap[currentPhase] || 
                                       currentPhase.charAt(0).toUpperCase() + currentPhase.slice(1);
              }
              
              // Display as dungeon depth/floor
              if (waveText && state.wave !== undefined) {
                waveText.textContent = `Floor ${state.wave}`;
              }
              
              // Count remaining foes
              if (enemiesText && state.enemies) {
                const aliveEnemies = state.enemies.filter(e => e.hp > 0).length;
                enemiesText.textContent = aliveEnemies.toString();
              }
              
              // Update run stats
              const goldText = document.getElementById('goldText');
              const essenceText = document.getElementById('essenceText');
              const runTimeText = document.getElementById('runTimeText');
              
              if (gameLoop.wasmModule) {
                if (goldText && gameLoop.wasmModule.get_gold) {
                  goldText.textContent = gameLoop.wasmModule.get_gold();
                }
                if (essenceText && gameLoop.wasmModule.get_essence) {
                  essenceText.textContent = gameLoop.wasmModule.get_essence();
                }
              }
              
              if (runTimeText) {
                runTimeText.textContent = formatTime(Date.now() - runStartTime);
              }
              
              // Phase-specific UI handling
              handlePhaseUI(currentPhase);
              
              // Check for player death and update counter
              if (state.player && state.player.hp <= 0) {
                const currentDeaths = parseInt(localStorage.getItem('dozedent_deaths') || '0', 10);
                if (currentDeaths === deathCount) {
                  deathCount++;
                  localStorage.setItem('dozedent_deaths', deathCount.toString());
                  document.getElementById('deathCount').textContent = deathCount;
                  console.log('[Roguelike] ‚ò†Ô∏è Another warrior falls. Total deaths:', deathCount);
                }
              }
            }
          } catch (error) {
            // Silently handle errors to avoid console spam
          }
          
          requestAnimationFrame(updateUI);
        };
        
        // Phase-specific UI handler
        const handlePhaseUI = (phase) => {
          const choiceModal = document.getElementById('choiceModal');
          const shopModal = document.getElementById('shopModal');
          const curseIndicators = document.getElementById('curseIndicators');
          const escalationMeter = document.getElementById('escalationMeter');
          const minibossHealth = document.getElementById('minibossHealth');
          
          // Handle phase transitions
          if (phase !== lastPhase) {
            lastPhase = phase;
            
            // Hide all phase-specific UI
            choiceModal.classList.remove('active');
            shopModal.classList.remove('active');
            curseIndicators.style.display = 'none';
            escalationMeter.style.display = 'none';
            minibossHealth.style.display = 'none';
            
            // Show phase-specific UI
            if (phase === 'choose') {
              populateChoiceModal();
              choiceModal.classList.add('active');
              console.log('[Roguelike] ‚öîÔ∏è Choice phase - Select your boon');
            } else if (phase === 'cashout') {
              populateShopModal();
              shopModal.classList.add('active');
              console.log('[Roguelike] üí∞ Shop phase - Visit the merchant');
            }
          }
          
          // Update Risk phase curses
          if (phase === 'risk' && gameLoop.wasmModule && gameLoop.wasmModule.get_curse_count) {
            const curseCount = gameLoop.wasmModule.get_curse_count();
            if (curseCount > 0) {
              let curseHtml = '<div style="background: rgba(18, 12, 8, 0.92); border: 2px solid rgba(139, 69, 19, 0.6); border-radius: 3px; padding: 8px 12px;">';
              curseHtml += '<div style="font-family: \'Fira Mono\', monospace; font-size: 11px; font-weight: 700; color: #d4a574; margin-bottom: 4px;">‚ö† ACTIVE CURSES</div>';
              for (let i = 0; i < curseCount; i++) {
                const curseType = gameLoop.wasmModule.get_curse_type?.(i) ?? 0;
                curseHtml += `<div style="font-size: 12px; color: #b8986d; margin: 2px 0;">‚ò† Curse ${curseType}</div>`;
              }
              curseHtml += '</div>';
              curseIndicators.innerHTML = curseHtml;
              curseIndicators.style.display = 'block';
            }
          }
          
          // Update Escalate phase difficulty
          if (phase === 'escalate' && gameLoop.wasmModule && gameLoop.wasmModule.get_escalation_level) {
            const escalation = gameLoop.wasmModule.get_escalation_level() * 100;
            escalationMeter.innerHTML = `
              <div style="font-family: 'Fira Mono', monospace; font-size: 11px; font-weight: 700; color: #d4a574;">
                ‚öî ESCALATION: ${Math.round(escalation)}%
              </div>
            `;
            escalationMeter.style.display = 'block';
            
            // Show miniboss health if active
            if (gameLoop.wasmModule.get_miniboss_active?.() === 1) {
              minibossHealth.innerHTML = `
                <div style="font-family: 'Crimson Text', serif; font-size: 16px; font-weight: 700; color: #d4a574; margin-bottom: 6px; text-align: center;">
                  ‚öîÔ∏è ELITE FOE ‚öîÔ∏è
                </div>
                <div style="height: 12px; background: rgba(10, 5, 2, 0.8); border-radius: 2px; overflow: hidden; border: 1px solid rgba(80, 60, 40, 0.6);">
                  <div style="height: 100%; width: 75%; background: linear-gradient(90deg, #8b0000, #dc143c); transition: width 0.3s ease;"></div>
                </div>
              `;
              minibossHealth.style.display = 'block';
            }
          }
        };
        
        // Start UI update loop
        updateUI();
        
        // Export run data functionality
        const btnExport = document.getElementById('btnExport');
        if (btnExport) {
          btnExport.addEventListener('click', () => {
            try {
              const replay = gameLoop.exportReplay();
              if (replay) {
                const json = JSON.stringify(replay, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `run-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                console.log('[Roguelike] üíæ Run data saved:', replay.frameCount, 'frames');
              }
            } catch (error) {
              console.error('[Roguelike] ‚ùå Failed to save run data:', error);
            }
          });
        }
        
        // Restart button - new run
        const btnRestart = document.getElementById('btnRestart');
        if (btnRestart) {
          btnRestart.addEventListener('click', () => {
            console.log('[Roguelike] ‚ü≤ Beginning new descent...');
            location.reload();
          });
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          if (e.key === 'h' || e.key === 'H' || e.key === '?') {
            const helpModal = document.getElementById('helpModal');
            if (helpModal && !helpModal.classList.contains('active')) {
              helpModal.classList.add('active');
              console.log('[Roguelike] üìñ Consulting the warrior\'s guide...');
            }
          }
          
          if (e.key === 'Escape' || e.key === 'p' || e.key === 'P') {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => modal.classList.remove('active'));
          }
          
          // Choice selection shortcuts (1, 2, 3)
          const choiceModal = document.getElementById('choiceModal');
          if (choiceModal && choiceModal.classList.contains('active')) {
            if (e.key === '1' || e.key === '2' || e.key === '3') {
              const choiceIndex = parseInt(e.key, 10) - 1;
              if (gameLoop && gameLoop.wasmModule && gameLoop.wasmModule.get_choice_count) {
                const choiceCount = gameLoop.wasmModule.get_choice_count();
                if (choiceIndex < choiceCount) {
                  const choiceId = gameLoop.wasmModule.get_choice_id(choiceIndex);
                  window.selectChoice(choiceId);
                  console.log('[Roguelike] ‚å®Ô∏è Quick-selected choice', e.key);
                }
              }
            }
          }
        });
        
        console.log('[Roguelike] üí° Press H or ? for controls, ESC/P to close menus');
        console.log('[Roguelike] üí° Press 1/2/3 to quick-select choices when offered');
        console.log('[Roguelike] ‚öîÔ∏è Your descent begins. May fortune favor the bold.');
        
      } catch (error) {
        console.error('[Roguelike] üî¥ The descent failed:', error);
        
        // Show atmospheric error in UI
        const root = document.getElementById('root');
        if (root) {
          const errorDiv = document.createElement('div');
          errorDiv.style.cssText = `
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(18, 12, 8, 0.98), rgba(12, 8, 5, 0.98));
            color: #d4a574;
            font-family: 'Crimson Text', serif;
            font-size: 18px;
            font-weight: 600;
            padding: 32px;
            text-align: center;
            z-index: 1000;
          `;
          errorDiv.innerHTML = `
            <div style="max-width: 500px; border: 3px solid #5a4a3a; padding: 32px; border-radius: 4px; background: rgba(26, 18, 10, 0.9);">
              <div style="font-size: 64px; margin-bottom: 16px;">‚ò†</div>
              <div style="font-size: 24px; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 12px;">The Path is Blocked</div>
              <div style="font-size: 14px; margin-top: 16px; opacity: 0.8; font-style: italic; color: #9a8570;">
                ${error.message}
              </div>
              <div style="font-size: 13px; margin-top: 20px; opacity: 0.7; font-style: italic; color: #9a8570;">
                "Even the bravest warriors must turn back when the dungeon refuses entry..."
              </div>
              <button onclick="location.reload()" style="margin-top: 28px; padding: 14px 28px; background: linear-gradient(180deg, #3a2a1a, #2a1e12); border: 2px solid #5a4a3a; border-radius: 3px; color: #d4c5b0; cursor: pointer; font-weight: 700; font-family: 'Fira Mono', monospace; text-transform: uppercase; letter-spacing: 1px; font-size: 12px;">
                ‚ü≤ Try Again
              </button>
            </div>
          `;
          root.appendChild(errorDiv);
        }
      }
    })();
  </script>
</body>
</html>
