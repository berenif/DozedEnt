class t{constructor(t,e,i={}){this.x=t,this.y=e,this.vx=i.vx||0,this.vy=i.vy||0,this.ax=i.ax||0,this.ay=i.ay||0,this.life=i.life||1,this.maxLife=i.life||1,this.size=i.size||4,this.sizeDecay=i.sizeDecay||.98,this.color=i.color||{r:255,g:255,b:255},this.alpha=i.alpha||1,this.alphaDecay=i.alphaDecay||.98,this.rotation=i.rotation||0,this.rotationSpeed=i.rotationSpeed||0,this.trail=i.trail||!1,this.trailPositions=[],this.blendMode=i.blendMode||"source-over",this.glow=i.glow||!1,this.glowSize=i.glowSize||2,this.shape=i.shape||"circle",this.friction=i.friction||1,this.bounce=i.bounce||0,this.gravity=i.gravity||0,this.turbulence=i.turbulence||0,this.scaleWithVelocity=i.scaleWithVelocity||!1}update(t){if(this.vx*=this.friction,this.vy*=this.friction,this.vx+=this.ax*t,this.vy+=(this.ay+this.gravity)*t,this.turbulence>0){let t=Number((globalThis.runSeedForVisuals??1n)%2147483647n);t=48271*t%2147483647;const e=t/2147483647-.5;t=48271*t%2147483647;const i=t/2147483647-.5;this.vx+=e*this.turbulence,this.vy+=i*this.turbulence}return this.x+=this.vx*t,this.y+=this.vy*t,this.rotation+=this.rotationSpeed*t,this.trail&&(this.trailPositions.push({x:this.x,y:this.y,alpha:this.alpha}),this.trailPositions.length>10&&this.trailPositions.shift()),this.life-=t,this.size*=this.sizeDecay,this.alpha*=this.alphaDecay,this.bounce>0&&((this.x<0||this.x>1280)&&(this.vx*=-this.bounce,this.x=Math.max(0,Math.min(1280,this.x))),(this.y<0||this.y>720)&&(this.vy*=-this.bounce,this.y=Math.max(0,Math.min(720,this.y)))),this.life>0&&this.alpha>.01&&this.size>.1}render(t){if(t.save(),t.globalCompositeOperation=this.blendMode,t.globalAlpha=this.alpha,this.trail&&this.trailPositions.length>1&&(t.strokeStyle=`rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${.5*this.alpha})`,t.lineWidth=.5*this.size,t.lineCap="round",t.beginPath(),this.trailPositions.forEach((e,i)=>{0===i?t.moveTo(e.x,e.y):t.lineTo(e.x,e.y)}),t.stroke()),this.glow){const e=t.createRadialGradient(this.x,this.y,0,this.x,this.y,this.size*this.glowSize);e.addColorStop(0,`rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${this.alpha})`),e.addColorStop(1,`rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, 0)`),t.fillStyle=e,t.beginPath(),t.arc(this.x,this.y,this.size*this.glowSize,0,2*Math.PI),t.fill()}t.translate(this.x,this.y),t.rotate(this.rotation);let e=this.size;switch(this.scaleWithVelocity&&(e*=1+.1*Math.sqrt(this.vx*this.vx+this.vy*this.vy)),t.fillStyle=`rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${this.alpha})`,this.shape){case"square":t.fillRect(-e/2,-e/2,e,e);break;case"star":this.drawStar(t,0,0,5,e,.5*e);break;case"triangle":t.beginPath(),t.moveTo(0,-e),t.lineTo(.866*-e,.5*e),t.lineTo(.866*e,.5*e),t.closePath(),t.fill();break;default:t.beginPath(),t.arc(0,0,e,0,2*Math.PI),t.fill()}t.restore()}drawStar(t,e,i,a,h,s){let n,o,l=Math.PI/2*3;const r=Math.PI/a;t.beginPath(),t.moveTo(e,i-h);for(let c=0;c<a;c++)n=e+Math.cos(l)*h,o=i+Math.sin(l)*h,t.lineTo(n,o),l+=r,n=e+Math.cos(l)*s,o=i+Math.sin(l)*s,t.lineTo(n,o),l+=r;t.lineTo(e,i-h),t.closePath(),t.fill()}}class e{constructor(t,e,i={}){this.x=t,this.y=e,this.active=!0,this.emissionRate=i.emissionRate||10,this.emissionTimer=0,this.lifetime=i.lifetime||1/0,this.age=0,this.particleConfig=i.particleConfig||{},this.spread=i.spread||2*Math.PI,this.direction=i.direction||0,this.system=null}update(t){if(this.age+=t,this.age>=this.lifetime)return void(this.active=!1);this.emissionTimer+=t;const e=1/this.emissionRate;for(;this.emissionTimer>=e&&this.active;)this.emissionTimer-=e,this.emit()}emit(){if(!this.system)return;const e=this.direction+(Math.random()-.5)*this.spread,i={...this.particleConfig};i.speed&&(i.vx=Math.cos(e)*i.speed,i.vy=Math.sin(e)*i.speed,delete i.speed),this.system.addParticle(new t(this.x,this.y,i))}setPosition(t,e){this.x=t,this.y=e}stop(){this.active=!1}}class i{constructor(){this.particles=[],this.emitters=[]}update(t){this.particles=this.particles.filter(e=>e.update(t)),this.emitters=this.emitters.filter(e=>(e.update(t),e.active))}render(t){const e={};this.particles.forEach(t=>{e[t.blendMode]||(e[t.blendMode]=[]),e[t.blendMode].push(t)});for(const[,i]of Object.entries(e))i.forEach(e=>e.render(t))}addParticle(t){this.particles.push(t)}addEmitter(t){this.emitters.push(t),t.system=this}emit(e,i,a={}){const h=Math.max(1,Math.round((a.emitRate||4)/60)),s=a.emitAngle&&"number"==typeof a.emitAngle.min?a.emitAngle.min:0,n=a.emitAngle&&"number"==typeof a.emitAngle.max?a.emitAngle.max:2*Math.PI,o=a.particleSpeed&&"number"==typeof a.particleSpeed.min?a.particleSpeed.min:20,l=a.particleSpeed&&"number"==typeof a.particleSpeed.max?a.particleSpeed.max:60,r=a.particleSize&&"number"==typeof a.particleSize.min?a.particleSize.min:2,c=a.particleSize&&"number"==typeof a.particleSize.max?a.particleSize.max:5,f="number"==typeof a.particleLife?Math.max(.05,a.particleLife/1e3):.4;let p={r:200,g:200,b:200},d=.6;if("string"==typeof a.particleColor){const t=a.particleColor.match(/rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*([0-9.]+))?\)/i);t&&(p={r:Number(t[1]),g:Number(t[2]),b:Number(t[3])},d=void 0!==t[4]&&null!==t[4]?Number(t[4]):1)}let M=Number((globalThis.runSeedForVisuals??1n)%0xffffffffn)>>>0;for(let u=0;u<h;u++){M=1664525*M+1013904223>>>0;const h=M/4294967296;M=1664525*M+1013904223>>>0;const u=M/4294967296;M=1664525*M+1013904223>>>0;const y=s+h*(n-s),g=o+u*(l-o),b=r+M/4294967296*(c-r);this.addParticle(new t(e,i,{vx:Math.cos(y)*g,vy:Math.sin(y)*g,color:p,size:b,life:f,alpha:d,gravity:"number"==typeof a.gravity?a.gravity:0,alphaDecay:.96,sizeDecay:a.expanding?1.02:.98,glow:!!a.expanding,blendMode:a.expanding?"screen":"source-over"}))}}createBloodSplatter(e,i,a=null){let h=Number((globalThis.runSeedForVisuals??1n)%0xffffffffn)>>>0;const s=15+(h=1664525*h+1013904223>>>0,h/4294967296*10);for(let n=0;n<s;n++){h=1664525*h+1013904223>>>0;const s=h/4294967296;h=1664525*h+1013904223>>>0;const n=h/4294967296;h=1664525*h+1013904223>>>0;const o=a?a+(s-.5)*Math.PI*.5:s*Math.PI*2,l=150*(.5+.5*n),r=2+h/4294967296*4;this.addParticle(new t(e,i,{vx:Math.cos(o)*l,vy:Math.sin(o)*l,color:{r:180+Math.floor(40*(h=1664525*h+1013904223>>>0,h/4294967296)),g:0,b:0},size:r,life:.5+.5*(h=1664525*h+1013904223>>>0,h/4294967296),gravity:300,friction:.95,bounce:.3,alphaDecay:.95,sizeDecay:.98,trail:r>3,blendMode:"multiply"}))}for(let a=0;a<5;a++)this.addParticle(new t(e,i,{vx:50*(Math.random()-.5),vy:50*(Math.random()-.5),color:{r:150,g:0,b:0},size:15+10*Math.random(),life:.8,alpha:.3,alphaDecay:.96,sizeDecay:1.01,blendMode:"multiply"}))}createHitSpark(e,i,a={r:255,g:200,b:100}){let h=Number((globalThis.runSeedForVisuals??1n)%0xffffffffn)>>>0;const s=8+8*(h=1664525*h+1013904223>>>0,h/4294967296);for(let n=0;n<s;n++){h=1664525*h+1013904223>>>0;const o=2*Math.PI*n/s+h/4294967296*.5;h=1664525*h+1013904223>>>0;const l=200+h/4294967296*150;this.addParticle(new t(e,i,{vx:Math.cos(o)*l,vy:Math.sin(o)*l,color:a,size:2+3*(h=1664525*h+1013904223>>>0,h/4294967296),life:.2+.3*(h=1664525*h+1013904223>>>0,h/4294967296),alphaDecay:.92,sizeDecay:.95,glow:!0,glowSize:3,shape:"star",blendMode:"screen",trail:!0}))}this.addParticle(new t(e,i,{color:{r:255,g:255,b:255},size:30,life:.1,alpha:.8,alphaDecay:.85,sizeDecay:1.15,glow:!0,glowSize:2,blendMode:"screen"}))}createDustCloud(e,i,a=30){const h=10+10*Math.random();for(let s=0;s<h;s++){const h=Math.random()*Math.PI*2,s=Math.random()*a,n=e+Math.cos(h)*s,o=i+Math.sin(h)*s;this.addParticle(new t(n,o,{vx:30*(Math.random()-.5),vy:50*-Math.random()-20,color:{r:150,g:130,b:100},size:10+15*Math.random(),life:.8+.4*Math.random(),alpha:.4,alphaDecay:.97,sizeDecay:1.01,turbulence:5,blendMode:"multiply"}))}}createRollDust(e,i,a){for(let h=0;h<5;h++){const s=10*(h-2.5);this.addParticle(new t(e-20*Math.cos(a),i-20*Math.sin(a)+s,{vx:50*-Math.cos(a)+20*(Math.random()-.5),vy:50*-Math.sin(a)+20*(Math.random()-.5),color:{r:180,g:160,b:140},size:8+4*Math.random(),life:.4,alpha:.5,alphaDecay:.95,sizeDecay:1.02,blendMode:"multiply"}))}}createBlockSpark(e,i,a){for(let h=0;h<12;h++){const h=a+(Math.random()-.5)*Math.PI*.3,s=250+150*Math.random();this.addParticle(new t(e,i,{vx:Math.cos(h)*s,vy:Math.sin(h)*s,color:{r:255,g:230,b:150},size:1+2*Math.random(),life:.3,alphaDecay:.9,friction:.92,glow:!0,glowSize:4,shape:Math.random()>.5?"star":"circle",blendMode:"screen",trail:!0,gravity:100}))}this.addParticle(new t(e,i,{color:{r:255,g:255,b:200},size:5,life:.2,alpha:.6,alphaDecay:.85,sizeDecay:1.25,shape:"circle",blendMode:"screen",glow:!0,glowSize:3}))}createPerfectParryFlash(e,i){this.addParticle(new t(e,i,{color:{r:100,g:200,b:255},size:100,life:.3,alpha:.8,alphaDecay:.9,sizeDecay:1.08,glow:!0,glowSize:2,blendMode:"screen"}));for(let a=0;a<16;a++){const h=2*Math.PI*a/16,s=300;this.addParticle(new t(e,i,{vx:Math.cos(h)*s,vy:Math.sin(h)*s,color:{r:150,g:200,b:255},size:4,life:.5,alphaDecay:.94,friction:.9,glow:!0,glowSize:3,shape:"star",blendMode:"screen",trail:!0}))}}createEnemyDeathExplosion(e,i){for(let a=0;a<30;a++){const a=Math.random()*Math.PI*2,h=100+200*Math.random();this.addParticle(new t(e,i,{vx:Math.cos(a)*h,vy:Math.sin(a)*h,color:{r:255,g:100+100*Math.random(),b:100*Math.random()},size:3+5*Math.random(),life:.5+.5*Math.random(),gravity:200,friction:.94,alphaDecay:.95,sizeDecay:.97,glow:!0,glowSize:2,blendMode:"screen"}))}for(let a=0;a<8;a++)this.addParticle(new t(e,i,{vx:50*(Math.random()-.5),vy:100*-Math.random()-50,color:{r:80,g:80,b:80},size:20+20*Math.random(),life:1,alpha:.5,alphaDecay:.97,sizeDecay:1.02,blendMode:"multiply"}))}createFootstep(e,i,a=1){for(let h=0;h<3;h++)this.addParticle(new t(e+10*(Math.random()-.5),i+5*(Math.random()-.5),{vx:20*(Math.random()-.5),vy:30*-Math.random()-10,color:{r:160,g:140,b:120},size:(3+2*Math.random())*a,life:.3,alpha:.3,alphaDecay:.94,sizeDecay:1.01,blendMode:"multiply"}))}clear(){this.particles=[],this.emitters=[]}createSlashEffect(e,i,a=1){for(let h=0;h<6;h++){const h=250+150*Math.random(),s=.4*(Math.random()-.5);this.addParticle(new t(e,i+20*(Math.random()-.5),{vx:a*h+60*(Math.random()-.5),vy:s*h*.2,color:{r:255,g:230,b:120},size:2+2*Math.random(),life:.25+.2*Math.random(),alphaDecay:.92,sizeDecay:.96,glow:!0,glowSize:3,shape:"star",blendMode:"screen",trail:!0}))}this.addParticle(new t(e+10*a,i,{color:{r:255,g:255,b:200},size:24,life:.12,alpha:.8,alphaDecay:.85,sizeDecay:1.18,glow:!0,glowSize:2,blendMode:"screen"}))}createShieldEffect(e,i){for(let a=0;a<12;a++){const h=2*Math.PI*a/12,s=120+80*Math.random();this.addParticle(new t(e,i,{vx:Math.cos(h)*s,vy:Math.sin(h)*s,color:{r:120,g:180,b:255},size:2,life:.25,alphaDecay:.92,sizeDecay:.98,glow:!0,glowSize:3,shape:"circle",blendMode:"screen"}))}this.addParticle(new t(e,i,{color:{r:180,g:220,b:255},size:30,life:.18,alpha:.5,alphaDecay:.9,sizeDecay:1.12,glow:!0,glowSize:2,blendMode:"screen"}))}createBlockImpact(t,e){this.createBlockSpark(t,e,0)}createBloodEffect(t,e){this.createBloodSplatter(t,e)}createDeathEffect(t,e){this.createEnemyDeathExplosion(t,e)}createRespawnEffect(e,i){this.createDustCloud(e,i,40),this.addParticle(new t(e,i,{color:{r:180,g:255,b:255},size:60,life:.4,alpha:.6,alphaDecay:.9,sizeDecay:1.1,glow:!0,glowSize:2,blendMode:"screen"}))}startChargingEffect(t,i){const a=new e(t,i,{emissionRate:20,lifetime:1.5,particleConfig:{color:{r:120,g:200,b:255},size:3,life:.4,alpha:.7,alphaDecay:.94,sizeDecay:.98,glow:!0,glowSize:2,shape:"circle",speed:30,rotationSpeed:3},spread:2*Math.PI,direction:0});return this.addEmitter(a),a}createChargedSlash(e,i,a=1,h=0){this.createSlashEffect(e,i,a);const s=Math.floor(6*Math.max(0,Math.min(1,h)));for(let h=0;h<s;h++)this.addParticle(new t(e,i+20*(Math.random()-.5),{vx:a*(300+200*Math.random()),vy:40*(Math.random()-.5),color:{r:255,g:255,b:180},size:3+2*Math.random(),life:.3,alphaDecay:.9,sizeDecay:.95,glow:!0,glowSize:3,shape:"star",blendMode:"screen",trail:!0}));this.addParticle(new t(e+15*a,i,{color:{r:255,g:255,b:220},size:30+20*h,life:.14+.1*h,alpha:.85,alphaDecay:.88,sizeDecay:1.2,glow:!0,glowSize:2,blendMode:"screen"}))}createDashTrail(e,i,a=1,h=0){const s=Math.sqrt(a*a+h*h)||1,n=a/s,o=h/s;for(let a=0;a<4;a++)this.addParticle(new t(e-n*(10+3*a),i-o*(10+3*a),{vx:80*-n+20*(Math.random()-.5),vy:80*-o+20*(Math.random()-.5),color:{r:200,g:220,b:255},size:3,life:.25,alpha:.5,alphaDecay:.9,sizeDecay:.98,glow:!0,glowSize:2,blendMode:"screen"}))}createLandingImpact(e,i,a=1){const h=30+40*Math.max(0,Math.min(1,a));this.createDustCloud(e,i,h),this.addParticle(new t(e,i,{color:{r:255,g:255,b:255},size:20*a,life:.12,alpha:.6,alphaDecay:.88,sizeDecay:1.2,glow:!0,glowSize:2,blendMode:"screen"}))}createSparkle(e,i){this.addParticle(new t(e,i,{color:{r:255,g:255,b:200},size:3+2*Math.random(),life:.3,alpha:.9,alphaDecay:.92,sizeDecay:.97,glow:!0,glowSize:3,shape:"star",blendMode:"screen"}))}}class a{constructor(){this.animations=new Map,this.proceduralAnimations=new Map,this.particleEffects=new Map,this.t=0,this.wasmModule=null,this.initializeAnimations(),this.initializeProceduralAnimations(),this.initializeParticleEffects()}setWasmModule(t){this.wasmModule=t}i(t){if(null===t.h){const e=65535&Math.floor(1e3*(t.position?.x||0)),i=65535&Math.floor(1e3*(t.position?.y||0)),a=65535&Math.floor(1e6*(t.furPattern||.5));t.h=(e<<16^i^a<<1)>>>0}null===t.o&&(t.o=t.h>>>0)}l(t){this.i(t);let e=0|t.o;return e^=e<<13,e^=e>>>17,e^=e<<5,t.o=e>>>0,(4294967295&t.o)/4294967296}p(t,e){return this.l(t)<e}M(t,e,i){return t+(e-t)*i}u(t,e,i){const a=this.t||.016,h=Math.min(1,Math.max(0,i*a));return this.M(t,e,h)}m(t,e,i,a=8){const h=null!==t[e]?t[e]:i;t[e]=this.u(h,i,a)}D(t){const e=t.velocity?.x||0,i=t.velocity?.y||0;t.S=this.u(t.S||0,e,10),t.v=this.u(t.v||0,i,10)}initializeAnimations(){this.animations.set("idle",{breathing:{amplitude:2,frequency:.002,offset:0},earTwitch:{probability:.001,duration:300,maxRotation:.2},tailSway:{amplitude:.1,frequency:.003},blinking:{probability:.002,duration:150}}),this.animations.set("walking",{legCycle:{frequency:.008,amplitude:8,phaseOffset:Math.PI},bodyBob:{amplitude:2,frequency:.016},headBob:{amplitude:1.5,frequency:.008},tailSway:{amplitude:.2,frequency:.008}}),this.animations.set("running",{legCycle:{frequency:.015,amplitude:12,phaseOffset:Math.PI,stretchFactor:1.2},bodyBob:{amplitude:4,frequency:.03},headBob:{amplitude:3,frequency:.015},tailStream:{amplitude:.4,frequency:.02,streamEffect:!0},earsPinned:!0}),this.animations.set("prowling",{legCycle:{frequency:.004,amplitude:5,phaseOffset:Math.PI,careful:!0},bodyLowered:{lowerAmount:10,sway:1},headLowered:{lowerAmount:5,scanning:!0,scanSpeed:.002},tailStill:{tipTwitch:.01,frequency:.005},earsForward:{rotation:-.3,alertness:1}}),this.animations.set("lunging",{bodyStretch:{stretchFactor:1.3,compressionStart:.8,extensionPeak:1.5},legsExtended:{frontExtension:20,rearExtension:15,clawsOut:!0},mouthOpen:{openAmount:.8,teethVisible:!0},earsBack:{rotation:.5},furRipple:{intensity:.3,speed:.02}}),this.animations.set("attacking",{biteSequence:[{jaw:0,duration:100},{jaw:.9,duration:50},{jaw:.7,duration:100},{jaw:0,duration:150}],headShake:{amplitude:5,frequency:.05},clawSwipe:{swipeSpeed:.03,swipeArc:Math.PI/3},bodyTense:{tensionLevel:.8}}),this.animations.set("howling",{headTilt:{startAngle:0,endAngle:-Math.PI/4,duration:1e3},mouthOpen:{openAmount:.6,vibration:.02},chestExpansion:{expansionAmount:1.2,frequency:.003},tailRaised:{angle:.3},soundWaves:{frequency:.01,amplitude:2,visible:!0}}),this.animations.set("hurt",{flinch:{intensity:10,duration:200,direction:"away"},earsFlat:{rotation:.6},tailTucked:{tuckAmount:.8},whimper:{mouthOpen:.2,duration:300},bodyShake:{amplitude:3,frequency:.1,dampening:.9}}),this.animations.set("death",{collapse:{stages:[{legs:"buckle",duration:300},{body:"fall",duration:400},{final:"limp",duration:500}]},fadeOut:{startDelay:1e3,duration:2e3}})}initializeProceduralAnimations(){this.proceduralAnimations.set("legIK",{calculateLegPosition:(t,e,i)=>{const a=this.animations.get(t.state);if(!a||!a.legCycle)return{x:0,y:0};const h=a.legCycle,s=e%2==0?0:h.phaseOffset,n=i*h.frequency+s,o=Math.sin(n)*h.amplitude*.5,l=Math.max(0,Math.sin(2*n))*h.amplitude;return h.careful?{x:.5*o,y:.7*l,placement:"careful"}:{x:o,y:l}}}),this.proceduralAnimations.set("tailPhysics",{segments:5,calculateTailCurve:(t,e)=>{const i=this.animations.get(t.state),a=[];for(let t=0;t<5;t++){const h=.1*t;let s=0;i?.tailSway?s=Math.sin(e*i.tailSway.frequency-h)*i.tailSway.amplitude*(1-.15*t):i?.tailStream?s=Math.sin(e*i.tailStream.frequency-h)*i.tailStream.amplitude*(1+.1*t):i?.tailTucked&&(s=i.tailTucked.tuckAmount*(1+.2*t)),a.push({angle:s,length:8-.5*t})}return a}}),this.proceduralAnimations.set("furDynamics",{calculateFurMovement(t,e,i=0){const a=Math.sqrt(t.velocity.x**2+t.velocity.y**2),h=Math.sin(.005*e)*i;return{ripple:a>200?.2*Math.sin(.02*e):0,flow:h+a/1e3,ruffled:"hurt"===t.state||"attacking"===t.state}}}),this.proceduralAnimations.set("breathing",{calculateBreathing(t,e){const i=.002*({idle:1,walking:1.2,running:2,prowling:.8,attacking:1.5,hurt:1.8,howling:1.3}[t.state]||1),a="running"===t.state?4:2;return{chestExpansion:Math.sin(e*i)*a,bellyExpansion:Math.sin(e*i-.2)*a*.7}}})}initializeParticleEffects(){this.particleEffects.set("runDust",{emitRate:5,particleLife:500,particleSpeed:{min:20,max:50},particleSize:{min:2,max:5},particleColor:"rgba(139, 115, 85, 0.4)",emitAngle:{min:.4*Math.PI,max:.6*Math.PI},gravity:50}),this.particleEffects.set("bloodSplatter",{emitRate:20,particleLife:800,particleSpeed:{min:100,max:200},particleSize:{min:1,max:3},particleColor:"rgba(139, 0, 0, 0.7)",emitAngle:{min:0,max:2*Math.PI},gravity:200}),this.particleEffects.set("attackFoam",{emitRate:8,particleLife:300,particleSpeed:{min:50,max:100},particleSize:{min:1,max:2},particleColor:"rgba(255, 255, 255, 0.6)",emitAngle:{min:-Math.PI/6,max:Math.PI/6},gravity:100}),this.particleEffects.set("soundWaves",{emitRate:2,particleLife:1500,particleSpeed:{min:100,max:100},particleSize:{min:20,max:40},particleColor:"rgba(255, 255, 255, 0.2)",emitAngle:{min:-Math.PI/8,max:Math.PI/8},gravity:0,expanding:!0})}applyAnimation(t,e){if(!this.wasmModule)return;this.t=e;const i=t.id;if("function"!=typeof this.wasmModule.get_wolf_anim_active||!this.wasmModule.get_wolf_anim_active(i))return;const a="function"==typeof globalThis.wasmExports?.get_time_seconds?globalThis.wasmExports.get_time_seconds():performance.now()/1e3,h=t.state,s=this.animations.get(h);if(s){switch(t.k!==h&&(t.k=h,t.A=0),t.A=Math.min(1,(t.A||0)+6*e),this.D(t),this.applyProceduralAnimations(t,i,a),h){case"idle":this.applyIdleAnimation(t,s,a);break;case"walking":case"running":this.applyLocomotionAnimation(t,s,a);break;case"prowling":this.applyProwlingAnimation(t,s,a);break;case"lunging":this.applyLungingAnimation(t,s,a);break;case"attacking":this.applyAttackingAnimation(t,s,a);break;case"howling":this.applyHowlingAnimation(t,s,a);break;case"hurt":this.applyHurtAnimation(t,s,a)}this.updateParticleEffects(t,e)}}applyProceduralAnimations(t,e,i){if(!this.wasmModule)return;const a={active:"function"==typeof this.wasmModule.get_wolf_anim_active&&this.wasmModule.get_wolf_anim_active(e),leg_x:["function"==typeof this.wasmModule.get_wolf_anim_leg_x?this.wasmModule.get_wolf_anim_leg_x(e,0):0,"function"==typeof this.wasmModule.get_wolf_anim_leg_x?this.wasmModule.get_wolf_anim_leg_x(e,1):0,"function"==typeof this.wasmModule.get_wolf_anim_leg_x?this.wasmModule.get_wolf_anim_leg_x(e,2):0,"function"==typeof this.wasmModule.get_wolf_anim_leg_x?this.wasmModule.get_wolf_anim_leg_x(e,3):0],leg_y:["function"==typeof this.wasmModule.get_wolf_anim_leg_y?this.wasmModule.get_wolf_anim_leg_y(e,0):0,"function"==typeof this.wasmModule.get_wolf_anim_leg_y?this.wasmModule.get_wolf_anim_leg_y(e,1):0,"function"==typeof this.wasmModule.get_wolf_anim_leg_y?this.wasmModule.get_wolf_anim_leg_y(e,2):0,"function"==typeof this.wasmModule.get_wolf_anim_leg_y?this.wasmModule.get_wolf_anim_leg_y(e,3):0],spine_bend:"function"==typeof this.wasmModule.get_wolf_anim_spine_bend?this.wasmModule.get_wolf_anim_spine_bend(e):0,tail_angle:"function"==typeof this.wasmModule.get_wolf_anim_tail_angle?this.wasmModule.get_wolf_anim_tail_angle(e):0,head_pitch:"function"==typeof this.wasmModule.get_wolf_anim_head_pitch?this.wasmModule.get_wolf_anim_head_pitch(e):0,head_yaw:"function"==typeof this.wasmModule.get_wolf_anim_head_yaw?this.wasmModule.get_wolf_anim_head_yaw(e):0,ear_rotation:["function"==typeof this.wasmModule.get_wolf_anim_ear_rotation?this.wasmModule.get_wolf_anim_ear_rotation(e,0):0,"function"==typeof this.wasmModule.get_wolf_anim_ear_rotation?this.wasmModule.get_wolf_anim_ear_rotation(e,1):0],body_stretch:"function"==typeof this.wasmModule.get_wolf_anim_body_stretch?this.wasmModule.get_wolf_anim_body_stretch(e):1,body_offset_y:"function"==typeof this.wasmModule.get_wolf_anim_body_offset_y?this.wasmModule.get_wolf_anim_body_offset_y(e):0,fur_ruffle:"function"==typeof this.wasmModule.get_wolf_anim_fur_ruffle?this.wasmModule.get_wolf_anim_fur_ruffle(e):0};t.legPositions=a.leg_x.map((t,e)=>({x:t,y:a.leg_y[e]})),t.spineBend=a.spine_bend,t.tailPosition=a.tail_angle,t.headPitch=a.head_pitch,t.headYaw=a.head_yaw,t.earRotation=a.ear_rotation[0],t.bodyStretch=a.body_stretch,t.bodyBob=a.body_offset_y,t.furMovement={ripple:a.fur_ruffle,flow:0,ruffled:a.fur_ruffle>.05};const h=this.proceduralAnimations.get("breathing").calculateBreathing(t,i);t.breathingOffset=h.chestExpansion,t.bellyOffset=h.bellyExpansion}applyIdleAnimation(t,e,i){this.m(t,"earRotation",t.earRotation||0,8),this.p(t,e.blinking.probability)&&(t.blinkTime=i,t.blinkDuration=e.blinking.duration),t.isBlinking=t.blinkTime&&i-t.blinkTime<t.blinkDuration}applyLocomotionAnimation(t,e,i){this.m(t,"bodyBob",t.bodyBob||0,10),this.m(t,"headBob",t.headBob||0,10),e.earsPinned&&this.m(t,"earRotation",t.earRotation||.4,12)}applyProwlingAnimation(t,e,i){this.m(t,"bodyLowered",1e3*(t.bodyBob||0),10),this.m(t,"bodySway",1*Math.sin(.002*i),10),e.headLowered.scanning&&(t.headScan=t.headYaw),this.m(t,"earRotation",t.earRotation||0,10),this.m(t,"earAlertness",t.earRotation?1:0,10)}applyLungingAnimation(t,e,i){this.m(t,"bodyStretch",t.bodyStretch||1,14),t.frontLegExtension=20*(t.bodyStretch-1),t.rearLegExtension=15*(t.bodyStretch-1),t.clawsOut=t.bodyStretch>1.1,t.mouthOpen=e.mouthOpen.openAmount,t.teethVisible=e.mouthOpen.teethVisible,t.furRipple=t.furMovement?.ripple||0}applyAttackingAnimation(t,e,i){t.biteSequenceIndex||(t.biteSequenceIndex=0),t.biteSequenceTime||(t.biteSequenceTime=i);const a=e.biteSequence[t.biteSequenceIndex];i-t.biteSequenceTime<a.duration?t.jawOpen=a.jaw:(t.biteSequenceIndex=(t.biteSequenceIndex+1)%e.biteSequence.length,t.biteSequenceTime=i),this.m(t,"headShake",Math.sin(i*e.headShake.frequency)*e.headShake.amplitude,18),t.bodyTension=e.bodyTense.tensionLevel}applyHowlingAnimation(t,e,i){t.howlStartTime||(t.howlStartTime=i),t.howlStartTime,e.headTilt.duration,t.headTilt=t.headPitch,t.mouthOpen=e.mouthOpen.openAmount,t.mouthVibration=Math.sin(.05*i)*e.mouthOpen.vibration,this.m(t,"chestExpansion",1+Math.sin(i*e.chestExpansion.frequency)*(e.chestExpansion.expansionAmount-1),10),e.soundWaves.visible&&(t.soundWavePhase=i*e.soundWaves.frequency,t.soundWaveAmplitude=e.soundWaves.amplitude)}applyHurtAnimation(t,e,i){t.hurtStartTime||(t.hurtStartTime=i);const a=i-t.hurtStartTime;if(a<e.flinch.duration){const i=a/e.flinch.duration;t.flinchOffset=e.flinch.intensity*(1-i)}const h=e.bodyShake.dampening**(a/100);this.m(t,"bodyShake",Math.sin(i*e.bodyShake.frequency)*e.bodyShake.amplitude*h,18),this.m(t,"earRotation",t.earRotation||e.earsFlat.rotation,14),this.m(t,"tailTucked",t.tailPosition||e.tailTucked.tuckAmount,14)}updateParticleEffects(t,e){if(t.particleSystem||(t.particleSystem=new i),"running"===t.state&&t.isGrounded){const e=this.particleEffects.get("runDust"),i=t.position.x-20*t.facing,a=t.position.y+t.height/2;"function"==typeof t.particleSystem.emit?t.particleSystem.emit(i,a,e):"function"==typeof t.particleSystem.createDustCloud&&t.particleSystem.createDustCloud(i,a,20)}if("howling"===t.state){const e=this.particleEffects.get("soundWaves"),i=t.position.x+30*t.facing,a=t.position.y-t.height/4;"function"==typeof t.particleSystem.emit?t.particleSystem.emit(i,a,e):"function"==typeof t.particleSystem.createSparkle&&t.particleSystem.createSparkle(i,a)}t.particleSystem.update(e)}renderAnimatedWolf(t,e,i){const a=Math.sqrt((e.position.x-i.x)**2+(e.position.y-i.y)**2);if(a>1500)return;const h=a<500,s=a<1e3;t.save();const n=e.position.x-i.x,o=e.position.y-i.y;t.translate(n,o);const l=e.S||0,r=e.v||0,c=Math.sqrt(l*l+r*r),f=e.spineBend||0;f&&t.rotate(f);const p=1+.05*Math.min(c/(e.maxSpeed||350),1),d=(e.bodyStretch||1)*p,M=2-d;t.scale(e.size*e.facing*d,e.size*M),e.bodyShake&&t.translate(e.bodyShake,0),e.flinchOffset&&t.translate(-e.facing*e.flinchOffset,.5*-e.flinchOffset),s&&this.drawAnimatedShadow(t,e),h?(this.drawAnimatedTail(t,e),this.drawAnimatedLegs(t,e,"hind"),this.drawAnimatedBody(t,e),this.drawAnimatedLegs(t,e,"front"),this.drawAnimatedNeck(t,e),this.drawAnimatedHead(t,e)):s?(this.drawAnimatedBody(t,e),this.drawAnimatedHead(t,e)):this.drawSimplifiedWolf(t,e),h&&e.particleSystem&&e.particleSystem.render(t,i),s&&this.drawWolfUI(t,e),t.restore()}drawSimplifiedWolf(t,e){t.fillStyle=e.color||"#8B4513",t.beginPath(),t.ellipse(0,0,20*e.size,12*e.size,0,0,2*Math.PI),t.fill(),t.beginPath(),t.ellipse(e.facing*e.size*15,8*-e.size,8*e.size,6*e.size,0,0,2*Math.PI),t.fill()}drawAnimatedShadow(t,e){const i=Math.sqrt((e.S||0)**2+(e.v||0)**2),a=1+.15*Math.min(i/(e.maxSpeed||350),1),h="lunging"===e.state?1.2*a:a,s=e.isGrounded?.32:.12;t.fillStyle=`rgba(0, 0, 0, ${s})`,t.beginPath(),t.ellipse(0,e.height/2+5,e.width/3*h,8,0,0,2*Math.PI),t.fill()}drawAnimatedTail(t,e){t.save();const i=.35*-e.width;let a=.1*-e.height;if(e.bodyLowered&&(a+=.5*e.bodyLowered),t.translate(i,a),e.tailSegments){let i=0,a=0,h=e.tailPosition||0;e.tailSegments.forEach((s,n)=>{t.save(),t.translate(i,a),t.rotate(h+s.angle);const o=8-1.2*n,l=s.length;t.fillStyle=n%2==0?e.colors.primary:e.colors.secondary,t.fillRect(0,-o/2,l,o),i+=Math.cos(h+s.angle)*l,a+=Math.sin(h+s.angle)*l,h+=s.angle,t.restore()})}else t.rotate(e.tailPosition||0),t.fillStyle=e.colors.primary,t.beginPath(),t.moveTo(0,0),t.quadraticCurveTo(-15,5,-25,15),t.quadraticCurveTo(-20,20,-10,18),t.quadraticCurveTo(-5,10,0,0),t.fill();t.restore()}drawAnimatedLegs(t,e,i){const a=e.legPositions||[],h="hind"===i,s=h?0:2;for(let i=s;i<s+2;i++){const s=a[i]||{x:0,y:0},n=h?-e.width*(.25-i%2*.1):e.width*(.15+i%2*.1),o=.2*e.height;if(t.save(),t.translate(n+100*s.x,o+100*s.y),t.fillStyle=e.colors.primary,t.fillRect(0,0,10,15-50*s.y),t.translate(0,15-50*s.y),t.rotate(.05*s.y),t.fillRect(0,0,8,10+50*s.y),t.translate(0,10+50*s.y),t.fillStyle=e.colors.secondary,t.fillRect(-1,0,10,5),e.clawsOut){t.fillStyle=e.colors.claws;for(let e=0;e<3;e++)t.fillRect(3*e,4,2,4)}t.restore()}}drawAnimatedBody(t,e){t.save(),e.bodyBob&&t.translate(0,100*e.bodyBob);const i=e.breathingOffset||0,a=e.chestExpansion||1;t.fillStyle=e.colors.primary,t.beginPath(),t.ellipse(0,i,.35*e.width*a*(e.bodyStretch||1),.25*e.height,0,0,2*Math.PI),t.fill();const h=i+(e.bellyOffset||0);t.fillStyle=e.colors.belly,t.beginPath(),t.ellipse(0,h+.1*e.height,.3*e.width*(e.bodyStretch||1),.15*e.height,0,0,Math.PI),t.fill(),e.furMovement&&this.drawAnimatedFur(t,e,0,i,.35*e.width,.25*e.height),t.restore()}drawAnimatedNeck(t,e){t.save(),e.bodyBob&&t.translate(0,50*e.bodyBob),t.fillStyle=e.colors.primary,t.beginPath(),t.moveTo(.15*e.width,.1*-e.height),t.quadraticCurveTo(.25*e.width,.05*-e.height,.3*e.width,.15*-e.height),t.quadraticCurveTo(.25*e.width,.05*e.height,.15*e.width,.1*e.height),t.fill(),t.restore()}drawAnimatedHead(t,e){t.save(),t.translate(.35*e.width,.15*-e.height),e.headPitch&&t.rotate(e.headPitch),e.headShake&&t.translate(e.headShake,0),e.headYaw&&t.rotate(e.headYaw),e.bodyBob&&t.translate(0,50*e.bodyBob),t.fillStyle=e.colors.primary,t.beginPath(),t.moveTo(0,0),t.quadraticCurveTo(10,-5,15,0),t.quadraticCurveTo(20,3,25,5),t.lineTo(28,8),t.quadraticCurveTo(25,10,20,10),t.quadraticCurveTo(10,8,0,10),t.quadraticCurveTo(-5,5,0,0),t.fill(),this.drawAnimatedEars(t,e),this.drawAnimatedMouth(t,e),this.drawAnimatedEyes(t,e),null!==e.soundWavePhase&&this.drawSoundWaves(t,e),t.restore()}drawAnimatedEars(t,e){const i=e.earRotation||0,a=e.earAlertness||0;t.save(),t.translate(5,-3),t.rotate(i-.1*a),t.fillStyle=e.colors.primary,t.beginPath(),t.moveTo(0,0),t.lineTo(-3,-8-2*a),t.lineTo(3,-8-2*a),t.closePath(),t.fill(),t.fillStyle=e.colors.belly,t.beginPath(),t.moveTo(0,-2),t.lineTo(-1,-6-a),t.lineTo(1,-6-a),t.closePath(),t.fill(),t.restore(),t.save(),t.translate(8,-2),t.rotate(i+.1*a),t.fillStyle=e.colors.secondary,t.beginPath(),t.moveTo(0,0),t.lineTo(-2,-7-2*a),t.lineTo(3,-7-2*a),t.closePath(),t.fill(),t.restore()}drawAnimatedMouth(t,e){const i=e.mouthOpen||e.jawOpen||0,a=e.mouthVibration||0;t.fillStyle=e.colors.secondary,t.beginPath(),t.moveTo(20,5),t.quadraticCurveTo(25,6,28,8),t.quadraticCurveTo(25,9+3*i,20,9+3*i),t.fill(),i>0&&(t.fillStyle="rgba(0, 0, 0, 0.7)",t.beginPath(),t.moveTo(20,9),t.quadraticCurveTo(24,9+5*i+a,28,9+3*i+a),t.quadraticCurveTo(24,11+5*i+a,20,11+5*i),t.fill(),(e.teethVisible||i>.5)&&(t.fillStyle="#ffffff",t.beginPath(),t.moveTo(22,9),t.lineTo(21,11+2*i),t.lineTo(23,11+2*i),t.closePath(),t.fill(),t.beginPath(),t.moveTo(25,9),t.lineTo(24,11+2*i),t.lineTo(26,11+2*i),t.closePath(),t.fill(),i>.7&&(t.beginPath(),t.moveTo(23,11+4*i),t.lineTo(22,9+4*i),t.lineTo(24,9+4*i),t.closePath(),t.fill())),i>.3&&"attacking"!==e.state&&(t.fillStyle="rgba(255, 100, 100, 0.8)",t.beginPath(),t.ellipse(24,10+3*i,3,2+2*i,.2,0,Math.PI),t.fill())),t.fillStyle=e.colors.nose,t.beginPath(),t.arc(28,8,2,0,2*Math.PI),t.fill()}drawAnimatedEyes(t,e){if(e.isBlinking)return t.strokeStyle=e.colors.secondary,t.lineWidth=2,t.beginPath(),t.moveTo(10,3),t.lineTo(16,3),void t.stroke();"prowling"!==e.state&&"lunging"!==e.state&&"attacking"!==e.state||(t.shadowColor=e.colors.eyes,t.shadowBlur=8),t.fillStyle="#ffffff",t.beginPath(),t.ellipse(12,3,4,3,-.2,0,2*Math.PI),t.fill();const i="attacking"===e.state?.7:"prowling"===e.state?.5:.3;t.fillStyle=e.colors.eyes,t.beginPath(),t.arc(13,3,2,0,2*Math.PI),t.fill(),t.fillStyle="#000000",t.beginPath(),t.arc(13.5,3,1*(1-i),0,2*Math.PI),t.fill(),t.fillStyle="rgba(255, 255, 255, 0.7)",t.beginPath(),t.arc(12,2,.5,0,2*Math.PI),t.fill(),t.shadowBlur=0}drawAnimatedFur(t,e,i,a,h,s){t.strokeStyle=e.colors.secondary,t.lineWidth=.5,t.globalAlpha=.4;const n=(e.furMovement?.ripple||0)+e.furRuffle,o=e.furMovement?.flow||0,l=e.furMovement?.ruffled||!1;for(let r=0;r<12;r++){const c=r/12*Math.PI*2,f=i+Math.cos(c)*h*.7,p=a+Math.sin(c)*s*.7,d=Math.sin(.01*e.animationTime+r)*n*10,M=Math.cos(.01*e.animationTime+r)*n*5;t.beginPath(),t.moveTo(f,p),l?t.lineTo(f+8*Math.cos(c)+d,p+8*Math.sin(c)+M):t.quadraticCurveTo(f+4*Math.cos(c)+.5*d,p+4*Math.sin(c)+.5*M,f+6*Math.cos(c+o)+d,p+6*Math.sin(c+o)+M),t.stroke()}t.globalAlpha=1}drawSoundWaves(t,e){t.save(),t.globalAlpha=.3,t.strokeStyle=e.colors.eyes,t.lineWidth=2;for(let i=0;i<3;i++){const a=e.soundWavePhase+i*Math.PI/3,h=10+Math.sin(a)*e.soundWaveAmplitude+15*i,s=.3-.1*i;t.globalAlpha=s,t.beginPath(),t.arc(30,5,h,-Math.PI/3,Math.PI/3),t.stroke()}t.restore()}drawWolfUI(t,e){if(e.isAlpha||e.health<e.maxHealth){t.save(),t.scale(1/e.size,1/e.size);const i=60,a=6,h=.5*-e.height-20;t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(-i/2,h,i,a);const s=e.health/e.maxHealth;t.fillStyle=s>.5?"#4caf50":s>.25?"#ff9800":"#f44336",t.fillRect(-i/2,h,i*s,a),t.strokeStyle=e.isAlpha?"#ffd700":"#ffffff",t.lineWidth=1,t.strokeRect(-i/2,h,i,a),e.isAlpha&&(t.font="12px Arial",t.textAlign="center",t.fillText("ðŸ‘‘",0,h-5)),"prowling"===e.state?t.fillText("ðŸ‘",-35,h+5):"howling"===e.state&&t.fillText("ðŸ”Š",-35,h+5),t.restore()}if(e.lungeState?.charging){t.save(),t.globalAlpha=.7;const i=e.lungeState.chargeTime/e.lungeState.maxChargeTime,a=15;t.strokeStyle=`hsl(${60*i}, 100%, 50%)`,t.lineWidth=3,t.beginPath(),t.arc(0,.7*-e.height,a,-Math.PI/2,-Math.PI/2+2*Math.PI*i),t.stroke(),i>=1&&(t.globalAlpha=.3+.3*Math.sin(.01*e.animationTime),t.strokeStyle="#ff0000",t.beginPath(),t.arc(0,.7*-e.height,a+5,0,2*Math.PI),t.stroke()),t.restore()}}}export{a as WolfAnimationSystem,a as default};