<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DozedEnt - Player Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
            font-family: Arial, sans-serif;
        }
        #gameCanvas {
            border: 2px solid #4a90e2;
            background: #2a2a2a;
            display: block;
            margin: 20px auto;
        }
        .instructions {
            text-align: center;
            margin-bottom: 20px;
        }
        .debug-info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="instructions">
        <h1>üéÆ DozedEnt Player Test</h1>
        <p>Use <strong>WASD</strong> to move the player. Press <strong>J</strong> for light attack, <strong>K</strong> for heavy attack.</p>
        <p>The blue square with white border should be visible and move with your inputs.</p>
    </div>

    <canvas id="gameCanvas" width="1280" height="720"></canvas>

    <div class="debug-info" id="debug-info">
        Loading...
    </div>

    <script type="module">
        import { WasmManager } from './src/wasm/wasm-manager.js';
        import { InputManager } from './src/input/input-manager.js';
        import { AnimatedPlayer } from './src/animation/player-animator.js';
        import { GameRenderer } from './src/utils/game-renderer.js';
        import { CameraEffects } from './src/utils/camera-effects.js';

        class PlayerTest {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.debugInfo = document.getElementById('debug-info');
                
                this.WORLD_WIDTH = 3840;
                this.WORLD_HEIGHT = 2160;
                
                this.wasmManager = new WasmManager();
                this.inputManager = null;
                this.player = null;
                this.gameRenderer = null;
                this.cameraEffects = null;
                
                this.lastFrameTime = 0;
                this.animationId = null;
                
                this.init();
            }
            
            async init() {
                console.log('üöÄ Initializing player test...');
                
                // Initialize WASM
                const wasmSuccess = await this.wasmManager.initialize();
                console.log('WASM loaded:', wasmSuccess);
                
                // Initialize input manager
                this.inputManager = new InputManager(this.wasmManager);
                
                // Initialize game renderer
                this.gameRenderer = new GameRenderer(this.ctx, this.canvas, 0);
                this.gameRenderer.useExternalPlayer = true;
                globalThis.gameRenderer = this.gameRenderer;
                
                // Initialize camera effects
                this.cameraEffects = new CameraEffects(this.canvas);
                
                // Initialize player at world center
                const centerX = this.WORLD_WIDTH / 2;
                const centerY = this.WORLD_HEIGHT / 2;
                this.player = new AnimatedPlayer(centerX, centerY, {
                    health: 100,
                    maxHealth: 100,
                    stamina: 100,
                    maxStamina: 100,
                    speed: 250,
                    width: 32,
                    height: 32,
                    color: '#4a90e2'
                });
                
                console.log('‚úÖ Player test initialized');
                this.startGameLoop();
            }
            
            startGameLoop() {
                this.lastFrameTime = performance.now();
                this.gameLoop();
            }
            
            gameLoop() {
                const currentTime = performance.now();
                const deltaTime = (currentTime - this.lastFrameTime) / 1000;
                this.lastFrameTime = currentTime;
                
                this.update(deltaTime);
                this.render();
                
                this.animationId = requestAnimationFrame(() => this.gameLoop());
            }
            
            update(deltaTime) {
                // Get input state
                const inputState = this.inputManager?.getInputState() || {};
                
                // Update WASM if available
                if (this.wasmManager && this.wasmManager.isLoaded) {
                    // Send input to WASM
                    if (this.wasmManager.exports?.set_player_input) {
                        this.wasmManager.exports.set_player_input(
                            inputState.direction?.x || 0,
                            inputState.direction?.y || 0,
                            inputState.roll ? 1 : 0,
                            0, // jump
                            inputState.lightAttack ? 1 : 0,
                            inputState.heavyAttack ? 1 : 0,
                            inputState.block ? 1 : 0,
                            inputState.special ? 1 : 0
                        );
                    }
                    
                    // Update WASM
                    if (this.wasmManager.exports?.update) {
                        this.wasmManager.exports.update(deltaTime);
                    }
                    
                    // Get updated position from WASM
                    const wasmPos = this.wasmManager.getPlayerPosition();
                    this.player.x = wasmPos.x * this.WORLD_WIDTH;
                    this.player.y = wasmPos.y * this.WORLD_HEIGHT;
                } else {
                    // Fallback movement without WASM
                    const moveSpeed = 250 * deltaTime;
                    if (inputState.direction) {
                        this.player.x += inputState.direction.x * moveSpeed;
                        this.player.y += inputState.direction.y * moveSpeed;
                        
                        // Keep in bounds
                        this.player.x = Math.max(50, Math.min(this.WORLD_WIDTH - 50, this.player.x));
                        this.player.y = Math.max(50, Math.min(this.WORLD_HEIGHT - 50, this.player.y));
                    }
                }
                
                // Update camera to follow player
                this.cameraEffects.followTarget(this.player.x, this.player.y);
            }
            
            render() {
                // Clear canvas
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Render background
                this.gameRenderer.render();
                
                // Get camera for rendering
                const camera = this.gameRenderer.camera;
                
                // Render player
                this.player.render(this.ctx, camera);
                
                // Update debug info
                this.updateDebugInfo();
            }
            
            updateDebugInfo() {
                const inputState = this.inputManager?.getInputState() || {};
                const hasInput = inputState.direction?.x !== 0 || inputState.direction?.y !== 0;
                
                let info = `
                    <div><strong>üéÆ Player Test Debug</strong></div>
                    <div>WASM: ${this.wasmManager.isLoaded ? '‚úÖ Loaded' : '‚ùå Failed'}</div>
                    <div>Input: ${hasInput ? 'üéÆ Active' : '‚è∏Ô∏è Idle'}</div>
                `;
                
                if (this.wasmManager.isLoaded) {
                    const wasmPos = this.wasmManager.getPlayerPosition();
                    const stamina = this.wasmManager.getStamina();
                    info += `
                        <div>WASM Pos: (${wasmPos.x.toFixed(3)}, ${wasmPos.y.toFixed(3)})</div>
                        <div>World Pos: (${this.player.x.toFixed(0)}, ${this.player.y.toFixed(0)})</div>
                        <div>Stamina: ${(stamina * 100).toFixed(0)}%</div>
                    `;
                } else {
                    info += `
                        <div>Fallback Pos: (${this.player.x.toFixed(0)}, ${this.player.y.toFixed(0)})</div>
                        <div>Using fallback movement</div>
                    `;
                }
                
                if (hasInput) {
                    info += `
                        <div>Dir: (${(inputState.direction.x || 0).toFixed(1)}, ${(inputState.direction.y || 0).toFixed(1)})</div>
                    `;
                }
                
                this.debugInfo.innerHTML = info;
            }
            
            destroy() {
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                }
                if (this.inputManager) {
                    this.inputManager.destroy();
                }
            }
        }
        
        // Start the test
        window.playerTest = new PlayerTest();
        
        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (window.playerTest) {
                window.playerTest.destroy();
            }
        });
    </script>
</body>
</html>
