<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern UI Integration Test</title>
    <link rel="stylesheet" href="docs/js/src/css/modern-roguelite-ui.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            overflow: hidden;
        }
        
        .test-info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
            max-width: 300px;
        }
        
        .test-info h3 {
            margin: 0 0 10px 0;
            color: #4a9eff;
        }
        
        .test-controls {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .test-controls button {
            background: #4a9eff;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 2px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .test-controls button:hover {
            background: #3a8ae0;
        }
    </style>
</head>
<body>
    <!-- Test Information -->
    <div class="test-info">
        <h3>Modern UI Integration Test</h3>
        <p>This test verifies that the modern roguelite UI components are properly integrated with player movement.</p>
        <ul>
            <li>‚úÖ CSS styles loaded</li>
            <li>‚úÖ Modern UI container present</li>
            <li>‚úÖ Player movement integration ready</li>
            <li>üéÆ Click "Test Movement" to start!</li>
        </ul>
    </div>
    
    <!-- Test Controls -->
    <div class="test-controls">
        <button onclick="testModernUI()">Test Modern UI</button>
        <button onclick="testAccessibility()">Test Accessibility</button>
        <button onclick="testPerformance()">Test Performance</button>
        <button onclick="testInputManager()">Test Input Manager</button>
        <button onclick="testMovementIntegration()" style="background: #ff6b4a;">üéÆ Test Movement</button>
    </div>
    
    <!-- Modern Roguelite UI Container -->
    <div id="modern-roguelite-ui" class="modern-roguelite-ui">
        <!-- This will be populated by the ModernRogueliteUI class -->
    </div>
    
    <script type="module">
        // Import existing systems instead of recreating them
        import { InputManager } from './src/input/input-manager.js';
        import { WasmManager } from './src/wasm/wasm-manager.js';
        import { GameStateManager } from './src/game/game-state-manager.js';
        
        // Global instances for movement integration
        let wasmManager;
        let inputManager;
        let gameStateManager;
        let modernUI;
        let gameLoopRunning = false;
        let lastFrameTime = 0;
        
        // Game loop for movement integration using existing systems
        function gameLoop(currentTime) {
            if (!gameLoopRunning) {
                return;
            }
            
            const deltaTime = (currentTime - lastFrameTime) / 1000; // Convert to seconds
            lastFrameTime = currentTime;
            
            // Update game state using existing GameStateManager
            if (gameStateManager && inputManager) {
                // Get input state from InputManager
                const inputState = inputManager.getInputState();
                
                // Update game state with input
                gameStateManager.update(deltaTime, inputState);
                
                // Update UI with new position from WASM
                updatePlayerVisual();
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        // Update player visual representation using existing WASM API
        function updatePlayerVisual() {
            const playerElement = document.getElementById('player-visual');
            if (playerElement && wasmManager && wasmManager.exports) {
                // Use existing WASM API methods
                const x = wasmManager.exports.get_x ? wasmManager.exports.get_x() : 0.5;
                const y = wasmManager.exports.get_y ? wasmManager.exports.get_y() : 0.5;
                
                // Convert normalized coordinates to screen coordinates
                const screenX = x * window.innerWidth;
                const screenY = y * window.innerHeight;
                
                playerElement.style.left = `${screenX - 10}px`; // Center the 20px circle
                playerElement.style.top = `${screenY - 10}px`;
            }
        }
        
        // Start the game loop
        function startGameLoop() {
            if (!gameLoopRunning) {
                gameLoopRunning = true;
                lastFrameTime = performance.now();
                requestAnimationFrame(gameLoop);
                console.log('üéÆ Game loop started');
            }
        }
        
        // Stop the game loop
        function stopGameLoop() {
            gameLoopRunning = false;
            console.log('‚èπÔ∏è Game loop stopped');
        }
        
        // Test functions using existing systems
        window.testModernUI = async function() {
            try {
                const { ModernRogueliteUI } = await import('./docs/js/src/ui/modern-roguelite-ui.js');
                
                // Initialize WASM manager with existing system
                wasmManager = new WasmManager();
                await wasmManager.initialize();
                
                modernUI = new ModernRogueliteUI(wasmManager);
                console.log('‚úÖ Modern UI initialized successfully with existing WASM system');
                alert('Modern UI test passed! Check console for details.');
            } catch (error) {
                console.error('‚ùå Modern UI test failed:', error);
                alert('Modern UI test failed: ' + error.message);
            }
        };
        
        window.testAccessibility = async function() {
            try {
                const { AccessibilityManager } = await import('./docs/js/src/ui/accessibility-manager.js');
                const accessibilityManager = new AccessibilityManager();
                console.log('‚úÖ Accessibility Manager initialized successfully');
                alert('Accessibility test passed! Check console for details.');
            } catch (error) {
                console.error('‚ùå Accessibility test failed:', error);
                alert('Accessibility test failed: ' + error.message);
            }
        };
        
        window.testPerformance = async function() {
            try {
                console.log('‚úÖ Performance Optimizer test skipped (removed)');
                alert('Performance test skipped - component removed.');
            } catch (error) {
                console.error('‚ùå Performance test failed:', error);
                alert('Performance test failed: ' + error.message);
            }
        };
        
        window.testInputManager = async function() {
            try {
                // Initialize WASM manager if not already done
                if (!wasmManager) {
                    wasmManager = new WasmManager();
                    await wasmManager.initialize();
                }
                
                // Use existing InputManager from src/input/
                inputManager = new InputManager(wasmManager);
                console.log('‚úÖ Input Manager initialized successfully with existing WASM system');
                alert('Input Manager test passed! Check console for details.');
            } catch (error) {
                console.error('‚ùå Input Manager test failed:', error);
                alert('Input Manager test failed: ' + error.message);
            }
        };
        
        // New comprehensive movement integration test using existing systems
        window.testMovementIntegration = async function() {
            try {
                // Initialize all components using existing systems
                const { ModernRogueliteUI } = await import('./docs/js/src/ui/modern-roguelite-ui.js');
                
                // Initialize WASM manager
                wasmManager = new WasmManager();
                await wasmManager.initialize();
                
                // Initialize GameStateManager (handles WASM integration)
                gameStateManager = new GameStateManager();
                gameStateManager.initialize(wasmManager);
                
                // Initialize InputManager (from src/input/)
                inputManager = new InputManager(wasmManager);
                
                // Initialize Modern UI
                modernUI = new ModernRogueliteUI(wasmManager);
                
                // Start the game
                gameStateManager.startGame();
                
                // Create player visual element
                createPlayerVisual();
                
                // Start the game loop
                startGameLoop();
                
                console.log('‚úÖ Movement integration test started using existing systems');
                console.log('üéÆ Use WASD or Arrow keys to move the player');
                console.log('üéØ Use Ctrl or 4 key to roll');
                console.log('‚öîÔ∏è Use J/1 for light attack, K/2 for heavy attack');
                console.log('üõ°Ô∏è Use Shift or 3 to block');
                console.log('üìä Using existing InputManager, WasmManager, and GameStateManager');
                
                alert('Movement integration test started! Using existing built systems. Check console for controls.');
            } catch (error) {
                console.error('‚ùå Movement integration test failed:', error);
                alert('Movement integration test failed: ' + error.message);
            }
        };
        
        // Create visual player representation
        function createPlayerVisual() {
            // Remove existing player visual if any
            const existingPlayer = document.getElementById('player-visual');
            if (existingPlayer) {
                existingPlayer.remove();
            }
            
            // Create new player visual
            const playerVisual = document.createElement('div');
            playerVisual.id = 'player-visual';
            playerVisual.style.cssText = `
                position: fixed;
                width: 20px;
                height: 20px;
                background: #4a9eff;
                border: 2px solid #ffffff;
                border-radius: 50%;
                z-index: 1000;
                pointer-events: none;
                transition: all 0.1s ease-out;
                box-shadow: 0 0 10px rgba(74, 158, 255, 0.5);
            `;
            
            // Position at center initially
            playerVisual.style.left = `${window.innerWidth / 2 - 10}px`;
            playerVisual.style.top = `${window.innerHeight / 2 - 10}px`;
            
            document.body.appendChild(playerVisual);
            
            // Add movement instructions
            const instructions = document.createElement('div');
            instructions.id = 'movement-instructions';
            instructions.style.cssText = `
                position: fixed;
                top: 50px;
                right: 10px;
                background: rgba(0, 0, 0, 0.8);
                padding: 15px;
                border-radius: 8px;
                font-size: 12px;
                z-index: 1000;
                max-width: 200px;
            `;
            instructions.innerHTML = `
                <h4 style="margin: 0 0 10px 0; color: #4a9eff;">Movement Controls</h4>
                <div style="margin-bottom: 5px;">üéÆ <strong>WASD</strong> or <strong>Arrow Keys</strong> - Move</div>
                <div style="margin-bottom: 5px;">üéØ <strong>Ctrl</strong> or <strong>4</strong> - Roll</div>
                <div style="margin-bottom: 5px;">‚öîÔ∏è <strong>J/1</strong> - Light Attack</div>
                <div style="margin-bottom: 5px;">‚öîÔ∏è <strong>K/2</strong> - Heavy Attack</div>
                <div style="margin-bottom: 5px;">üõ°Ô∏è <strong>Shift/3</strong> - Block</div>
                <div style="margin-top: 10px; font-size: 10px; color: #888;">
                    Player position: <span id="player-position">0.5, 0.5</span>
                </div>
            `;
            
            document.body.appendChild(instructions);
            
            // Update position display using existing WASM API
            setInterval(() => {
                if (wasmManager && wasmManager.exports) {
                    const posElement = document.getElementById('player-position');
                    if (posElement) {
                        const x = wasmManager.exports.get_x ? wasmManager.exports.get_x().toFixed(3) : '0.500';
                        const y = wasmManager.exports.get_y ? wasmManager.exports.get_y().toFixed(3) : '0.500';
                        posElement.textContent = `${x}, ${y}`;
                    }
                }
            }, 100);
        }
        
        console.log('Modern UI Integration Test loaded successfully');
        console.log('Available test functions: testModernUI, testAccessibility, testPerformance, testInputManager, testMovementIntegration');
        console.log('üéÆ Click "Test Movement" to start the comprehensive movement integration test!');
    </script>
</body>
</html>
