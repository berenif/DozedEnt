<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play Online - DozedEnt</title>
    <link rel="stylesheet" href="../src/css/common.css">
    <link rel="stylesheet" href="../src/css/working-multiplayer-demo.css">
</head>
<body>
    <div class="demo-container">
        <header class="demo-header">
            <div class="hero-intro">
                <h1>PLAY ONLINE</h1>
                <p class="subtitle">Host the room, share the code, and squad up in seconds.</p>
            </div>
        </header>

        <div class="ui-toast-stack" id="toast-stack" aria-live="assertive" aria-atomic="true"></div>

        <div class="demo-grid">
            <section class="control-card host-join" aria-labelledby="play-online-heading">
                <div class="card-heading">
                    <h2 id="play-online-heading">Play Online</h2>
                    <p>Host a room or drop into a friend's game.</p>
                </div>

                <div class="tabstrip" role="tablist" aria-label="Room options">
                    <button class="tab-button is-active" id="tab-host" role="tab" aria-selected="true" aria-controls="host-panel">Host</button>
                    <button class="tab-button" id="tab-join" role="tab" aria-selected="false" aria-controls="join-panel">Join</button>
                </div>

                <div class="tab-panels">
                    <section class="tab-panel is-active" id="host-panel" role="tabpanel" aria-labelledby="tab-host">
                        <div class="field-group">
                            <label class="field-label" for="player-name-input">Name</label>
                            <input class="field-input" id="player-name-input" type="text" placeholder="Your display name" autocomplete="nickname" inputmode="text">
                        </div>

                        <div class="field-group toggle-group">
                            <label class="toggle" for="serverless-toggle">
                                <input type="checkbox" id="serverless-toggle" checked>
                                <span class="toggle-label">Serverless (WebTorrent)</span>
                            </label>
                            <p class="field-hint">Keep this on for peer to peer hosting.</p>
                        </div>

                        <div class="advanced-section">
                            <button class="button-link" id="advanced-toggle" type="button" aria-expanded="false" aria-controls="advanced-panel">Advanced &#9660;</button>
                            <div class="advanced-panel" id="advanced-panel" hidden>
                                <label class="field-label" for="provider-select">Connection</label>
                                <div class="connection-row">
                                    <select class="field-input" id="provider-select">
                                        <option value="torrent">WebTorrent - serverless signaling</option>
                                        <option value="mqtt">MQTT - reliable messaging</option>
                                        <option value="firebase">Firebase - Google infrastructure</option>
                                        <option value="ipfs">IPFS - decentralized network</option>
                                        <option value="supabase">Supabase - open source Firebase</option>
                                    </select>
                                    <button class="icon-help" id="connection-help" type="button" title="WebTorrent keeps things serverless. Switch if you need fallbacks." aria-label="Connection help">?</button>
                                </div>
                            </div>
                        </div>

                        <button class="button button-primary" id="create-room-button" type="button">Create Room</button>

                        <div class="share-row" id="share-row" hidden>
                            <button class="button-link" id="share-copy-invite" type="button">Copy Invite</button>
                            <span class="share-dot" aria-hidden="true">&bull;</span>
                            <button class="button-link" id="share-copy-code" type="button">Copy Code</button>
                            <span class="share-dot" aria-hidden="true">&bull;</span>
                            <button class="button-link" id="share-show-qr" type="button">QR</button>
                        </div>
                    </section>

                    <section class="tab-panel" id="join-panel" role="tabpanel" aria-labelledby="tab-join" hidden>
                        <div class="field-group">
                            <label class="field-label" for="room-id-input">Room code</label>
                            <div class="input-with-status">
                                <input class="field-input" id="room-id-input" type="text" placeholder="ABC-123" autocomplete="one-time-code" inputmode="text" maxlength="7">
                                <span class="input-status" id="room-code-status" aria-hidden="true"></span>
                            </div>
                        </div>

                        <button class="button button-primary" id="join-room-button" type="button">Join Room</button>

                        <div class="rooms-toolbar">
                            <span class="rooms-label">Nearby rooms</span>
                            <div class="rooms-actions">
                                <button class="button button-quiet" id="discover-button" type="button">Discover</button>
                                <button class="button button-quiet" id="refresh-button" type="button">Refresh</button>
                            </div>
                        </div>

                        <div class="room-list" id="room-list" role="list" aria-live="polite">
                            <div class="room-item empty" role="listitem">
                                <div class="room-name">No rooms yet</div>
                                <div class="room-details">Nearby rooms: No rooms found. Hit Discover, then pick one.</div>
                            </div>
                        </div>
                    </section>
                </div>
            </section>

            <section class="control-card status-card" aria-labelledby="status-heading">
                <div class="card-heading">
                    <h2 id="status-heading">Live Status</h2>
                    <p>Track your link and squad in real time.</p>
                </div>

                <div class="status-chips" role="list">
                    <div class="status-chip is-status" id="status-chip" role="listitem">
                        <span class="chip-label">Status</span>
                        <span class="chip-value" id="connection-status-text">Not connected</span>
                    </div>
                    <button class="status-chip is-action" id="room-copy-button" type="button" role="listitem" disabled>
                        <span class="chip-label">Room</span>
                        <span class="chip-value" id="room-id">Not connected</span>
                        <span class="chip-action">Copy</span>
                    </button>
                    <div class="status-chip" id="connection-chip" role="listitem">
                        <span class="chip-label">Connection</span>
                        <span class="chip-value" id="connection-quality">Idle (WebTorrent)</span>
                    </div>
                </div>

                <div class="players-card">
                    <div class="players-header">
                        <span class="players-title">Players</span>
                        <span class="players-count" id="players-count">0 online</span>
                    </div>
                    <div class="players-meta">You as <span class="player-name" id="peer-name">New Player</span></div>
                    <ul class="players-list" id="players-list" role="list" aria-live="polite">
                        <li class="player-item empty" role="listitem">No players connected</li>
                    </ul>
                </div>

                <button class="button button-danger" id="leave-room-button" type="button" hidden>Leave Room</button>
                <div class="sr-only" id="players-announcer" aria-live="polite"></div>
            </section>
        </div>

        <div class="sr-only" id="status-announcer" aria-live="polite"></div>
    </div>
    <script type="module">
        import MultiplayerDemoCoordinator from '../src/multiplayer/multiplayer-demo-coordinator.js'
        import { roomCodeManager } from '../src/utils/room-code-manager.js'
        import { AlertTypes, showAlert } from '../src/ui/alert-system.js'

        const elements = {
            hostTab: document.getElementById('tab-host'),
            joinTab: document.getElementById('tab-join'),
            hostPanel: document.getElementById('host-panel'),
            joinPanel: document.getElementById('join-panel'),
            nameInput: document.getElementById('player-name-input'),
            serverlessToggle: document.getElementById('serverless-toggle'),
            advancedToggle: document.getElementById('advanced-toggle'),
            advancedPanel: document.getElementById('advanced-panel'),
            providerSelect: document.getElementById('provider-select'),
            createButton: document.getElementById('create-room-button'),
            shareRow: document.getElementById('share-row'),
            shareInvite: document.getElementById('share-copy-invite'),
            shareCode: document.getElementById('share-copy-code'),
            shareQr: document.getElementById('share-show-qr'),
            roomCodeInput: document.getElementById('room-id-input'),
            roomCodeStatus: document.getElementById('room-code-status'),
            joinButton: document.getElementById('join-room-button'),
            discoverButton: document.getElementById('discover-button'),
            refreshButton: document.getElementById('refresh-button'),
            roomList: document.getElementById('room-list'),
            statusChip: document.getElementById('status-chip'),
            connectionStatusText: document.getElementById('connection-status-text'),
            roomCopyButton: document.getElementById('room-copy-button'),
            roomIdValue: document.getElementById('room-id'),
            connectionQuality: document.getElementById('connection-quality'),
            playersCount: document.getElementById('players-count'),
            peerName: document.getElementById('peer-name'),
            playersList: document.getElementById('players-list'),
            leaveButton: document.getElementById('leave-room-button'),
            playersAnnouncer: document.getElementById('players-announcer'),
            statusAnnouncer: document.getElementById('status-announcer')
        }

        let coordinator = null
        let selectedProviderId = 'torrent'

        init()

        async function init() {
            try {
                // Initialize the coordinator
                coordinator = new MultiplayerDemoCoordinator()
                await coordinator.init()

                // Set up event handlers
                coordinator.on('onConnectionStateChange', (state, statusText) => {
                    console.log('Connection state changed:', state, statusText)
                })

                coordinator.on('onPlayerListUpdate', (players) => {
                    console.log('Player list updated:', players.length, 'players')
                })

                coordinator.on('onRoomListUpdate', (rooms) => {
                    console.log('Room list updated:', rooms.length, 'rooms')
                })

                coordinator.on('onError', (error) => {
                    console.error('Coordinator error:', error)
                })

                // Set up UI event listeners
                attachEventListeners()
                switchTab('host')

                // Restore peer name in UI
                const state = coordinator.getState()
                if (elements.peerName && state.currentPeerName) {
                    elements.peerName.textContent = state.currentPeerName
                }

                console.log('Multiplayer demo initialized successfully')
            } catch (error) {
                console.error('Failed to initialize demo:', error)
                showAlert('Failed to initialize multiplayer demo', AlertTypes.ERROR)
            }
        }

        function attachEventListeners() {
            // Tab switching
            elements.hostTab?.addEventListener('click', () => switchTab('host'))
            elements.joinTab?.addEventListener('click', () => switchTab('join'))
            elements.hostTab?.addEventListener('keydown', handleTabKey)
            elements.joinTab?.addEventListener('keydown', handleTabKey)

            // Advanced options
            elements.advancedToggle?.addEventListener('click', toggleAdvanced)
            elements.serverlessToggle?.addEventListener('change', handleServerlessToggle)
            elements.providerSelect?.addEventListener('change', (event) => handleProviderChange(event.target.value))

            // Name input
            elements.nameInput?.addEventListener('input', handleNameInput)
            elements.nameInput?.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    elements.createButton?.click()
                    event.preventDefault()
                }
            })

            // Room code input
            elements.roomCodeInput?.addEventListener('input', (event) => {
                roomCodeManager.handleRoomCodeInput(event, elements.roomCodeStatus)
            })
            elements.roomCodeInput?.addEventListener('paste', (event) => {
                roomCodeManager.handleRoomCodePaste(event, elements.roomCodeInput, elements.roomCodeStatus)
            })
            elements.roomCodeInput?.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    elements.joinButton?.click()
                    event.preventDefault()
                }
            })

            // Escape key for advanced panel
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && elements.advancedPanel && !elements.advancedPanel.hidden) {
                    collapseAdvanced()
                }
            })

            // Room actions
            elements.createButton?.addEventListener('click', () => guardedAction(createRoom))
            elements.joinButton?.addEventListener('click', () => guardedAction(joinRoom))
            elements.leaveButton?.addEventListener('click', () => guardedAction(leaveRoom))

            // Discovery actions
            elements.discoverButton?.addEventListener('click', () => guardedAction(discoverRooms))
            elements.refreshButton?.addEventListener('click', () => refreshRoomList())

            // Share actions
            elements.shareInvite?.addEventListener('click', copyInvite)
            elements.shareCode?.addEventListener('click', copyCode)
            elements.shareQr?.addEventListener('click', showQr)
            elements.roomCopyButton?.addEventListener('click', copyRoomCode)

            // Room list clicks
            elements.roomList?.addEventListener('click', handleRoomListClick)
        }

        // Event handler functions
        function handleTabKey(event) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault()
                event.currentTarget.click()
            }
        }

        function handleNameInput(event) {
            const value = event.target.value.trim()
            coordinator.updatePeerName(value)
        }

        function handleServerlessToggle() {
            const useServerless = elements.serverlessToggle.checked
            if (useServerless) {
                collapseAdvanced()
                handleProviderChange('torrent')
            } else {
                expandAdvanced()
            }
        }

        function handleProviderChange(providerId) {
            selectedProviderId = providerId
            coordinator.updateProvider(providerId)
            if (providerId !== 'torrent') {
                elements.serverlessToggle.checked = false
                expandAdvanced()
            }
        }

        function toggleAdvanced() {
            if (elements.advancedPanel.hidden) {
                expandAdvanced()
            } else {
                collapseAdvanced()
            }
        }

        function expandAdvanced() {
            elements.advancedPanel.hidden = false
            elements.advancedToggle.setAttribute('aria-expanded', 'true')
            elements.advancedToggle.innerHTML = 'Advanced &#9650;'
        }

        function collapseAdvanced() {
            elements.advancedPanel.hidden = true
            elements.advancedToggle.setAttribute('aria-expanded', 'false')
            elements.advancedToggle.innerHTML = 'Advanced &#9660;'
        }

        function switchTab(target) {
            const hostActive = target === 'host'
            elements.hostTab?.classList.toggle('is-active', hostActive)
            elements.joinTab?.classList.toggle('is-active', !hostActive)
            elements.hostTab?.setAttribute('aria-selected', hostActive)
            elements.joinTab?.setAttribute('aria-selected', !hostActive)
            elements.hostPanel?.classList.toggle('is-active', hostActive)
            elements.joinPanel?.classList.toggle('is-active', !hostActive)
            elements.hostPanel?.toggleAttribute('hidden', !hostActive)
            elements.joinPanel?.toggleAttribute('hidden', hostActive)
            if (hostActive) {
                elements.nameInput?.focus({ preventScroll: true })
            } else {
                elements.roomCodeInput?.focus({ preventScroll: true })
            }
        }

        async function guardedAction(action) {
            if (typeof action !== 'function') return
            try {
                await action()
            } catch (error) {
                console.error(error)
                showAlert(error.message || 'Something went wrong', AlertTypes.ERROR)
            }
        }

        async function createRoom() {
            await coordinator.createRoom()
            showShareRow()
        }

        async function joinRoom() {
            const roomCode = elements.roomCodeInput?.value || ''
            await coordinator.joinRoom(roomCode)
            hideShareRow()
        }

        async function leaveRoom() {
            await coordinator.leaveRoom()
            hideShareRow()
        }

        async function discoverRooms() {
            await coordinator.discoverRooms()
        }

        function refreshRoomList() {
            coordinator.refreshRoomList()
        }

        function handleRoomListClick(event) {
            const target = event.target
            if (!(target instanceof HTMLElement)) return
            const container = target.closest('[data-room]')
            if (!container) return
            const roomId = container.getAttribute('data-room')
            if (!roomId) return
            
            elements.roomCodeInput.value = roomCodeManager.formatRoomCode(roomId)
            roomCodeManager.updateRoomCodeStatus(elements.roomCodeStatus, roomCodeManager.isValidRoomCode(roomId))
            roomCodeManager.saveRoomCode(roomId)
            
            if (target.classList.contains('join-room-button') && !target.hasAttribute('disabled')) {
                elements.joinButton?.click()
            }
        }

        function showShareRow() {
            if (!elements.shareRow) return
            elements.shareRow.hidden = false
        }

        function hideShareRow() {
            if (!elements.shareRow) return
            elements.shareRow.hidden = true
        }

        function copyInvite() {
            const roomId = elements.shareRow?.dataset.roomId || elements.roomIdValue?.dataset.roomCode || ''
            if (!roomId) return
            const message = `Join my room with code ${roomCodeManager.formatRoomCode(roomId)} on the DozedEnt demo.`
            copyToClipboard(message, 'Invite copied')
        }

        function copyCode() {
            const roomId = elements.shareRow?.dataset.roomId || elements.roomIdValue?.dataset.roomCode || ''
            if (!roomId) return
            copyToClipboard(roomCodeManager.formatRoomCode(roomId), 'Code copied')
        }

        function showQr() {
            showAlert('QR coming soon. Code copied instead.', AlertTypes.INFO)
            copyCode()
        }

        function copyRoomCode() {
            const roomId = elements.roomIdValue?.dataset.roomCode
            if (!roomId) return
            copyToClipboard(roomCodeManager.formatRoomCode(roomId), 'Room code copied')
        }

        function copyToClipboard(text, successMessage = 'Copied') {
            try {
                navigator.clipboard.writeText(text).then(() => {
                    showAlert(successMessage, AlertTypes.SUCCESS)
                }).catch(() => fallbackCopy(text, successMessage))
            } catch (_) {
                fallbackCopy(text, successMessage)
            }
        }

        function fallbackCopy(text, successMessage) {
            const textarea = document.createElement('textarea')
            textarea.value = text
            textarea.setAttribute('readonly', '')
            textarea.style.position = 'absolute'
            textarea.style.left = '-9999px'
            document.body.appendChild(textarea)
            textarea.select()
            try {
                document.execCommand('copy')
                showAlert(successMessage, AlertTypes.SUCCESS)
            } catch (error) {
                console.error(error)
                showAlert('Unable to copy', AlertTypes.ERROR)
            } finally {
                document.body.removeChild(textarea)
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (coordinator) {
                coordinator.destroy()
            }
        })
    </script>
</body>
</html>
