<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procedural Wolf Animation Demo</title>
    <link rel="stylesheet" href="src/css/procedural-wolf-demo.css">
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <div>Loading Procedural Wolf Animation System...</div>
    </div>

    <div id="error" class="error" style="display: none;">
        <h3>‚ö†Ô∏è Error Loading Demo</h3>
        <p id="errorMessage"></p>
        <button onclick="location.reload()">Reload</button>
    </div>

    <canvas id="gameCanvas" width="1200" height="800" style="display: none;"></canvas>

    <div class="controls" style="display: none;">
        <h3>üê∫ Wolf Controls</h3>
        
        <div class="control-group">
            <label>Wolf Type:</label>
            <select id="wolfType">
                <option value="normal">Normal Wolf</option>
                <option value="alpha">Alpha Wolf</option>
                <option value="scout">Scout Wolf</option>
                <option value="hunter">Hunter Wolf</option>
                <option value="omega">Omega Wolf</option>
            </select>
        </div>

        <div class="control-group">
            <label>Behavior:</label>
            <select id="wolfBehavior">
                <option value="auto">Auto (AI Controlled)</option>
                <option value="resting">Resting</option>
                <option value="patrolling">Patrolling</option>
                <option value="hunting">Hunting</option>
                <option value="stalking">Stalking</option>
                <option value="chasing">Chasing</option>
                <option value="defending">Defending</option>
                <option value="howling">Howling</option>
                <option value="playing">Playing</option>
            </select>
        </div>

        <div class="control-group">
            <button onclick="addWolf()">Add Wolf</button>
            <button onclick="addWolfPack()">Add Pack (5)</button>
            <button onclick="clearWolves()" class="danger">Clear All</button>
        </div>

        <div class="control-group">
            <label>Environment:</label>
            <button onclick="setEnvironment('forest')">Forest</button>
            <button onclick="setEnvironment('plains')">Plains</button>
            <button onclick="setEnvironment('winter')">Winter</button>
        </div>

        <div class="control-group">
            <label>Wind Strength: <span id="windValue">0</span></label>
            <input type="range" id="windStrength" min="0" max="1" step="0.1" value="0" oninput="updateWind()">
        </div>

        <div class="control-group">
            <label>
                <input type="checkbox" id="enablePhysics" checked onchange="togglePhysics()">
                Realistic Physics
            </label>
            <label>
                <input type="checkbox" id="enableBehavior" checked onchange="toggleBehavior()">
                AI Behavior
            </label>
            <label>
                <input type="checkbox" id="showDebug" onchange="toggleDebug()">
                Debug Info
            </label>
        </div>
    </div>

    <div class="stats" style="display: none;">
        <h3>üìä Performance</h3>
        <div class="stat-item">
            <span>FPS:</span>
            <span id="fpsCounter">60</span>
        </div>
        <div class="stat-item">
            <span>Frame Time:</span>
            <span id="frameTime">16ms</span>
        </div>
        <div class="stat-item">
            <span>Wolves:</span>
            <span id="wolfCount">0</span>
        </div>
        <div class="stat-item">
            <span>Animation:</span>
            <span id="animTime">0ms</span>
        </div>
        <div class="stat-item">
            <span>Physics:</span>
            <span id="physicsTime">0ms</span>
        </div>
        <div class="stat-item">
            <span>Render:</span>
            <span id="renderTime">0ms</span>
        </div>
    </div>

    <div class="wolf-list" style="display: none;">
        <h4>üê∫ Active Wolves</h4>
        <div id="wolfListContent"></div>
    </div>

    <div class="instructions" style="display: none;">
        <h4>üéÆ Controls</h4>
        <ul>
            <li><strong>Click</strong> - Add scent at cursor</li>
            <li><strong>Space</strong> - Pause/Resume</li>
            <li><strong>R</strong> - Reset camera</li>
            <li><strong>1-5</strong> - Trigger pack behaviors</li>
            <li><strong>Mouse Wheel</strong> - Zoom</li>
            <li><strong>Arrow Keys</strong> - Pan camera</li>
        </ul>
    </div>

    <script type="module">
        // Import the procedural wolf system
        import ProceduralWolfSystem from './src/animation/procedural-wolf-integration.js';
        import { EnhancedWolfBehavior } from './src/animation/wolf-procedural.js';
        import { getWolfBehaviorName } from './src/animation/enhanced-wolf-procedural.js';

        // Global variables
        let wolfSystem = null;
        let canvas = null;
        let ctx = null;
        let camera = { x: 0, y: 0, zoom: 1 };
        let lastTime = 0;
        let isPaused = false;
        let frameCount = 0;
        let lastFpsTime = 0;
        let currentFps = 60;

        // Environment state
        let environment = {
            type: 'forest',
            wind: { x: 0, y: 0, strength: 0 },
            weather: { rain: 0, snow: 0, temperature: 0.5 },
            surface: { type: 'grass', friction: 1.0, slope: 0 },
            scents: []
        };

        // Initialize the demo
        async function init() {
            try {
                console.log('üöÄ Initializing Procedural Wolf Demo');
                
                // Get canvas and context
                canvas = document.getElementById('gameCanvas');
                ctx = canvas.getContext('2d');
                
                // Initialize wolf system
                wolfSystem = new ProceduralWolfSystem({
                    enablePhysics: true,
                    enableRealisticBehavior: true,
                    enablePackDynamics: true,
                    enableEnvironmentalEffects: true,
                    maxWolves: 20
                });

                // Setup event listeners
                setupEventListeners();
                
                // Hide loading, show interface
                document.getElementById('loading').style.display = 'none';
                canvas.style.display = 'block';
                document.querySelector('.controls').style.display = 'block';
                document.querySelector('.stats').style.display = 'block';
                document.querySelector('.wolf-list').style.display = 'block';
                document.querySelector('.instructions').style.display = 'block';

                // Add initial wolves
                addInitialWolves();

                // Start game loop
                requestAnimationFrame(gameLoop);
                
                console.log('‚úÖ Demo initialized successfully');
                
            } catch (error) {
                console.error('‚ùå Failed to initialize demo:', error);
                showError('Failed to initialize demo: ' + error.message);
            }
        }

        // Add initial wolves for demonstration
        function addInitialWolves() {
            // Add alpha wolf
            const alpha = wolfSystem.createWolf('alpha1', {
                type: 'alpha',
                position: { x: 600, y: 400 },
                packRank: 0.9,
                personality: {
                    confidence: 0.9,
                    aggression: 0.7,
                    playfulness: 0.3,
                    curiosity: 0.6
                }
            });

            // Add scout wolf
            const scout = wolfSystem.createWolf('scout1', {
                type: 'scout',
                position: { x: 550, y: 420 },
                packRank: 0.6,
                personality: {
                    confidence: 0.6,
                    aggression: 0.4,
                    playfulness: 0.5,
                    curiosity: 0.9
                }
            });

            // Add normal wolf
            const normal = wolfSystem.createWolf('normal1', {
                type: 'normal',
                position: { x: 650, y: 380 },
                packRank: 0.4,
                personality: {
                    confidence: 0.5,
                    aggression: 0.5,
                    playfulness: 0.7,
                    curiosity: 0.5
                }
            });

            console.log('üê∫ Added initial wolf pack');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Mouse events
            canvas.addEventListener('click', handleCanvasClick);
            canvas.addEventListener('wheel', handleWheel);
            canvas.addEventListener('mousemove', handleMouseMove);

            // Keyboard events
            document.addEventListener('keydown', handleKeyDown);
            
            // Window resize
            window.addEventListener('resize', handleResize);
        }

        // Handle canvas click (add scent)
        function handleCanvasClick(event) {
            const rect = canvas.getBoundingClientRect();
            const x = (event.clientX - rect.left) + camera.x;
            const y = (event.clientY - rect.top) + camera.y;

            // Add scent at click location
            environment.scents.push({
                position: { x, y },
                type: 'prey',
                strength: 0.8,
                age: 0,
                maxAge: 10
            });

            console.log(`ü¶å Added prey scent at (${x.toFixed(0)}, ${y.toFixed(0)})`);
        }

        // Handle mouse wheel (zoom)
        function handleWheel(event) {
            event.preventDefault();
            const zoomFactor = event.deltaY > 0 ? 0.9 : 1.1;
            camera.zoom = Math.max(0.5, Math.min(3, camera.zoom * zoomFactor));
        }

        // Handle mouse movement
        function handleMouseMove(event) {
            // Could be used for mouse-based camera control
        }

        // Handle keyboard input
        function handleKeyDown(event) {
            switch(event.code) {
                case 'Space':
                    event.preventDefault();
                    isPaused = !isPaused;
                    console.log(isPaused ? '‚è∏Ô∏è Paused' : '‚ñ∂Ô∏è Resumed');
                    break;
                case 'KeyR':
                    camera.x = 0;
                    camera.y = 0;
                    camera.zoom = 1;
                    break;
                case 'ArrowLeft':
                    camera.x -= 50;
                    break;
                case 'ArrowRight':
                    camera.x += 50;
                    break;
                case 'ArrowUp':
                    camera.y -= 50;
                    break;
                case 'ArrowDown':
                    camera.y += 50;
                    break;
                case 'Digit1':
                    triggerPackBehavior('hunting');
                    break;
                case 'Digit2':
                    triggerPackBehavior('defending');
                    break;
                case 'Digit3':
                    triggerPackBehavior('howling');
                    break;
                case 'Digit4':
                    triggerPackBehavior('playing');
                    break;
                case 'Digit5':
                    triggerPackBehavior('resting');
                    break;
            }
        }

        // Handle window resize
        function handleResize() {
            // Could adjust canvas size here if needed
        }

        // Main game loop
        function gameLoop(currentTime) {
            const deltaTime = (currentTime - lastTime) / 1000;
            lastTime = currentTime;

            if (!isPaused && deltaTime < 0.1) { // Cap delta time to prevent large jumps
                update(deltaTime);
            }
            
            render();
            updateUI();

            // FPS calculation
            frameCount++;
            if (currentTime - lastFpsTime >= 1000) {
                currentFps = Math.round(frameCount * 1000 / (currentTime - lastFpsTime));
                frameCount = 0;
                lastFpsTime = currentTime;
            }

            requestAnimationFrame(gameLoop);
        }

        // Update game state
        function update(deltaTime) {
            // Update scents (decay over time)
            environment.scents = environment.scents.filter(scent => {
                scent.age += deltaTime;
                scent.strength *= 0.99; // Gradual decay
                return scent.age < scent.maxAge && scent.strength > 0.1;
            });

            // Update wolf system
            wolfSystem.update(deltaTime, environment);
        }

        // Render everything
        function render() {
            // Clear canvas
            ctx.fillStyle = '#87CEEB';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw ground gradient
            const gradient = ctx.createLinearGradient(0, canvas.height * 0.7, 0, canvas.height);
            gradient.addColorStop(0, '#98FB98');
            gradient.addColorStop(1, '#228B22');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, canvas.height * 0.7, canvas.width, canvas.height * 0.3);

            // Apply camera transform
            ctx.save();
            ctx.scale(camera.zoom, camera.zoom);
            ctx.translate(-camera.x, -camera.y);

            // Draw environment
            drawEnvironment();

            // Draw wolves
            wolfSystem.render(ctx, camera);

            ctx.restore();

            // Draw UI overlays
            if (isPaused) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'white';
                ctx.font = '48px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('PAUSED', canvas.width / 2, canvas.height / 2);
                ctx.textAlign = 'left';
            }
        }

        // Draw environment elements
        function drawEnvironment() {
            // Draw scents
            environment.scents.forEach(scent => {
                const alpha = scent.strength * 0.5;
                const radius = 20 + scent.strength * 30;
                
                ctx.save();
                ctx.globalAlpha = alpha;
                ctx.fillStyle = scent.type === 'prey' ? '#90EE90' : '#FFB6C1';
                ctx.beginPath();
                ctx.arc(scent.position.x, scent.position.y, radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            });

            // Draw wind visualization
            if (environment.wind.strength > 0.1) {
                ctx.save();
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 2;
                
                for (let x = 0; x < canvas.width + camera.x; x += 100) {
                    for (let y = 0; y < canvas.height + camera.y; y += 100) {
                        const windX = environment.wind.x * environment.wind.strength * 50;
                        const windY = environment.wind.y * environment.wind.strength * 50;
                        
                        ctx.beginPath();
                        ctx.moveTo(x + camera.x, y + camera.y);
                        ctx.lineTo(x + camera.x + windX, y + camera.y + windY);
                        ctx.stroke();
                    }
                }
                ctx.restore();
            }
        }

        // Update UI elements
        function updateUI() {
            // Performance stats
            const status = wolfSystem.getStatus();
            document.getElementById('fpsCounter').textContent = currentFps;
            document.getElementById('frameTime').textContent = status.performance.frameTime.toFixed(1) + 'ms';
            document.getElementById('wolfCount').textContent = status.wolves;
            document.getElementById('animTime').textContent = status.performance.animationTime.toFixed(1) + 'ms';
            document.getElementById('physicsTime').textContent = status.performance.physicsTime.toFixed(1) + 'ms';
            document.getElementById('renderTime').textContent = status.performance.renderTime.toFixed(1) + 'ms';

            // Wolf list
            updateWolfList();
        }

        // Update wolf list display
        function updateWolfList() {
            const wolves = wolfSystem.getAllWolves();
            const listContent = document.getElementById('wolfListContent');
            
            listContent.innerHTML = wolves.map(wolf => {
                const status = wolf.getStatus();
                const isAlpha = wolf.type === 'alpha' || wolf.animComponent.packRank > 0.8;
                return `
                    <div class="wolf-item ${isAlpha ? 'alpha' : ''}">
                        <strong>${status.id}</strong> (${status.type})<br>
                        Behavior: ${status.behavior}<br>
                        Health: ${status.health.toFixed(0)}/100<br>
                        Rank: ${status.packRank.toFixed(2)}
                    </div>
                `;
            }).join('');
        }

        // Control functions (called from HTML)
        window.addWolf = function() {
            const type = document.getElementById('wolfType').value;
            const behavior = document.getElementById('wolfBehavior').value;
            
            const wolfId = `wolf_${Date.now()}`;
            const position = {
                x: 400 + Math.random() * 400,
                y: 300 + Math.random() * 200
            };

            const wolf = wolfSystem.createWolf(wolfId, {
                type,
                position,
                packRank: Math.random(),
                behavior: behavior !== 'auto' ? EnhancedWolfBehavior[behavior.charAt(0).toUpperCase() + behavior.slice(1)] : undefined
            });

            if (wolf) {
                console.log(`üê∫ Added ${type} wolf: ${wolfId}`);
            }
        };

        window.addWolfPack = function() {
            const types = ['alpha', 'scout', 'normal', 'normal', 'omega'];
            const centerX = 600;
            const centerY = 400;

            types.forEach((type, index) => {
                const angle = (index / types.length) * Math.PI * 2;
                const radius = 50;
                const position = {
                    x: centerX + Math.cos(angle) * radius,
                    y: centerY + Math.sin(angle) * radius
                };

                const packRank = type === 'alpha' ? 0.9 :
                               type === 'scout' ? 0.7 :
                               type === 'omega' ? 0.1 :
                               0.3 + Math.random() * 0.4;

                wolfSystem.createWolf(`pack_${Date.now()}_${index}`, {
                    type,
                    position,
                    packRank
                });
            });

            console.log('üê∫ Added wolf pack (5 wolves)');
        };

        window.clearWolves = function() {
            const wolves = wolfSystem.getAllWolves();
            wolves.forEach(wolf => wolfSystem.removeWolf(wolf.id));
            console.log('üßπ Cleared all wolves');
        };

        window.setEnvironment = function(envType) {
            switch(envType) {
                case 'forest':
                    environment.surface.type = 'grass';
                    environment.weather.temperature = 0.6;
                    environment.wind.strength = 0.2;
                    break;
                case 'plains':
                    environment.surface.type = 'grass';
                    environment.weather.temperature = 0.7;
                    environment.wind.strength = 0.5;
                    break;
                case 'winter':
                    environment.surface.type = 'snow';
                    environment.weather.temperature = 0.2;
                    environment.weather.snow = 0.3;
                    environment.wind.strength = 0.7;
                    break;
            }
            console.log(`üåç Environment set to: ${envType}`);
        };

        window.updateWind = function() {
            const strength = parseFloat(document.getElementById('windStrength').value);
            environment.wind.strength = strength;
            environment.wind.x = Math.cos(Date.now() * 0.001) * strength;
            environment.wind.y = Math.sin(Date.now() * 0.001) * strength;
            document.getElementById('windValue').textContent = strength.toFixed(1);
        };

        window.togglePhysics = function() {
            const enabled = document.getElementById('enablePhysics').checked;
            wolfSystem.config.enablePhysics = enabled;
            console.log(`üîß Physics ${enabled ? 'enabled' : 'disabled'}`);
        };

        window.toggleBehavior = function() {
            const enabled = document.getElementById('enableBehavior').checked;
            wolfSystem.config.enableRealisticBehavior = enabled;
            console.log(`üß† AI Behavior ${enabled ? 'enabled' : 'disabled'}`);
        };

        window.toggleDebug = function() {
            const enabled = document.getElementById('showDebug').checked;
            wolfSystem.config.showDebugInfo = enabled;
            console.log(`üêõ Debug info ${enabled ? 'enabled' : 'disabled'}`);
        };

        window.triggerPackBehavior = function(behavior) {
            const wolves = wolfSystem.getAllWolves();
            const behaviorEnum = EnhancedWolfBehavior[behavior.charAt(0).toUpperCase() + behavior.slice(1)];
            
            wolves.forEach(wolf => {
                wolf.behavior = behaviorEnum;
                wolf.animComponent.behavior = behaviorEnum;
            });

            console.log(`üê∫ Triggered pack behavior: ${behavior}`);
        };

        // Show error message
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        // Start the demo
        init().catch(error => {
            console.error('Fatal error:', error);
            showError('Fatal error: ' + error.message);
        });
    </script>
</body>
</html>
