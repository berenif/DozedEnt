name: Deploy DozedEnt to GitHub Pages (Public Folder) (DEPRECATED - Use deploy-build-only.yml)

on:
  # DISABLED - This workflow is deprecated
  # Use deploy-build-only.yml instead
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
      
      - name: Install PowerShell Core
        run: |
          # Install PowerShell Core on Ubuntu
          wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb
          sudo dpkg -i packages-microsoft-prod.deb
          sudo apt-get update
          sudo apt-get install -y powershell
          pwsh --version
      
      - name: Setup Emscripten SDK
        run: |
          # Clone and setup Emscripten SDK
          if [ ! -d "emsdk" ]; then
            git clone https://github.com/emscripten-core/emsdk.git
          fi
          cd emsdk
          ./emsdk install latest
          ./emsdk activate latest
          source ./emsdk_env.sh
          cd ..
          echo "Emscripten version:"
          emcc --version
      
      - name: Generate balance data
        run: npm run balance:gen
        
      - name: Build WASM modules
        run: |
          # Source emsdk environment
          source ./emsdk/emsdk_env.sh
          # Build all WASM modules
          npm run wasm:build:all
          echo "WASM files built:"
          ls -la *.wasm || echo "No WASM files in root"
          ls -la dist/wasm/ || echo "No WASM files in dist/wasm"
      
      - name: Build project
        run: |
          # Build the complete project
          npm run build:all
          echo "Build completed. Dist folder contents:"
          ls -la dist/ || echo "No dist folder found"
      
      - name: Build public folder for deployment
        run: |
          # Run the public folder build script
          node tools/scripts/build-public.js
          echo "Public folder built. Contents:"
          ls -la public/ || echo "No public folder found"
      
      - name: Validate public folder structure
        run: |
          echo "ğŸ” Validating public folder structure..."
          
          # Check essential files
          test -f public/index.html && echo "âœ… public/index.html exists" || echo "âŒ public/index.html missing"
          test -f public/game.wasm && echo "âœ… public/game.wasm exists" || echo "âŒ public/game.wasm missing"
          test -f public/game-host.wasm && echo "âœ… public/game-host.wasm exists" || echo "âŒ public/game-host.wasm missing"
          test -f public/favicon.ico && echo "âœ… public/favicon.ico exists" || echo "âŒ public/favicon.ico missing"
          test -f public/_config.yml && echo "âœ… public/_config.yml exists" || echo "âŒ public/_config.yml missing"
          test -f public/.nojekyll && echo "âœ… public/.nojekyll exists" || echo "âŒ public/.nojekyll missing"
          
          # Check essential directories
          test -d public/dist && echo "âœ… public/dist directory exists" || echo "âŒ public/dist directory missing"
          test -d public/core && echo "âœ… public/core directory exists" || echo "âŒ public/core directory missing"
          test -d public/animations && echo "âœ… public/animations directory exists" || echo "âŒ public/animations directory missing"
          test -d public/assets && echo "âœ… public/assets directory exists" || echo "âŒ public/assets directory missing"
          test -d public/images && echo "âœ… public/images directory exists" || echo "âŒ public/images directory missing"
          
          # Check file sizes
          echo "ğŸ“Š File sizes:"
          du -h public/*.wasm || echo "No WASM files found"
          du -h public/dist/ || echo "No dist folder found"
          
          # Run comprehensive validation
          npm run validate:public-deployment || echo "Validation script not found, continuing..."
      
      - name: Run deployment validation
        run: |
          echo "ğŸš€ Running comprehensive deployment validation..."
          
          # Check if all required files are present and not empty
          for file in public/index.html public/game.wasm public/game-host.wasm public/favicon.ico; do
            if [ -f "$file" ] && [ -s "$file" ]; then
              echo "âœ… $file exists and is not empty"
            else
              echo "âŒ $file missing or empty"
              exit 1
            fi
          done
          
          # Check if dist folder has content
          if [ -d "public/dist" ] && [ "$(ls -A public/dist)" ]; then
            echo "âœ… public/dist has content"
          else
            echo "âŒ public/dist is empty or missing"
            exit 1
          fi
          
          echo "âœ… All validation checks passed!"
      
      - name: Setup Pages
        uses: actions/configure-pages@v5
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './public'

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: Output deployment information
        run: |
          echo "ğŸš€ Deployment completed successfully!"
          echo "ğŸŒ Site URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ® Game available at: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“ Assets served from: ${{ steps.deployment.outputs.page_url }}/dist/"
          echo "ğŸ”§ WASM files available at: ${{ steps.deployment.outputs.page_url }}/*.wasm"
          echo "ğŸŒ Core modules available at: ${{ steps.deployment.outputs.page_url }}/core/"
          echo "ğŸ­ Animation modules available at: ${{ steps.deployment.outputs.page_url }}/animations/"
          echo "ğŸµ Assets available at: ${{ steps.deployment.outputs.page_url }}/assets/"
          echo ""
          echo "ğŸ“‹ Deployment Summary:"
          echo "  - Complete /dist folder deployed to /dist/"
          echo "  - WASM modules deployed to root and /wasm/"
          echo "  - Core networking modules deployed to /core/"
          echo "  - Animation modules deployed to /animations/"
          echo "  - All assets and data deployed to respective folders"
          echo "  - Source files available at /src/ for debugging"
          echo "  - Jekyll configuration optimized for GitHub Pages"
