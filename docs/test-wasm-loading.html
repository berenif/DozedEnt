<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM Loading Test</title>
    <style>
        body {
            font-family: monospace;
            margin: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .log {
            background: #2a2a2a;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 3px solid #4CAF50;
        }
        .error {
            border-left-color: #f44336;
        }
        .warning {
            border-left-color: #ff9800;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>WASM Loading Test</h1>
    <p>This page tests the WASM lazy loader to diagnose loading issues.</p>
    
    <div>
        <button id="testLazyLoader">Test Lazy Loader</button>
        <button id="testDirectLoad">Test Direct Load</button>
        <button id="clearLogs">Clear Logs</button>
    </div>
    
    <div id="logs"></div>

    <script type="module">
        import { globalWasmLoader } from './js/src/utils/wasm-lazy-loader.js';
        
        const logsDiv = document.getElementById('logs');
        
        function addLog(message, type = 'log') {
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(logDiv);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        function clearLogs() {
            logsDiv.innerHTML = '';
        }
        
        // Override console methods to capture logs
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        console.log = (...args) => {
            originalLog(...args);
            addLog(args.join(' '), 'log');
        };
        
        console.warn = (...args) => {
            originalWarn(...args);
            addLog(args.join(' '), 'warning');
        };
        
        console.error = (...args) => {
            originalError(...args);
            addLog(args.join(' '), 'error');
        };
        
        document.getElementById('testLazyLoader').addEventListener('click', async () => {
            addLog('Starting lazy loader test...', 'log');
            try {
                const instance = await globalWasmLoader.loadModule('game', {
                    imports: {},
                    onProgress: (progress) => {
                        addLog(`Progress: ${(progress.progress * 100).toFixed(1)}%`, 'log');
                    }
                });
                
                if (instance && instance.exports) {
                    addLog(`✅ Lazy loader success! Exports: ${Object.keys(instance.exports).length} functions`, 'log');
                    addLog(`Available exports: ${Object.keys(instance.exports).slice(0, 10).join(', ')}...`, 'log');
                } else {
                    addLog('❌ Lazy loader returned invalid instance', 'error');
                }
            } catch (error) {
                addLog(`❌ Lazy loader failed: ${error.message}`, 'error');
                addLog(`Error details: ${error.stack}`, 'error');
            }
        });
        
        document.getElementById('testDirectLoad').addEventListener('click', async () => {
            addLog('Starting direct load test...', 'log');
            try {
                const response = await fetch('game.wasm');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                addLog(`✅ Direct fetch success! Size: ${arrayBuffer.byteLength} bytes`, 'log');
                
                // Try to compile
                const module = await WebAssembly.compile(arrayBuffer);
                addLog(`✅ WASM compilation success!`, 'log');
                
                // Try to instantiate
                const instance = await WebAssembly.instantiate(module, {
                    env: {
                        memory: new WebAssembly.Memory({ initial: 16 }),
                        abort: () => { throw new Error('WASM abort'); }
                    }
                });
                
                addLog(`✅ WASM instantiation success! Exports: ${Object.keys(instance.exports).length}`, 'log');
                
            } catch (error) {
                addLog(`❌ Direct load failed: ${error.message}`, 'error');
                addLog(`Error details: ${error.stack}`, 'error');
            }
        });
        
        document.getElementById('clearLogs').addEventListener('click', clearLogs);
        
        addLog('WASM Loading Test initialized', 'log');
        addLog(`Current URL: ${window.location.href}`, 'log');
        addLog(`Base URI: ${document.baseURI}`, 'log');
    </script>
</body>
</html>
