class e{constructor(e,t,a={}){this.x=e,this.y=t,this.vx=a.vx||0,this.vy=a.vy||0,this.ax=a.ax||0,this.ay=a.ay||0,this.life=a.life||1,this.maxLife=a.life||1,this.size=a.size||4,this.sizeDecay=a.sizeDecay||.98,this.color=a.color||{r:255,g:255,b:255},this.alpha=a.alpha||1,this.alphaDecay=a.alphaDecay||.98,this.rotation=a.rotation||0,this.rotationSpeed=a.rotationSpeed||0,this.trail=a.trail||!1,this.trailPositions=[],this.blendMode=a.blendMode||"source-over",this.glow=a.glow||!1,this.glowSize=a.glowSize||2,this.shape=a.shape||"circle",this.friction=a.friction||1,this.bounce=a.bounce||0,this.gravity=a.gravity||0,this.turbulence=a.turbulence||0,this.scaleWithVelocity=a.scaleWithVelocity||!1}update(e){if(this.vx*=this.friction,this.vy*=this.friction,this.vx+=this.ax*e,this.vy+=(this.ay+this.gravity)*e,this.turbulence>0){let e=Number((globalThis.runSeedForVisuals??1n)%2147483647n);e=48271*e%2147483647;const t=e/2147483647-.5;e=48271*e%2147483647;const a=e/2147483647-.5;this.vx+=t*this.turbulence,this.vy+=a*this.turbulence}return this.x+=this.vx*e,this.y+=this.vy*e,this.rotation+=this.rotationSpeed*e,this.trail&&(this.trailPositions.push({x:this.x,y:this.y,alpha:this.alpha}),this.trailPositions.length>10&&this.trailPositions.shift()),this.life-=e,this.size*=this.sizeDecay,this.alpha*=this.alphaDecay,this.bounce>0&&((this.x<0||this.x>1280)&&(this.vx*=-this.bounce,this.x=Math.max(0,Math.min(1280,this.x))),(this.y<0||this.y>720)&&(this.vy*=-this.bounce,this.y=Math.max(0,Math.min(720,this.y)))),this.life>0&&this.alpha>.01&&this.size>.1}render(e){if(e.save(),e.globalCompositeOperation=this.blendMode,e.globalAlpha=this.alpha,this.trail&&this.trailPositions.length>1&&(e.strokeStyle=`rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${.5*this.alpha})`,e.lineWidth=.5*this.size,e.lineCap="round",e.beginPath(),this.trailPositions.forEach((t,a)=>{0===a?e.moveTo(t.x,t.y):e.lineTo(t.x,t.y)}),e.stroke()),this.glow){const t=e.createRadialGradient(this.x,this.y,0,this.x,this.y,this.size*this.glowSize);t.addColorStop(0,`rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${this.alpha})`),t.addColorStop(1,`rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, 0)`),e.fillStyle=t,e.beginPath(),e.arc(this.x,this.y,this.size*this.glowSize,0,2*Math.PI),e.fill()}e.translate(this.x,this.y),e.rotate(this.rotation);let t=this.size;if(this.scaleWithVelocity){t*=1+.1*Math.sqrt(this.vx*this.vx+this.vy*this.vy)}switch(e.fillStyle=`rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${this.alpha})`,this.shape){case"square":e.fillRect(-t/2,-t/2,t,t);break;case"star":this.drawStar(e,0,0,5,t,.5*t);break;case"triangle":e.beginPath(),e.moveTo(0,-t),e.lineTo(.866*-t,.5*t),e.lineTo(.866*t,.5*t),e.closePath(),e.fill();break;default:e.beginPath(),e.arc(0,0,t,0,2*Math.PI),e.fill()}e.restore()}drawStar(e,t,a,i,o,s){let l,n,r=Math.PI/2*3;const h=Math.PI/i;e.beginPath(),e.moveTo(t,a-o);for(let c=0;c<i;c++)l=t+Math.cos(r)*o,n=a+Math.sin(r)*o,e.lineTo(l,n),r+=h,l=t+Math.cos(r)*s,n=a+Math.sin(r)*s,e.lineTo(l,n),r+=h;e.lineTo(t,a-o),e.closePath(),e.fill()}}class t{constructor(){this.particles=[],this.emitters=[]}update(e){this.particles=this.particles.filter(t=>t.update(e)),this.emitters=this.emitters.filter(t=>(t.update(e),t.active))}render(e){const t={};this.particles.forEach(e=>{t[e.blendMode]||(t[e.blendMode]=[]),t[e.blendMode].push(e)});for(const[,a]of Object.entries(t))a.forEach(t=>t.render(e))}addParticle(e){this.particles.push(e)}addEmitter(e){this.emitters.push(e),e.system=this}emit(t,a,i={}){const o=Math.max(1,Math.round((i.emitRate||4)/60)),s=i.emitAngle&&"number"==typeof i.emitAngle.min?i.emitAngle.min:0,l=i.emitAngle&&"number"==typeof i.emitAngle.max?i.emitAngle.max:2*Math.PI,n=i.particleSpeed&&"number"==typeof i.particleSpeed.min?i.particleSpeed.min:20,r=i.particleSpeed&&"number"==typeof i.particleSpeed.max?i.particleSpeed.max:60,h=i.particleSize&&"number"==typeof i.particleSize.min?i.particleSize.min:2,c=i.particleSize&&"number"==typeof i.particleSize.max?i.particleSize.max:5,d="number"==typeof i.particleLife?Math.max(.05,i.particleLife/1e3):.4;let m={r:200,g:200,b:200},f=.6;if("string"==typeof i.particleColor){const e=i.particleColor.match(/rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*([0-9.]+))?\)/i);e&&(m={r:Number(e[1]),g:Number(e[2]),b:Number(e[3])},f=null!=e[4]?Number(e[4]):1)}for(let p=0;p<o;p++){seed=1664525*seed+1013904223>>>0;const o=seed/4294967296;seed=1664525*seed+1013904223>>>0;const p=seed/4294967296;seed=1664525*seed+1013904223>>>0;const u=s+o*(l-s),y=n+p*(r-n),g=h+seed/4294967296*(c-h);this.addParticle(new e(t,a,{vx:Math.cos(u)*y,vy:Math.sin(u)*y,color:m,size:g,life:d,alpha:f,gravity:"number"==typeof i.gravity?i.gravity:0,alphaDecay:.96,sizeDecay:i.expanding?1.02:.98,glow:!!i.expanding,blendMode:i.expanding?"screen":"source-over"}))}}createBloodSplatter(t,a,i=null){let o=Number((globalThis.runSeedForVisuals??1n)%0xffffffffn)>>>0;const s=15+(o=1664525*o+1013904223>>>0,o/4294967296*10);for(let l=0;l<s;l++){o=1664525*o+1013904223>>>0;const s=o/4294967296;o=1664525*o+1013904223>>>0;const l=o/4294967296;o=1664525*o+1013904223>>>0;const n=i?i+(s-.5)*Math.PI*.5:s*Math.PI*2,r=150*(.5+.5*l),h=2+4*(o/4294967296);this.addParticle(new e(t,a,{vx:Math.cos(n)*r,vy:Math.sin(n)*r,color:{r:180+Math.floor(40*(o=1664525*o+1013904223>>>0,o/4294967296)),g:0,b:0},size:h,life:.5+.5*(o=1664525*o+1013904223>>>0,o/4294967296),gravity:300,friction:.95,bounce:.3,alphaDecay:.95,sizeDecay:.98,trail:h>3,blendMode:"multiply"}))}for(let i=0;i<5;i++)this.addParticle(new e(t,a,{vx:50*(Math.random()-.5),vy:50*(Math.random()-.5),color:{r:150,g:0,b:0},size:15+10*Math.random(),life:.8,alpha:.3,alphaDecay:.96,sizeDecay:1.01,blendMode:"multiply"}))}createHitSpark(t,a,i={r:255,g:200,b:100}){let o=Number((globalThis.runSeedForVisuals??1n)%0xffffffffn)>>>0;const s=8+8*(o=1664525*o+1013904223>>>0,o/4294967296);for(let l=0;l<s;l++){o=1664525*o+1013904223>>>0;const n=2*Math.PI*l/s+o/4294967296*.5;o=1664525*o+1013904223>>>0;const r=200+o/4294967296*150;this.addParticle(new e(t,a,{vx:Math.cos(n)*r,vy:Math.sin(n)*r,color:i,size:2+3*(o=1664525*o+1013904223>>>0,o/4294967296),life:.2+.3*(o=1664525*o+1013904223>>>0,o/4294967296),alphaDecay:.92,sizeDecay:.95,glow:!0,glowSize:3,shape:"star",blendMode:"screen",trail:!0}))}this.addParticle(new e(t,a,{color:{r:255,g:255,b:255},size:30,life:.1,alpha:.8,alphaDecay:.85,sizeDecay:1.15,glow:!0,glowSize:2,blendMode:"screen"}))}createDustCloud(t,a,i=30){const o=10+10*Math.random();for(let s=0;s<o;s++){const o=Math.random()*Math.PI*2,s=Math.random()*i,l=t+Math.cos(o)*s,n=a+Math.sin(o)*s;this.addParticle(new e(l,n,{vx:30*(Math.random()-.5),vy:50*-Math.random()-20,color:{r:150,g:130,b:100},size:10+15*Math.random(),life:.8+.4*Math.random(),alpha:.4,alphaDecay:.97,sizeDecay:1.01,turbulence:5,blendMode:"multiply"}))}}createRollDust(t,a,i){for(let o=0;o<5;o++){const s=10*(o-2.5);this.addParticle(new e(t-20*Math.cos(i),a-20*Math.sin(i)+s,{vx:50*-Math.cos(i)+20*(Math.random()-.5),vy:50*-Math.sin(i)+20*(Math.random()-.5),color:{r:180,g:160,b:140},size:8+4*Math.random(),life:.4,alpha:.5,alphaDecay:.95,sizeDecay:1.02,blendMode:"multiply"}))}}createBlockSpark(t,a,i){for(let o=0;o<12;o++){const o=i+(Math.random()-.5)*Math.PI*.3,s=250+150*Math.random();this.addParticle(new e(t,a,{vx:Math.cos(o)*s,vy:Math.sin(o)*s,color:{r:255,g:230,b:150},size:1+2*Math.random(),life:.3,alphaDecay:.9,friction:.92,glow:!0,glowSize:4,shape:Math.random()>.5?"star":"circle",blendMode:"screen",trail:!0,gravity:100}))}this.addParticle(new e(t,a,{color:{r:255,g:255,b:200},size:5,life:.2,alpha:.6,alphaDecay:.85,sizeDecay:1.25,shape:"circle",blendMode:"screen",glow:!0,glowSize:3}))}createPerfectParryFlash(t,a){this.addParticle(new e(t,a,{color:{r:100,g:200,b:255},size:100,life:.3,alpha:.8,alphaDecay:.9,sizeDecay:1.08,glow:!0,glowSize:2,blendMode:"screen"}));for(let i=0;i<16;i++){const o=2*Math.PI*i/16,s=300;this.addParticle(new e(t,a,{vx:Math.cos(o)*s,vy:Math.sin(o)*s,color:{r:150,g:200,b:255},size:4,life:.5,alphaDecay:.94,friction:.9,glow:!0,glowSize:3,shape:"star",blendMode:"screen",trail:!0}))}}createEnemyDeathExplosion(t,a){for(let i=0;i<30;i++){const i=Math.random()*Math.PI*2,o=100+200*Math.random();this.addParticle(new e(t,a,{vx:Math.cos(i)*o,vy:Math.sin(i)*o,color:{r:255,g:100+100*Math.random(),b:100*Math.random()},size:3+5*Math.random(),life:.5+.5*Math.random(),gravity:200,friction:.94,alphaDecay:.95,sizeDecay:.97,glow:!0,glowSize:2,blendMode:"screen"}))}for(let i=0;i<8;i++)this.addParticle(new e(t,a,{vx:50*(Math.random()-.5),vy:100*-Math.random()-50,color:{r:80,g:80,b:80},size:20+20*Math.random(),life:1,alpha:.5,alphaDecay:.97,sizeDecay:1.02,blendMode:"multiply"}))}createFootstep(t,a,i=1){for(let o=0;o<3;o++)this.addParticle(new e(t+10*(Math.random()-.5),a+5*(Math.random()-.5),{vx:20*(Math.random()-.5),vy:30*-Math.random()-10,color:{r:160,g:140,b:120},size:(3+2*Math.random())*i,life:.3,alpha:.3,alphaDecay:.94,sizeDecay:1.01,blendMode:"multiply"}))}clear(){this.particles=[],this.emitters=[]}createSlashEffect(t,a,i=1){for(let o=0;o<6;o++){const o=250+150*Math.random(),s=.4*(Math.random()-.5);this.addParticle(new e(t,a+20*(Math.random()-.5),{vx:i*o+60*(Math.random()-.5),vy:s*o*.2,color:{r:255,g:230,b:120},size:2+2*Math.random(),life:.25+.2*Math.random(),alphaDecay:.92,sizeDecay:.96,glow:!0,glowSize:3,shape:"star",blendMode:"screen",trail:!0}))}this.addParticle(new e(t+10*i,a,{color:{r:255,g:255,b:200},size:24,life:.12,alpha:.8,alphaDecay:.85,sizeDecay:1.18,glow:!0,glowSize:2,blendMode:"screen"}))}createShieldEffect(t,a){for(let i=0;i<12;i++){const o=2*Math.PI*i/12,s=120+80*Math.random();this.addParticle(new e(t,a,{vx:Math.cos(o)*s,vy:Math.sin(o)*s,color:{r:120,g:180,b:255},size:2,life:.25,alphaDecay:.92,sizeDecay:.98,glow:!0,glowSize:3,shape:"circle",blendMode:"screen"}))}this.addParticle(new e(t,a,{color:{r:180,g:220,b:255},size:30,life:.18,alpha:.5,alphaDecay:.9,sizeDecay:1.12,glow:!0,glowSize:2,blendMode:"screen"}))}createBlockImpact(e,t){this.createBlockSpark(e,t,0)}createBloodEffect(e,t){this.createBloodSplatter(e,t)}createDeathEffect(e,t){this.createEnemyDeathExplosion(e,t)}createRespawnEffect(t,a){this.createDustCloud(t,a,40),this.addParticle(new e(t,a,{color:{r:180,g:255,b:255},size:60,life:.4,alpha:.6,alphaDecay:.9,sizeDecay:1.1,glow:!0,glowSize:2,blendMode:"screen"}))}startChargingEffect(e,t){const i=new a(e,t,{emissionRate:20,lifetime:1.5,particleConfig:{color:{r:120,g:200,b:255},size:3,life:.4,alpha:.7,alphaDecay:.94,sizeDecay:.98,glow:!0,glowSize:2,shape:"circle",speed:30,rotationSpeed:3},spread:2*Math.PI,direction:0});return this.addEmitter(i),i}createChargedSlash(t,a,i=1,o=0){this.createSlashEffect(t,a,i);const s=Math.floor(6*Math.max(0,Math.min(1,o)));for(let o=0;o<s;o++)this.addParticle(new e(t,a+20*(Math.random()-.5),{vx:i*(300+200*Math.random()),vy:40*(Math.random()-.5),color:{r:255,g:255,b:180},size:3+2*Math.random(),life:.3,alphaDecay:.9,sizeDecay:.95,glow:!0,glowSize:3,shape:"star",blendMode:"screen",trail:!0}));this.addParticle(new e(t+15*i,a,{color:{r:255,g:255,b:220},size:30+20*o,life:.14+.1*o,alpha:.85,alphaDecay:.88,sizeDecay:1.2,glow:!0,glowSize:2,blendMode:"screen"}))}createDashTrail(t,a,i=1,o=0){const s=Math.sqrt(i*i+o*o)||1,l=i/s,n=o/s;for(let i=0;i<4;i++)this.addParticle(new e(t-l*(10+3*i),a-n*(10+3*i),{vx:80*-l+20*(Math.random()-.5),vy:80*-n+20*(Math.random()-.5),color:{r:200,g:220,b:255},size:3,life:.25,alpha:.5,alphaDecay:.9,sizeDecay:.98,glow:!0,glowSize:2,blendMode:"screen"}))}createLandingImpact(t,a,i=1){const o=30+40*Math.max(0,Math.min(1,i));this.createDustCloud(t,a,o),this.addParticle(new e(t,a,{color:{r:255,g:255,b:255},size:20*i,life:.12,alpha:.6,alphaDecay:.88,sizeDecay:1.2,glow:!0,glowSize:2,blendMode:"screen"}))}createSparkle(t,a){this.addParticle(new e(t,a,{color:{r:255,g:255,b:200},size:3+2*Math.random(),life:.3,alpha:.9,alphaDecay:.92,sizeDecay:.97,glow:!0,glowSize:3,shape:"star",blendMode:"screen"}))}}class a{constructor(e,t,a={}){this.x=e,this.y=t,this.active=!0,this.emissionRate=a.emissionRate||10,this.emissionTimer=0,this.lifetime=a.lifetime||1/0,this.age=0,this.particleConfig=a.particleConfig||{},this.spread=a.spread||2*Math.PI,this.direction=a.direction||0,this.system=null}update(e){if(this.age+=e,this.age>=this.lifetime)return void(this.active=!1);this.emissionTimer+=e;const t=1/this.emissionRate;for(;this.emissionTimer>=t&&this.active;)this.emissionTimer-=t,this.emit()}emit(){if(!this.system)return;const t=this.direction+(Math.random()-.5)*this.spread,a={...this.particleConfig};a.speed&&(a.vx=Math.cos(t)*a.speed,a.vy=Math.sin(t)*a.speed,delete a.speed),this.system.addParticle(new e(this.x,this.y,a))}setPosition(e,t){this.x=e,this.y=t}stop(){this.active=!1}}class i{constructor(){this.animations=new Map,this.proceduralAnimations=new Map,this.particleEffects=new Map,this._dt=0,this.wasmModule=null,this.initializeAnimations(),this.initializeProceduralAnimations(),this.initializeParticleEffects()}setWasmModule(e){this.wasmModule=e}_seedWolf(e){if(null==e._animSeed){const t=65535&Math.floor(1e3*(e.position?.x||0)),a=65535&Math.floor(1e3*(e.position?.y||0)),i=65535&Math.floor(1e6*(e.furPattern||.5));e._animSeed=(t<<16^a^i<<1)>>>0}null==e._animRngState&&(e._animRngState=e._animSeed>>>0)}_rand(e){this._seedWolf(e);let t=0|e._animRngState;return t^=t<<13,t^=t>>>17,t^=t<<5,e._animRngState=t>>>0,(4294967295&e._animRngState)/4294967296}_chance(e,t){return this._rand(e)<t}_lerp(e,t,a){return e+(t-e)*a}_smoothNumber(e,t,a){const i=this._dt||.016,o=Math.min(1,Math.max(0,a*i));return this._lerp(e,t,o)}_smoothProp(e,t,a,i=8){const o=null!=e[t]?e[t]:a;e[t]=this._smoothNumber(o,a,i)}_updateSmoothedVelocity(e){const t=e.velocity?.x||0,a=e.velocity?.y||0;e._smVelX=this._smoothNumber(e._smVelX||0,t,10),e._smVelY=this._smoothNumber(e._smVelY||0,a,10)}initializeAnimations(){this.animations.set("idle",{breathing:{amplitude:2,frequency:.002,offset:0},earTwitch:{probability:.001,duration:300,maxRotation:.2},tailSway:{amplitude:.1,frequency:.003},blinking:{probability:.002,duration:150}}),this.animations.set("walking",{legCycle:{frequency:.008,amplitude:8,phaseOffset:Math.PI},bodyBob:{amplitude:2,frequency:.016},headBob:{amplitude:1.5,frequency:.008},tailSway:{amplitude:.2,frequency:.008}}),this.animations.set("running",{legCycle:{frequency:.015,amplitude:12,phaseOffset:Math.PI,stretchFactor:1.2},bodyBob:{amplitude:4,frequency:.03},headBob:{amplitude:3,frequency:.015},tailStream:{amplitude:.4,frequency:.02,streamEffect:!0},earsPinned:!0}),this.animations.set("prowling",{legCycle:{frequency:.004,amplitude:5,phaseOffset:Math.PI,careful:!0},bodyLowered:{lowerAmount:10,sway:1},headLowered:{lowerAmount:5,scanning:!0,scanSpeed:.002},tailStill:{tipTwitch:.01,frequency:.005},earsForward:{rotation:-.3,alertness:1}}),this.animations.set("lunging",{bodyStretch:{stretchFactor:1.3,compressionStart:.8,extensionPeak:1.5},legsExtended:{frontExtension:20,rearExtension:15,clawsOut:!0},mouthOpen:{openAmount:.8,teethVisible:!0},earsBack:{rotation:.5},furRipple:{intensity:.3,speed:.02}}),this.animations.set("attacking",{biteSequence:[{jaw:0,duration:100},{jaw:.9,duration:50},{jaw:.7,duration:100},{jaw:0,duration:150}],headShake:{amplitude:5,frequency:.05},clawSwipe:{swipeSpeed:.03,swipeArc:Math.PI/3},bodyTense:{tensionLevel:.8}}),this.animations.set("howling",{headTilt:{startAngle:0,endAngle:-Math.PI/4,duration:1e3},mouthOpen:{openAmount:.6,vibration:.02},chestExpansion:{expansionAmount:1.2,frequency:.003},tailRaised:{angle:.3},soundWaves:{frequency:.01,amplitude:2,visible:!0}}),this.animations.set("hurt",{flinch:{intensity:10,duration:200,direction:"away"},earsFlat:{rotation:.6},tailTucked:{tuckAmount:.8},whimper:{mouthOpen:.2,duration:300},bodyShake:{amplitude:3,frequency:.1,dampening:.9}}),this.animations.set("death",{collapse:{stages:[{legs:"buckle",duration:300},{body:"fall",duration:400},{final:"limp",duration:500}]},fadeOut:{startDelay:1e3,duration:2e3}})}initializeProceduralAnimations(){this.proceduralAnimations.set("legIK",{calculateLegPosition:(e,t,a)=>{const i=this.animations.get(e.state);if(!i||!i.legCycle)return{x:0,y:0};const o=i.legCycle,s=t%2==0?0:o.phaseOffset,l=a*o.frequency+s,n=Math.sin(l)*o.amplitude*.5,r=Math.max(0,Math.sin(2*l))*o.amplitude;return o.careful?{x:.5*n,y:.7*r,placement:"careful"}:{x:n,y:r}}}),this.proceduralAnimations.set("tailPhysics",{segments:5,calculateTailCurve:(e,t)=>{const a=this.animations.get(e.state),i=[];for(let e=0;e<5;e++){const o=.1*e;let s=0;a?.tailSway?s=Math.sin(t*a.tailSway.frequency-o)*a.tailSway.amplitude*(1-.15*e):a?.tailStream?s=Math.sin(t*a.tailStream.frequency-o)*a.tailStream.amplitude*(1+.1*e):a?.tailTucked&&(s=a.tailTucked.tuckAmount*(1+.2*e)),i.push({angle:s,length:8-.5*e})}return i}}),this.proceduralAnimations.set("furDynamics",{calculateFurMovement(e,t,a=0){const i=Math.sqrt(e.velocity.x**2+e.velocity.y**2),o=Math.sin(.005*t)*a;return{ripple:i>200?.2*Math.sin(.02*t):0,flow:o+i/1e3,ruffled:"hurt"===e.state||"attacking"===e.state}}}),this.proceduralAnimations.set("breathing",{calculateBreathing(e,t){const a=.002*({idle:1,walking:1.2,running:2,prowling:.8,attacking:1.5,hurt:1.8,howling:1.3}[e.state]||1),i="running"===e.state?4:2;return{chestExpansion:Math.sin(t*a)*i,bellyExpansion:Math.sin(t*a-.2)*i*.7}}})}initializeParticleEffects(){this.particleEffects.set("runDust",{emitRate:5,particleLife:500,particleSpeed:{min:20,max:50},particleSize:{min:2,max:5},particleColor:"rgba(139, 115, 85, 0.4)",emitAngle:{min:.4*Math.PI,max:.6*Math.PI},gravity:50}),this.particleEffects.set("bloodSplatter",{emitRate:20,particleLife:800,particleSpeed:{min:100,max:200},particleSize:{min:1,max:3},particleColor:"rgba(139, 0, 0, 0.7)",emitAngle:{min:0,max:2*Math.PI},gravity:200}),this.particleEffects.set("attackFoam",{emitRate:8,particleLife:300,particleSpeed:{min:50,max:100},particleSize:{min:1,max:2},particleColor:"rgba(255, 255, 255, 0.6)",emitAngle:{min:-Math.PI/6,max:Math.PI/6},gravity:100}),this.particleEffects.set("soundWaves",{emitRate:2,particleLife:1500,particleSpeed:{min:100,max:100},particleSize:{min:20,max:40},particleColor:"rgba(255, 255, 255, 0.2)",emitAngle:{min:-Math.PI/8,max:Math.PI/8},gravity:0,expanding:!0})}applyAnimation(e,t){if(!this.wasmModule)return;this._dt=t;const a=e.id;if(!this.wasmModule.get_wolf_anim_active(a))return;const i="function"==typeof globalThis.wasmExports?.get_time_seconds?globalThis.wasmExports.get_time_seconds():performance.now()/1e3,o=e.state,s=this.animations.get(o);if(s){switch(e._lastAnimState!==o&&(e._lastAnimState=o,e._stateBlend=0),e._stateBlend=Math.min(1,(e._stateBlend||0)+6*t),this._updateSmoothedVelocity(e),this.applyProceduralAnimations(e,a,i),o){case"idle":this.applyIdleAnimation(e,s,i);break;case"walking":case"running":this.applyLocomotionAnimation(e,s,i);break;case"prowling":this.applyProwlingAnimation(e,s,i);break;case"lunging":this.applyLungingAnimation(e,s,i);break;case"attacking":this.applyAttackingAnimation(e,s,i);break;case"howling":this.applyHowlingAnimation(e,s,i);break;case"hurt":this.applyHurtAnimation(e,s,i)}this.updateParticleEffects(e,t)}}applyProceduralAnimations(e,t,a){if(!this.wasmModule)return;const i={active:this.wasmModule.get_wolf_anim_active(t),leg_x:[this.wasmModule.get_wolf_anim_leg_x(t,0),this.wasmModule.get_wolf_anim_leg_x(t,1),this.wasmModule.get_wolf_anim_leg_x(t,2),this.wasmModule.get_wolf_anim_leg_x(t,3)],leg_y:[this.wasmModule.get_wolf_anim_leg_y(t,0),this.wasmModule.get_wolf_anim_leg_y(t,1),this.wasmModule.get_wolf_anim_leg_y(t,2),this.wasmModule.get_wolf_anim_leg_y(t,3)],spine_bend:this.wasmModule.get_wolf_anim_spine_bend(t),tail_angle:this.wasmModule.get_wolf_anim_tail_angle(t),head_pitch:this.wasmModule.get_wolf_anim_head_pitch(t),head_yaw:this.wasmModule.get_wolf_anim_head_yaw(t),ear_rotation:[this.wasmModule.get_wolf_anim_ear_rotation(t,0),this.wasmModule.get_wolf_anim_ear_rotation(t,1)],body_stretch:this.wasmModule.get_wolf_anim_body_stretch(t),body_offset_y:this.wasmModule.get_wolf_anim_body_offset_y(t),fur_ruffle:this.wasmModule.get_wolf_anim_fur_ruffle(t)};e.legPositions=i.leg_x.map((e,t)=>({x:e,y:i.leg_y[t]})),e.spineBend=i.spine_bend,e.tailPosition=i.tail_angle,e.headPitch=i.head_pitch,e.headYaw=i.head_yaw,e.earRotation=i.ear_rotation[0],e.bodyStretch=i.body_stretch,e.bodyBob=i.body_offset_y,e.furMovement={ripple:i.fur_ruffle,flow:0,ruffled:i.fur_ruffle>.05};const o=this.proceduralAnimations.get("breathing").calculateBreathing(e,a);e.breathingOffset=o.chestExpansion,e.bellyOffset=o.bellyExpansion}applyIdleAnimation(e,t,a){this._smoothProp(e,"earRotation",e.earRotation||0,8),this._chance(e,t.blinking.probability)&&(e.blinkTime=a,e.blinkDuration=t.blinking.duration),e.isBlinking=e.blinkTime&&a-e.blinkTime<e.blinkDuration}applyLocomotionAnimation(e,t,a){this._smoothProp(e,"bodyBob",e.bodyBob||0,10),this._smoothProp(e,"headBob",e.headBob||0,10),t.earsPinned&&this._smoothProp(e,"earRotation",e.earRotation||.4,12)}applyProwlingAnimation(e,t,a){this._smoothProp(e,"bodyLowered",1e3*(e.bodyBob||0),10),this._smoothProp(e,"bodySway",1*Math.sin(.002*a),10),t.headLowered.scanning&&(e.headScan=e.headYaw),this._smoothProp(e,"earRotation",e.earRotation||0,10),this._smoothProp(e,"earAlertness",e.earRotation?1:0,10)}applyLungingAnimation(e,t,a){this._smoothProp(e,"bodyStretch",e.bodyStretch||1,14),e.frontLegExtension=20*(e.bodyStretch-1),e.rearLegExtension=15*(e.bodyStretch-1),e.clawsOut=e.bodyStretch>1.1,e.mouthOpen=t.mouthOpen.openAmount,e.teethVisible=t.mouthOpen.teethVisible,e.furRipple=e.furMovement?.ripple||0}applyAttackingAnimation(e,t,a){e.biteSequenceIndex||(e.biteSequenceIndex=0),e.biteSequenceTime||(e.biteSequenceTime=a);const i=t.biteSequence[e.biteSequenceIndex];a-e.biteSequenceTime<i.duration?e.jawOpen=i.jaw:(e.biteSequenceIndex=(e.biteSequenceIndex+1)%t.biteSequence.length,e.biteSequenceTime=a),this._smoothProp(e,"headShake",Math.sin(a*t.headShake.frequency)*t.headShake.amplitude,18),e.bodyTension=t.bodyTense.tensionLevel}applyHowlingAnimation(e,t,a){e.howlStartTime||(e.howlStartTime=a),e.howlStartTime,t.headTilt.duration,e.headTilt=e.headPitch,e.mouthOpen=t.mouthOpen.openAmount,e.mouthVibration=Math.sin(.05*a)*t.mouthOpen.vibration,this._smoothProp(e,"chestExpansion",1+Math.sin(a*t.chestExpansion.frequency)*(t.chestExpansion.expansionAmount-1),10),t.soundWaves.visible&&(e.soundWavePhase=a*t.soundWaves.frequency,e.soundWaveAmplitude=t.soundWaves.amplitude)}applyHurtAnimation(e,t,a){e.hurtStartTime||(e.hurtStartTime=a);const i=a-e.hurtStartTime;if(i<t.flinch.duration){const a=i/t.flinch.duration;e.flinchOffset=t.flinch.intensity*(1-a)}const o=t.bodyShake.dampening**(i/100);this._smoothProp(e,"bodyShake",Math.sin(a*t.bodyShake.frequency)*t.bodyShake.amplitude*o,18),this._smoothProp(e,"earRotation",e.earRotation||t.earsFlat.rotation,14),this._smoothProp(e,"tailTucked",e.tailPosition||t.tailTucked.tuckAmount,14)}updateParticleEffects(e,a){if(e.particleSystem||(e.particleSystem=new t),"running"===e.state&&e.isGrounded){const t=this.particleEffects.get("runDust"),a=e.position.x-20*e.facing,i=e.position.y+e.height/2;"function"==typeof e.particleSystem.emit?e.particleSystem.emit(a,i,t):"function"==typeof e.particleSystem.createDustCloud&&e.particleSystem.createDustCloud(a,i,20)}if("howling"===e.state){const t=this.particleEffects.get("soundWaves"),a=e.position.x+30*e.facing,i=e.position.y-e.height/4;"function"==typeof e.particleSystem.emit?e.particleSystem.emit(a,i,t):"function"==typeof e.particleSystem.createSparkle&&e.particleSystem.createSparkle(a,i)}e.particleSystem.update(a)}renderAnimatedWolf(e,t,a){e.save();const i=t.position.x-a.x,o=t.position.y-a.y;e.translate(i,o);const s=t._smVelX||0,l=t._smVelY||0,n=Math.sqrt(s*s+l*l),r=t.spineBend||0;r&&e.rotate(r);const h=1+.05*Math.min(n/(t.maxSpeed||350),1),c=(t.bodyStretch||1)*h,d=2-c;e.scale(t.size*t.facing*c,t.size*d),t.bodyShake&&e.translate(t.bodyShake,0),t.flinchOffset&&e.translate(-t.facing*t.flinchOffset,.5*-t.flinchOffset),this.drawAnimatedShadow(e,t),this.drawAnimatedTail(e,t),this.drawAnimatedLegs(e,t,"hind"),this.drawAnimatedBody(e,t),this.drawAnimatedLegs(e,t,"front"),this.drawAnimatedNeck(e,t),this.drawAnimatedHead(e,t),t.particleSystem&&t.particleSystem.render(e,a),this.drawWolfUI(e,t),e.restore()}drawAnimatedShadow(e,t){const a=Math.sqrt((t._smVelX||0)**2+(t._smVelY||0)**2),i=1+.15*Math.min(a/(t.maxSpeed||350),1),o="lunging"===t.state?1.2*i:i,s=t.isGrounded?.32:.12;e.fillStyle=`rgba(0, 0, 0, ${s})`,e.beginPath(),e.ellipse(0,t.height/2+5,t.width/3*o,8,0,0,2*Math.PI),e.fill()}drawAnimatedTail(e,t){e.save();const a=.35*-t.width;let i=.1*-t.height;if(t.bodyLowered&&(i+=.5*t.bodyLowered),e.translate(a,i),t.tailSegments){let a=0,i=0,o=t.tailPosition||0;t.tailSegments.forEach((s,l)=>{e.save(),e.translate(a,i),e.rotate(o+s.angle);const n=8-1.2*l,r=s.length;e.fillStyle=l%2==0?t.colors.primary:t.colors.secondary,e.fillRect(0,-n/2,r,n),a+=Math.cos(o+s.angle)*r,i+=Math.sin(o+s.angle)*r,o+=s.angle,e.restore()})}else e.rotate(t.tailPosition||0),e.fillStyle=t.colors.primary,e.beginPath(),e.moveTo(0,0),e.quadraticCurveTo(-15,5,-25,15),e.quadraticCurveTo(-20,20,-10,18),e.quadraticCurveTo(-5,10,0,0),e.fill();e.restore()}drawAnimatedLegs(e,t,a){const i=t.legPositions||[],o="hind"===a,s=o?0:2;for(let a=s;a<s+2;a++){const s=i[a]||{x:0,y:0},l=o?-t.width*(.25-a%2*.1):t.width*(.15+a%2*.1),n=.2*t.height;if(e.save(),e.translate(l+100*s.x,n+100*s.y),e.fillStyle=t.colors.primary,e.fillRect(0,0,10,15-50*s.y),e.translate(0,15-50*s.y),e.rotate(.05*s.y),e.fillRect(0,0,8,10+50*s.y),e.translate(0,10+50*s.y),e.fillStyle=t.colors.secondary,e.fillRect(-1,0,10,5),t.clawsOut){e.fillStyle=t.colors.claws;for(let t=0;t<3;t++)e.fillRect(3*t,4,2,4)}e.restore()}}drawAnimatedBody(e,t){e.save(),t.bodyBob&&e.translate(0,100*t.bodyBob);const a=t.breathingOffset||0,i=t.chestExpansion||1;e.fillStyle=t.colors.primary,e.beginPath(),e.ellipse(0,a,.35*t.width*i*(t.bodyStretch||1),.25*t.height,0,0,2*Math.PI),e.fill();const o=a+(t.bellyOffset||0);e.fillStyle=t.colors.belly,e.beginPath(),e.ellipse(0,o+.1*t.height,.3*t.width*(t.bodyStretch||1),.15*t.height,0,0,Math.PI),e.fill(),t.furMovement&&this.drawAnimatedFur(e,t,0,a,.35*t.width,.25*t.height),e.restore()}drawAnimatedNeck(e,t){e.save(),t.bodyBob&&e.translate(0,50*t.bodyBob),e.fillStyle=t.colors.primary,e.beginPath(),e.moveTo(.15*t.width,.1*-t.height),e.quadraticCurveTo(.25*t.width,.05*-t.height,.3*t.width,.15*-t.height),e.quadraticCurveTo(.25*t.width,.05*t.height,.15*t.width,.1*t.height),e.fill(),e.restore()}drawAnimatedHead(e,t){e.save(),e.translate(.35*t.width,.15*-t.height),t.headPitch&&e.rotate(t.headPitch),t.headShake&&e.translate(t.headShake,0),t.headYaw&&e.rotate(t.headYaw),t.bodyBob&&e.translate(0,50*t.bodyBob),e.fillStyle=t.colors.primary,e.beginPath(),e.moveTo(0,0),e.quadraticCurveTo(10,-5,15,0),e.quadraticCurveTo(20,3,25,5),e.lineTo(28,8),e.quadraticCurveTo(25,10,20,10),e.quadraticCurveTo(10,8,0,10),e.quadraticCurveTo(-5,5,0,0),e.fill(),this.drawAnimatedEars(e,t),this.drawAnimatedMouth(e,t),this.drawAnimatedEyes(e,t),null!==t.soundWavePhase&&this.drawSoundWaves(e,t),e.restore()}drawAnimatedEars(e,t){const a=t.earRotation||0,i=t.earAlertness||0;e.save(),e.translate(5,-3),e.rotate(a-.1*i),e.fillStyle=t.colors.primary,e.beginPath(),e.moveTo(0,0),e.lineTo(-3,-8-2*i),e.lineTo(3,-8-2*i),e.closePath(),e.fill(),e.fillStyle=t.colors.belly,e.beginPath(),e.moveTo(0,-2),e.lineTo(-1,-6-i),e.lineTo(1,-6-i),e.closePath(),e.fill(),e.restore(),e.save(),e.translate(8,-2),e.rotate(a+.1*i),e.fillStyle=t.colors.secondary,e.beginPath(),e.moveTo(0,0),e.lineTo(-2,-7-2*i),e.lineTo(3,-7-2*i),e.closePath(),e.fill(),e.restore()}drawAnimatedMouth(e,t){const a=t.mouthOpen||t.jawOpen||0,i=t.mouthVibration||0;e.fillStyle=t.colors.secondary,e.beginPath(),e.moveTo(20,5),e.quadraticCurveTo(25,6,28,8),e.quadraticCurveTo(25,9+3*a,20,9+3*a),e.fill(),a>0&&(e.fillStyle="rgba(0, 0, 0, 0.7)",e.beginPath(),e.moveTo(20,9),e.quadraticCurveTo(24,9+5*a+i,28,9+3*a+i),e.quadraticCurveTo(24,11+5*a+i,20,11+5*a),e.fill(),(t.teethVisible||a>.5)&&(e.fillStyle="#ffffff",e.beginPath(),e.moveTo(22,9),e.lineTo(21,11+2*a),e.lineTo(23,11+2*a),e.closePath(),e.fill(),e.beginPath(),e.moveTo(25,9),e.lineTo(24,11+2*a),e.lineTo(26,11+2*a),e.closePath(),e.fill(),a>.7&&(e.beginPath(),e.moveTo(23,11+4*a),e.lineTo(22,9+4*a),e.lineTo(24,9+4*a),e.closePath(),e.fill())),a>.3&&"attacking"!==t.state&&(e.fillStyle="rgba(255, 100, 100, 0.8)",e.beginPath(),e.ellipse(24,10+3*a,3,2+2*a,.2,0,Math.PI),e.fill())),e.fillStyle=t.colors.nose,e.beginPath(),e.arc(28,8,2,0,2*Math.PI),e.fill()}drawAnimatedEyes(e,t){if(t.isBlinking)return e.strokeStyle=t.colors.secondary,e.lineWidth=2,e.beginPath(),e.moveTo(10,3),e.lineTo(16,3),void e.stroke();"prowling"!==t.state&&"lunging"!==t.state&&"attacking"!==t.state||(e.shadowColor=t.colors.eyes,e.shadowBlur=8),e.fillStyle="#ffffff",e.beginPath(),e.ellipse(12,3,4,3,-.2,0,2*Math.PI),e.fill();const a="attacking"===t.state?.7:"prowling"===t.state?.5:.3;e.fillStyle=t.colors.eyes,e.beginPath(),e.arc(13,3,2,0,2*Math.PI),e.fill(),e.fillStyle="#000000",e.beginPath(),e.arc(13.5,3,1*(1-a),0,2*Math.PI),e.fill(),e.fillStyle="rgba(255, 255, 255, 0.7)",e.beginPath(),e.arc(12,2,.5,0,2*Math.PI),e.fill(),e.shadowBlur=0}drawAnimatedFur(e,t,a,i,o,s){e.strokeStyle=t.colors.secondary,e.lineWidth=.5,e.globalAlpha=.4;const l=(t.furMovement?.ripple||0)+t.furRuffle,n=t.furMovement?.flow||0,r=t.furMovement?.ruffled||!1;for(let h=0;h<12;h++){const c=h/12*Math.PI*2,d=a+Math.cos(c)*o*.7,m=i+Math.sin(c)*s*.7,f=Math.sin(.01*t.animationTime+h)*l*10,p=Math.cos(.01*t.animationTime+h)*l*5;e.beginPath(),e.moveTo(d,m),r?e.lineTo(d+8*Math.cos(c)+f,m+8*Math.sin(c)+p):e.quadraticCurveTo(d+4*Math.cos(c)+.5*f,m+4*Math.sin(c)+.5*p,d+6*Math.cos(c+n)+f,m+6*Math.sin(c+n)+p),e.stroke()}e.globalAlpha=1}drawSoundWaves(e,t){e.save(),e.globalAlpha=.3,e.strokeStyle=t.colors.eyes,e.lineWidth=2;for(let a=0;a<3;a++){const i=t.soundWavePhase+a*Math.PI/3,o=10+Math.sin(i)*t.soundWaveAmplitude+15*a,s=.3-.1*a;e.globalAlpha=s,e.beginPath(),e.arc(30,5,o,-Math.PI/3,Math.PI/3),e.stroke()}e.restore()}drawWolfUI(e,t){if(t.isAlpha||t.health<t.maxHealth){e.save(),e.scale(1/t.size,1/t.size);const a=60,i=6,o=.5*-t.height-20;e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(-a/2,o,a,i);const s=t.health/t.maxHealth;e.fillStyle=s>.5?"#4caf50":s>.25?"#ff9800":"#f44336",e.fillRect(-a/2,o,a*s,i),e.strokeStyle=t.isAlpha?"#ffd700":"#ffffff",e.lineWidth=1,e.strokeRect(-a/2,o,a,i),t.isAlpha&&(e.font="12px Arial",e.textAlign="center",e.fillText("ðŸ‘‘",0,o-5)),"prowling"===t.state?e.fillText("ðŸ‘",-35,o+5):"howling"===t.state&&e.fillText("ðŸ”Š",-35,o+5),e.restore()}if(t.lungeState?.charging){e.save(),e.globalAlpha=.7;const a=t.lungeState.chargeTime/t.lungeState.maxChargeTime,i=15;e.strokeStyle=`hsl(${60*a}, 100%, 50%)`,e.lineWidth=3,e.beginPath(),e.arc(0,.7*-t.height,i,-Math.PI/2,-Math.PI/2+2*Math.PI*a),e.stroke(),a>=1&&(e.globalAlpha=.3+.3*Math.sin(.01*t.animationTime),e.strokeStyle="#ff0000",e.beginPath(),e.arc(0,.7*-t.height,i+5,0,2*Math.PI),e.stroke()),e.restore()}}}export{i as WolfAnimationSystem,i as default};