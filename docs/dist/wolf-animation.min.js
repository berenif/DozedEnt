import"./animation-system.js";import{ParticleSystem as e}from"./particle-system.js";class t{constructor(){this.animations=new Map,this.proceduralAnimations=new Map,this.particleEffects=new Map,this.initializeAnimations(),this.initializeProceduralAnimations(),this.initializeParticleEffects()}initializeAnimations(){this.animations.set("idle",{breathing:{amplitude:2,frequency:.002,offset:0},earTwitch:{probability:.001,duration:300,maxRotation:.2},tailSway:{amplitude:.1,frequency:.003},blinking:{probability:.002,duration:150}}),this.animations.set("walking",{legCycle:{frequency:.008,amplitude:8,phaseOffset:Math.PI},bodyBob:{amplitude:2,frequency:.016},headBob:{amplitude:1.5,frequency:.008},tailSway:{amplitude:.2,frequency:.008}}),this.animations.set("running",{legCycle:{frequency:.015,amplitude:12,phaseOffset:Math.PI,stretchFactor:1.2},bodyBob:{amplitude:4,frequency:.03},headBob:{amplitude:3,frequency:.015},tailStream:{amplitude:.4,frequency:.02,streamEffect:!0},earsPinned:!0}),this.animations.set("prowling",{legCycle:{frequency:.004,amplitude:5,phaseOffset:Math.PI,careful:!0},bodyLowered:{lowerAmount:10,sway:1},headLowered:{lowerAmount:5,scanning:!0,scanSpeed:.002},tailStill:{tipTwitch:.01,frequency:.005},earsForward:{rotation:-.3,alertness:1}}),this.animations.set("lunging",{bodyStretch:{stretchFactor:1.3,compressionStart:.8,extensionPeak:1.5},legsExtended:{frontExtension:20,rearExtension:15,clawsOut:!0},mouthOpen:{openAmount:.8,teethVisible:!0},earsBack:{rotation:.5},furRipple:{intensity:.3,speed:.02}}),this.animations.set("attacking",{biteSequence:[{jaw:0,duration:100},{jaw:.9,duration:50},{jaw:.7,duration:100},{jaw:0,duration:150}],headShake:{amplitude:5,frequency:.05},clawSwipe:{swipeSpeed:.03,swipeArc:Math.PI/3},bodyTense:{tensionLevel:.8}}),this.animations.set("howling",{headTilt:{startAngle:0,endAngle:-Math.PI/4,duration:1e3},mouthOpen:{openAmount:.6,vibration:.02},chestExpansion:{expansionAmount:1.2,frequency:.003},tailRaised:{angle:.3},soundWaves:{frequency:.01,amplitude:2,visible:!0}}),this.animations.set("hurt",{flinch:{intensity:10,duration:200,direction:"away"},earsFlat:{rotation:.6},tailTucked:{tuckAmount:.8},whimper:{mouthOpen:.2,duration:300},bodyShake:{amplitude:3,frequency:.1,dampening:.9}}),this.animations.set("death",{collapse:{stages:[{legs:"buckle",duration:300},{body:"fall",duration:400},{final:"limp",duration:500}]},fadeOut:{startDelay:1e3,duration:2e3}})}initializeProceduralAnimations(){this.proceduralAnimations.set("legIK",{calculateLegPosition:(e,t,a)=>{const i=this.animations.get(e.state);if(!i||!i.legCycle)return{x:0,y:0};const n=i.legCycle,l=t%2==0?0:n.phaseOffset,o=a*n.frequency+l,s=Math.sin(o)*n.amplitude*.5,r=Math.max(0,Math.sin(2*o))*n.amplitude;return n.careful?{x:.5*s,y:.7*r,placement:"careful"}:{x:s,y:r}}}),this.proceduralAnimations.set("tailPhysics",{segments:5,calculateTailCurve:(e,t)=>{const a=this.animations.get(e.state),i=[];for(let e=0;e<5;e++){const n=.1*e;let l=0;a?.tailSway?l=Math.sin(t*a.tailSway.frequency-n)*a.tailSway.amplitude*(1-.15*e):a?.tailStream?l=Math.sin(t*a.tailStream.frequency-n)*a.tailStream.amplitude*(1+.1*e):a?.tailTucked&&(l=a.tailTucked.tuckAmount*(1+.2*e)),i.push({angle:l,length:8-.5*e})}return i}}),this.proceduralAnimations.set("furDynamics",{calculateFurMovement(e,t,a=0){const i=Math.sqrt(e.velocity.x**2+e.velocity.y**2),n=Math.sin(.005*t)*a;return{ripple:i>200?.2*Math.sin(.02*t):0,flow:n+i/1e3,ruffled:"hurt"===e.state||"attacking"===e.state}}}),this.proceduralAnimations.set("breathing",{calculateBreathing(e,t){const a=.002*({idle:1,walking:1.2,running:2,prowling:.8,attacking:1.5,hurt:1.8,howling:1.3}[e.state]||1),i="running"===e.state?4:2;return{chestExpansion:Math.sin(t*a)*i,bellyExpansion:Math.sin(t*a-.2)*i*.7}}})}initializeParticleEffects(){this.particleEffects.set("runDust",{emitRate:5,particleLife:500,particleSpeed:{min:20,max:50},particleSize:{min:2,max:5},particleColor:"rgba(139, 115, 85, 0.4)",emitAngle:{min:.4*Math.PI,max:.6*Math.PI},gravity:50}),this.particleEffects.set("bloodSplatter",{emitRate:20,particleLife:800,particleSpeed:{min:100,max:200},particleSize:{min:1,max:3},particleColor:"rgba(139, 0, 0, 0.7)",emitAngle:{min:0,max:2*Math.PI},gravity:200}),this.particleEffects.set("attackFoam",{emitRate:8,particleLife:300,particleSpeed:{min:50,max:100},particleSize:{min:1,max:2},particleColor:"rgba(255, 255, 255, 0.6)",emitAngle:{min:-Math.PI/6,max:Math.PI/6},gravity:100}),this.particleEffects.set("soundWaves",{emitRate:2,particleLife:1500,particleSpeed:{min:100,max:100},particleSize:{min:20,max:40},particleColor:"rgba(255, 255, 255, 0.2)",emitAngle:{min:-Math.PI/8,max:Math.PI/8},gravity:0,expanding:!0})}applyAnimation(e,t){const a=e.animationTime,i=e.state,n=this.animations.get(i);if(n){switch(this.applyProceduralAnimations(e,a),i){case"idle":this.applyIdleAnimation(e,n,a);break;case"walking":case"running":this.applyLocomotionAnimation(e,n,a);break;case"prowling":this.applyProwlingAnimation(e,n,a);break;case"lunging":this.applyLungingAnimation(e,n,a);break;case"attacking":this.applyAttackingAnimation(e,n,a);break;case"howling":this.applyHowlingAnimation(e,n,a);break;case"hurt":this.applyHurtAnimation(e,n,a)}this.updateParticleEffects(e,t)}}applyProceduralAnimations(e,t){const a=this.proceduralAnimations.get("breathing").calculateBreathing(e,t);e.breathingOffset=a.chestExpansion,e.bellyOffset=a.bellyExpansion;const i=this.proceduralAnimations.get("furDynamics");e.furMovement=i.calculateFurMovement(e,t,.3);const n=this.proceduralAnimations.get("tailPhysics");e.tailSegments=n.calculateTailCurve(e,t)}applyIdleAnimation(e,t,a){if(Math.random()<t.earTwitch.probability&&(e.earTwitchTime=a,e.earTwitchDuration=t.earTwitch.duration),e.earTwitchTime&&a-e.earTwitchTime<e.earTwitchDuration){const i=(a-e.earTwitchTime)/e.earTwitchDuration;e.earRotation=Math.sin(i*Math.PI)*t.earTwitch.maxRotation}else e.earRotation=0;Math.random()<t.blinking.probability&&(e.blinkTime=a,e.blinkDuration=t.blinking.duration),e.isBlinking=e.blinkTime&&a-e.blinkTime<e.blinkDuration}applyLocomotionAnimation(e,t,a){const i=this.proceduralAnimations.get("legIK");e.legPositions=[];for(let t=0;t<4;t++)e.legPositions[t]=i.calculateLegPosition(e,t,a);e.bodyBob=Math.sin(a*t.bodyBob.frequency)*t.bodyBob.amplitude,e.headBob=Math.sin(a*t.headBob.frequency)*t.headBob.amplitude,t.earsPinned&&(e.earRotation=.4)}applyProwlingAnimation(e,t,a){e.bodyLowered=t.bodyLowered.lowerAmount,e.bodySway=Math.sin(.002*a)*t.bodyLowered.sway,t.headLowered.scanning&&(e.headScan=.3*Math.sin(a*t.headLowered.scanSpeed)),e.earRotation=t.earsForward.rotation,e.earAlertness=t.earsForward.alertness;const i=this.proceduralAnimations.get("legIK");e.legPositions=[];for(let t=0;t<4;t++)e.legPositions[t]=i.calculateLegPosition(e,t,a)}applyLungingAnimation(e,t,a){const i=e.lungeState.lungeProgress/e.lungeState.lungeDuration;let n=1;if(i<.2)n=1-i/.2*(1-t.bodyStretch.compressionStart);else{const e=(i-.2)/.8;n=t.bodyStretch.compressionStart+e*(t.bodyStretch.extensionPeak-t.bodyStretch.compressionStart)}e.bodyStretch=n,e.frontLegExtension=t.legsExtended.frontExtension*i,e.rearLegExtension=t.legsExtended.rearExtension*i,e.clawsOut=t.legsExtended.clawsOut,e.mouthOpen=t.mouthOpen.openAmount,e.teethVisible=t.mouthOpen.teethVisible,e.furRipple=Math.sin(.02*a)*t.furRipple.intensity}applyAttackingAnimation(e,t,a){e.biteSequenceIndex||(e.biteSequenceIndex=0),e.biteSequenceTime||(e.biteSequenceTime=a);const i=t.biteSequence[e.biteSequenceIndex];a-e.biteSequenceTime<i.duration?e.jawOpen=i.jaw:(e.biteSequenceIndex=(e.biteSequenceIndex+1)%t.biteSequence.length,e.biteSequenceTime=a),e.headShake=Math.sin(a*t.headShake.frequency)*t.headShake.amplitude,e.bodyTension=t.bodyTense.tensionLevel}applyHowlingAnimation(e,t,a){e.howlStartTime||(e.howlStartTime=a);const i=Math.min((a-e.howlStartTime)/t.headTilt.duration,1);e.headTilt=t.headTilt.startAngle+(t.headTilt.endAngle-t.headTilt.startAngle)*i,e.mouthOpen=t.mouthOpen.openAmount,e.mouthVibration=Math.sin(.05*a)*t.mouthOpen.vibration,e.chestExpansion=1+Math.sin(a*t.chestExpansion.frequency)*(t.chestExpansion.expansionAmount-1),t.soundWaves.visible&&(e.soundWavePhase=a*t.soundWaves.frequency,e.soundWaveAmplitude=t.soundWaves.amplitude)}applyHurtAnimation(e,t,a){e.hurtStartTime||(e.hurtStartTime=a);const i=a-e.hurtStartTime;if(i<t.flinch.duration){const a=i/t.flinch.duration;e.flinchOffset=t.flinch.intensity*(1-a)}const n=Math.pow(t.bodyShake.dampening,i/100);e.bodyShake=Math.sin(a*t.bodyShake.frequency)*t.bodyShake.amplitude*n,e.earRotation=t.earsFlat.rotation,e.tailTucked=t.tailTucked.tuckAmount}updateParticleEffects(t,a){if(t.particleSystem||(t.particleSystem=new e),"running"===t.state&&t.isGrounded){const e=this.particleEffects.get("runDust");t.particleSystem.emit(t.position.x-20*t.facing,t.position.y+t.height/2,e)}if("howling"===t.state){const e=this.particleEffects.get("soundWaves");t.particleSystem.emit(t.position.x+30*t.facing,t.position.y-t.height/4,e)}t.particleSystem.update(a)}renderAnimatedWolf(e,t,a){e.save();const i=t.position.x-a.x,n=t.position.y-a.y;e.translate(i,n);const l=t.bodyStretch||1,o=2-l;e.scale(t.size*t.facing*l,t.size*o),t.bodyShake&&e.translate(t.bodyShake,0),t.flinchOffset&&e.translate(-t.facing*t.flinchOffset,.5*-t.flinchOffset),this.drawAnimatedShadow(e,t),this.drawAnimatedTail(e,t),this.drawAnimatedLegs(e,t,"hind"),this.drawAnimatedBody(e,t),this.drawAnimatedLegs(e,t,"front"),this.drawAnimatedNeck(e,t),this.drawAnimatedHead(e,t),t.particleSystem&&t.particleSystem.render(e,a),this.drawWolfUI(e,t),e.restore()}drawAnimatedShadow(e,t){const a="lunging"===t.state?1.3:1,i=t.isGrounded?.3:.1;e.fillStyle=`rgba(0, 0, 0, ${i})`,e.beginPath(),e.ellipse(0,t.height/2+5,t.width/3*a,8,0,0,2*Math.PI),e.fill()}drawAnimatedTail(e,t){e.save();let a=.35*-t.width,i=.1*-t.height;if(t.bodyLowered&&(i+=.5*t.bodyLowered),e.translate(a,i),t.tailSegments){let a=0,i=0,n=0;t.tailSegments.forEach((l,o)=>{e.save(),e.translate(a,i),e.rotate(n+l.angle);const s=8-1.2*o,r=l.length;e.fillStyle=o%2==0?t.colors.primary:t.colors.secondary,e.fillRect(0,-s/2,r,s),a+=Math.cos(n+l.angle)*r,i+=Math.sin(n+l.angle)*r,n+=l.angle,e.restore()})}else e.rotate(t.tailPosition||0),e.fillStyle=t.colors.primary,e.beginPath(),e.moveTo(0,0),e.quadraticCurveTo(-15,5,-25,15),e.quadraticCurveTo(-20,20,-10,18),e.quadraticCurveTo(-5,10,0,0),e.fill();e.restore()}drawAnimatedLegs(e,t,a){const i=t.legPositions||[],n="hind"===a,l=n?0:2;for(let a=l;a<l+2;a++){const l=i[a]||{x:0,y:0},o=n?-t.width*(.25-a%2*.1):t.width*(.15+a%2*.1),s=.2*t.height;if(e.save(),e.translate(o+l.x,s),e.fillStyle=t.colors.primary,e.fillRect(0,0,10,15-.5*l.y),e.translate(0,15-.5*l.y),e.rotate(.02*l.y),e.fillRect(0,0,8,10+l.y),e.translate(0,10+l.y),e.fillStyle=t.colors.secondary,e.fillRect(-1,0,10,5),t.clawsOut){e.fillStyle=t.colors.claws;for(let t=0;t<3;t++)e.fillRect(3*t,4,2,4)}e.restore()}}drawAnimatedBody(e,t){e.save(),t.bodyLowered&&e.translate(0,t.bodyLowered),t.bodyBob&&e.translate(0,t.bodyBob);const a=t.breathingOffset||0,i=t.chestExpansion||1;e.fillStyle=t.colors.primary,e.beginPath(),e.ellipse(0,a,.35*t.width*i,.25*t.height,0,0,2*Math.PI),e.fill();const n=a+(t.bellyOffset||0);e.fillStyle=t.colors.belly,e.beginPath(),e.ellipse(0,n+.1*t.height,.3*t.width,.15*t.height,0,0,Math.PI),e.fill(),t.furMovement&&this.drawAnimatedFur(e,t,0,a,.35*t.width,.25*t.height),e.restore()}drawAnimatedNeck(e,t){e.save(),t.headBob&&e.translate(0,.5*t.headBob),e.fillStyle=t.colors.primary,e.beginPath(),e.moveTo(.15*t.width,.1*-t.height),e.quadraticCurveTo(.25*t.width,.05*-t.height,.3*t.width,.15*-t.height),e.quadraticCurveTo(.25*t.width,.05*t.height,.15*t.width,.1*t.height),e.fill(),e.restore()}drawAnimatedHead(e,t){e.save(),e.translate(.35*t.width,.15*-t.height),t.headTilt&&e.rotate(t.headTilt),t.headShake&&e.translate(t.headShake,0),t.headScan&&e.rotate(t.headScan),t.headBob&&e.translate(0,t.headBob),e.fillStyle=t.colors.primary,e.beginPath(),e.moveTo(0,0),e.quadraticCurveTo(10,-5,15,0),e.quadraticCurveTo(20,3,25,5),e.lineTo(28,8),e.quadraticCurveTo(25,10,20,10),e.quadraticCurveTo(10,8,0,10),e.quadraticCurveTo(-5,5,0,0),e.fill(),this.drawAnimatedEars(e,t),this.drawAnimatedMouth(e,t),this.drawAnimatedEyes(e,t),void 0!==t.soundWavePhase&&this.drawSoundWaves(e,t),e.restore()}drawAnimatedEars(e,t){const a=t.earRotation||0,i=t.earAlertness||0;e.save(),e.translate(5,-3),e.rotate(a-.1*i),e.fillStyle=t.colors.primary,e.beginPath(),e.moveTo(0,0),e.lineTo(-3,-8-2*i),e.lineTo(3,-8-2*i),e.closePath(),e.fill(),e.fillStyle=t.colors.belly,e.beginPath(),e.moveTo(0,-2),e.lineTo(-1,-6-i),e.lineTo(1,-6-i),e.closePath(),e.fill(),e.restore(),e.save(),e.translate(8,-2),e.rotate(a+.1*i),e.fillStyle=t.colors.secondary,e.beginPath(),e.moveTo(0,0),e.lineTo(-2,-7-2*i),e.lineTo(3,-7-2*i),e.closePath(),e.fill(),e.restore()}drawAnimatedMouth(e,t){const a=t.mouthOpen||t.jawOpen||0,i=t.mouthVibration||0;e.fillStyle=t.colors.secondary,e.beginPath(),e.moveTo(20,5),e.quadraticCurveTo(25,6,28,8),e.quadraticCurveTo(25,9+3*a,20,9+3*a),e.fill(),a>0&&(e.fillStyle="rgba(0, 0, 0, 0.7)",e.beginPath(),e.moveTo(20,9),e.quadraticCurveTo(24,9+5*a+i,28,9+3*a+i),e.quadraticCurveTo(24,11+5*a+i,20,11+5*a),e.fill(),(t.teethVisible||a>.5)&&(e.fillStyle="#ffffff",e.beginPath(),e.moveTo(22,9),e.lineTo(21,11+2*a),e.lineTo(23,11+2*a),e.closePath(),e.fill(),e.beginPath(),e.moveTo(25,9),e.lineTo(24,11+2*a),e.lineTo(26,11+2*a),e.closePath(),e.fill(),a>.7&&(e.beginPath(),e.moveTo(23,11+4*a),e.lineTo(22,9+4*a),e.lineTo(24,9+4*a),e.closePath(),e.fill())),a>.3&&"attacking"!==t.state&&(e.fillStyle="rgba(255, 100, 100, 0.8)",e.beginPath(),e.ellipse(24,10+3*a,3,2+2*a,.2,0,Math.PI),e.fill())),e.fillStyle=t.colors.nose,e.beginPath(),e.arc(28,8,2,0,2*Math.PI),e.fill()}drawAnimatedEyes(e,t){if(t.isBlinking)return e.strokeStyle=t.colors.secondary,e.lineWidth=2,e.beginPath(),e.moveTo(10,3),e.lineTo(16,3),void e.stroke();"prowling"!==t.state&&"lunging"!==t.state&&"attacking"!==t.state||(e.shadowColor=t.colors.eyes,e.shadowBlur=8),e.fillStyle="#ffffff",e.beginPath(),e.ellipse(12,3,4,3,-.2,0,2*Math.PI),e.fill();const a="attacking"===t.state?.7:"prowling"===t.state?.5:.3;e.fillStyle=t.colors.eyes,e.beginPath(),e.arc(13,3,2,0,2*Math.PI),e.fill(),e.fillStyle="#000000",e.beginPath(),e.arc(13.5,3,1*(1-a),0,2*Math.PI),e.fill(),e.fillStyle="rgba(255, 255, 255, 0.7)",e.beginPath(),e.arc(12,2,.5,0,2*Math.PI),e.fill(),e.shadowBlur=0}drawAnimatedFur(e,t,a,i,n,l){e.strokeStyle=t.colors.secondary,e.lineWidth=.5,e.globalAlpha=.4;const o=t.furRipple||0,s=t.furMovement?.flow||0,r=t.furMovement?.ruffled||!1;for(let h=0;h<12;h++){const c=h/12*Math.PI*2,d=a+Math.cos(c)*n*.7,u=i+Math.sin(c)*l*.7,m=Math.sin(.01*t.animationTime+h)*o*10,f=Math.cos(.01*t.animationTime+h)*o*5;e.beginPath(),e.moveTo(d,u),r?e.lineTo(d+8*Math.cos(c)+m,u+8*Math.sin(c)+f):e.quadraticCurveTo(d+4*Math.cos(c)+.5*m,u+4*Math.sin(c)+.5*f,d+6*Math.cos(c+s)+m,u+6*Math.sin(c+s)+f),e.stroke()}e.globalAlpha=1}drawSoundWaves(e,t){e.save(),e.globalAlpha=.3,e.strokeStyle=t.colors.eyes,e.lineWidth=2;for(let a=0;a<3;a++){const i=t.soundWavePhase+a*Math.PI/3,n=10+Math.sin(i)*t.soundWaveAmplitude+15*a,l=.3-.1*a;e.globalAlpha=l,e.beginPath(),e.arc(30,5,n,-Math.PI/3,Math.PI/3),e.stroke()}e.restore()}drawWolfUI(e,t){if(t.isAlpha||t.health<t.maxHealth){e.save(),e.scale(1/t.size,1/t.size);const a=60,i=6,n=.5*-t.height-20;e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(-a/2,n,a,i);const l=t.health/t.maxHealth;e.fillStyle=l>.5?"#4caf50":l>.25?"#ff9800":"#f44336",e.fillRect(-a/2,n,a*l,i),e.strokeStyle=t.isAlpha?"#ffd700":"#ffffff",e.lineWidth=1,e.strokeRect(-a/2,n,a,i),t.isAlpha&&(e.font="12px Arial",e.textAlign="center",e.fillText("👑",0,n-5)),"prowling"===t.state?e.fillText("👁",-35,n+5):"howling"===t.state&&e.fillText("🔊",-35,n+5),e.restore()}if(t.lungeState?.charging){e.save(),e.globalAlpha=.7;const a=t.lungeState.chargeTime/t.lungeState.maxChargeTime,i=15;e.strokeStyle=`hsl(${60*a}, 100%, 50%)`,e.lineWidth=3,e.beginPath(),e.arc(0,.7*-t.height,i,-Math.PI/2,-Math.PI/2+2*Math.PI*a),e.stroke(),a>=1&&(e.globalAlpha=.3+.3*Math.sin(.01*t.animationTime),e.strokeStyle="#ff0000",e.beginPath(),e.arc(0,.7*-t.height,i+5,0,2*Math.PI),e.stroke()),e.restore()}}}export{t as WolfAnimationSystem,t as default};