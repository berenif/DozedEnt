const t=t=>!Number.isFinite(t)||t<=0?0:t>10?t:1e3*t;class e{constructor(t,e,i,s,a=100){this.x=t,this.y=e,this.width=i,this.height=s,this.duration=a}}class i{constructor(t,e,i={}){this.name=t,this.frames=e,this.loop=null===i.loop||void 0===i.loop||i.loop,this.pingPong=i.pingPong||!1,this.speed=i.speed||1,this.onComplete=i.onComplete||null,this.onFrame=i.onFrame||null,this.currentFrame=0,this.elapsedTime=0,this.direction=1,this.isPlaying=!1,this.hasCompleted=!1}play(){this.isPlaying=!0,this.hasCompleted=!1,this.currentFrame=0,this.elapsedTime=0,this.direction=1}stop(){this.isPlaying=!1,this.reset()}pause(){this.isPlaying=!1}resume(){this.isPlaying=!0}reset(){this.currentFrame=0,this.elapsedTime=0,this.direction=1,this.hasCompleted=!1}update(e){if(!this.isPlaying||0===this.frames.length)return;const i=t(e)*this.speed;if(i<=0)return;if(this.elapsedTime+=i,this.frames.length<=1){const t=this.frames[0];return t?t.duration<=0?(this.loop||(this.isPlaying=!1,this.hasCompleted=!0,this.onComplete&&this.onComplete()),void(this.elapsedTime=0)):void(this.elapsedTime>=t.duration&&(this.loop?this.elapsedTime=this.elapsedTime%t.duration:(this.currentFrame=0,this.isPlaying=!1,this.hasCompleted=!0,this.elapsedTime=0,this.onComplete&&this.onComplete()))):void(this.elapsedTime=0)}const s=3*this.frames.length;let a=0;for(;a<s;){const t=this.frames[this.currentFrame];if(!t){this.currentFrame=Math.min(Math.max(this.currentFrame,0),this.frames.length-1),this.elapsedTime=0;break}if(t.duration<=0){this.loop||this.currentFrame!==this.frames.length-1||(this.isPlaying=!1,this.hasCompleted=!0,this.onComplete&&this.onComplete()),this.elapsedTime=0;break}if(this.elapsedTime<t.duration)break;this.elapsedTime-=t.duration;const e=this.currentFrame;if(this.currentFrame+=this.direction,this.pingPong)(this.currentFrame>=this.frames.length||this.currentFrame<0)&&(this.direction*=-1,this.currentFrame=e+this.direction);else if(this.currentFrame>=this.frames.length){if(!this.loop){if(this.currentFrame=this.frames.length-1,this.isPlaying=!1,this.hasCompleted=!0,this.elapsedTime=0,this.onComplete&&this.onComplete(),this.onFrame&&this.currentFrame!==e){const t=this.frames[this.currentFrame];t&&this.onFrame(this.currentFrame,t)}break}this.currentFrame=0}else this.currentFrame<0&&(this.currentFrame=this.loop?this.frames.length-1:0);if(this.onFrame&&this.currentFrame!==e){const t=this.frames[this.currentFrame];t&&this.onFrame(this.currentFrame,t)}a+=1}}getCurrentFrame(){return 0===this.frames.length||this.currentFrame<0||this.currentFrame>=this.frames.length?null:this.frames[this.currentFrame]}getProgress(){return this.frames.length<=1?0:this.currentFrame/(this.frames.length-1)}getFrameAt(t){return t<0||t>=this.frames.length?null:this.frames[t]}}class s{constructor(){this.animations=Object.create(null),this._animationMap=new Map,this.currentAnimation=null,this.blendTime=0,this.blendFrom=null,this.blendProgress=0,this.isTransitioning=!1,this.transitionDuration=0}addAnimation(t,e){let i=null,s=null;"string"==typeof t&&e?(i=t,s=e):(s=t,s&&"string"==typeof s.name&&(i=s.name)),i&&s&&(this.animations[i]=s,this._animationMap.set(i,s))}getAnimation(t){return t&&(this._animationMap.get(t)||this.animations[t])||null}play(e,i={}){const s=this.getAnimation(e);if(!s)return;const a=!!this.currentAnimation,n=i.transition,r="number"==typeof i.transitionDuration?i.transitionDuration:0;let o=0;"number"==typeof n&&n>0?o=n:(!0===n||r>0)&&r>0?o=r:!0===n&&0===r?o=150:r>0&&(o=r);const h=t(o);a&&h>0?(this.blendFrom=this.currentAnimation,this.blendTime=h,this.blendProgress=0,this.isTransitioning=!0,this.transitionDuration=h):(this.blendFrom=null,this.blendTime=0,this.blendProgress=0,this.isTransitioning=!1,this.transitionDuration=0),this.currentAnimation=s,s.play()}stop(){this.currentAnimation&&this.currentAnimation.stop(),this.isTransitioning=!1,this.blendTime=0,this.blendFrom=null,this.blendProgress=0,this.transitionDuration=0}update(e){const i=t(e);this.blendTime>0&&i>0&&(this.blendProgress+=i,this.blendProgress>=this.blendTime&&(this.blendTime=0,this.blendFrom=null,this.blendProgress=0,this.isTransitioning=!1,this.transitionDuration=0)),this.currentAnimation&&this.currentAnimation.update(e)}getCurrentFrame(){return this.currentAnimation?this.currentAnimation.getCurrentFrame():null}getBlendFrames(){if(0===this.blendTime||!this.blendFrom)return{current:this.getCurrentFrame(),blend:null,blendFactor:0};const t=this.blendTime>0?Math.min(1,this.blendProgress/this.blendTime):0;return{current:this.currentAnimation?this.currentAnimation.getCurrentFrame():null,blend:this.blendFrom?this.blendFrom.getCurrentFrame():null,blendFactor:t}}isPlaying(t){return this.currentAnimation&&this.currentAnimation.name===t&&this.currentAnimation.isPlaying}setSpeed(t){this.currentAnimation&&(this.currentAnimation.speed=t)}}class a{constructor(){this.animations=Object.create(null)}addAnimation(t,e,i={}){if(!t||"function"!=typeof e)return null;const s={name:t,update:e,duration:"number"==typeof i.duration?i.duration:null,loop:void 0===i.loop||i.loop,isPlaying:void 0===i.autoStart||!1!==i.autoStart,elapsed:0,meta:i.meta??null};return this.animations[t]=s,s}play(t){const e=this.animations[t];e&&(e.isPlaying=!0,e.elapsed=0)}stop(t){const e=this.animations[t];e&&(e.isPlaying=!1,e.elapsed=0)}update(t){const e=Number.isFinite(t)?t:0;for(const t of Object.values(this.animations))t&&!1!==t.isPlaying&&"function"==typeof t.update&&(t.elapsed+=e,t.update(e,t),t.duration&&t.duration>0&&t.elapsed>=t.duration&&(t.loop?t.elapsed=t.elapsed%t.duration:t.isPlaying=!1))}createBreathingAnimation(t={}){const{baseScale:e=1,intensity:i=.015,speed:s=2,asymmetry:a=.2}=t;return{time:0,phase:0,breathRate:s,currentIntensity:i,depthMod:1,asymmetryOffset:0,_buf:{scaleX:e,scaleY:e,offsetY:0,chestExpansion:0,phase:0,intensity:0},modulateForState(t){switch(t){case"running":this.depthMod=.3,this.breathRate=3*s;break;case"attacking":this.depthMod=.5,this.breathRate=1.8*s;break;case"blocking":this.depthMod=.2,this.breathRate=1.3*s;break;case"hurt":this.depthMod=.1,this.breathRate=.5*s;break;case"dead":this.depthMod=0,this.breathRate=0;break;default:this.depthMod=1,this.breathRate=s}},update(t){const i=this._buf;if(this.breathRate<=0)return i.scaleX=e,i.scaleY=e,i.offsetY=0,i.chestExpansion=0,i.phase=0,i.intensity=0,i;this.time+=t*this.breathRate,this.phase=Math.sin(this.time);const s=this.currentIntensity*this.depthMod,n=e+this.phase*s,r=e+this.phase*s*.7,o=n+Math.sin(.7*this.time)*a*s*.3,h=this.phase*s*2,l=1-Math.exp(5*-t);return this.currentIntensity=this.currentIntensity+(s-this.currentIntensity)*l,i.scaleX=o,i.scaleY=r,i.offsetY=.5*-h,i.chestExpansion=h,i.phase=this.phase,i.intensity=s,i}}}createBobbingAnimation(t=5,e=2){return{time:0,_buf:{offsetY:0,rotation:0},update(i){this.time+=i*e;const s=this._buf;return s.offsetY=Math.sin(this.time)*t,s.rotation=.05*Math.sin(.5*this.time),s}}}createSquashStretch(t=.3,e=.2){return{time:0,active:!1,_buf:{scaleX:1,scaleY:1},trigger(){this.time=0,this.active=!0},update(i){const s=this._buf;if(!this.active)return s.scaleX=1,s.scaleY=1,s;this.time+=i;const a=Math.min(this.time/e,1);if(a>=1)return this.active=!1,s.scaleX=1,s.scaleY=1,s;const n=2**(-10*a)*Math.sin(2*Math.PI*(a-.075)/.3)+1,r=1-n*t,o=1+n*t*.5;return s.scaleX=a<.5?o:r,s.scaleY=a<.5?r:o,s}}}createWobble(t=10,e=.8,i=.1){return{velocity:0,displacement:0,_buf:{scaleX:1,scaleY:1,rotation:0},update(s,a=0){const n=-t*this.displacement,r=-e*this.velocity;this.velocity+=(n+r+a)*s,this.displacement+=this.velocity*s;const o=this._buf;return o.scaleX=1+this.displacement*i,o.scaleY=1-this.displacement*i*.5,o.rotation=.1*this.displacement,o},impulse(t){this.velocity+=t}}}createAnticipation(t=.3,e=.15){return{time:0,active:!1,phase:"idle",_buf:{scaleX:1,scaleY:1,offsetX:0},trigger(){this.time=0,this.active=!0,this.phase="anticipation"},update(i){const s=this._buf;if(!this.active)return s.scaleX=1,s.scaleY=1,s.offsetX=0,s;if(this.time+=i,"anticipation"===this.phase){const i=Math.min(this.time/(.4*t),1),a=1-Math.cos(i*Math.PI*.5);return i>=1&&(this.phase="action",this.time=0),s.scaleX=1-a*e,s.scaleY=1+a*e*.5,s.offsetX=10*-a,s}if("action"===this.phase){const i=Math.min(this.time/(.2*t),1),a=Math.sin(i*Math.PI*.5);return i>=1&&(this.phase="recovery",this.time=0),s.scaleX=1+a*e*2,s.scaleY=1-a*e,s.offsetX=20*a,s}if("recovery"===this.phase){const i=Math.min(this.time/(.4*t),1),a=1-(1-i)**3;return i>=1&&(this.active=!1,this.phase="idle"),s.scaleX=1+(1-a)*e*.5,s.scaleY=1-(1-a)*e*.25,s.offsetX=10*(1-a),s}return s.scaleX=1,s.scaleY=1,s.offsetX=0,s}}}createAdvancedIK(t={}){const{armLength:e=25,forearmLength:i=20,damping:s=.8,stiffness:a=.5,maxReach:n=40}=t;return{shoulder:{x:0,y:0},elbow:{x:0,y:0},hand:{x:0,y:0},target:{x:0,y:0},targetVelocity:{x:0,y:0},_buf:{shoulder:{x:0,y:0},elbow:{x:0,y:0},hand:{x:0,y:0},target:{x:0,y:0},reach:0,stiffness:0},solveIK(t,s,a,r){this.target.x=t,this.target.y=s,this.shoulder.x=a,this.shoulder.y=r;const o=t-a,h=s-r,l=Math.sqrt(o*o+h*h),c=Math.min(l,n),m=c/l,g=a+o*m,u=r+h*m,d=e+i,p=Math.acos(Math.max(-1,Math.min(1,c/d))),f=Math.atan2(u-r,g-a);this.elbow.x=a+Math.cos(f-.5*p)*e,this.elbow.y=r+Math.sin(f-.5*p)*e,this.hand.x=this.elbow.x+Math.cos(f+.5*p)*i,this.hand.y=this.elbow.y+Math.sin(f+.5*p)*i;const y=this._buf;return y.shoulder.x=this.shoulder.x,y.shoulder.y=this.shoulder.y,y.elbow.x=this.elbow.x,y.elbow.y=this.elbow.y,y.hand.x=this.hand.x,y.hand.y=this.hand.y,y.target.x=g,y.target.y=u,y.reach=c/d,y},update(t,e,i,n,r){const o=e+this.targetVelocity.x*t*.1,h=i+this.targetVelocity.y*t*.1;this.targetVelocity.x=(o-this.target.x)/t*s,this.targetVelocity.y=(h-this.target.y)/t*s;const l=this.solveIK(o,h,n,r),c=1-Math.exp(-a*t),m=this._buf;return m.shoulder.x=l.shoulder.x,m.shoulder.y=l.shoulder.y,m.elbow.x=l.elbow.x,m.elbow.y=l.elbow.y,m.hand.x=l.hand.x,m.hand.y=l.hand.y,m.target.x=l.target.x,m.target.y=l.target.y,m.reach=l.reach,m.stiffness=c,m}}}createSecondaryMotion(t={}){const{segments:e=5,length:i=15,damping:s=.85,gravity:a=.5,windStrength:n=.1}=t;return{segments:[],anchorPoint:{x:0,y:0},windTime:0,_segBuf:[],initialize(t,s){this.anchorPoint={x:t,y:s},this.segments=[];for(let a=0;a<e;a++)this.segments.push({x:t,y:s+a*(i/e),vx:0,vy:0,prevX:t,prevY:s+a*(i/e)})},update(t,r,o,h=0){this.anchorPoint.x=r,this.anchorPoint.y=o,this.windTime+=t,this.segments[0].x=r,this.segments[0].y=o;for(let r=1;r<this.segments.length;r++){const o=this.segments[r],l=this.segments[r-1],c=o.x-l.x,m=o.y-l.y,g=Math.sqrt(c*c+m*m);if(g>0){const t=i/e/g;o.x=l.x+c*t,o.y=l.y+m*t}o.vy+=a*t;const u=Math.sin(2*this.windTime+h)*n,d=Math.cos(1.5*this.windTime+h)*n*.5;o.vx+=u*t,o.vy+=d*t;const p=o.x,f=o.y;o.x+=(o.x-o.prevX)*s+o.vx*t,o.y+=(o.y-o.prevY)*s+o.vy*t,o.prevX=p,o.prevY=f,o.vx*=s,o.vy*=s}this._segBuf&&this._segBuf.length===this.segments.length||(this._segBuf=Array(this.segments.length));for(let t=0;t<this.segments.length;t++)this._segBuf[t]=this.segments[t];return this._segBuf},applyForce(t,e,i=-1){-1===i?this.segments.forEach(i=>{i.vx+=t,i.vy+=e}):i<this.segments.length&&(this.segments[i].vx+=t,this.segments[i].vy+=e)}}}createMomentumSystem(t={}){const{maxMomentum:e=10,momentumDecay:i=.9,momentumInfluence:s=.3,directionSmoothing:a=.8}=t;return{momentum:{x:0,y:0},smoothedDirection:{x:0,y:0},lastVelocity:{x:0,y:0},_buf:{momentum:{x:0,y:0},smoothedDirection:{x:0,y:0},leanAngle:0,bounceFactor:0,stretchFactor:0},update(t,n,r,o=!0){const h=n-this.lastVelocity.x,l=r-this.lastVelocity.y;this.lastVelocity={x:n,y:r};const c=Math.sqrt(h*h+l*l);if(c>.1){const t=Math.min(c*s,e),i=h/c,a=l/c;this.momentum.x+=i*t,this.momentum.y+=a*t}this.momentum.x*=i,this.momentum.y*=i;const m=Math.sqrt(this.momentum.x*this.momentum.x+this.momentum.y*this.momentum.y);m>e&&(this.momentum.x=this.momentum.x/m*e,this.momentum.y=this.momentum.y/m*e);const g=n,u=r,d=Math.sqrt(g*g+u*u);if(d>.1){const t={x:g/d,y:u/d};this.smoothedDirection.x=this.smoothedDirection.x*(1-a)+t.x*a,this.smoothedDirection.y=this.smoothedDirection.y*(1-a)+t.y*a}const p=this._buf;return p.momentum.x=this.momentum.x,p.momentum.y=this.momentum.y,p.smoothedDirection.x=this.smoothedDirection.x,p.smoothedDirection.y=this.smoothedDirection.y,p.leanAngle=o?.3*Math.atan2(this.momentum.x,Math.abs(this.momentum.y)+1):0,p.bounceFactor=.1*m,p.stretchFactor=Math.max(0,.05*m),p},addImpulse(t,e){this.momentum.x+=t,this.momentum.y+=e}}}createTrailEffect(t=5,e=.3){return{trails:[],lastPosition:null,update(i,s){if(this.trails=this.trails.filter(t=>(t.alpha-=e*i,t.alpha>0)),this.lastPosition){const e=s.x-this.lastPosition.x,i=s.y-this.lastPosition.y;Math.sqrt(e*e+i*i)>10&&(this.trails.push({x:this.lastPosition.x,y:this.lastPosition.y,alpha:.5,scale:.8}),this.trails.length>t&&this.trails.shift(),this.lastPosition={...s})}else this.lastPosition={...s};return this.trails},clear(){this.trails=[]}}}}class n{constructor(){this.controller=new s,this.procedural=new a,this.animations=Object.create(null),this.currentAnimation=null,this.eventSystem=null,this.eventListeners=new Map,this.breathing=this.procedural.createBreathingAnimation({intensity:.012,speed:1.8,asymmetry:.15}),this.squashStretch=this.procedural.createSquashStretch(),this.wobble=this.procedural.createWobble(),this.anticipation=this.procedural.createAnticipation(),this.trail=this.procedural.createTrailEffect(),this.advancedIK=this.procedural.createAdvancedIK({armLength:22,forearmLength:18,damping:.75,stiffness:.4}),this.secondaryMotion=this.procedural.createSecondaryMotion({segments:4,length:12,damping:.82,stiffness:.25,gravity:.3,windStrength:.08}),this.momentumSystem=this.procedural.createMomentumSystem({maxMomentum:8,momentumDecay:.88,momentumInfluence:.25,directionSmoothing:.75}),this.state=0,this.stateName="idle",this.facing="right",this.moving=!1,this.attacking=!1,this.blocking=!1,this.rolling=!1,this.hurt=!1,this.jumping=!1,this.doubleJumping=!1,this.wallSliding=!1,this.dashing=!1,this.charging=!1,this.dead=!1,this.landing=!1,this.blendFactors={idle:1,running:0,attacking:0,blocking:0,rolling:0,hurt:0,jumping:0,doubleJumping:0,landing:0,wallSliding:0,dashing:0,chargingAttack:0,dead:0},this.targetBlendFactors={...this.blendFactors},this.blendSpeed=.2,this.hurtTimer=0,this.attackTimer=0,this.rollTimer=0}resetActionTimers(){this.hurtTimer=0,this.attackTimer=0,this.rollTimer=0}addAnimation(t,e){if(!e)return;const i=t||e&&e.name;i&&(this.animations[i]=e,this.controller.addAnimation(i,e))}play(t,e={}){t&&this.animations[t]&&(this.controller.play(t,e),this.currentAnimation=this.controller.currentAnimation,"string"==typeof t&&(this.stateName=t))}getAnimStateName(t){switch(t){case 0:default:return"idle";case 1:return"running";case 2:return"attacking";case 3:return"blocking";case 4:return"rolling";case 5:return"hurt";case 6:return"dead";case 7:return"jumping";case 8:return"doubleJumping";case 9:return"landing";case 10:return"wallSliding";case 11:return"dashing";case 12:return"chargingAttack"}}setAnimState(t){if(this.state===t)return;this.resetActionTimers();const e=this.state,i=this.stateName;switch(this.state=t,this.stateName=this.getAnimStateName(t),this.emit("stateChange",{fromState:e,toState:t,fromStateName:i,toStateName:this.stateName}),Object.keys(this.targetBlendFactors).forEach(t=>{this.targetBlendFactors[t]=0}),this.targetBlendFactors[this.stateName]=1,this.play(this.stateName,{transition:.1}),t){case 2:this.anticipation.trigger();break;case 5:this.squashStretch.trigger(),this.wobble.impulse(10);break;case 4:case 11:this.trail.clear();break;case 7:this.squashStretch.trigger();break;case 8:this.wobble.impulse(5),this.trail.clear();break;case 9:this.squashStretch.trigger(),this.wobble.impulse(15);break;case 12:this.anticipation.trigger(),this.wobble.impulse(3);break;case 6:this.squashStretch.trigger(),this.wobble.impulse(20)}}update(t,e,i={x:0,y:0},s=!0){this.hurtTimer>0&&(this.hurtTimer-=t,this.hurtTimer<=0&&5===this.state&&this.setAnimState(0)),this.attackTimer>0&&(this.attackTimer-=t,this.attackTimer<=0&&2===this.state&&this.setAnimState(0)),this.rollTimer>0&&(this.rollTimer-=t,this.rollTimer<=0&&4===this.state&&this.setAnimState(0)),this.controller.update(t),Object.keys(this.blendFactors).forEach(t=>{const e=this.targetBlendFactors[t]-this.blendFactors[t];this.blendFactors[t]+=e*this.blendSpeed}),this.breathing.modulateForState(this.stateName);const a=this.breathing.update(t),n=this.momentumSystem.update(t,i.x,i.y,s);0===this.secondaryMotion.segments.length&&this.secondaryMotion.initialize(e.x,e.y-8);const r=this.secondaryMotion.update(t,e.x,e.y-8),o=this.squashStretch.update(t),h=this.wobble.update(t),l=this.anticipation.update(t),c={scaleX:1,scaleY:1,rotation:0,offsetX:0,offsetY:0,trails:this.trail.update(t,e),secondaryMotion:r,momentum:n,ik:null};return(this.blendFactors.idle>0||this.blendFactors.running>0)&&(c.scaleX*=a.scaleX,c.scaleY*=a.scaleY,c.offsetY+=a.offsetY),c.rotation+=n.leanAngle,c.scaleY*=1+n.stretchFactor,c.offsetY+=n.bounceFactor*Math.sin(.01*Date.now()),c.scaleX*=o.scaleX,c.scaleY*=o.scaleY,c.scaleX*=h.scaleX,c.scaleY*=h.scaleY,c.rotation+=h.rotation,"attacking"!==this.stateName&&"chargingAttack"!==this.stateName||(c.scaleX*=l.scaleX,c.scaleY*=l.scaleY,c.offsetX+=l.offsetX),"left"===this.facing&&(c.scaleX*=-1),c}setFacing(t){this.facing=t}setEventSystem(t){this.eventSystem=t}on(t,e,i=null){this.eventListeners.has(t)||this.eventListeners.set(t,new Set);const s={callback:e,context:i,once:!1};return this.eventListeners.get(t).add(s),this.eventSystem?this.eventSystem.on(t,e,i):()=>this.off(t,e)}once(t,e,i=null){this.eventListeners.has(t)||this.eventListeners.set(t,new Set);const s={callback:e,context:i,once:!0};return this.eventListeners.get(t).add(s),this.eventSystem?this.eventSystem.once(t,e,i):()=>this.off(t,e)}off(t,e){if(!this.eventListeners.has(t))return!1;const i=this.eventListeners.get(t);for(const t of i)if(t.callback===e){i.delete(t);break}return 0===i.size&&this.eventListeners.delete(t),this.eventSystem&&this.eventSystem.off(t,e),!0}emit(t,e={}){if(this.eventListeners.has(t)){const i=Array.from(this.eventListeners.get(t));for(const s of i)try{s.context?s.callback.call(s.context,e):s.callback(e),s.once&&this.eventListeners.get(t).delete(s)}catch(e){console.error(`Error in animation event listener for ${t}:`,e)}}this.eventSystem&&this.eventSystem.emit(t,e)}triggerHurt(){this.setAnimState(5),this.hurtTimer=300,this.emit("hurt",{timer:this.hurtTimer})}triggerAttack(){this.setAnimState(2),this.attackTimer=400,this.emit("attack",{timer:this.attackTimer})}triggerRoll(){this.setAnimState(4),this.rollTimer=400,this.emit("roll",{timer:this.rollTimer})}triggerBlock(){this.setAnimState(3),this.emit("block")}releaseBlock(){3===this.state&&(this.setAnimState(0),this.emit("blockRelease"))}setMoving(t){this.moving=t,t&&0===this.state?this.setAnimState(1):t||1!==this.state||this.setAnimState(0)}}const r={playerWalk:{frameCount:6,frameDuration:100,loop:!0},playerRun:{frameCount:6,frameDuration:80,loop:!0},playerJump:{frameCount:3,frameDuration:100,loop:!1},wolfWalk:{frameCount:4,frameDuration:150,loop:!0},wolfRun:{frameCount:6,frameDuration:100,loop:!0},wolfAttack:{frameCount:5,frameDuration:80,loop:!1},createPlayerAnimations:()=>({idle:new i("idle",[new e(0,0,32,32,200),new e(32,0,32,32,200),new e(64,0,32,32,200),new e(96,0,32,32,200)]),running:new i("running",[new e(0,32,32,32,100),new e(32,32,32,32,100),new e(64,32,32,32,100),new e(96,32,32,32,100),new e(128,32,32,32,100),new e(160,32,32,32,100)]),attacking:new i("attacking",[new e(0,64,32,32,50),new e(32,64,32,32,50),new e(64,64,32,32,100),new e(96,64,32,32,50)],{loop:!1}),blocking:new i("blocking",[new e(0,96,32,32,100)],{loop:!1}),rolling:new i("rolling",[new e(0,128,32,32,50),new e(32,128,32,32,50),new e(64,128,32,32,50),new e(96,128,32,32,50)],{loop:!1}),hurt:new i("hurt",[new e(0,160,32,32,100),new e(32,160,32,32,100)],{loop:!1}),dead:new i("dead",[new e(0,192,32,32,100),new e(32,192,32,32,100),new e(64,192,32,32,100),new e(96,192,32,32,200),new e(128,192,32,32,-1)],{loop:!1}),jumping:new i("jumping",[new e(0,224,32,32,100),new e(32,224,32,32,100),new e(64,224,32,32,-1)],{loop:!1}),doubleJumping:new i("doubleJumping",[new e(0,256,32,32,50),new e(32,256,32,32,50),new e(64,256,32,32,50),new e(96,256,32,32,50),new e(128,256,32,32,50),new e(160,256,32,32,50),new e(192,256,32,32,50),new e(224,256,32,32,-1)],{loop:!1}),landing:new i("landing",[new e(0,288,32,32,50),new e(32,288,32,32,50),new e(64,288,32,32,100)],{loop:!1}),wallSliding:new i("wallSliding",[new e(0,320,32,32,100),new e(32,320,32,32,100)],{loop:!0}),dashing:new i("dashing",[new e(0,352,32,32,50),new e(32,352,32,32,50),new e(64,352,32,32,100),new e(96,352,32,32,50)],{loop:!1}),chargingAttack:new i("chargingAttack",[new e(0,384,32,32,100),new e(32,384,32,32,100),new e(64,384,32,32,100),new e(96,384,32,32,50),new e(128,384,32,32,50),new e(160,384,32,32,100)],{loop:!1})}),createWolfAnimations:()=>({idle:new i("idle",[new e(0,0,48,32,300),new e(48,0,48,32,300)]),prowl:new i("prowl",[new e(0,32,48,32,150),new e(48,32,48,32,150),new e(96,32,48,32,150),new e(144,32,48,32,150)]),lunge:new i("lunge",[new e(0,64,48,32,50),new e(48,64,48,32,100),new e(96,64,48,32,50)],{loop:!1}),hurt:new i("hurt",[new e(0,96,48,32,100)],{loop:!1}),howl:new i("howl",[new e(0,128,48,32,200),new e(48,128,48,32,300),new e(96,128,48,32,400),new e(144,128,48,32,300),new e(192,128,48,32,200)],{loop:!1}),death:new i("death",[new e(0,160,48,32,100),new e(48,160,48,32,100),new e(96,160,48,32,100),new e(144,160,48,32,200),new e(192,160,48,32,-1)],{loop:!1}),packRun:new i("packRun",[new e(0,192,48,32,80),new e(48,192,48,32,80),new e(96,192,48,32,80),new e(144,192,48,32,80),new e(192,192,48,32,80),new e(240,192,48,32,80)],{loop:!0})}),createEffectAnimations:()=>({explosion:new i("explosion",[new e(0,0,64,64,50),new e(64,0,64,64,50),new e(128,0,64,64,50),new e(192,0,64,64,50),new e(256,0,64,64,50)],{loop:!1}),spark:new i("spark",[new e(0,64,32,32,30),new e(32,64,32,32,30),new e(64,64,32,32,30)],{loop:!1}),projectileSpawn:new i("projectileSpawn",[new e(0,128,16,16,30),new e(16,128,16,16,30),new e(32,128,16,16,30)],{loop:!1}),projectileImpact:new i("projectileImpact",[new e(0,144,32,32,40),new e(32,144,32,32,40),new e(64,144,32,32,40),new e(96,144,32,32,40)],{loop:!1}),itemPickup:new i("itemPickup",[new e(0,176,32,32,50),new e(32,176,32,32,50),new e(64,176,32,32,50),new e(96,176,32,32,50),new e(128,176,32,32,50)],{loop:!1}),powerUp:new i("powerUp",[new e(0,208,64,64,60),new e(64,208,64,64,60),new e(128,208,64,64,60),new e(192,208,64,64,60),new e(256,208,64,64,60),new e(320,208,64,64,60)],{loop:!1})})};class o{constructor(t=o.createDefaultPose()){this.pose=o.clonePose(t)}static createDefaultPose(){return{root:{x:0,y:0},pelvis:{x:0,y:0},torso:{x:0,y:-14},head:{x:0,y:-26},leftArm:{shoulder:{x:-7,y:-17},elbow:{x:-11,y:-9},hand:{x:-14,y:0}},rightArm:{shoulder:{x:7,y:-17},elbow:{x:11,y:-9},hand:{x:14,y:0}},leftLeg:{hip:{x:-4,y:0},knee:{x:-5,y:10},foot:{x:-6,y:21}},rightLeg:{hip:{x:4,y:0},knee:{x:5,y:10},foot:{x:6,y:21}}}}static clonePose(t){const e=t=>{const i={};return Object.entries(t).forEach(([t,s])=>{i[t]=s&&"object"==typeof s&&"x"in s?{x:s.x,y:s.y}:s&&"object"==typeof s?e(s):s}),i};return e(t)}createWorkingPose(){return o.clonePose(this.pose)}commitPose(t){this.pose=o.clonePose(t)}toSkeleton(){return this.createWorkingPose()}}const h=(t,e,i)=>Math.min(i,Math.max(e,t)),l=(t,e,i,s)=>{const a=Math.exp(-s*i);return t*a+e*(1-a)};class c{constructor(t={}){this.config={maxLean:t.maxLean??.35,pelvisBobAmplitude:t.pelvisBobAmplitude??3,headStabilization:t.headStabilization??.55,leanResponsiveness:t.leanResponsiveness??10,bobResponsiveness:t.bobResponsiveness??14},this.lean=0,this.pelvisOffset=0,this.breathTimer=0}apply(t,e,i){const s=i.velocity||{x:0},a=i.facing??1,n=i.maxSpeed??240,r=i.normalizedTime??0,o=i.isGrounded??!0,c=i.pelvisOffset??0,m=i.breathing??1,g=h(i.fatigue??0,0,1),u=h(s.x/n,-1,1)*this.config.maxLean;this.lean=l(this.lean,u,t,this.config.leanResponsiveness);const d=i.stridePhase??r,p=o?this.config.pelvisBobAmplitude:.3*this.config.pelvisBobAmplitude,f=g*p*.5,y=Math.sin(d*Math.PI*2)*p-f+c;this.pelvisOffset=l(this.pelvisOffset,y,t,this.config.bobResponsiveness),this.breathTimer+=t*h(m,.25,2);const w=.6*Math.sin(this.breathTimer*Math.PI*2)*m;return e.pelvis.x=4*this.lean*a,e.pelvis.y=this.pelvisOffset,e.torso.x=12*this.lean*a,e.torso.y=.35*this.pelvisOffset-14,e.torso.rotation=.25*this.lean,e.head.x=6*this.lean*a,e.head.y=this.pelvisOffset*(1-this.config.headStabilization)-26+w,e.head.rotation=.2*-this.lean,{offsetX:3*this.lean*a,offsetY:.2*this.pelvisOffset,rotation:.12*this.lean,pelvis:this.pelvisOffset,lean:this.lean,breathOffset:w}}}const m=(t,e,i,s)=>{const a=Math.exp(-s*i);return t*a+e*(1-a)};class g{constructor(t={}){this.config={strideLength:t.strideLength??12,stepHeight:t.stepHeight??5,stanceWidth:t.stanceWidth??8,maxStrideSpeed:t.maxStrideSpeed??220,phaseSpeed:t.phaseSpeed??2.2},this.phase=0,this.lastStepPower=0}apply(t,e,i){const s=i.velocity||{x:0,y:0},a=i.speed??Math.hypot(s.x,s.y),n=i.facing??1,r=i.isGrounded??!0,o=i.legLiftLeft??0,h=i.legLiftRight??0,l=i.groundOffset??0,c=(g=a/this.config.maxStrideSpeed,Math.min(1,Math.max(0,g)));var g;const u=c>.05&&r;if(u){const e=this.config.phaseSpeed+c*this.config.phaseSpeed;this.phase=(this.phase+t*e)%1}else this.phase=m(this.phase,0,t,6);const d=this.config.strideLength*c,p=.5*-this.config.stanceWidth,f=.5*this.config.stanceWidth,y=21+l,w=this.phase,b=(this.phase+.5)%1,x=Math.max(0,Math.sin(w*Math.PI))*this.config.stepHeight+o*this.config.stepHeight,v=Math.max(0,Math.sin(b*Math.PI))*this.config.stepHeight+h*this.config.stepHeight,k=Math.sin(w*Math.PI*2)*d,S=Math.sin(b*Math.PI*2)*d;return e.leftLeg.foot.x=p+n*k,e.leftLeg.foot.y=y-x,e.rightLeg.foot.x=f+n*S,e.rightLeg.foot.y=y-v,e.leftLeg.knee.x=.5*(e.leftLeg.hip.x+e.leftLeg.foot.x),e.leftLeg.knee.y=.5*(e.leftLeg.hip.y+e.leftLeg.foot.y)-(u?.5*this.config.stepHeight:2),e.rightLeg.knee.x=.5*(e.rightLeg.hip.x+e.rightLeg.foot.x),e.rightLeg.knee.y=.5*(e.rightLeg.hip.y+e.rightLeg.foot.y)-(u?.5*this.config.stepHeight:2),this.lastStepPower=m(this.lastStepPower,u?c:0,t,8),{stridePhase:this.phase,moving:u,stepPower:this.lastStepPower,footContacts:{left:x<.2,right:v<.2}}}}const u=(t,e,i,s)=>{const a=Math.exp(-s*i);return t*a+e*(1-a)};class d{constructor(t={}){this.config={attackReach:t.attackReach??18,blockGuardHeight:t.blockGuardHeight??-10,blendSpeed:t.blendSpeed??14,swingAmplitude:t.swingAmplitude??7},this.currentTargets={leftHand:{x:-12,y:-2},rightHand:{x:12,y:-2}}}apply(t,e,i){const s=i.playerState||"idle",a=i.facing??1,n=(r=i.normalizedTime??0,Math.min(1,Math.max(0,r)));var r;const o=i.locomotion||{stridePhase:0,moving:!1},h=i.speed??0,l={x:-12,y:-2},c={x:12,y:-2};let m={...l},g={...c};if("attacking"===s){const t=Math.sin(n*Math.PI),e=this.config.attackReach*(i.attackStrength??1);g.x=a*(e*t),g.y=-6-6*t,m.x=a*(.35*e),m.y=-8-2*t}else if("blocking"===s)g.x=10*a,g.y=this.config.blockGuardHeight,m.x=6*a,m.y=this.config.blockGuardHeight-1;else if("rolling"===s)g.x=6*a,g.y=-4,m.x=6*-a,m.y=-4;else{const t=Math.sin(o.stridePhase*Math.PI*2)*(o.moving?1:0);g.x=12+a*t*this.config.swingAmplitude,g.y=2*Math.cos(o.stridePhase*Math.PI*2)-2,m.x=-12-a*t*this.config.swingAmplitude,m.y=-2-2*Math.cos(o.stridePhase*Math.PI*2)}const d=this.config.blendSpeed+.02*h;return this.currentTargets.leftHand.x=u(this.currentTargets.leftHand.x,m.x,t,d),this.currentTargets.leftHand.y=u(this.currentTargets.leftHand.y,m.y,t,d),this.currentTargets.rightHand.x=u(this.currentTargets.rightHand.x,g.x,t,d),this.currentTargets.rightHand.y=u(this.currentTargets.rightHand.y,g.y,t,d),e.leftArm.hand.x=this.currentTargets.leftHand.x,e.leftArm.hand.y=this.currentTargets.leftHand.y,e.rightArm.hand.x=this.currentTargets.rightHand.x,e.rightArm.hand.y=this.currentTargets.rightHand.y,e.leftArm.elbow.x=.5*(e.leftArm.shoulder.x+e.leftArm.hand.x),e.leftArm.elbow.y=.5*(e.leftArm.shoulder.y+e.leftArm.hand.y)+4,e.rightArm.elbow.x=.5*(e.rightArm.shoulder.x+e.rightArm.hand.x),e.rightArm.elbow.y=.5*(e.rightArm.shoulder.y+e.rightArm.hand.y)+4,{handTargets:{left:{...this.currentTargets.leftHand},right:{...this.currentTargets.rightHand}},poseState:s}}}const p=(t,e,i,s)=>{const a=Math.exp(-s*i);return t*a+e*(1-a)},f=t=>t.map(t=>({position:{x:t.position.x,y:t.position.y}}));class y{constructor(t={}){const e=Math.max(2,t.clothPoints??5),i=Math.max(2,t.hairSegments??4);this.cloth=Array.from({length:e},(t,e)=>({position:{x:0,y:4*e}})),this.hair=Array.from({length:i},(t,e)=>({position:{x:0,y:3*-e}})),this.equipment=[{type:"sword",position:{x:0,y:0}}],this.time=0}apply(t,e,i){this.time+=t;const s=i.wind??0,a=i.momentum||i.velocity||{x:0,y:0},n=i.facing??1,r=i.clothSway??0,o=i.hairBounce??0,h=i.equipmentJiggle??0;this.updateChain(this.cloth,{x:e.pelvis.x??0,y:e.pelvis.y+4},t,{wind:s,momentum:a,gravity:12,sway:r,bounce:.5*r}),this.updateChain(this.hair,{x:e.head.x,y:e.head.y-6},t,{wind:.8*s,momentum:a,gravity:4,sway:o,bounce:o});const l=e.rightArm.hand.x,c=e.rightArm.hand.y,m=this.equipment[0],g=Math.sin(6*this.time)*h*2,u=Math.cos(4*this.time)*h*2;return m.position.x=p(m.position.x,l-6*n+.06*a.x+g,t,10),m.position.y=p(m.position.y,c+6+.06*a.y+u,t,10),{cloth:f(this.cloth),hair:f(this.hair),equipment:this.equipment.map(t=>({type:t.type,position:{x:t.position.x,y:t.position.y}}))}}updateChain(t,e,i,s){let a=e;t.forEach((t,e)=>{const n=(s.sway??0)*Math.sin(3*this.time+.6*e),r=(s.bounce??0)*Math.cos(4*this.time+.5*e),o=a.x+s.wind*(e+1)*.3+.02*s.momentum.x+n,h=a.y+4*e+.015*s.momentum.y+.05*s.gravity+r;t.position.x=p(t.position.x,o,i,12),t.position.y=p(t.position.y,h,i,12),a=t.position})}}const w=(t,e,i,s)=>{const a=Math.exp(-s*i);return t*a+e*(1-a)};class b{constructor(t={}){this.config={windInfluence:t.windInfluence??.25,shiverMagnitude:t.shiverMagnitude??.6,windResponsiveness:t.windResponsiveness??4,shiverResponsiveness:t.shiverResponsiveness??6},this.wind=0,this.shiver=0,this.shiverPhase=0}apply(t,e,i){const s=i.wind??0,a=i.temperatureShiver??0;this.wind=w(this.wind,s,t,this.config.windResponsiveness),this.shiver=w(this.shiver,a,t,this.config.shiverResponsiveness),this.shiverPhase=(this.shiverPhase+18*t)%(2*Math.PI);const n=Math.sin(this.shiverPhase)*this.shiver*this.config.shiverMagnitude;return e.torso.x+=this.wind*this.config.windInfluence,e.head.x+=this.wind*this.config.windInfluence*1.5,e.leftArm.hand.x+=this.wind*this.config.windInfluence*1.2,e.rightArm.hand.x+=this.wind*this.config.windInfluence*1.2,e.torso.y+=.6*n,e.head.y+=.4*n,{wind:this.wind,shiver:n,temperature:a}}}class x{constructor(t={}){this.rig=new o,this.modules={core:new c(t.core),locomotion:new g(t.locomotion),combat:new d(t.combat),secondary:new y(t.secondary),environment:new b(t.environment)},this.cachedTransform={scaleX:1,scaleY:1,rotation:0,offsetX:0,offsetY:0,trails:[],skeleton:this.rig.toSkeleton(),secondaryMotion:null,environmental:null,debug:null}}buildContext(t,e={}){const i=e.overlay||{},s=e.velocity||{x:0,y:0},a=e.momentum||s,n=Math.hypot(s.x,s.y);return{deltaTime:t,playerState:e.playerState||"idle",facing:e.facing??1,velocity:s,momentum:a,speed:n,maxSpeed:e.maxSpeed??260,normalizedTime:e.normalizedTime??0,stridePhase:e.stridePhase,isGrounded:e.isGrounded??!0,pelvisOffset:e.pelvisOffset??0,breathing:e.breathing??1,fatigue:e.fatigue??0,legLiftLeft:e.legLiftLeft??0,legLiftRight:e.legLiftRight??0,groundOffset:e.groundOffset??0,wind:e.wind??0,temperatureShiver:e.temperatureShiver??0,clothSway:e.clothSway??0,hairBounce:e.hairBounce??0,equipmentJiggle:e.equipmentJiggle??0,staminaRatio:e.staminaRatio??1,healthRatio:e.healthRatio??1,inputState:e.inputState||{},attackStrength:e.attackStrength??1,attackType:e.attackType||"light",overlay:{scaleX:i.scaleX??1,scaleY:i.scaleY??1,rotation:i.rotation??0,offsetX:i.offsetX??0,offsetY:i.offsetY??0}}}composeTransform(t,e,i){const s=t.overlay,a=i?.stepPower?1.4*-i.stepPower:0;return{scaleX:s.scaleX,scaleY:s.scaleY,rotation:s.rotation+(e?.rotation??0),offsetX:s.offsetX+(e?.offsetX??0),offsetY:s.offsetY+(e?.offsetY??0)+a,trails:s.trails||[]}}update(t,e={}){const i=this.buildContext(t,e),s=this.rig.createWorkingPose(),a=this.modules.core.apply(t,s,i);i.posture=a,i.stridePhase=i.stridePhase??a?.stridePhase??i.normalizedTime;const n=this.modules.locomotion.apply(t,s,i);i.locomotion=n,i.stridePhase=n?.stridePhase??i.stridePhase;const r=this.modules.combat.apply(t,s,i);i.combat=r;const o=this.modules.secondary.apply(t,s,i),h=this.modules.environment.apply(t,s,i);this.rig.commitPose(s);const l=this.composeTransform(i,a,n);return this.cachedTransform={...l,skeleton:this.rig.toSkeleton(),secondaryMotion:o,environmental:h,debug:{state:i.playerState,stridePhase:n?.stridePhase??0,speed:i.speed,lean:a?.lean??0,wind:h?.wind??0,shiver:h?.shiver??0}},this.cachedTransform}}class v{constructor(t=400,e=300,i={}){this.x=t,this.y=e,this.facing=1,this.health=i.health||100,this.maxHealth=i.maxHealth||100,this.stamina=i.stamina||100,this.maxStamina=i.maxStamina||100,this._cachedHealth=this.health,this._cachedStamina=this.stamina,this.speed=i.speed||250,this.rollSpeed=i.rollSpeed||500,this.state="idle",this.previousState="idle",this.stateTimer=0,this.stateTime=0,this.stateDuration=0,this._prevNormTime=0,this._comboQueued=!1,this._currentAttackType="light",this.invulnerable=!1,this.invulnerabilityTimer=0,this.isGrounded=!0,this.jumpCount=0,this.nearWall=!1,this.dashCooldown=0,this.chargeTime=0,this.maxChargeTime=1.5,this.params={roll:{duration:.4,iFrameStart:.08,iFrameEnd:.36,staminaCost:25,cooldown:.8},attackLight:{duration:.4,activeStart:.28,activeEnd:.38,staminaCost:12,cooldown:.5},attackHeavy:{duration:.62,activeStart:.32,activeEnd:.48,staminaCost:24,cooldown:.8},comboWindow:{start:.55,end:.75},parry:{duration:.22,window:.18,staminaCost:10}},this.animator=new n,this.animations=r.createPlayerAnimations(),this.setupAnimations();const s=i.proceduralOptions||i.proceduralConfig||i.proceduralModules||{};this.proceduralAnimator=new x(s),this.attackCooldown=0,this.rollCooldown=0,this.blockHeld=!1,this.width=i.width||32,this.height=i.height||32,this.color=i.color||"#00ff88",this.sprite=i.sprite||null,this.sprite||this.loadSpriteSheet(),this.particleSystem=i.particleSystem||null,this.soundSystem=i.soundSystem||null,this.attackDamage=i.attackDamage||20,this.attackDamageHeavy=i.attackDamageHeavy||35,this.attackRange=i.attackRange||60,this.attackRangeHeavy=i.attackRangeHeavy||80,this.blockDamageReduction=i.blockDamageReduction||.5,this.stridePhase=0,this.gaitRate=1.4,this._lastFootFlag=0,this.footstepIntervalBase=.28,this.ik={pelvisY:0,pelvisRate:10,left:{locked:!1,y:0},right:{locked:!1,y:0},stepHeight:2},this.debugMode=!1;try{i.wasmModule&&!globalThis.wasmExports&&(globalThis.wasmExports=i.wasmModule)}catch{}}loadSpriteSheet(){this.sprite=new Image;const t=["./src/images/player-sprites.png","../src/images/player-sprites.png","../../src/images/player-sprites.png"];let e=0;const i=()=>{e<t.length?(this.sprite.src=t[e],e++):(console.warn("Player sprite sheet not found at any expected location, using fallback rendering"),this.sprite=null)};this.sprite.onload=()=>{},this.sprite.onerror=()=>{console.warn(`Player sprite sheet not found at ${this.sprite.src}, trying next path...`),i()},i()}setupAnimations(){Object.entries(this.animations).forEach(([t,e])=>{this.animator.addAnimation(t,e)}),this.animator.play("idle")}update(t,e={}){if(this._prevNormTime=this.getNormalizedTime(),this.attackCooldown=Math.max(0,this.attackCooldown-t),this.rollCooldown=Math.max(0,this.rollCooldown-t),this.invulnerable&&(this.invulnerabilityTimer-=t,this.invulnerabilityTimer<=0&&(this.invulnerable=!1)),this.updateIK(t),!globalThis.wasmInputManagedExternally){let t=0,i=0;e.left&&(t-=1),e.right&&(t+=1),e.up&&(i-=1),e.down&&(i+=1),globalThis.wasmExports?.set_player_input?.(t,i,e.roll?1:0,e.jump?1:0,e.lightAttack?1:0,e.heavyAttack?1:0,e.block?1:0,e.special?1:0)}const i=globalThis.wasmExports?.get_x?.(),s=globalThis.wasmExports?.get_y?.();this.x="number"==typeof i&&Number.isFinite(i)?i:.5,this.y="number"==typeof s&&Number.isFinite(s)?s:.5,this.isGrounded=1===globalThis.wasmExports?.get_is_grounded?.(),this.jumpCount=globalThis.wasmExports?.get_jump_count?.();const a=globalThis.wasmExports?.get_vel_x?.(),n=globalThis.wasmExports?.get_vel_y?.();if("number"==typeof a&&"number"==typeof n){Math.hypot(a,n)>.001&&(this.facing=a>=0?1:-1)}this.animator&&"function"==typeof this.animator.setFacing&&this.animator.setFacing(this.facing>=0?"right":"left");const r=globalThis.wasmExports?.get_anim_offset_x?.()??0,o=globalThis.wasmExports?.get_anim_offset_y?.()??0,h=globalThis.wasmExports?.get_anim_scale_x?.()??1,l=globalThis.wasmExports?.get_anim_scale_y?.()??1,c=globalThis.wasmExports?.get_anim_rotation?.()??0,m=globalThis.wasmExports?.get_anim_pelvis_y?.()??0,g=globalThis.wasmExports?.get_player_anim_state?.();"number"==typeof g&&this.setState(this.getAnimStateName(g),!0);const u=Number.isFinite(a)?a:0,d=Number.isFinite(n)?n:0,p=this.animator.update(t,{x:this.x,y:this.y},{x:u,y:d},this.isGrounded)||{scaleX:1,scaleY:1,rotation:0,offsetX:0,offsetY:0},f=globalThis.wasmExports&&"number"==typeof r?{scaleX:h,scaleY:l,rotation:c,offsetX:r,offsetY:o}:this.computePoseOverlay(e),y=globalThis.wasmExports?.get_anim_leg_lift_left?.()??0,w=globalThis.wasmExports?.get_anim_leg_lift_right?.()??0,b=globalThis.wasmExports?.get_anim_breathing_intensity?.()??1,x=globalThis.wasmExports?.get_anim_fatigue_factor?.()??0,v=globalThis.wasmExports?.get_anim_wind_response?.()??0,k=globalThis.wasmExports?.get_anim_ground_adapt?.()??0,S=globalThis.wasmExports?.get_anim_temperature_shiver?.()??0,T=globalThis.wasmExports?.get_anim_cloth_sway?.()??0,_=globalThis.wasmExports?.get_anim_hair_bounce?.()??0,M=globalThis.wasmExports?.get_anim_equipment_jiggle?.()??0,A=globalThis.wasmExports?.get_anim_momentum_x?.()??u,P=globalThis.wasmExports?.get_anim_momentum_y?.()??d,F=this.getNormalizedTime(),E=globalThis.wasmExports?.get_hp?.()??globalThis.wasmExports?.get_health?.()??this.health,L=globalThis.wasmExports?.get_stamina?.()??this.stamina;this._cachedHealth=E,this._cachedStamina=L;const R=this.proceduralAnimator.update(t,{playerState:this.state,facing:this.facing,velocity:{x:u,y:d},momentum:{x:A,y:P},normalizedTime:F,isGrounded:this.isGrounded,pelvisOffset:m,breathing:b,fatigue:x,legLiftLeft:y,legLiftRight:w,groundOffset:k,wind:v,temperatureShiver:S,clothSway:T,hairBounce:_,equipmentJiggle:M,staminaRatio:this.maxStamina?L/this.maxStamina:1,healthRatio:this.maxHealth?E/this.maxHealth:1,attackStrength:"heavy"===this._currentAttackType?1.35:1,attackType:this._currentAttackType,inputState:e,maxSpeed:this.speed,stridePhase:this.stridePhase,overlay:f});this.currentTransform={scaleX:p.scaleX*(R.scaleX??1),scaleY:p.scaleY*(R.scaleY??1),rotation:p.rotation+(R.rotation??0),offsetX:p.offsetX+(R.offsetX??0),offsetY:p.offsetY+(R.offsetY??0),trails:p.trails||[],skeleton:R.skeleton,secondaryMotion:R.secondaryMotion,environmental:R.environmental,debug:R.debug}}getNormalizedTime(){try{const t=t=>"function"==typeof globalThis.wasmExports?.[t]?globalThis.wasmExports[t]():void 0,e=t("get_attack_state"),i=t("get_attack_state_time"),s=t("get_time_seconds");if("number"==typeof e&&"number"==typeof i&&"number"==typeof s){const a=Math.max(0,s-i);let n=0;if(1===e?n=t("get_attack_windup_sec")??this.params.attackLight.duration:2===e?n=t("get_attack_active_sec")??this.params.attackLight.duration:3===e&&(n=t("get_attack_recovery_sec")??this.params.attackLight.duration),n&&n>0)return Math.max(0,Math.min(1,a/n))}if(1===t("get_is_rolling")){const e=t("get_roll_duration")||this.params.roll.duration,i=t("get_player_state_timer");if("number"==typeof i&&e>0)return Math.max(0,Math.min(1,i/e))}const a=t("get_player_state_timer");if("number"==typeof a){let t=0;switch(this.state){case"rolling":t=this.params.roll.duration;break;case"attacking":t="heavy"===this._currentAttackType?this.params.attackHeavy.duration:this.params.attackLight.duration;break;default:t=0}if(t>0)return Math.max(0,Math.min(1,a/t))}}catch{}try{const t=this.animator?.controller?.currentAnimation;if(t&&Array.isArray(t.frames)&&t.frames.length>1){const e=t.currentFrame/(t.frames.length-1);return Math.max(0,Math.min(1,e))}}catch{}return 0}startRoll(t){if(!globalThis.wasmExports?.on_roll_start?.())return;let e=0,i=0;t.left&&(e-=1),t.right&&(e+=1),t.up&&(i-=1),t.down&&(i+=1),0===e&&0===i&&(e=this.facing);const s=Math.hypot(e,i);s>0&&(e/=s,i/=s),this.rollDirection={x:e,y:i},this.particleSystem&&this.particleSystem.createDustCloud(this.x,this.y),this.soundSystem&&this.soundSystem.play("roll")}startAttack(t="light"){"heavy"===t?this.params.attackHeavy:this.params.attackLight,this._currentAttackType=t,globalThis.wasmExports?.on_attack?.("heavy"===t?1:0)&&this.soundSystem&&this.soundSystem.play("attack")}queueAttack(t="light"){this.canAttack()?this.startAttack(t):"attacking"===this.state&&(this._comboQueued=!0)}tryRoll(t=null){const e={};t&&(t.x||t.y)&&(e.left=t.x<-.5,e.right=t.x>.5,e.up=t.y<-.5,e.down=t.y>.5),this.startRoll(e)}tryParry(){"dead"!==this.state&&globalThis.wasmExports?.on_parry?.()&&this.soundSystem&&this.soundSystem.play("parry")}executeAttack(){const t="heavy"===this._currentAttackType,e=t?this.attackRangeHeavy:this.attackRange,i=t?this.attackDamageHeavy:this.attackDamage,s=this.x+this.facing*e/2,a=this.y;return this.particleSystem&&(t?this.particleSystem.createChargedSlash?.(s,a,this.facing,1):this.particleSystem.createSlashEffect(s,a,this.facing)),{x:s,y:a,width:e,height:this.height,damage:i}}startBlock(){globalThis.wasmExports?.set_blocking?.(1,this.facing,0)&&(this.blockHeld=!0,this.particleSystem&&this.particleSystem.createShieldEffect(this.x,this.y),this.soundSystem&&this.soundSystem.play("block"))}stopBlock(){globalThis.wasmExports?.set_blocking?.(0,this.facing,0),this.blockHeld=!1}takeDamage(t,e=0,i=0){return!this.invulnerable&&"dead"!==this.state&&("blocking"===this.state?(this.particleSystem&&this.particleSystem.createBlockImpact(this.x,this.y),this.soundSystem&&this.soundSystem.play("blockImpact")):(this.particleSystem&&this.particleSystem.createBloodEffect(this.x,this.y),this.soundSystem&&this.soundSystem.play("hurt")),!0)}die(){this.particleSystem&&this.particleSystem.createDeathEffect(this.x,this.y),this.soundSystem&&this.soundSystem.play("death")}respawn(t,e){this.particleSystem&&this.particleSystem.createRespawnEffect(this.x,this.y),this.soundSystem&&this.soundSystem.play("respawn")}setState(t,e=!1){if(this.state===t)return;this.previousState=this.state,this.state=t,this.stateTime=0,this.stateDuration=0,this._prevNormTime=0;const i=this.stateNameToNumber(t);this.animator.setAnimState(i)}canAttack(){const t=Math.min(this.params.attackLight.staminaCost,this.params.attackHeavy.staminaCost);return this.attackCooldown<=0&&this.stamina>=t&&"dead"!==this.state&&"rolling"!==this.state&&"hurt"!==this.state}canRoll(){return this.rollCooldown<=0&&this.stamina>=this.params.roll.staminaCost&&"dead"!==this.state&&"attacking"!==this.state&&"hurt"!==this.state}canBlock(){return this.stamina>0&&"dead"!==this.state&&"rolling"!==this.state&&"attacking"!==this.state&&"hurt"!==this.state}render(t,e=null){let i=0,s=0;const a=e?.x||0,n=e?.y||0;if(globalThis.gameRenderer&&"function"==typeof globalThis.gameRenderer.wasmToWorld){const t=globalThis.gameRenderer.wasmToWorld(this.x||.5,this.y||.5);i=t.x-a,s=t.y-n}else{const t=800,e=600;i=(this.x||0)*t-a,s=(this.y||0)*e-n}t.save(),1===globalThis.wasmExports?.get_is_invulnerable?.()&&(t.globalAlpha=.5+.3*Math.sin(.02*Date.now()));const r=this.animator.controller.getCurrentFrame();if(this.sprite&&r){t.save();const e=this.currentTransform||{scaleX:1,scaleY:1,rotation:0,offsetX:0,offsetY:0},a=i+e.offsetX,n=s+e.offsetY;t.translate(a,n),t.rotate(e.rotation),t.scale(this.facing<0?-e.scaleX:e.scaleX,e.scaleY),e.secondaryMotion&&this.debugMode&&this.renderSecondaryMotion(t,e.secondaryMotion),t.drawImage(this.sprite,r.x,r.y,r.width,r.height,-this.width/2,-this.height/2,this.width,this.height),e.skeleton&&this.debugMode&&this.renderSkeletalOverlay(t,e.skeleton),t.restore()}else{t.fillStyle=this.color||"#4a90e2","hurt"===this.state?t.fillStyle="#ff4444":"blocking"===this.state?t.fillStyle="#4444ff":"rolling"===this.state&&(t.fillStyle="#ffff44");const e=this.width||32,a=this.height||32;t.fillRect(i-e/2,s-a/2,e,a),t.strokeStyle="#ffffff",t.lineWidth=2,t.strokeRect(i-e/2,s-a/2,e,a),t.fillStyle="#ffffff",t.beginPath(),t.arc(i,s,3,0,2*Math.PI),t.fill()}const o=40,h=s-this.height/2-10;t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(i-20,h,o,4);const l=(Number.isFinite(this._cachedHealth)?this._cachedHealth:globalThis.wasmExports?.get_hp?.()??globalThis.wasmExports?.get_health?.()??this.health)/this.maxHealth;t.fillStyle=l>.5?"#00ff00":l>.25?"#ffff00":"#ff0000",t.fillRect(i-20,h,o*l,4);const c=h+5;t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(i-20,c,o,2);const m=(Number.isFinite(this._cachedStamina)?this._cachedStamina:globalThis.wasmExports?.get_stamina?.()??this.stamina)/this.maxStamina;t.fillStyle="#00aaff",t.fillRect(i-20,c,o*m,2),this.debugMode&&this.renderDebug(t,e,i,s),t.restore()}computePoseOverlay(t){const e=this.getNormalizedTime();let i=1,s=1,a=0;let n=this.ik?.pelvisY||0;const r=globalThis.wasmExports?.get_vel_x?.()??0;globalThis.wasmExports?.get_vel_y?.();const o=globalThis.wasmExports?.get_speed?.()??this.speed;if("running"===this.state){a+=Math.max(-.15,Math.min(.15,r/(o||1)*.25))}if("blocking"===this.state&&(s*=.98,n+=1),"rolling"===this.state){const t=e<.5?2*e:2*(1-e);s*=1-.06*t,i*=1+.04*t,a+=.12*(this.facing>=0?1:-1)*t}return this.state,{scaleX:i,scaleY:s,rotation:a,offsetX:0,offsetY:n}}updateIK(t){const e=globalThis.wasmExports?.get_anim_pelvis_y?.();this.ik.pelvisY="number"==typeof e?e:0;const i=globalThis.wasmExports?.get_vel_x?.()??0,s=globalThis.wasmExports?.get_vel_y?.()??0;if(Math.hypot(i,s)>10){this.stridePhase=(this.stridePhase+t*this.gaitRate)%1;const e=this.stridePhase<.25||this.stridePhase>.75;this.ik.left.locked=e,this.ik.right.locked=!e}else this.ik.left.locked=!1,this.ik.right.locked=!1,this.stridePhase=0}renderDebug(t,e,i,s){const a=i,n=s-this.height/2-18;t.save(),t.fillStyle="rgba(0,0,0,0.35)",t.fillRect(a-24,n,48,4),t.fillStyle="#00ffaa",t.fillRect(a-24,n,this.stridePhase%1*48,4),t.strokeStyle="#ffaa00",t.beginPath(),t.moveTo(a+30,n+2),t.lineTo(a+30,n+2-(this.ik?.pelvisY||0)),t.stroke();const r=globalThis.wasmExports?.get_attack_state?.()??0,o=globalThis.wasmExports?.get_attack_state_time?.()??0,h=globalThis.wasmExports?.get_time_seconds?.()??0;let l=0;1===r?l=(h-o)/(globalThis.wasmExports?.get_attack_windup_sec?.()??this.params.attackLight.duration):2===r?l=(h-o)/(globalThis.wasmExports?.get_attack_active_sec?.()??this.params.attackLight.duration):3===r&&(l=(h-o)/(globalThis.wasmExports?.get_attack_recovery_sec?.()??this.params.attackLight.duration));const c=n+8;t.fillStyle="rgba(0,0,0,0.35)",t.fillRect(a-24,c,48,3),2===r&&(t.fillStyle="#ff4477",t.fillRect(a-24+48*.28,c,48*(.38-.28),3)),1===globalThis.wasmExports?.get_is_rolling?.()&&(t.fillStyle="#ffee55",t.fillRect(a-24+3.84,c,48*(.36-.08),3)),t.fillStyle="#ffffff",t.fillRect(a-24+48*l-1,c-1,2,5),t.restore()}getAnimStateName(t){switch(t){case 0:default:return"idle";case 1:return"running";case 2:return"attacking";case 3:return"blocking";case 4:return"rolling";case 5:return"hurt";case 6:return"dead";case 7:return"jumping";case 8:return"doubleJumping";case 9:return"landing";case 10:return"wallSliding";case 11:return"dashing";case 12:return"chargingAttack"}}stateNameToNumber(t){switch(t){case"idle":default:return 0;case"running":return 1;case"attacking":return 2;case"blocking":return 3;case"rolling":return 4;case"hurt":return 5;case"dead":return 6;case"jumping":return 7;case"doubleJumping":return 8;case"landing":return 9;case"wallSliding":return 10;case"dashing":return 11;case"chargingAttack":return 12}}getAnimationStateCode(){return this.stateNameToNumber(this.state)}getAnimationInfo(){return{state:this.state,animation:this.animator.controller.currentAnimation?.name,frame:this.animator.controller.getCurrentFrame(),stateTimer:globalThis.wasmExports?.get_player_state_timer?.()??0,invulnerable:1===globalThis.wasmExports?.get_is_invulnerable?.(),proceduralData:this.currentTransform?.debug||null,skeletalData:this.currentTransform?.skeleton||null,secondaryMotion:this.currentTransform?.secondaryMotion||null,environmental:this.currentTransform?.environmental||null}}renderSecondaryMotion(t,e){e&&(t.save(),t.globalAlpha=.8,e.cloth&&(t.strokeStyle="#4A4A4A",t.lineWidth=2,t.beginPath(),e.cloth.forEach((e,i)=>{0===i?t.moveTo(e.position.x,e.position.y):t.lineTo(e.position.x,e.position.y)}),t.stroke()),e.hair&&(t.strokeStyle="#8B4513",t.lineWidth=3,t.lineCap="round",t.beginPath(),e.hair.forEach((e,i)=>{0===i?t.moveTo(e.position.x,e.position.y):t.lineTo(e.position.x,e.position.y)}),t.stroke()),e.equipment&&e.equipment.forEach(e=>{t.fillStyle="sword"===e.type?"#C0C0C0":"#8B4513",t.fillRect(e.position.x-2,e.position.y-1,4,2)}),t.restore())}renderSkeletalOverlay(t,e){if(!e)return;t.save(),t.strokeStyle="#00ff88",t.fillStyle="#ffff44",t.lineWidth=1,t.globalAlpha=.6,this.drawBone(t,e.torso,e.head),this.drawBone(t,e.torso,e.pelvis),this.drawBone(t,e.leftArm.shoulder,e.leftArm.elbow),this.drawBone(t,e.leftArm.elbow,e.leftArm.hand),this.drawBone(t,e.rightArm.shoulder,e.rightArm.elbow),this.drawBone(t,e.rightArm.elbow,e.rightArm.hand),this.drawBone(t,e.leftLeg.hip,e.leftLeg.knee),this.drawBone(t,e.leftLeg.knee,e.leftLeg.foot),this.drawBone(t,e.rightLeg.hip,e.rightLeg.knee),this.drawBone(t,e.rightLeg.knee,e.rightLeg.foot);[e.head,e.torso,e.pelvis,e.leftArm.shoulder,e.leftArm.elbow,e.leftArm.hand,e.rightArm.shoulder,e.rightArm.elbow,e.rightArm.hand,e.leftLeg.hip,e.leftLeg.knee,e.leftLeg.foot,e.rightLeg.hip,e.rightLeg.knee,e.rightLeg.foot].forEach(e=>{e&&void 0!==e.x&&void 0!==e.y&&(t.beginPath(),t.arc(e.x,e.y,2,0,2*Math.PI),t.fill())}),t.restore()}drawBone(t,e,i){e&&i&&void 0!==e.x&&void 0!==i.x&&(t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(i.x,i.y),t.stroke())}static createInputFromKeys(t){return{left:t.a||t.arrowleft,right:t.d||t.arrowright,up:t.w||t.arrowup,down:t.s||t.arrowdown,lightAttack:t.j||t[1],heavyAttack:t.k||t[2],block:t.shift||t[3],roll:t.control||t[4],special:t.l||t[5],attack:t.j||t[" "],jump:t.space||t.z}}jump(){globalThis.wasmExports?.on_jump?.(),this.particleSystem&&this.particleSystem.createDustCloud(this.x,this.y+this.height/2),this.soundSystem&&this.soundSystem.play("jump")}}v.attachDebugToggle=(t,e="F3")=>{if(!t||t.__debugToggleAttached)return;const i=(e||"F3").toLowerCase(),s=e=>{(e.key||"").toLowerCase()===i.toLowerCase()&&(t.debugMode=!t.debugMode)};try{addEventListener("keydown",s),t.__debugToggleAttached=!0}catch{}};export{v as AnimatedPlayer,v as default};//# sourceMappingURL=player-animator.min.js.map
