import{CharacterAnimator as t,AnimationPresets as i}from"./animation-system.js";class s{constructor(s=400,a=300,e={}){this.x=s,this.y=a,this.vx=0,this.vy=0,this.facing=1,this.health=e.health||100,this.maxHealth=e.maxHealth||100,this.stamina=e.stamina||100,this.maxStamina=e.maxStamina||100,this.speed=e.speed||250,this.rollSpeed=e.rollSpeed||500,this.state="idle",this.previousState="idle",this.stateTimer=0,this.invulnerable=!1,this.invulnerabilityTimer=0,this.isGrounded=!0,this.jumpCount=0,this.maxJumps=2,this.nearWall=!1,this.dashCooldown=0,this.chargeTime=0,this.maxChargeTime=1.5,this.animator=new t,this.animations=i.createPlayerAnimations(),this.setupAnimations(),this.attackCooldown=0,this.rollCooldown=0,this.blockHeld=!1,this.width=e.width||32,this.height=e.height||32,this.color=e.color||"#00ff88",this.sprite=e.sprite||null,this.particleSystem=e.particleSystem||null,this.soundSystem=e.soundSystem||null,this.attackDamage=e.attackDamage||20,this.attackRange=e.attackRange||60,this.blockDamageReduction=e.blockDamageReduction||.5}setupAnimations(){Object.values(this.animations).forEach(t=>{this.animator.controller.addAnimation(t)}),this.animator.controller.play("idle")}update(t,i={}){this.stateTimer-=t,this.attackCooldown=Math.max(0,this.attackCooldown-t),this.rollCooldown=Math.max(0,this.rollCooldown-t),this.invulnerable&&(this.invulnerabilityTimer-=t,this.invulnerabilityTimer<=0&&(this.invulnerable=!1)),this.handleStateTransitions(i),this.updateState(t,i),this.animator.update(t,{x:this.x,y:this.y}),this.applyPhysics(t),"rolling"!==this.state&&"attacking"!==this.state&&(this.stamina=Math.min(this.maxStamina,this.stamina+20*t))}handleStateTransitions(t){if("attacking"===this.state&&this.stateTimer>0)return;if("rolling"===this.state&&this.stateTimer>0)return;if("hurt"===this.state&&this.stateTimer>0)return;if("dead"===this.state)return;if(t.roll&&this.canRoll())return void this.startRoll(t);if(t.attack&&this.canAttack())return void this.startAttack();if(t.block&&this.canBlock())return void this.startBlock();if("blocking"===this.state&&!t.block)return void this.stopBlock();const i=t.left||t.right||t.up||t.down;i&&"running"!==this.state?this.setState("running"):i||"running"!==this.state||this.setState("idle")}updateState(t,i){switch(this.state){case"idle":case"running":this.handleMovement(t,i);break;case"attacking":this.stateTimer<=.2&&!this.attackExecuted&&(this.executeAttack(),this.attackExecuted=!0);break;case"rolling":this.x+=this.rollDirection.x*this.rollSpeed*t,this.y+=this.rollDirection.y*this.rollSpeed*t;break;case"blocking":this.handleMovement(t,i,.3);break;case"hurt":this.vx*=.5**t,this.vy*=.5**t}}handleMovement(t,i,s=1){let a=0,e=0;i.left&&(a-=1),i.right&&(a+=1),i.up&&(e-=1),i.down&&(e+=1),0!==a&&0!==e&&(a*=.707,e*=.707);const h=this.speed*s;this.vx+=1e3*a*t,this.vy+=1e3*e*t;const n=Math.hypot(this.vx,this.vy);n>h&&(this.vx=this.vx/n*h,this.vy=this.vy/n*h),Math.abs(this.vx)>10&&(this.facing=Math.sign(this.vx))}applyPhysics(t){"rolling"!==this.state&&(this.vx*=.1**t,this.vy*=.1**t),this.x+=this.vx*t,this.y+=this.vy*t}startRoll(t){let i=0,s=0;t.left&&(i-=1),t.right&&(i+=1),t.up&&(s-=1),t.down&&(s+=1),0===i&&0===s&&(i=this.facing);const a=Math.hypot(i,s);a>0&&(i/=a,s/=a),this.rollDirection={x:i,y:s},this.setState("rolling"),this.stateTimer=.4,this.rollCooldown=.8,this.stamina-=25,this.invulnerable=!0,this.invulnerabilityTimer=.4,this.particleSystem&&this.particleSystem.createDustCloud(this.x,this.y),this.soundSystem&&this.soundSystem.play("roll")}startAttack(){this.setState("attacking"),this.stateTimer=.4,this.attackCooldown=.6,this.attackExecuted=!1,this.stamina-=15,this.soundSystem&&this.soundSystem.play("attack")}executeAttack(){const t=this.x+this.facing*this.attackRange/2,i=this.y;return this.particleSystem&&this.particleSystem.createSlashEffect(t,i,this.facing),{x:t,y:i,width:this.attackRange,height:this.height,damage:this.attackDamage}}startBlock(){this.setState("blocking"),this.blockHeld=!0,this.particleSystem&&this.particleSystem.createShieldEffect(this.x,this.y),this.soundSystem&&this.soundSystem.play("block")}stopBlock(){this.setState("idle"),this.blockHeld=!1}takeDamage(t,i=0,s=0){if(this.invulnerable||"dead"===this.state)return!1;let a=t;return"blocking"===this.state?(a*=this.blockDamageReduction,this.particleSystem&&this.particleSystem.createBlockImpact(this.x,this.y),this.soundSystem&&this.soundSystem.play("blockImpact")):(this.setState("hurt"),this.stateTimer=.3,this.vx=300*i,this.vy=300*s,this.particleSystem&&this.particleSystem.createBloodEffect(this.x,this.y),this.soundSystem&&this.soundSystem.play("hurt")),this.health=Math.max(0,this.health-a),this.health<=0&&this.die(),!0}die(){this.setState("dead"),this.vx=0,this.vy=0,this.particleSystem&&this.particleSystem.createDeathEffect(this.x,this.y),this.soundSystem&&this.soundSystem.play("death")}respawn(t,i){this.x=t,this.y=i,this.vx=0,this.vy=0,this.health=this.maxHealth,this.stamina=this.maxStamina,this.setState("idle"),this.invulnerable=!0,this.invulnerabilityTimer=2,this.particleSystem&&this.particleSystem.createRespawnEffect(this.x,this.y),this.soundSystem&&this.soundSystem.play("respawn")}setState(t){if(this.state!==t)switch(this.previousState=this.state,this.state=t,this.animator.setState(t),t){case"idle":this.animator.controller.play("idle",{transition:200});break;case"running":this.animator.controller.play("run",{transition:100});break;case"attacking":this.animator.controller.play("attack",{transition:50});break;case"blocking":this.animator.controller.play("block",{transition:100});break;case"rolling":this.animator.controller.play("roll",{transition:50});break;case"hurt":this.animator.controller.play("hurt",{transition:0});break;case"dead":this.animator.controller.play("death",{transition:0});break;case"jumping":this.animator.controller.play("jump",{transition:50});break;case"doubleJumping":this.animator.controller.play("doubleJump",{transition:0});break;case"landing":this.animator.controller.play("land",{transition:0});break;case"wallSliding":this.animator.controller.play("wallSlide",{transition:100});break;case"dashing":this.animator.controller.play("dash",{transition:0});break;case"chargingAttack":this.animator.controller.play("chargeAttack",{transition:100})}}canAttack(){return this.attackCooldown<=0&&this.stamina>=15&&"dead"!==this.state&&"rolling"!==this.state&&"hurt"!==this.state}canRoll(){return this.rollCooldown<=0&&this.stamina>=25&&"dead"!==this.state&&"attacking"!==this.state&&"hurt"!==this.state}canBlock(){return this.stamina>0&&"dead"!==this.state&&"rolling"!==this.state&&"attacking"!==this.state&&"hurt"!==this.state}render(t,i=null){let s=this.x,a=this.y;i&&(s=this.x-i.x,a=this.y-i.y),t.save(),this.invulnerable&&(t.globalAlpha=.5+.3*Math.sin(.02*Date.now()));const e=this.animator.controller.getCurrentFrame();this.sprite&&e?(t.save(),this.facing<0&&(t.scale(-1,1),s=-s-this.width),t.drawImage(this.sprite,e.x,e.y,e.width,e.height,s-this.width/2,a-this.height/2,this.width,this.height),t.restore()):(t.fillStyle=this.color,"hurt"===this.state?t.fillStyle="#ff4444":"blocking"===this.state?t.fillStyle="#4444ff":"rolling"===this.state&&(t.fillStyle="#ffff44"),t.fillRect(s-this.width/2,a-this.height/2,this.width,this.height));const h=40,n=a-this.height/2-10;t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(s-20,n,h,4);const l=this.health/this.maxHealth;t.fillStyle=l>.5?"#00ff00":l>.25?"#ffff00":"#ff0000",t.fillRect(s-20,n,h*l,4);const r=n+5;t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(s-20,r,h,2);const o=this.stamina/this.maxStamina;t.fillStyle="#00aaff",t.fillRect(s-20,r,h*o,2),t.restore()}getAnimationInfo(){return{state:this.state,animation:this.animator.controller.currentAnimation?.name,frame:this.animator.controller.getCurrentFrame(),stateTimer:this.stateTimer,invulnerable:this.invulnerable}}static createInputFromKeys(t){return{left:t.a||t.arrowleft,right:t.d||t.arrowright,up:t.w||t.arrowup,down:t.s||t.arrowdown,attack:t[" "]||t.j,block:t.shift||t.k,roll:t.control||t.l,jump:t.space||t.z,dash:t.x||t.shift,chargeAttack:t.c||t.h}}jump(){this.isGrounded&&0===this.jumpCount?(this.setState("jumping"),this.isGrounded=!1,this.jumpCount=1,this.vy=-400,this.particleSystem&&this.particleSystem.createDustCloud(this.x,this.y+this.height/2),this.soundSystem&&this.soundSystem.play("jump")):1===this.jumpCount&&this.jumpCount<this.maxJumps&&this.triggerDoubleJump()}triggerDoubleJump(){if(this.setState("doubleJumping"),this.jumpCount=2,this.vy=-350,this.particleSystem)for(let t=0;t<8;t++){const i=t/8*Math.PI*2;this.particleSystem.createSparkle(this.x+20*Math.cos(i),this.y+20*Math.sin(i))}this.soundSystem&&this.soundSystem.play("doubleJump")}land(){if(!this.isGrounded&&this.vy>100){this.setState("landing"),this.stateTimer=.2,this.isGrounded=!0,this.jumpCount=0;const t=Math.min(this.vy/500,1);this.particleSystem&&this.particleSystem.createLandingImpact(this.x,this.y+this.height/2,t),this.soundSystem&&this.soundSystem.play("land",{volume:.3+.7*t})}else this.isGrounded=!0,this.jumpCount=0}dash(t=null){if(this.dashCooldown<=0&&this.stamina>=20){this.setState("dashing"),this.stateTimer=.3,this.dashCooldown=1,this.stamina-=20,this.invulnerable=!0,this.invulnerabilityTimer=.3;let i=t?.x||this.facing,s=t?.y||0;const a=Math.sqrt(i*i+s*s);a>0&&(i/=a,s/=a),this.vx=600*i,this.vy=600*s,this.particleSystem&&this.particleSystem.createDashTrail(this.x,this.y,i,s),this.soundSystem&&this.soundSystem.play("dash")}}startChargeAttack(){this.canAttack()&&this.stamina>=30&&(this.setState("chargingAttack"),this.chargeTime=0,this.particleSystem&&this.particleSystem.startChargingEffect(this.x,this.y),this.soundSystem&&this.soundSystem.play("chargeStart"))}releaseChargeAttack(){if("chargingAttack"===this.state){const t=Math.min(this.chargeTime/this.maxChargeTime,1),i=this.attackDamage*(1+2*t);this.setState("attacking"),this.stateTimer=.5,this.attackCooldown=.8,this.stamina-=30;const s=this.x+this.facing*this.attackRange*(1+t),a=this.y;return this.particleSystem&&this.particleSystem.createChargedSlash(s,a,this.facing,t),this.soundSystem&&this.soundSystem.play("chargedAttack",{volume:.5+.5*t}),{x:s,y:a,width:this.attackRange*(1+t),height:this.height,damage:i}}}}export{s as AnimatedPlayer,s as default};