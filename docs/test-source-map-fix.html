<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Source Map Fix Test - DozedEnt</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .test-section {
            background-color: #2a2a2a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #45a049; }
        #console-output {
            background-color: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üîß Source Map Fix Test - DozedEnt</h1>
    
    <div class="test-section">
        <h2>Test Status</h2>
        <p id="test-status" class="info">Ready to test...</p>
    </div>
    
    <div class="test-section">
        <h2>Actions</h2>
        <button onclick="testWasmLoading()">Test WASM Loading</button>
        <button onclick="testSourceMapCleanup()">Test Source Map Cleanup</button>
        <button onclick="clearConsole()">Clear Console</button>
    </div>
    
    <div class="test-section">
        <h2>Console Output</h2>
        <div id="console-output"></div>
    </div>

    <script type="module">
        // Capture console output
        const consoleOutput = document.getElementById('console-output');
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        function addToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : '‚úÖ';
            consoleOutput.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        console.log = (...args) => {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };
        
        console.warn = (...args) => {
            originalWarn.apply(console, args);
            addToConsole(args.join(' '), 'warn');
        };
        
        console.error = (...args) => {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };
        
        // Import the WASM lazy loader
        let wasmLoader;
        let cleanupFunction;
        
        async function loadWasmLoader() {
            try {
                const module = await import('http://localhost:8081/js/src/utils/wasm-lazy-loader.js');
                wasmLoader = module.globalWasmLoader;
                cleanupFunction = module.cleanupGlobalSourceMaps;
                console.log('WASM lazy loader imported successfully');
                return true;
            } catch (error) {
                console.error('Failed to import WASM lazy loader:', error.message);
                return false;
            }
        }
        
        // Test functions
        window.testWasmLoading = async function() {
            const statusEl = document.getElementById('test-status');
            statusEl.textContent = 'Testing WASM loading...';
            statusEl.className = 'info';
            
            try {
                if (!wasmLoader) {
                    const loaded = await loadWasmLoader();
                    if (!loaded) {
                        throw new Error('Failed to load WASM lazy loader');
                    }
                }
                
                console.log('Starting WASM loading test...');
                
                // Test loading the game WASM module
                const instance = await wasmLoader.loadModule('game');
                
                if (instance && instance.exports) {
                    console.log('‚úÖ WASM module loaded successfully');
                    console.log('‚úÖ No source map URL constructor errors detected');
                    
                    // Check if source map references were cleaned up
                    const hasSourceMapRefs = instance.sourceMapURL || 
                                           instance.module?.sourceMapURL || 
                                           instance.exports?.sourceMapURL;
                    
                    if (!hasSourceMapRefs) {
                        console.log('‚úÖ Source map references properly cleaned up');
                        statusEl.textContent = '‚úÖ WASM loading test passed - No source map errors!';
                        statusEl.className = 'success';
                    } else {
                        console.warn('‚ö†Ô∏è Some source map references still present');
                        statusEl.textContent = '‚ö†Ô∏è WASM loaded but source map cleanup incomplete';
                        statusEl.className = 'warning';
                    }
                } else {
                    throw new Error('WASM instance is invalid');
                }
                
            } catch (error) {
                console.error('‚ùå WASM loading test failed:', error.message);
                statusEl.textContent = '‚ùå WASM loading test failed: ' + error.message;
                statusEl.className = 'error';
            }
        };
        
        window.testSourceMapCleanup = function() {
            const statusEl = document.getElementById('test-status');
            statusEl.textContent = 'Testing source map cleanup...';
            statusEl.className = 'info';
            
            try {
                if (!cleanupFunction) {
                    throw new Error('Source map cleanup function not available');
                }
                
                console.log('Testing global source map cleanup...');
                cleanupFunction();
                
                // Check WebAssembly prototypes for source map references
                const hasModuleSourceMap = window.WebAssembly?.Module?.prototype?.sourceMapURL;
                const hasInstanceSourceMap = window.WebAssembly?.Instance?.prototype?.sourceMapURL;
                
                if (!hasModuleSourceMap && !hasInstanceSourceMap) {
                    console.log('‚úÖ Global source map cleanup successful');
                    statusEl.textContent = '‚úÖ Source map cleanup test passed!';
                    statusEl.className = 'success';
                } else {
                    console.warn('‚ö†Ô∏è Some global source map references still present');
                    statusEl.textContent = '‚ö†Ô∏è Source map cleanup partially successful';
                    statusEl.className = 'warning';
                }
                
            } catch (error) {
                console.error('‚ùå Source map cleanup test failed:', error.message);
                statusEl.textContent = '‚ùå Source map cleanup test failed: ' + error.message;
                statusEl.className = 'error';
            }
        };
        
        window.clearConsole = function() {
            consoleOutput.textContent = '';
        };
        
        // Initialize
        console.log('Source map fix test page loaded');
        console.log('Server running at: http://localhost:8081');
        console.log('Ready to test WASM loading and source map cleanup...');
    </script>
</body>
</html>