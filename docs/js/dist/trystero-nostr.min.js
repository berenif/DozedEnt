const e={p:0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2fn,n:0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141n,h:1n,a:0n,b:7n,Gx:0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798n,Gy:0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8n},{p:t,n:r,Gx:n,Gy:a,b:o}=e,s=32,i={publicKey:33,publicKeyUncompressed:65,seed:48},c=(e="")=>{const t=Error(e);throw((...e)=>{"captureStackTrace"in Error&&"function"==typeof Error.captureStackTrace&&Error.captureStackTrace(...e)})(t,c),t},f=(e,t,r="")=>{const n=(a=e)instanceof Uint8Array||ArrayBuffer.isView(a)&&"Uint8Array"===a.constructor.name;var a;const o=e?.length,s=void 0!==t;if(!n||s&&o!==t){c((r&&`"${r}" `)+"expected Uint8Array"+(s?" of length "+t:"")+", got "+(n?"length="+o:"type="+typeof e))}return e},l=e=>new Uint8Array(e),d=(e,t)=>e.toString(16).padStart(t,"0"),u=e=>Array.from(f(e)).map(e=>d(e,2)).join(""),y=48,p=57,m=65,h=70,w=97,g=102,b=e=>e>=y&&e<=p?e-y:e>=m&&e<=h?e-(m-10):e>=w&&e<=g?e-(w-10):void 0,v=e=>{const t="hex invalid";if("string"!=typeof e)return c(t);const r=e.length,n=r/2;if(r%2)return c(t);const a=l(n);for(let r=0,o=0;r<n;r++,o+=2){const n=b(e.charCodeAt(o)),s=b(e.charCodeAt(o+1));if(void 0===n||void 0===s)return c(t);a[r]=16*n+s}return a},A=()=>globalThis?.crypto,k=()=>A()?.subtle??c("crypto.subtle must be defined, consider polyfill"),x=(...e)=>{const t=l(e.reduce((e,t)=>e+f(t).length,0));let r=0;return e.forEach(e=>{t.set(e,r),r+=e.length}),t},S=(e=s)=>A().getRandomValues(l(e)),T=BigInt,P=(e,t,r,n="bad number: out of range")=>(e=>"bigint"==typeof e)(e)&&t<=e&&e<r?e:c(n),E=(e,r=t)=>{const n=e%r;return n>=0n?n:r+n},U=e=>E(e,r),C=e=>e instanceof K?e:c("Point expected"),D=e=>E(E(e*e)*e+o),L=e=>P(e,0n,t),I=e=>P(e,1n,t),$=e=>0n==(1n&e),O=e=>Uint8Array.of(e),V=e=>{const r=D(I(e));let n=1n;for(let e=r,a=(t+1n)/4n;a>0n;a>>=1n)1n&a&&(n=n*e%t),e=e*e%t;return E(n*n)===r?n:c("sqrt invalid")};class K{static BASE;static ZERO;X;Y;Z;constructor(e,t,r){this.X=L(e),this.Y=I(t),this.Z=L(r),Object.freeze(this)}static CURVE(){return e}static fromAffine(e){const{x:t,y:r}=e;return 0n===t&&0n===r?B:new K(t,r,1n)}static fromBytes(e){f(e);const{publicKey:t,publicKeyUncompressed:r}=i;let n;const a=e.length,o=e[0],l=e.subarray(1),d=j(l,0,s);if(a===t&&(2===o||3===o)){let e=V(d);const t=$(e);$(T(o))!==t&&(e=E(-e)),n=new K(d,e,1n)}return a===r&&4===o&&(n=new K(d,j(l,s,64),1n)),n?n.assertValidity():c("bad point: not on curve")}static fromHex(e){return K.fromBytes(v(e))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}equals(e){const{X:t,Y:r,Z:n}=this,{X:a,Y:o,Z:s}=C(e),i=E(t*s),c=E(a*n),f=E(r*s),l=E(o*n);return i===c&&f===l}is0(){return this.equals(B)}negate(){return new K(this.X,E(-this.Y),this.Z)}double(){return this.add(this)}add(e){const{X:t,Y:r,Z:n}=this,{X:a,Y:s,Z:i}=C(e);let c=0n,f=0n,l=0n;const d=E(3n*o);let u=E(t*a),y=E(r*s),p=E(n*i),m=E(t+r),h=E(a+s);m=E(m*h),h=E(u+y),m=E(m-h),h=E(t+n);let w=E(a+i);return h=E(h*w),w=E(u+p),h=E(h-w),w=E(r+n),c=E(s+i),w=E(w*c),c=E(y+p),w=E(w-c),l=E(0n*h),c=E(d*p),l=E(c+l),c=E(y-l),l=E(y+l),f=E(c*l),y=E(u+u),y=E(y+u),p=E(0n*p),h=E(d*h),y=E(y+p),p=E(u-p),p=E(0n*p),h=E(h+p),u=E(y*h),f=E(f+u),u=E(w*h),c=E(m*c),c=E(c-u),u=E(m*y),l=E(w*l),l=E(l+u),new K(c,f,l)}subtract(e){return this.add(C(e).negate())}multiply(e,t=!0){if(!t&&0n===e)return B;if((e=>{P(e,1n,r)})(e),1n===e)return this;if(this.equals(R))return ye(e).p;let n=B,a=R;for(let r=this;e>0n;r=r.double(),e>>=1n)1n&e?n=n.add(r):t&&(a=a.add(r));return n}multiplyUnsafe(e){return this.multiply(e,!1)}toAffine(){const{X:e,Y:r,Z:n}=this;if(this.equals(B))return{x:0n,y:0n};if(1n===n)return{x:e,y:r};const a=((e,t)=>{(0n===e||t<=0n)&&c("no inverse n="+e+" mod="+t);let r=E(e,t),n=t,a=0n,o=1n;for(;0n!==r;){const e=n%r,t=a-o*(n/r);n=r,r=e,a=o,o=t}return 1n===n?E(a,t):c("no inverse")})(n,t);return 1n!==E(n*a)&&c("inverse invalid"),{x:E(e*a),y:E(r*a)}}assertValidity(){const{x:e,y:t}=this.toAffine();return I(e),I(t),E(t*t)===D(e)?this:c("bad point: not on curve")}toBytes(e=!0){const{x:t,y:r}=this.assertValidity().toAffine(),n=Z(t);return e?x((e=>O($(e)?2:3))(r),n):x(O(4),n,Z(r))}toHex(e){return u(this.toBytes(e))}}const R=new K(n,a,1n),B=new K(0n,1n,0n);K.BASE=R,K.ZERO=B;const H=e=>T("0x"+(u(e)||"0")),j=(e,t,r)=>H(e.subarray(t,r)),M=2n**256n,Z=e=>v(d(P(e,0n,M),64)),X=e=>{const t=H(f(e,s,"secret key"));return P(t,1n,r,"invalid secret key: outside of range")},q="SHA-256",Y={async hmacSha256Async(e,t){const r=k(),n="HMAC",a=await r.importKey("raw",e,{name:n,hash:{name:q}},!1,["sign"]);return l(await r.sign(n,a,t))},hmacSha256:void 0,async sha256Async(e){return l(await k().digest(q,e))},sha256:void 0},G=(e=S(i.seed))=>{f(e),(e.length<i.seed||e.length>1024)&&c("expected 40-1024b");const t=E(H(e),r-1n);return Z(t+1n)},N={isValidSecretKey(e){try{return!!X(e)}catch(e){return!1}},isValidPublicKey(e,t){const{publicKey:r,publicKeyUncompressed:n}=i;try{const a=e.length;return(!0!==t||a===r)&&((!1!==t||a===n)&&!!K.fromBytes(e))}catch(e){return!1}},randomSecretKey:G},J=e=>Uint8Array.from("BIP0340/"+e,e=>e.charCodeAt(0)),_="nonce",z="challenge",F=async(e,...t)=>{const r=Y.sha256Async,n=await r(J(e));return await r(x(n,n,...t))},Q=e=>{const t=X(e),r=R.multiply(t),{x:n,y:a}=r.assertValidity().toAffine();return{d:$(a)?t:U(-t),px:Z(n)}},W=e=>U(H(e)),ee=async(...e)=>W(await F(z,...e)),te=e=>Q(e).px;re=te;var re;const ne=(e,t,r)=>{const{px:n,d:a}=Q(t);return{m:f(e),px:n,d:a,a:f(r,s)}},ae=e=>{const t=W(e);0n===t&&c("sign failed: k is zero");const{px:r,d:n}=Q(Z(t));return{rx:r,k:n}},oe=(e,t,r,n)=>x(t,Z(U(e+r*n))),se="invalid signature produced",ie=(e,n,a,o)=>{const i=f(e,64,"signature"),c=f(n,void 0,"message"),l=f(a,s,"publicKey");try{const e=H(l),n=V(e),a=$(n)?n:E(-n),f=new K(e,a,1n).assertValidity(),y=Z(f.toAffine().x),p=j(i,0,s);P(p,1n,t);const m=j(i,s,64);P(m,1n,r);const h=x(Z(p),y,c);return d=o(h),u=e=>{const{x:t,y:r}=(n=f,a=m,o=U(-e),R.multiply(a,!1).add(n.multiply(o,!1)).assertValidity()).toAffine();var n,a,o;return!(!$(r)||t!==p)},d instanceof Promise?d.then(u):u(d)}catch(e){return!1}var d,u},ce=async(e,t,r)=>ie(e,t,r,ee),fe=te,le=async(e,t,r=S(s))=>{const{m:n,px:a,d:o,a:i}=ne(e,t,r),f=await F("aux",i),l=Z(o^H(f)),d=await F(_,l,a,n),{rx:u,k:y}=ae(d),p=await ee(u,a,n),m=oe(y,u,p,o);return await ce(m,n,a)||c(se),m};let de;const ue=(e,t)=>{const r=t.negate();return e?r:t},ye=e=>{const t=de||(de=(()=>{const e=[];let t=R,r=t;for(let n=0;n<33;n++){r=t,e.push(r);for(let n=1;n<128;n++)r=r.add(t),e.push(r);t=r.double()}return e})());let r=B,n=R;const a=T(255),o=T(8);for(let s=0;s<33;s++){let i=Number(e&a);e>>=o,i>128&&(i-=256,e+=1n);const c=128*s,f=c,l=c+Math.abs(i)-1,d=s%2!=0,u=i<0;0===i?n=n.add(ue(d,t[f])):r=r.add(ue(u,t[l]))}return 0n!==e&&c("invalid wnaf"),{p:r,f:n}},{floor:pe,sin:me}=Math,he="Trystero",we=(e,t)=>Array(e).fill().map(t),ge="0123456789AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz",be=e=>{const t=(()=>{try{return"undefined"!=typeof globalThis&&globalThis.crypto&&"function"==typeof globalThis.crypto.getRandomValues?globalThis.crypto:null}catch(e){return null}})();if(t){const r=new Uint8Array(e);return t.getRandomValues(r),Array.from(r,e=>ge[e%62]).join("")}const r=be.counter||0;be.counter=(r+1)%1e6;const n=Date.now()+r;return we(e,(e,t)=>ge[Math.abs((n+1664525*t+1013904223)%62)%62]).join("")},ve=be(20),Ae=Promise.all.bind(Promise),ke="undefined"!=typeof window,{entries:xe,fromEntries:Se,keys:Te}=Object,Pe=()=>{},Ee=e=>Error(`${he}: ${e}`),Ue=new TextEncoder,Ce=new TextDecoder,De=e=>Ue.encode(e),Le=e=>Ce.decode(e),Ie=e=>e.reduce((e,t)=>e+t.toString(16).padStart(2,"0"),""),$e=(...e)=>e.join("@"),Oe=(e,t,r)=>(e.relayUrls||((e,t)=>{const r=[...e],n=()=>{const e=1e4*me(t++);return e-pe(e)};let a=r.length;for(;a;){const e=pe(n()*a);a--,[r[a],r[e]]=[r[e],r[a]]}return r})(t,Re(e.appId))).slice(0,e.relayUrls?e.relayUrls.length:e.relayRedundancy||r),Ve=JSON.stringify,Ke=JSON.parse,Re=(e,t=Number.MAX_SAFE_INTEGER)=>e.split("").reduce((e,t)=>e+t.charCodeAt(0),0)%t,Be={},He="AES-GCM",je={},Me=async(e,t)=>new Uint8Array(await crypto.subtle.digest(e,De(t))),Ze=async e=>je[e]||=Array.from(await Me("SHA-1",e)).map(e=>e.toString(36)).join(""),Xe=async(e,t)=>{const r=crypto.getRandomValues(new Uint8Array(16));return r.join(",")+"$"+(n=await crypto.subtle.encrypt({name:He,iv:r},await e,De(t)),btoa(String.fromCharCode.apply(null,new Uint8Array(n))));var n},qe=async(e,t)=>{if(!t||"string"!=typeof t||!t.includes("$"))throw Error("Invalid encrypted data format");const[r,n]=t.split("$");if(!r||!n)throw Error("Missing IV or ciphertext in encrypted data");return Le(await crypto.subtle.decrypt({name:He,iv:new Uint8Array(r.split(","))},await e,(e=>{const t=atob(e);return new Uint8Array(t.length).map((e,r)=>t.charCodeAt(r)).buffer})(n)))},Ye="icegatheringstatechange",Ge="offer";var Ne=(e,{rtcConfig:t,rtcPolyfill:r,turnConfig:n})=>{const a=new(r||RTCPeerConnection)({iceServers:Je.concat(n||[]),...t}),o={};let s=!1,i=!1,c=null;const f=e=>{e.binaryType="arraybuffer",e.bufferedAmountLowThreshold=65535,e.onmessage=e=>o.data?.(e.data),e.onopen=()=>o.connect?.(),e.onclose=()=>o.close?.(),e.onerror=e=>o.error?.(e)},l=e=>Promise.race([new Promise(t=>{const r=()=>{"complete"===e.iceGatheringState&&(e.removeEventListener(Ye,r),t())};e.addEventListener(Ye,r),r()}),new Promise(e=>setTimeout(e,5e3))]).then(()=>({type:e.localDescription.type,sdp:e.localDescription.sdp.replace(/a=ice-options:trickle\s\n/g,"")}));return e?(c=a.createDataChannel("data"),f(c)):a.ondatachannel=({channel:e})=>{c=e,f(e)},a.onnegotiationneeded=async()=>{try{s=!0,await a.setLocalDescription();const e=await l(a);o.signal?.(e)}catch(e){o.error?.(e)}finally{s=!1}},a.onconnectionstatechange=()=>{["disconnected","failed","closed"].includes(a.connectionState)&&o.close?.()},a.ontrack=e=>{o.track?.(e.track,e.streams[0]),o.stream?.(e.streams[0])},a.onremovestream=e=>o.stream?.(e.stream),e&&(a.canTrickleIceCandidates||a.onnegotiationneeded()),{created:Date.now(),connection:a,get channel(){return c},get isDead(){return"closed"===a.connectionState},async signal(t){if("open"!==c?.readyState||t.sdp?.includes("a=rtpmap"))try{if(t.type===Ge){if(s||"stable"!==a.signalingState&&!i){if(e)return;await Ae([a.setLocalDescription({type:"rollback"}),a.setRemoteDescription(t)])}else await a.setRemoteDescription(t);await a.setLocalDescription();const r=await l(a);return o.signal?.(r),r}if("answer"===t.type){i=!0;try{await a.setRemoteDescription(t)}finally{i=!1}}}catch(e){o.error?.(e)}},sendData(e){if(!c||"open"!==c.readyState)throw Error("Data channel is not available or not open");c.send(e)},destroy(){c?.close(),a.close(),s=!1,i=!1},setHandlers(e){return Object.assign(o,e)},offerPromise:e?new Promise(e=>o.signal=t=>{t.type===Ge&&e(t)}):Promise.resolve(),addStream(e){return e.getTracks().forEach(t=>a.addTrack(t,e))},removeStream(e){return a.getSenders().filter(t=>e.getTracks().includes(t.track)).forEach(e=>a.removeTrack(e))},addTrack(e,t){return a.addTrack(e,t)},removeTrack(e){const t=a.getSenders().find(t=>t.track===e);t&&a.removeTrack(t)},replaceTrack(e,t){const r=a.getSenders().find(t=>t.track===e);if(r)return r.replaceTrack(t)}}};const Je=[...we(3,(e,t)=>`stun:stun${t||""}.l.google.com:19302`),"stun:stun.cloudflare.com:3478"].map(e=>({urls:e})),_e=["none","error","warn","info","debug"],ze=(e={})=>{const{level:t="warn",prefix:r="Trystero"}=e||{},n=_e.includes(t)?_e.indexOf(t):_e.indexOf("warn"),a=e=>_e.indexOf(e)<=n&&n>0,o=e=>`[${r}:${e}]`;return{error(...e){return a("error")&&console.error(o("error"),...e)},warn(...e){return a("warn")&&console.warn(o("warn"),...e)},info(){return a("info")&&void 0},debug(...e){return a("debug")&&console.debug(o("debug"),...e)}}},Fe=Object.getPrototypeOf(Uint8Array),Qe=16369,We=255,et="bufferedamountlow",tt=e=>"@_"+e;var rt=(e,t,r,n)=>{const a=n||ze({level:"none"}),o={},s={},i={},c={},f={},l={},d={},u={onPeerJoin:Pe,onPeerLeave:Pe,onPeerStream:Pe,onPeerTrack:Pe},y=(e,t)=>(e?Array.isArray(e)?e:[e]:Te(o)).flatMap(e=>{const r=o[e];return r?t(e,r):(a.warn(`${he}: no peer with id ${e} found`),[])}),p=e=>{o[e]&&(o[e].destroy(),delete o[e],delete c[e],delete f[e],u.onPeerLeave(e),t(e))},m=e=>{if(s[e])return i[e];if(!e)throw Ee("action type argument is required");const t=De(e);if(t.byteLength>12)throw Ee(`action type string "${e}" (${t.byteLength}b) exceeds byte limit (12). Hint: choose a shorter name.`);const r=new Uint8Array(12);r.set(t);let n=0;return s[e]={onComplete:Pe,onProgress:Pe,setOnComplete(t){return s[e]={...s[e],onComplete:t}},setOnProgress(t){return s[e]={...s[e],onProgress:t}},async send(e,t,a,s){if(a&&"object"!=typeof a)throw Ee("action meta argument must be an object");const i=typeof e;if("undefined"===i)throw Ee("action data cannot be undefined");const c="string"!==i,f=e instanceof Blob,l=f||e instanceof ArrayBuffer||e instanceof Fe;if(a&&!l)throw Ee("action meta argument can only be used with binary data");const d=l?new Uint8Array(f?await e.arrayBuffer():e):De(c?Ve(e):e),u=a?De(Ve(a)):null,p=Math.ceil(d.byteLength/Qe)+(a?1:0)||1,m=we(p,(e,t)=>{const o=t===p-1,s=a&&0===t,i=new Uint8Array(15+(s?u.byteLength:o?d.byteLength-Qe*(p-(a?2:1)):Qe));return i.set(r),i.set([n],12),i.set([o|s<<1|l<<2|c<<3],13),i.set([Math.round((t+1)/p*We)],14),i.set(a?s?u:d.subarray((t-1)*Qe,t*Qe):d.subarray(t*Qe,(t+1)*Qe),15),i});return n=n+1&We,Ae(y(t,async(e,t)=>{const{channel:r}=t;let n=0;for(;n<p;){const i=m[n];if(r.bufferedAmount>r.bufferedAmountLowThreshold&&await new Promise(e=>{const t=()=>{r.removeEventListener(et,t),e()};r.addEventListener(et,t)}),!o[e])break;t.sendData(i),n++,s?.(i[14]/We,e,a)}}))}},i[e]||=[s[e].send,s[e].setOnComplete,s[e].setOnProgress]},h=async()=>{await E(""),await new Promise(e=>setTimeout(e,99)),xe(o).forEach(([e,t])=>{t.destroy(),delete o[e]}),r()},[w,g]=m(tt("ping")),[b,v]=m(tt("pong")),[A,k]=m(tt("signal")),[x,S]=m(tt("stream")),[T,P]=m(tt("track")),[E,U]=m(tt("leave"));return e((e,t)=>{o[t]||(o[t]=e,e.setHandlers({data(e){return((e,t)=>{const r=new Uint8Array(t),n=Le(r.subarray(0,12)).replaceAll("\0",""),[a]=r.subarray(12,13),[i]=r.subarray(13,14),[f]=r.subarray(14,15),l=r.subarray(15),d=!!(1&i),u=!!(2&i),y=!!(4&i),p=!!(8&i);if(!s[n])return void console.warn(`${he}: received message with unregistered type (${n})`);if(!o[e])return;c[e]||={},c[e][n]||={};const m=c[e][n][a]||={chunks:[]};if(u?m.meta=Ke(Le(l)):m.chunks.push(l),s[n].onProgress(f/We,e,m.meta),!d)return;const h=new Uint8Array(m.chunks.reduce((e,t)=>e+t.byteLength,0));if(m.chunks.reduce((e,t)=>(h.set(t,e),e+t.byteLength),0),c[e]?.[n]&&delete c[e][n][a],y)s[n].onComplete(h,e,m.meta);else{const t=Le(h);s[n].onComplete(p?Ke(t):t,e)}})(t,e)},stream(e){u.onPeerStream(e,t,l[t]),delete l[t]},track(e,r){u.onPeerTrack(e,r,t,d[t]),delete d[t]},signal(e){return A(e,t)},close(){return p(t)},error(e){a.error(e),p(t)}}),u.onPeerJoin(t))}),g((e,t)=>b("",t)),v((e,t)=>{f[t]?.(),delete f[t]}),k((e,t)=>o[t]?.signal(e)),S((e,t)=>l[t]=e),P((e,t)=>d[t]=e),U((e,t)=>p(t)),ke&&addEventListener("beforeunload",h),{makeAction:m,leave:h,async ping(e){if(!e)throw Ee("ping() must be called with target peer ID");const t=Date.now();return w("",e),await new Promise(t=>f[e]=t),Date.now()-t},getPeers(){return Se(xe(o).map(([e,t])=>[e,t.connection]))},addStream(e,t,r){return y(t,async(t,n)=>{r&&await x(r,t),n.addStream(e)})},removeStream(e,t){return y(t,(t,r)=>r.removeStream(e))},addTrack(e,t,r,n){return y(r,async(r,a)=>{n&&await T(n,r),a.addTrack(e,t)})},removeTrack(e,t){return y(t,(t,r)=>r.removeTrack(e))},replaceTrack(e,t,r,n){return y(r,async(r,a)=>{n&&await T(n,r),a.replaceTrack(e,t)})},onPeerJoin(e){return u.onPeerJoin=e},onPeerLeave(e){return u.onPeerLeave=e},onPeerStream(e){return u.onPeerStream=e},onPeerTrack(e){return u.onPeerTrack=e}}};const nt={},at="EVENT",ot=N.randomPrivateKey(),st=Ie(fe(ot)),it={},ct={},ft={},lt=()=>Math.floor(Date.now()/1e3),dt=e=>ft[e]??=Re(e,1e4)+2e4,ut=async(e,t)=>{const r={kind:dt(e),tags:[["x",e]],created_at:lt(),content:t,pubkey:st},n=await Me("SHA-256",Ve([0,r.pubkey,r.created_at,r.kind,r.tags,r.content]));return Ve([at,{...r,id:Ie(n),sig:Ie(await le(n,ot))}])},yt=(e,t)=>(it[e]=t,Ve(["REQ",e,{kinds:[dt(t)],since:lt(),"#x":[t]}])),pt=e=>(delete it[e],Ve(["CLOSE",e])),mt=(({init:e,subscribe:t,announce:r})=>{const n={};let a,o,s,i=0,c=!1;return(f,l,d)=>{const u=(e=>{if(!e)throw Ee("requires a config map as the first argument");const t={...e};return t.logger=ze(e.logger),t.rtcConfig||={},t})(f),{appId:y,logger:p}=u;if(n[y]?.[l])return n[y][l];const m={},h={},w=$e(he,y,l),g=Ze(w),b=Ze($e(w,ve)),v=(async(e,t,r)=>crypto.subtle.importKey("raw",await crypto.subtle.digest({name:"SHA-256"},De(`${e}:${t}:${r}`)),{name:He},!1,["encrypt","decrypt"]))(u.password||"",y,l),A=e=>async t=>({type:t.type,sdp:await e(v,t.sdp)}),k=A(qe),x=A(Xe),S=()=>Ne(!0,u),T=(e,t,r)=>{h[t]?h[t]!==e&&e.destroy():(h[t]=e,$(e,t),m[t]?.forEach((e,t)=>{t!==r&&e.destroy()}),delete m[t])},P=(e,t)=>{h[t]===e&&delete h[t]},E=e=>(o.push(...we(e,S)),Ae(o.splice(0,e).map(e=>e.offerPromise.then(x).then(t=>({peer:e,offer:t}))))),U=(e,t)=>d?.({error:`incorrect password (${u.password}) when decrypting ${t}`,appId:y,peerId:e,roomId:l}),C=e=>async(t,r,n)=>{const[a,o]=await Ae([g,b]);if(t!==a&&t!==o)return;const{peerId:s,offer:i,answer:c,peer:f}="string"==typeof r?Ke(r):r;if(s!==ve&&!h[s])if(!s||i||c){if(i){const t=m[s]?.[e];if(t&&ve>s)return;const r=Ne(!1,u);let a;r.setHandlers({connect(){return T(r,s,e)},close(){return P(r,s)}});try{a=await k(i)}catch{return void U(s,"offer")}if(r.isDead)return;const[o,c]=await Ae([Ze($e(w,s)),r.signal(a)]);n(o,Ve({peerId:ve,answer:await x(c)}))}else if(c){let t;try{t=await k(c)}catch(e){return void U(s,"answer")}if(f)f.setHandlers({connect(){return T(f,s,e)},close(){return P(f,s)}}),f.signal(t);else{const r=m[s]?.[e];r&&!r.isDead&&r.signal(t)}}}else{if(m[s]?.[e])return;const[[{peer:t,offer:r}],a]=await Ae([E(1),Ze($e(w,s))]);m[s]||=[],m[s][e]=t,setTimeout(()=>((e,t)=>{if(h[e])return;const r=m[e]?.[t];r&&(delete m[e][t],r.destroy())})(s,e),.9*D[e]),t.setHandlers({connect(){return T(t,s,e)},close(){return P(t,s)}}),n(a,Ve({peerId:ve,offer:r}))}};if(!y&&!u.firebaseApp)throw Ee("config map is missing appId field");if(!l)throw Ee("roomId argument required");if(!c){const t=e(f);o=we(20,S),a=Array.isArray(t)?t:[t],c=!0,s=setInterval(()=>o=o.filter(e=>{const t=Date.now()-e.created<57333;return t||e.destroy(),t}),59052.99)}const D=a.map(()=>5333),L=[],I=a.map(async(e,r)=>t(await e,await g,await b,C(r),E));Ae([g,b]).then(([e,t])=>{const n=async(a,o)=>{const s=await r(a,e,t);"number"==typeof s&&(D[o]=s),L[o]=setTimeout(()=>n(a,o),D[o])};I.forEach(async(e,t)=>{await e,n(await a[t],t)})});let $=Pe;return n[y]||={},i++,n[y][l]=rt(e=>$=e,e=>delete h[e],()=>{delete n[y][l],L.forEach(clearTimeout),I.forEach(async e=>(await e)()),i--,i<=0&&(s&&(clearInterval(s),s=null),o?.forEach(e=>e.destroy()),o=[],a=null,c=!1)},p)}})({init(e){return Oe(e,gt,5).map(e=>{const t=((e,t)=>{const r={},n=()=>{const a=new WebSocket(e);a.onclose=()=>{Be[e]??=3333,setTimeout(n,Be[e]),Be[e]*=2},a.onmessage=e=>t(e.data),r.socket=a,r.url=a.url,r.ready=new Promise(t=>a.onopen=()=>{t(r),Be[e]=3333}),r.send=e=>{1===a.readyState&&a.send(e)}};return n(),r})(e,e=>{const[r,n,a,o]=Ke(e);if(r!==at){const e=`${he}: relay failure from ${t.url} - `;return void("NOTICE"===r?console.warn(e+n):"OK"!==r||a||console.warn(e+o))}ct[n]?.(it[n],a.content)});return nt[e]=t,t.ready})},subscribe(e,t,r,n){const a=be(64),o=be(64);return ct[a]=ct[o]=(t,r)=>n(t,r,async(t,r)=>e.send(await ut(t,r))),e.send(yt(a,t)),e.send(yt(o,r)),()=>{e.send(pt(a)),e.send(pt(o)),delete ct[a],delete ct[o]}},async announce(e,t){return e.send(await ut(t,Ve({peerId:ve})))}}),ht=(wt=nt,()=>Se(xe(wt).map(([e,t])=>[e,t.socket])));var wt;const gt=["black.nostrcity.club","ftp.halifax.rwth-aachen.de/nostr","nos.lol","nostr.cool110.xyz","nostr.data.haus","nostr.sathoarder.com","nostr.vulpem.com","relay.agorist.space","relay.binaryrobot.com","relay.damus.io","relay.fountain.fm","relay.mostro.network","relay.nostraddress.com","relay.nostrdice.com","relay.nostromo.social","relay.oldenburg.cool","relay.verified-nostr.com","yabu.me/v2"].map(e=>"wss://"+e);export{ut as createEvent,gt as defaultRelayUrls,ht as getRelaySockets,mt as joinRoom,ve as selfId,yt as subscribe};