class t{constructor(t,e,i,s,a=100){this.x=t,this.y=e,this.width=i,this.height=s,this.duration=a}}class e{constructor(t,e,i={}){this.name=t,this.frames=e,this.loop=null===i.loop||void 0===i.loop||i.loop,this.pingPong=i.pingPong||!1,this.speed=i.speed||1,this.onComplete=i.onComplete||null,this.onFrame=i.onFrame||null,this.currentFrame=0,this.elapsedTime=0,this.direction=1,this.isPlaying=!1,this.hasCompleted=!1}play(){this.isPlaying=!0,this.hasCompleted=!1,this.currentFrame=0,this.elapsedTime=0,this.direction=1}stop(){this.isPlaying=!1,this.reset()}pause(){this.isPlaying=!1}resume(){this.isPlaying=!0}reset(){this.currentFrame=0,this.elapsedTime=0,this.direction=1,this.hasCompleted=!1}update(t){if(!this.isPlaying||0===this.frames.length)return;this.elapsedTime+=t*this.speed*1e3;const e=this.frames[this.currentFrame];if(e&&e.duration<=0)this.loop||this.currentFrame!==this.frames.length-1||(this.isPlaying=!1,this.hasCompleted=!0,this.onComplete&&this.onComplete());else if(this.elapsedTime>=e.duration){this.elapsedTime-=e.duration;const t=this.currentFrame;this.currentFrame+=this.direction,this.pingPong?(this.currentFrame>=this.frames.length||this.currentFrame<0)&&(this.direction*=-1,this.currentFrame+=2*this.direction):this.currentFrame>=this.frames.length&&(this.loop?this.currentFrame=0:(this.currentFrame=this.frames.length-1,this.isPlaying=!1,this.hasCompleted=!0,this.onComplete&&this.onComplete())),this.onFrame&&this.currentFrame!==t&&this.onFrame(this.currentFrame,this.frames[this.currentFrame])}}getCurrentFrame(){return 0===this.frames.length||this.currentFrame<0||this.currentFrame>=this.frames.length?null:this.frames[this.currentFrame]}getProgress(){return this.frames.length<=1?0:this.currentFrame/(this.frames.length-1)}getFrameAt(t){return t<0||t>=this.frames.length?null:this.frames[t]}}class i{constructor(){this.animations=new Map,this.currentAnimation=null,this.transitions=new Map,this.blendTime=0,this.blendFrom=null,this.blendProgress=0}addAnimation(t,e){if("string"==typeof t&&e)return void this.animations.set(t,e);const i=t;this.animations.set(i.name,i)}play(t,e={}){const i=this.animations.get(t);if(!i)return;const s=e.transition||0;s>0&&this.currentAnimation&&(this.blendFrom=this.currentAnimation,this.blendTime=s,this.blendProgress=0),this.currentAnimation=i,i.play()}stop(){this.currentAnimation&&this.currentAnimation.stop()}update(t){this.blendTime>0&&(this.blendProgress+=t,this.blendProgress>=this.blendTime&&(this.blendTime=0,this.blendFrom=null,this.blendProgress=0)),this.currentAnimation&&this.currentAnimation.update(t)}getCurrentFrame(){return this.currentAnimation?this.currentAnimation.getCurrentFrame():null}getBlendFrames(){if(0===this.blendTime||!this.blendFrom)return{current:this.getCurrentFrame(),blend:null,blendFactor:0};const t=this.blendProgress/this.blendTime;return{current:this.currentAnimation.getCurrentFrame(),blend:this.blendFrom.getCurrentFrame(),blendFactor:t}}isPlaying(t){return this.currentAnimation&&this.currentAnimation.name===t&&this.currentAnimation.isPlaying}setSpeed(t){this.currentAnimation&&(this.currentAnimation.speed=t)}}class s{constructor(){this.animations=new Map}createBreathingAnimation(t={}){const{baseScale:e=1,intensity:i=.015,speed:s=2,asymmetry:a=.2}=t;return{time:0,phase:0,breathRate:s,currentIntensity:i,depthMod:1,asymmetryOffset:0,_buf:{scaleX:e,scaleY:e,offsetY:0,chestExpansion:0,phase:0,intensity:0},modulateForState(t){switch(t){case"running":this.depthMod=.3,this.breathRate=3*s;break;case"attacking":this.depthMod=.5,this.breathRate=1.8*s;break;case"blocking":this.depthMod=.2,this.breathRate=1.3*s;break;case"hurt":this.depthMod=.1,this.breathRate=.5*s;break;case"dead":this.depthMod=0,this.breathRate=0;break;default:this.depthMod=1,this.breathRate=s}},update(t){const i=this._buf;if(this.breathRate<=0)return i.scaleX=e,i.scaleY=e,i.offsetY=0,i.chestExpansion=0,i.phase=0,i.intensity=0,i;this.time+=t*this.breathRate,this.phase=Math.sin(this.time);const s=this.currentIntensity*this.depthMod,n=e+this.phase*s,o=e+this.phase*s*.7,r=n+Math.sin(.7*this.time)*a*s*.3,h=this.phase*s*2,l=1-Math.exp(5*-t);return this.currentIntensity=this.currentIntensity+(s-this.currentIntensity)*l,i.scaleX=r,i.scaleY=o,i.offsetY=.5*-h,i.chestExpansion=h,i.phase=this.phase,i.intensity=s,i}}}createBobbingAnimation(t=5,e=2){return{time:0,_buf:{offsetY:0,rotation:0},update(i){this.time+=i*e;const s=this._buf;return s.offsetY=Math.sin(this.time)*t,s.rotation=.05*Math.sin(.5*this.time),s}}}createSquashStretch(t=.3,e=.2){return{time:0,active:!1,_buf:{scaleX:1,scaleY:1},trigger(){this.time=0,this.active=!0},update(i){const s=this._buf;if(!this.active)return s.scaleX=1,s.scaleY=1,s;this.time+=i;const a=Math.min(this.time/e,1);if(a>=1)return this.active=!1,s.scaleX=1,s.scaleY=1,s;const n=2**(-10*a)*Math.sin(2*Math.PI*(a-.075)/.3)+1,o=1-n*t,r=1+n*t*.5;return s.scaleX=a<.5?r:o,s.scaleY=a<.5?o:r,s}}}createWobble(t=10,e=.8,i=.1){return{velocity:0,displacement:0,_buf:{scaleX:1,scaleY:1,rotation:0},update(s,a=0){const n=-t*this.displacement,o=-e*this.velocity;this.velocity+=(n+o+a)*s,this.displacement+=this.velocity*s;const r=this._buf;return r.scaleX=1+this.displacement*i,r.scaleY=1-this.displacement*i*.5,r.rotation=.1*this.displacement,r},impulse(t){this.velocity+=t}}}createAnticipation(t=.3,e=.15){return{time:0,active:!1,phase:"idle",_buf:{scaleX:1,scaleY:1,offsetX:0},trigger(){this.time=0,this.active=!0,this.phase="anticipation"},update(i){const s=this._buf;if(!this.active)return s.scaleX=1,s.scaleY=1,s.offsetX=0,s;if(this.time+=i,"anticipation"===this.phase){const i=Math.min(this.time/(.4*t),1),a=1-Math.cos(i*Math.PI*.5);return i>=1&&(this.phase="action",this.time=0),s.scaleX=1-a*e,s.scaleY=1+a*e*.5,s.offsetX=10*-a,s}if("action"===this.phase){const i=Math.min(this.time/(.2*t),1),a=Math.sin(i*Math.PI*.5);return i>=1&&(this.phase="recovery",this.time=0),s.scaleX=1+a*e*2,s.scaleY=1-a*e,s.offsetX=20*a,s}if("recovery"===this.phase){const i=Math.min(this.time/(.4*t),1),a=1-(1-i)**3;return i>=1&&(this.active=!1,this.phase="idle"),s.scaleX=1+(1-a)*e*.5,s.scaleY=1-(1-a)*e*.25,s.offsetX=10*(1-a),s}return s.scaleX=1,s.scaleY=1,s.offsetX=0,s}}}createAdvancedIK(t={}){const{armLength:e=25,forearmLength:i=20,damping:s=.8,stiffness:a=.5,maxReach:n=40}=t;return{shoulder:{x:0,y:0},elbow:{x:0,y:0},hand:{x:0,y:0},target:{x:0,y:0},targetVelocity:{x:0,y:0},_buf:{shoulder:{x:0,y:0},elbow:{x:0,y:0},hand:{x:0,y:0},target:{x:0,y:0},reach:0,stiffness:0},solveIK(t,s,a,o){this.target.x=t,this.target.y=s,this.shoulder.x=a,this.shoulder.y=o;const r=t-a,h=s-o,l=Math.sqrt(r*r+h*h),c=Math.min(l,n),m=c/l,g=a+r*m,d=o+h*m,u=e+i,p=Math.acos(Math.max(-1,Math.min(1,c/u))),f=Math.atan2(d-o,g-a);this.elbow.x=a+Math.cos(f-.5*p)*e,this.elbow.y=o+Math.sin(f-.5*p)*e,this.hand.x=this.elbow.x+Math.cos(f+.5*p)*i,this.hand.y=this.elbow.y+Math.sin(f+.5*p)*i;const y=this._buf;return y.shoulder.x=this.shoulder.x,y.shoulder.y=this.shoulder.y,y.elbow.x=this.elbow.x,y.elbow.y=this.elbow.y,y.hand.x=this.hand.x,y.hand.y=this.hand.y,y.target.x=g,y.target.y=d,y.reach=c/u,y},update(t,e,i,n,o){const r=e+this.targetVelocity.x*t*.1,h=i+this.targetVelocity.y*t*.1;this.targetVelocity.x=(r-this.target.x)/t*s,this.targetVelocity.y=(h-this.target.y)/t*s;const l=this.solveIK(r,h,n,o),c=1-Math.exp(-a*t),m=this._buf;return m.shoulder.x=l.shoulder.x,m.shoulder.y=l.shoulder.y,m.elbow.x=l.elbow.x,m.elbow.y=l.elbow.y,m.hand.x=l.hand.x,m.hand.y=l.hand.y,m.target.x=l.target.x,m.target.y=l.target.y,m.reach=l.reach,m.stiffness=c,m}}}createSecondaryMotion(t={}){const{segments:e=5,length:i=15,damping:s=.85,gravity:a=.5,windStrength:n=.1}=t;return{segments:[],anchorPoint:{x:0,y:0},windTime:0,_segBuf:[],initialize(t,s){this.anchorPoint={x:t,y:s},this.segments=[];for(let a=0;a<e;a++)this.segments.push({x:t,y:s+a*(i/e),vx:0,vy:0,prevX:t,prevY:s+a*(i/e)})},update(t,o,r,h=0){this.anchorPoint.x=o,this.anchorPoint.y=r,this.windTime+=t,this.segments[0].x=o,this.segments[0].y=r;for(let o=1;o<this.segments.length;o++){const r=this.segments[o],l=this.segments[o-1],c=r.x-l.x,m=r.y-l.y,g=Math.sqrt(c*c+m*m);if(g>0){const t=i/e/g;r.x=l.x+c*t,r.y=l.y+m*t}r.vy+=a*t;const d=Math.sin(2*this.windTime+h)*n,u=Math.cos(1.5*this.windTime+h)*n*.5;r.vx+=d*t,r.vy+=u*t;const p=r.x,f=r.y;r.x+=(r.x-r.prevX)*s+r.vx*t,r.y+=(r.y-r.prevY)*s+r.vy*t,r.prevX=p,r.prevY=f,r.vx*=s,r.vy*=s}this._segBuf&&this._segBuf.length===this.segments.length||(this._segBuf=Array(this.segments.length));for(let t=0;t<this.segments.length;t++)this._segBuf[t]=this.segments[t];return this._segBuf},applyForce(t,e,i=-1){-1===i?this.segments.forEach(i=>{i.vx+=t,i.vy+=e}):i<this.segments.length&&(this.segments[i].vx+=t,this.segments[i].vy+=e)}}}createMomentumSystem(t={}){const{maxMomentum:e=10,momentumDecay:i=.9,momentumInfluence:s=.3,directionSmoothing:a=.8}=t;return{momentum:{x:0,y:0},smoothedDirection:{x:0,y:0},lastVelocity:{x:0,y:0},_buf:{momentum:{x:0,y:0},smoothedDirection:{x:0,y:0},leanAngle:0,bounceFactor:0,stretchFactor:0},update(t,n,o,r=!0){const h=n-this.lastVelocity.x,l=o-this.lastVelocity.y;this.lastVelocity={x:n,y:o};const c=Math.sqrt(h*h+l*l);if(c>.1){const t=Math.min(c*s,e),i=h/c,a=l/c;this.momentum.x+=i*t,this.momentum.y+=a*t}this.momentum.x*=i,this.momentum.y*=i;const m=Math.sqrt(this.momentum.x*this.momentum.x+this.momentum.y*this.momentum.y);m>e&&(this.momentum.x=this.momentum.x/m*e,this.momentum.y=this.momentum.y/m*e);const g=n,d=o,u=Math.sqrt(g*g+d*d);if(u>.1){const t={x:g/u,y:d/u};this.smoothedDirection.x=this.smoothedDirection.x*(1-a)+t.x*a,this.smoothedDirection.y=this.smoothedDirection.y*(1-a)+t.y*a}const p=this._buf;return p.momentum.x=this.momentum.x,p.momentum.y=this.momentum.y,p.smoothedDirection.x=this.smoothedDirection.x,p.smoothedDirection.y=this.smoothedDirection.y,p.leanAngle=r?.3*Math.atan2(this.momentum.x,Math.abs(this.momentum.y)+1):0,p.bounceFactor=.1*m,p.stretchFactor=Math.max(0,.05*m),p},addImpulse(t,e){this.momentum.x+=t,this.momentum.y+=e}}}createTrailEffect(t=5,e=.3){return{trails:[],lastPosition:null,update(i,s){if(this.trails=this.trails.filter(t=>(t.alpha-=e*i,t.alpha>0)),this.lastPosition){const e=s.x-this.lastPosition.x,i=s.y-this.lastPosition.y;Math.sqrt(e*e+i*i)>10&&(this.trails.push({x:this.lastPosition.x,y:this.lastPosition.y,alpha:.5,scale:.8}),this.trails.length>t&&this.trails.shift(),this.lastPosition={...s})}else this.lastPosition={...s};return this.trails},clear(){this.trails=[]}}}}class a{constructor(){this.controller=new i,this.procedural=new s,this.breathing=this.procedural.createBreathingAnimation({intensity:.012,speed:1.8,asymmetry:.15}),this.squashStretch=this.procedural.createSquashStretch(),this.wobble=this.procedural.createWobble(),this.anticipation=this.procedural.createAnticipation(),this.trail=this.procedural.createTrailEffect(),this.advancedIK=this.procedural.createAdvancedIK({armLength:22,forearmLength:18,damping:.75,stiffness:.4}),this.secondaryMotion=this.procedural.createSecondaryMotion({segments:4,length:12,damping:.82,stiffness:.25,gravity:.3,windStrength:.08}),this.momentumSystem=this.procedural.createMomentumSystem({maxMomentum:8,momentumDecay:.88,momentumInfluence:.25,directionSmoothing:.75}),this.state=0,this.stateName="idle",this.facing="right",this.moving=!1,this.attacking=!1,this.blocking=!1,this.rolling=!1,this.hurt=!1,this.jumping=!1,this.doubleJumping=!1,this.wallSliding=!1,this.dashing=!1,this.charging=!1,this.dead=!1,this.landing=!1,this.blendFactors={idle:1,running:0,attacking:0,blocking:0,rolling:0,hurt:0,jumping:0,doubleJumping:0,landing:0,wallSliding:0,dashing:0,chargingAttack:0,dead:0},this.targetBlendFactors={...this.blendFactors},this.blendSpeed=.2,this.hurtTimer=0,this.attackTimer=0,this.rollTimer=0}resetActionTimers(){this.hurtTimer=0,this.attackTimer=0,this.rollTimer=0}getAnimStateName(t){switch(t){case 0:default:return"idle";case 1:return"running";case 2:return"attacking";case 3:return"blocking";case 4:return"rolling";case 5:return"hurt";case 6:return"dead";case 7:return"jumping";case 8:return"doubleJumping";case 9:return"landing";case 10:return"wallSliding";case 11:return"dashing";case 12:return"chargingAttack"}}setAnimState(t){if(this.state!==t)switch(this.resetActionTimers(),this.state=t,this.stateName=this.getAnimStateName(t),Object.keys(this.targetBlendFactors).forEach(t=>{this.targetBlendFactors[t]=0}),this.targetBlendFactors[this.stateName]=1,this.controller.play(this.stateName,{transition:.1}),t){case 2:this.anticipation.trigger();break;case 5:this.squashStretch.trigger(),this.wobble.impulse(10);break;case 4:case 11:this.trail.clear();break;case 7:this.squashStretch.trigger();break;case 8:this.wobble.impulse(5),this.trail.clear();break;case 9:this.squashStretch.trigger(),this.wobble.impulse(15);break;case 12:this.anticipation.trigger(),this.wobble.impulse(3);break;case 6:this.squashStretch.trigger(),this.wobble.impulse(20)}}update(t,e,i={x:0,y:0},s=!0){this.hurtTimer>0&&(this.hurtTimer-=t,this.hurtTimer<=0&&5===this.state&&this.setAnimState(0)),this.attackTimer>0&&(this.attackTimer-=t,this.attackTimer<=0&&2===this.state&&this.setAnimState(0)),this.rollTimer>0&&(this.rollTimer-=t,this.rollTimer<=0&&4===this.state&&this.setAnimState(0)),this.controller.update(t),Object.keys(this.blendFactors).forEach(t=>{const e=this.targetBlendFactors[t]-this.blendFactors[t];this.blendFactors[t]+=e*this.blendSpeed}),this.breathing.modulateForState(this.stateName);const a=this.breathing.update(t),n=this.momentumSystem.update(t,i.x,i.y,s);0===this.secondaryMotion.segments.length&&this.secondaryMotion.initialize(e.x,e.y-8);const o=this.secondaryMotion.update(t,e.x,e.y-8),r=this.squashStretch.update(t),h=this.wobble.update(t),l=this.anticipation.update(t),c={scaleX:1,scaleY:1,rotation:0,offsetX:0,offsetY:0,trails:this.trail.update(t,e),secondaryMotion:o,momentum:n,ik:null};return(this.blendFactors.idle>0||this.blendFactors.running>0)&&(c.scaleX*=a.scaleX,c.scaleY*=a.scaleY,c.offsetY+=a.offsetY),c.rotation+=n.leanAngle,c.scaleY*=1+n.stretchFactor,c.offsetY+=n.bounceFactor*Math.sin(.01*Date.now()),c.scaleX*=r.scaleX,c.scaleY*=r.scaleY,c.scaleX*=h.scaleX,c.scaleY*=h.scaleY,c.rotation+=h.rotation,"attacking"!==this.stateName&&"chargingAttack"!==this.stateName||(c.scaleX*=l.scaleX,c.scaleY*=l.scaleY,c.offsetX+=l.offsetX),"left"===this.facing&&(c.scaleX*=-1),c}setFacing(t){this.facing=t}triggerHurt(){this.setAnimState(5),this.hurtTimer=300}triggerAttack(){this.setAnimState(2),this.attackTimer=400}triggerRoll(){this.setAnimState(4),this.rollTimer=400}triggerBlock(){this.setAnimState(3)}releaseBlock(){3===this.state&&this.setAnimState(0)}setMoving(t){this.moving=t,t&&0===this.state?this.setAnimState(1):t||1!==this.state||this.setAnimState(0)}}const n={createPlayerAnimations:()=>({idle:new e("idle",[new t(0,0,32,32,200),new t(32,0,32,32,200),new t(64,0,32,32,200),new t(96,0,32,32,200)]),running:new e("running",[new t(0,32,32,32,100),new t(32,32,32,32,100),new t(64,32,32,32,100),new t(96,32,32,32,100),new t(128,32,32,32,100),new t(160,32,32,32,100)]),attacking:new e("attacking",[new t(0,64,32,32,50),new t(32,64,32,32,50),new t(64,64,32,32,100),new t(96,64,32,32,50)],{loop:!1}),blocking:new e("blocking",[new t(0,96,32,32,100)],{loop:!1}),rolling:new e("rolling",[new t(0,128,32,32,50),new t(32,128,32,32,50),new t(64,128,32,32,50),new t(96,128,32,32,50)],{loop:!1}),hurt:new e("hurt",[new t(0,160,32,32,100),new t(32,160,32,32,100)],{loop:!1}),dead:new e("dead",[new t(0,192,32,32,100),new t(32,192,32,32,100),new t(64,192,32,32,100),new t(96,192,32,32,200),new t(128,192,32,32,-1)],{loop:!1}),jumping:new e("jumping",[new t(0,224,32,32,100),new t(32,224,32,32,100),new t(64,224,32,32,-1)],{loop:!1}),doubleJumping:new e("doubleJumping",[new t(0,256,32,32,50),new t(32,256,32,32,50),new t(64,256,32,32,50),new t(96,256,32,32,50),new t(128,256,32,32,50),new t(160,256,32,32,50),new t(192,256,32,32,50),new t(224,256,32,32,-1)],{loop:!1}),landing:new e("landing",[new t(0,288,32,32,50),new t(32,288,32,32,50),new t(64,288,32,32,100)],{loop:!1}),wallSliding:new e("wallSliding",[new t(0,320,32,32,100),new t(32,320,32,32,100)],{loop:!0}),dashing:new e("dashing",[new t(0,352,32,32,50),new t(32,352,32,32,50),new t(64,352,32,32,100),new t(96,352,32,32,50)],{loop:!1}),chargingAttack:new e("chargingAttack",[new t(0,384,32,32,100),new t(32,384,32,32,100),new t(64,384,32,32,100),new t(96,384,32,32,50),new t(128,384,32,32,50),new t(160,384,32,32,100)],{loop:!1})}),createWolfAnimations:()=>({idle:new e("idle",[new t(0,0,48,32,300),new t(48,0,48,32,300)]),prowl:new e("prowl",[new t(0,32,48,32,150),new t(48,32,48,32,150),new t(96,32,48,32,150),new t(144,32,48,32,150)]),lunge:new e("lunge",[new t(0,64,48,32,50),new t(48,64,48,32,100),new t(96,64,48,32,50)],{loop:!1}),hurt:new e("hurt",[new t(0,96,48,32,100)],{loop:!1}),howl:new e("howl",[new t(0,128,48,32,200),new t(48,128,48,32,300),new t(96,128,48,32,400),new t(144,128,48,32,300),new t(192,128,48,32,200)],{loop:!1}),death:new e("death",[new t(0,160,48,32,100),new t(48,160,48,32,100),new t(96,160,48,32,100),new t(144,160,48,32,200),new t(192,160,48,32,-1)],{loop:!1}),packRun:new e("packRun",[new t(0,192,48,32,80),new t(48,192,48,32,80),new t(96,192,48,32,80),new t(144,192,48,32,80),new t(192,192,48,32,80),new t(240,192,48,32,80)],{loop:!0})}),createEffectAnimations:()=>({explosion:new e("explosion",[new t(0,0,64,64,50),new t(64,0,64,64,50),new t(128,0,64,64,50),new t(192,0,64,64,50),new t(256,0,64,64,50)],{loop:!1}),spark:new e("spark",[new t(0,64,32,32,30),new t(32,64,32,32,30),new t(64,64,32,32,30)],{loop:!1}),projectileSpawn:new e("projectileSpawn",[new t(0,128,16,16,30),new t(16,128,16,16,30),new t(32,128,16,16,30)],{loop:!1}),projectileImpact:new e("projectileImpact",[new t(0,144,32,32,40),new t(32,144,32,32,40),new t(64,144,32,32,40),new t(96,144,32,32,40)],{loop:!1}),itemPickup:new e("itemPickup",[new t(0,176,32,32,50),new t(32,176,32,32,50),new t(64,176,32,32,50),new t(96,176,32,32,50),new t(128,176,32,32,50)],{loop:!1}),powerUp:new e("powerUp",[new t(0,208,64,64,60),new t(64,208,64,64,60),new t(128,208,64,64,60),new t(192,208,64,64,60),new t(256,208,64,64,60),new t(320,208,64,64,60)],{loop:!1})})};class o{constructor(t={}){this.config={ikEnabled:!1!==t.ikEnabled,armLength:t.armLength||20,forearmLength:t.forearmLength||16,thighLength:t.thighLength||18,shinLength:t.shinLength||16,gravity:t.gravity||.3,damping:t.damping||.85,stiffness:t.stiffness||.4,renderSkeleton:t.renderSkeleton||!1,renderIKTargets:t.renderIKTargets||!1,renderSecondaryMotion:t.renderSecondaryMotion||!1,updateRate:t.updateRate||60,enableOptimizations:!1!==t.enableOptimizations},this.state={position:{x:0,y:0},velocity:{x:0,y:0},facing:1,isGrounded:!0,head:{x:0,y:-25,rotation:0},torso:{x:0,y:-15,rotation:0},pelvis:{x:0,y:0,rotation:0},leftShoulder:{x:-8,y:-20},leftElbow:{x:-12,y:-10},leftHand:{x:-15,y:0},rightShoulder:{x:8,y:-20},rightElbow:{x:12,y:-10},rightHand:{x:15,y:0},leftHip:{x:-4,y:0},leftKnee:{x:-6,y:10},leftFoot:{x:-8,y:20},rightHip:{x:4,y:0},rightKnee:{x:6,y:10},rightFoot:{x:8,y:20}},this.ikSolver=new r({armLength:this.config.armLength,forearmLength:this.config.forearmLength,thighLength:this.config.thighLength,shinLength:this.config.shinLength}),this.secondaryMotion=new h,this.clothPhysics=new l,this.facialAnimator=new c,this.frameCount=0,this.lastUpdate=0,this.cachedTransforms=new Map,this.environmentalResponses=new m}update(t,e={}){this.frameCount++;const i=performance.now();if(this.config.enableOptimizations&&i-this.lastUpdate<1e3/this.config.updateRate)return this.getCachedTransform();this.lastUpdate=i;const s=this.getWasmAnimationData(e);this.updateBaseTransform(s,t),this.updateSkeletalSystem(s,t),this.updateSecondaryMotion(s,t),this.updateEnvironmentalResponses(s,t);const a=this.generateTransform(s);return this.cacheTransform(a),a}getWasmAnimationData(t){const e=globalThis.wasmExports||{};return{scaleX:e.get_anim_scale_x?.()||1,scaleY:e.get_anim_scale_y?.()||1,rotation:e.get_anim_rotation?.()||0,offsetX:e.get_anim_offset_x?.()||0,offsetY:e.get_anim_offset_y?.()||0,pelvisY:e.get_anim_pelvis_y?.()||0,spineCurve:e.get_anim_spine_curve?.()||0,shoulderRotation:e.get_anim_shoulder_rotation?.()||0,headBobX:e.get_anim_head_bob_x?.()||0,headBobY:e.get_anim_head_bob_y?.()||0,armSwingLeft:e.get_anim_arm_swing_left?.()||0,armSwingRight:e.get_anim_arm_swing_right?.()||0,legLiftLeft:e.get_anim_leg_lift_left?.()||0,legLiftRight:e.get_anim_leg_lift_right?.()||0,torsoTwist:e.get_anim_torso_twist?.()||0,breathingIntensity:e.get_anim_breathing_intensity?.()||1,fatigueFactor:e.get_anim_fatigue_factor?.()||0,momentumX:e.get_anim_momentum_x?.()||0,momentumY:e.get_anim_momentum_y?.()||0,clothSway:e.get_anim_cloth_sway?.()||0,hairBounce:e.get_anim_hair_bounce?.()||0,equipmentJiggle:e.get_anim_equipment_jiggle?.()||0,windResponse:e.get_anim_wind_response?.()||0,groundAdapt:e.get_anim_ground_adapt?.()||0,temperatureShiver:e.get_anim_temperature_shiver?.()||0,position:{x:e.get_x?.()||.5,y:e.get_y?.()||.5},velocity:{x:e.get_vel_x?.()||0,y:e.get_vel_y?.()||0},isGrounded:1===e.get_is_grounded?.(),stamina:e.get_stamina?.()||1,health:e.get_hp?.()||1,animState:e.get_player_anim_state?.()||0}}updateBaseTransform(t,e){this.state.position.x=t.position.x,this.state.position.y=t.position.y,this.state.velocity.x=t.velocity.x,this.state.velocity.y=t.velocity.y,this.state.isGrounded=t.isGrounded,Math.abs(t.velocity.x)>.01&&(this.state.facing=t.velocity.x>0?1:-1),this.state.torso.rotation=t.torsoTwist,this.state.pelvis.y=t.pelvisY,this.state.head.x=t.headBobX,this.state.head.y=-25+t.headBobY,this.state.head.rotation=.3*t.spineCurve}updateSkeletalSystem(t,e){if(!this.config.ikEnabled)return;const i=this.calculateArmTarget("left",t),s=this.calculateArmTarget("right",t),a=this.ikSolver.solveArm(this.state.leftShoulder,i,this.config.armLength,this.config.forearmLength),n=this.ikSolver.solveArm(this.state.rightShoulder,s,this.config.armLength,this.config.forearmLength);a&&(this.state.leftElbow=a.elbow,this.state.leftHand=a.hand),n&&(this.state.rightElbow=n.elbow,this.state.rightHand=n.hand);const o=this.calculateLegTarget("left",t),r=this.calculateLegTarget("right",t),h=this.ikSolver.solveLeg(this.state.leftHip,o,this.config.thighLength,this.config.shinLength),l=this.ikSolver.solveLeg(this.state.rightHip,r,this.config.thighLength,this.config.shinLength);h&&(this.state.leftKnee=h.knee,this.state.leftFoot=h.foot),l&&(this.state.rightKnee=l.knee,this.state.rightFoot=l.foot)}calculateArmTarget(t,e){const i="left"===t,s=i?-1:1,a=i?e.armSwingLeft:e.armSwingRight;let n=12*s,o=5;n+=8*Math.sin(a),o+=4*Math.cos(a)-2;return n+=3*(e.shoulderRotation*s),n+=.3*e.momentumX,o+=.2*e.momentumY,o+=.5*Math.sin(.001*Date.now()*e.breathingIntensity),{x:n,y:o}}calculateLegTarget(t,e){const i="left"===t,s=i?-1:1,a=i?e.legLiftLeft:e.legLiftRight;let n=6*s,o=20;o-=8*a,n+=2*a*s,o+=e.groundAdapt,n+=.2*e.momentumX;return n+=e.fatigueFactor*s*.5,{x:n,y:o}}updateSecondaryMotion(t,e){this.clothPhysics.update(e,{sway:t.clothSway,windResponse:t.windResponse,momentum:{x:t.momentumX,y:t.momentumY}}),this.secondaryMotion.updateHair(e,{bounce:t.hairBounce,windResponse:t.windResponse,headMovement:{x:t.headBobX,y:t.headBobY}}),this.secondaryMotion.updateEquipment(e,{jiggle:t.equipmentJiggle,momentum:{x:t.momentumX,y:t.momentumY}})}updateEnvironmentalResponses(t,e){t.temperatureShiver>0&&this.environmentalResponses.applyShivering(this.state,t.temperatureShiver),0!==t.windResponse&&this.environmentalResponses.applyWindEffects(this.state,t.windResponse)}generateTransform(t){return{scaleX:t.scaleX,scaleY:t.scaleY,rotation:t.rotation,offsetX:t.offsetX,offsetY:t.offsetY,skeleton:{head:this.state.head,torso:this.state.torso,pelvis:this.state.pelvis,leftArm:{shoulder:this.state.leftShoulder,elbow:this.state.leftElbow,hand:this.state.leftHand},rightArm:{shoulder:this.state.rightShoulder,elbow:this.state.rightElbow,hand:this.state.rightHand},leftLeg:{hip:this.state.leftHip,knee:this.state.leftKnee,foot:this.state.leftFoot},rightLeg:{hip:this.state.rightHip,knee:this.state.rightKnee,foot:this.state.rightFoot}},secondaryMotion:{cloth:this.clothPhysics.getState(),hair:this.secondaryMotion.getHairState(),equipment:this.secondaryMotion.getEquipmentState()},environmental:{windResponse:t.windResponse,temperatureShiver:t.temperatureShiver,groundAdapt:t.groundAdapt},debug:{frameCount:this.frameCount,animState:t.animState,fatigue:t.fatigueFactor,breathing:t.breathingIntensity}}}cacheTransform(t){const e=`${this.frameCount}_${this.lastUpdate}`;if(this.cachedTransforms.set(e,t),this.cachedTransforms.size>10){const t=this.cachedTransforms.keys().next().value;this.cachedTransforms.delete(t)}}getCachedTransform(){const t=Array.from(this.cachedTransforms.keys()),e=t[t.length-1];return this.cachedTransforms.get(e)||this.generateDefaultTransform()}generateDefaultTransform(){return{scaleX:1,scaleY:1,rotation:0,offsetX:0,offsetY:0,skeleton:null,secondaryMotion:null,environmental:null,debug:null}}renderDebug(t,e,i,s=1){this.config.renderSkeleton&&(t.save(),t.translate(e,i),t.scale(s,s),this.renderSkeleton(t),this.config.renderIKTargets&&this.renderIKTargets(t),this.config.renderSecondaryMotion&&this.renderSecondaryMotion(t),t.restore())}renderSkeleton(t){t.strokeStyle="#00ff88",t.lineWidth=2,this.drawBone(t,this.state.torso,this.state.head),this.drawBone(t,this.state.torso,this.state.pelvis),this.drawBone(t,this.state.leftShoulder,this.state.leftElbow),this.drawBone(t,this.state.leftElbow,this.state.leftHand),this.drawBone(t,this.state.rightShoulder,this.state.rightElbow),this.drawBone(t,this.state.rightElbow,this.state.rightHand),this.drawBone(t,this.state.leftHip,this.state.leftKnee),this.drawBone(t,this.state.leftKnee,this.state.leftFoot),this.drawBone(t,this.state.rightHip,this.state.rightKnee),this.drawBone(t,this.state.rightKnee,this.state.rightFoot),t.fillStyle="#ffff44",Object.values(this.state).forEach(e=>{void 0!==e.x&&void 0!==e.y&&(t.beginPath(),t.arc(e.x,e.y,2,0,2*Math.PI),t.fill())})}drawBone(t,e,i){t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(i.x,i.y),t.stroke()}renderIKTargets(t){t.fillStyle="#ff4444"}renderSecondaryMotion(t){this.clothPhysics.render(t),this.secondaryMotion.renderHair(t),this.secondaryMotion.renderEquipment(t)}}class r{constructor(t={}){this.armLength=t.armLength||20,this.forearmLength=t.forearmLength||16,this.thighLength=t.thighLength||18,this.shinLength=t.shinLength||16,this.maxIterations=t.maxIterations||10,this.tolerance=t.tolerance||.1,this.damping=t.damping||.8}solveArm(t,e,i,s){const a=Math.sqrt((e.x-t.x)**2+(e.y-t.y)**2),n=i+s;if(a>n){const s=Math.atan2(e.y-t.y,e.x-t.x);return{elbow:{x:t.x+Math.cos(s)*i,y:t.y+Math.sin(s)*i},hand:{x:t.x+Math.cos(s)*n,y:t.y+Math.sin(s)*n}}}const o=Math.acos((i*i+a*a-s*s)/(2*i*a)),r=Math.atan2(e.y-t.y,e.x-t.x)+o;return{elbow:{x:t.x+Math.cos(r)*i,y:t.y+Math.sin(r)*i},hand:e}}solveLeg(t,e,i,s){return this.solveArm(t,e,i,s)}}class h{constructor(){this.hairSegments=[],this.equipmentItems=[],this.initializeHair(),this.initializeEquipment()}initializeHair(){for(let t=0;t<5;t++)this.hairSegments.push({position:{x:0,y:-25-3*t},velocity:{x:0,y:0},restLength:3})}initializeEquipment(){this.equipmentItems=[{type:"sword",position:{x:8,y:5},velocity:{x:0,y:0}},{type:"pouch",position:{x:-6,y:8},velocity:{x:0,y:0}}]}updateHair(t,e){this.hairSegments.forEach((i,s)=>{if(0!==s&&(i.velocity.x+=.1*e.windResponse,i.velocity.y+=.1,1===s&&(i.velocity.x+=.05*e.headMovement.x,i.velocity.y+=.05*e.headMovement.y),i.position.x+=i.velocity.x*t,i.position.y+=i.velocity.y*t,i.velocity.x*=.95,i.velocity.y*=.95,s>0)){const t=this.hairSegments[s-1],e=i.position.x-t.position.x,a=i.position.y-t.position.y,n=Math.sqrt(e*e+a*a);if(n>i.restLength){const t=(n-i.restLength)/n*.5;i.position.x-=e*t,i.position.y-=a*t}}})}updateEquipment(t,e){this.equipmentItems.forEach(i=>{i.velocity.x+=.02*e.momentum.x,i.velocity.y+=.02*e.momentum.y,i.position.x+=i.velocity.x*t,i.position.y+=i.velocity.y*t,i.velocity.x*=.9,i.velocity.y*=.9})}getHairState(){return this.hairSegments}getEquipmentState(){return this.equipmentItems}renderHair(t){t.strokeStyle="#8B4513",t.lineWidth=2,t.beginPath(),this.hairSegments.forEach((e,i)=>{0===i?t.moveTo(e.position.x,e.position.y):t.lineTo(e.position.x,e.position.y)}),t.stroke()}renderEquipment(t){this.equipmentItems.forEach(e=>{t.fillStyle="sword"===e.type?"#C0C0C0":"#8B4513",t.fillRect(e.position.x-2,e.position.y-1,4,2)})}}class l{constructor(){this.clothPoints=[],this.constraints=[],this.initializeCloth()}initializeCloth(){for(let t=0;t<4;t++)for(let e=0;e<3;e++)this.clothPoints.push({position:{x:3*e-3,y:3*t+5},oldPosition:{x:3*e-3,y:3*t+5},pinned:0===t});for(let t=0;t<4;t++)for(let e=0;e<3;e++)e<2&&this.constraints.push({p1:3*t+e,p2:3*t+e+1,restLength:3}),t<3&&this.constraints.push({p1:3*t+e,p2:3*(t+1)+e,restLength:3})}update(t,e){this.clothPoints.forEach(t=>{if(t.pinned)return;const i=t.position.x-t.oldPosition.x,s=t.position.y-t.oldPosition.y;t.oldPosition.x=t.position.x,t.oldPosition.y=t.position.y,t.position.x+=i+.1*e.sway+.2*e.windResponse,t.position.y+=s+.2});for(let t=0;t<2;t++)this.constraints.forEach(t=>{const e=this.clothPoints[t.p1],i=this.clothPoints[t.p2],s=i.position.x-e.position.x,a=i.position.y-e.position.y,n=Math.sqrt(s*s+a*a),o=(t.restLength-n)/n/2,r=s*o,h=a*o;e.pinned||(e.position.x-=r,e.position.y-=h),i.pinned||(i.position.x+=r,i.position.y+=h)})}getState(){return this.clothPoints}render(t){t.strokeStyle="#4A4A4A",t.lineWidth=1,this.constraints.forEach(e=>{const i=this.clothPoints[e.p1],s=this.clothPoints[e.p2];t.beginPath(),t.moveTo(i.position.x,i.position.y),t.lineTo(s.position.x,s.position.y),t.stroke()})}}class c{constructor(){this.expressions={neutral:{eyeOpenness:1,mouthCurve:0,eyebrowHeight:0},happy:{eyeOpenness:.8,mouthCurve:.5,eyebrowHeight:.2},angry:{eyeOpenness:.6,mouthCurve:-.3,eyebrowHeight:-.4},surprised:{eyeOpenness:1.2,mouthCurve:-.2,eyebrowHeight:.6},tired:{eyeOpenness:.4,mouthCurve:-.1,eyebrowHeight:-.1}},this.currentExpression="neutral",this.blendWeight=0}setExpression(t,e=.5){this.targetExpression=t,this.blendTime=e,this.blendWeight=0}update(t,e){e.stamina<.3?this.setExpression("tired"):e.health<.5?this.setExpression("angry"):this.setExpression("neutral"),this.blendWeight<1&&(this.blendWeight+=t/this.blendTime,this.blendWeight=Math.min(this.blendWeight,1))}}class m{applyShivering(t,e){Object.values(t).forEach(t=>{void 0!==t.x&&(t.x+=0,t.y+=0)})}applyWindEffects(t,e){t.head.x+=.5*e,t.leftHand.x+=.8*e,t.rightHand.x+=.8*e}}class g{constructor(t=400,e=300,i={}){this.x=t,this.y=e,this.facing=1,this.health=i.health||100,this.maxHealth=i.maxHealth||100,this.stamina=i.stamina||100,this.maxStamina=i.maxStamina||100,this.speed=i.speed||250,this.rollSpeed=i.rollSpeed||500,this.state="idle",this.previousState="idle",this.stateTimer=0,this.stateTime=0,this.stateDuration=0,this._prevNormTime=0,this._comboQueued=!1,this._currentAttackType="light",this.invulnerable=!1,this.invulnerabilityTimer=0,this.isGrounded=!0,this.jumpCount=0,this.nearWall=!1,this.dashCooldown=0,this.chargeTime=0,this.maxChargeTime=1.5,this.params={roll:{duration:.4,iFrameStart:.08,iFrameEnd:.36,staminaCost:25,cooldown:.8},attackLight:{duration:.4,activeStart:.28,activeEnd:.38,staminaCost:12,cooldown:.5},attackHeavy:{duration:.62,activeStart:.32,activeEnd:.48,staminaCost:24,cooldown:.8},comboWindow:{start:.55,end:.75},parry:{duration:.22,window:.18,staminaCost:10}},this.animator=new a,this.animations=n.createPlayerAnimations(),this.setupAnimations(),this.proceduralAnimator=new o({ikEnabled:!1!==i.enableIK,renderSkeleton:i.debugMode||!1,renderIKTargets:i.debugMode||!1,renderSecondaryMotion:i.debugMode||!1,enableOptimizations:!1!==i.enableOptimizations}),this.attackCooldown=0,this.rollCooldown=0,this.blockHeld=!1,this.width=i.width||32,this.height=i.height||32,this.color=i.color||"#00ff88",this.sprite=i.sprite||null,this.sprite||this.loadSpriteSheet(),this.particleSystem=i.particleSystem||null,this.soundSystem=i.soundSystem||null,this.attackDamage=i.attackDamage||20,this.attackDamageHeavy=i.attackDamageHeavy||35,this.attackRange=i.attackRange||60,this.attackRangeHeavy=i.attackRangeHeavy||80,this.blockDamageReduction=i.blockDamageReduction||.5,this.stridePhase=0,this.gaitRate=1.4,this._lastFootFlag=0,this.footstepIntervalBase=.28,this.ik={pelvisY:0,pelvisRate:10,left:{locked:!1,y:0},right:{locked:!1,y:0},stepHeight:2},this.debugMode=!1;try{i.wasmModule&&!globalThis.wasmExports&&(globalThis.wasmExports=i.wasmModule)}catch{}}loadSpriteSheet(){this.sprite=new Image,this.sprite.src="./src/images/player-sprites.png",this.sprite.onload=()=>{},this.sprite.onerror=()=>{console.warn("Player sprite sheet not found at ./src/images/player-sprites.png, using fallback rendering"),this.sprite=null}}setupAnimations(){Object.values(this.animations).forEach(t=>{this.animator.controller.addAnimation(t)}),this.animator.controller.play("idle")}update(t,e={}){this._prevNormTime=this.getNormalizedTime(),this.attackCooldown=Math.max(0,this.attackCooldown-t),this.rollCooldown=Math.max(0,this.rollCooldown-t),this.invulnerable&&(this.invulnerabilityTimer-=t,this.invulnerabilityTimer<=0&&(this.invulnerable=!1)),this.updateIK(t);let i=0,s=0;e.left&&(i-=1),e.right&&(i+=1),e.up&&(s-=1),e.down&&(s+=1),globalThis.wasmExports?.set_player_input?.(i,s,e.roll?1:0,e.jump?1:0,e.lightAttack?1:0,e.heavyAttack?1:0,e.block?1:0,e.special?1:0);const a=globalThis.wasmExports?.get_x?.(),n=globalThis.wasmExports?.get_y?.();this.x="number"==typeof a&&Number.isFinite(a)?a:.5,this.y="number"==typeof n&&Number.isFinite(n)?n:.5,this.isGrounded=1===globalThis.wasmExports?.get_is_grounded?.(),this.jumpCount=globalThis.wasmExports?.get_jump_count?.();const o=globalThis.wasmExports?.get_vel_x?.(),r=globalThis.wasmExports?.get_vel_y?.();if("number"==typeof o&&"number"==typeof r){Math.hypot(o,r)>.001&&(this.facing=o>=0?1:-1)}this.animator&&"function"==typeof this.animator.setFacing&&this.animator.setFacing(this.facing>=0?"right":"left");const h=globalThis.wasmExports?.get_anim_offset_x?.()??0,l=globalThis.wasmExports?.get_anim_offset_y?.()??0,c=globalThis.wasmExports?.get_anim_scale_x?.()??1,m=globalThis.wasmExports?.get_anim_scale_y?.()??1,g=globalThis.wasmExports?.get_anim_rotation?.()??0;globalThis.wasmExports?.get_anim_pelvis_y?.();const d=globalThis.wasmExports?.get_player_anim_state?.();"number"==typeof d&&this.setState(this.getAnimStateName(d),!0);const u=this.animator.update(t,{x:this.x,y:this.y},{x:globalThis.wasmExports?.get_vel_x?.()??0,y:globalThis.wasmExports?.get_vel_y?.()??0},this.isGrounded)||{scaleX:1,scaleY:1,rotation:0,offsetX:0,offsetY:0},p=this.proceduralAnimator.update(t,{playerState:this.state,inputState:e,debugMode:this.debugMode}),f=globalThis.wasmExports&&"number"==typeof h?{scaleX:c,scaleY:m,rotation:g,offsetX:h,offsetY:l}:this.computePoseOverlay(e);this.currentTransform={scaleX:u.scaleX*f.scaleX*p.scaleX,scaleY:u.scaleY*f.scaleY*p.scaleY,rotation:u.rotation+f.rotation+p.rotation,offsetX:u.offsetX+f.offsetX+p.offsetX,offsetY:u.offsetY+f.offsetY+p.offsetY,trails:u.trails||[],skeleton:p.skeleton,secondaryMotion:p.secondaryMotion,environmental:p.environmental,debug:p.debug}}getNormalizedTime(){try{const t=t=>"function"==typeof globalThis.wasmExports?.[t]?globalThis.wasmExports[t]():void 0,e=t("get_attack_state"),i=t("get_attack_state_time"),s=t("get_time_seconds");if("number"==typeof e&&"number"==typeof i&&"number"==typeof s){const a=Math.max(0,s-i);let n=0;if(1===e?n=t("get_attack_windup_sec")??this.params.attackLight.duration:2===e?n=t("get_attack_active_sec")??this.params.attackLight.duration:3===e&&(n=t("get_attack_recovery_sec")??this.params.attackLight.duration),n&&n>0)return Math.max(0,Math.min(1,a/n))}if(1===t("get_is_rolling")){const e=t("get_roll_duration")||this.params.roll.duration,i=t("get_player_state_timer");if("number"==typeof i&&e>0)return Math.max(0,Math.min(1,i/e))}const a=t("get_player_state_timer");if("number"==typeof a){let t=0;switch(this.state){case"rolling":t=this.params.roll.duration;break;case"attacking":t="heavy"===this._currentAttackType?this.params.attackHeavy.duration:this.params.attackLight.duration;break;default:t=0}if(t>0)return Math.max(0,Math.min(1,a/t))}}catch{}try{const t=this.animator?.controller?.currentAnimation;if(t&&Array.isArray(t.frames)&&t.frames.length>1){const e=t.currentFrame/(t.frames.length-1);return Math.max(0,Math.min(1,e))}}catch{}return 0}startRoll(t){if(!globalThis.wasmExports?.on_roll_start?.())return;let e=0,i=0;t.left&&(e-=1),t.right&&(e+=1),t.up&&(i-=1),t.down&&(i+=1),0===e&&0===i&&(e=this.facing);const s=Math.hypot(e,i);s>0&&(e/=s,i/=s),this.rollDirection={x:e,y:i},this.particleSystem&&this.particleSystem.createDustCloud(this.x,this.y),this.soundSystem&&this.soundSystem.play("roll")}startAttack(t="light"){"heavy"===t?this.params.attackHeavy:this.params.attackLight,this._currentAttackType=t,globalThis.wasmExports?.on_attack?.("heavy"===t?1:0)&&this.soundSystem&&this.soundSystem.play("attack")}queueAttack(t="light"){this.canAttack()?this.startAttack(t):"attacking"===this.state&&(this._comboQueued=!0)}tryRoll(t=null){const e={};t&&(t.x||t.y)&&(e.left=t.x<-.5,e.right=t.x>.5,e.up=t.y<-.5,e.down=t.y>.5),this.startRoll(e)}tryParry(){"dead"!==this.state&&globalThis.wasmExports?.on_parry?.()&&this.soundSystem&&this.soundSystem.play("parry")}executeAttack(){const t="heavy"===this._currentAttackType,e=t?this.attackRangeHeavy:this.attackRange,i=t?this.attackDamageHeavy:this.attackDamage,s=this.x+this.facing*e/2,a=this.y;return this.particleSystem&&(t?this.particleSystem.createChargedSlash?.(s,a,this.facing,1):this.particleSystem.createSlashEffect(s,a,this.facing)),{x:s,y:a,width:e,height:this.height,damage:i}}startBlock(){globalThis.wasmExports?.set_blocking?.(1,this.facing,0)&&(this.blockHeld=!0,this.particleSystem&&this.particleSystem.createShieldEffect(this.x,this.y),this.soundSystem&&this.soundSystem.play("block"))}stopBlock(){globalThis.wasmExports?.set_blocking?.(0,this.facing,0),this.blockHeld=!1}takeDamage(t,e=0,i=0){return!this.invulnerable&&"dead"!==this.state&&("blocking"===this.state?(this.particleSystem&&this.particleSystem.createBlockImpact(this.x,this.y),this.soundSystem&&this.soundSystem.play("blockImpact")):(this.particleSystem&&this.particleSystem.createBloodEffect(this.x,this.y),this.soundSystem&&this.soundSystem.play("hurt")),!0)}die(){this.particleSystem&&this.particleSystem.createDeathEffect(this.x,this.y),this.soundSystem&&this.soundSystem.play("death")}respawn(t,e){this.particleSystem&&this.particleSystem.createRespawnEffect(this.x,this.y),this.soundSystem&&this.soundSystem.play("respawn")}setState(t,e=!1){if(this.state===t)return;this.previousState=this.state,this.state=t,this.stateTime=0,this.stateDuration=0,this._prevNormTime=0;const i=this.stateNameToNumber(t);this.animator.setAnimState(i)}canAttack(){const t=Math.min(this.params.attackLight.staminaCost,this.params.attackHeavy.staminaCost);return this.attackCooldown<=0&&this.stamina>=t&&"dead"!==this.state&&"rolling"!==this.state&&"hurt"!==this.state}canRoll(){return this.rollCooldown<=0&&this.stamina>=this.params.roll.staminaCost&&"dead"!==this.state&&"attacking"!==this.state&&"hurt"!==this.state}canBlock(){return this.stamina>0&&"dead"!==this.state&&"rolling"!==this.state&&"attacking"!==this.state&&"hurt"!==this.state}render(t,e=null){let i=0,s=0;const a=e?.x||0,n=e?.y||0;if(globalThis.gameRenderer&&"function"==typeof globalThis.gameRenderer.wasmToWorld){const t=globalThis.gameRenderer.wasmToWorld(this.x||.5,this.y||.5);i=t.x-a,s=t.y-n}else{const t=800,e=600;i=(this.x||0)*t-a,s=(this.y||0)*e-n}t.save(),1===globalThis.wasmExports?.get_is_invulnerable?.()&&(t.globalAlpha=.5+.3*Math.sin(.02*Date.now()));const o=this.animator.controller.getCurrentFrame();if(this.sprite&&o){t.save();const e=this.currentTransform||{scaleX:1,scaleY:1,rotation:0,offsetX:0,offsetY:0},a=i+e.offsetX,n=s+e.offsetY;t.translate(a,n),t.rotate(e.rotation),t.scale(this.facing<0?-e.scaleX:e.scaleX,e.scaleY),e.secondaryMotion&&this.debugMode&&this.renderSecondaryMotion(t,e.secondaryMotion),t.drawImage(this.sprite,o.x,o.y,o.width,o.height,-this.width/2,-this.height/2,this.width,this.height),e.skeleton&&this.debugMode&&this.renderSkeletalOverlay(t,e.skeleton),t.restore()}else{t.fillStyle=this.color||"#4a90e2","hurt"===this.state?t.fillStyle="#ff4444":"blocking"===this.state?t.fillStyle="#4444ff":"rolling"===this.state&&(t.fillStyle="#ffff44");const e=this.width||32,a=this.height||32;t.fillRect(i-e/2,s-a/2,e,a),t.strokeStyle="#ffffff",t.lineWidth=2,t.strokeRect(i-e/2,s-a/2,e,a),t.fillStyle="#ffffff",t.beginPath(),t.arc(i,s,3,0,2*Math.PI),t.fill()}const r=40,h=s-this.height/2-10;t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(i-20,h,r,4);const l=(globalThis.wasmExports?.get_hp?.()??globalThis.wasmExports?.get_health?.()??this.health)/this.maxHealth;t.fillStyle=l>.5?"#00ff00":l>.25?"#ffff00":"#ff0000",t.fillRect(i-20,h,r*l,4);const c=h+5;t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(i-20,c,r,2);const m=(globalThis.wasmExports?.get_stamina?.()??this.stamina)/this.maxStamina;t.fillStyle="#00aaff",t.fillRect(i-20,c,r*m,2),this.debugMode&&this.renderDebug(t,e,i,s),t.restore()}computePoseOverlay(t){const e=this.getNormalizedTime();let i=1,s=1,a=0;let n=this.ik?.pelvisY||0;const o=globalThis.wasmExports?.get_vel_x?.()??0;globalThis.wasmExports?.get_vel_y?.();const r=globalThis.wasmExports?.get_speed?.()??this.speed;if("running"===this.state){a+=Math.max(-.15,Math.min(.15,o/(r||1)*.25))}if("blocking"===this.state&&(s*=.98,n+=1),"rolling"===this.state){const t=e<.5?2*e:2*(1-e);s*=1-.06*t,i*=1+.04*t,a+=.12*(this.facing>=0?1:-1)*t}return this.state,{scaleX:i,scaleY:s,rotation:a,offsetX:0,offsetY:n}}updateIK(t){const e=globalThis.wasmExports?.get_anim_pelvis_y?.();this.ik.pelvisY="number"==typeof e?e:0;const i=globalThis.wasmExports?.get_vel_x?.()??0,s=globalThis.wasmExports?.get_vel_y?.()??0;if(Math.hypot(i,s)>10){this.stridePhase=(this.stridePhase+t*this.gaitRate)%1;const e=this.stridePhase<.25||this.stridePhase>.75;this.ik.left.locked=e,this.ik.right.locked=!e}else this.ik.left.locked=!1,this.ik.right.locked=!1,this.stridePhase=0}renderDebug(t,e,i,s){const a=i,n=s-this.height/2-18;t.save(),t.fillStyle="rgba(0,0,0,0.35)",t.fillRect(a-24,n,48,4),t.fillStyle="#00ffaa",t.fillRect(a-24,n,this.stridePhase%1*48,4),t.strokeStyle="#ffaa00",t.beginPath(),t.moveTo(a+30,n+2),t.lineTo(a+30,n+2-(this.ik?.pelvisY||0)),t.stroke();const o=globalThis.wasmExports?.get_attack_state?.()??0,r=globalThis.wasmExports?.get_attack_state_time?.()??0,h=globalThis.wasmExports?.get_time_seconds?.()??0;let l=0;1===o?l=(h-r)/(globalThis.wasmExports?.get_attack_windup_sec?.()??this.params.attackLight.duration):2===o?l=(h-r)/(globalThis.wasmExports?.get_attack_active_sec?.()??this.params.attackLight.duration):3===o&&(l=(h-r)/(globalThis.wasmExports?.get_attack_recovery_sec?.()??this.params.attackLight.duration));const c=n+8;t.fillStyle="rgba(0,0,0,0.35)",t.fillRect(a-24,c,48,3),2===o&&(t.fillStyle="#ff4477",t.fillRect(a-24+48*.28,c,48*(.38-.28),3)),1===globalThis.wasmExports?.get_is_rolling?.()&&(t.fillStyle="#ffee55",t.fillRect(a-24+3.84,c,48*(.36-.08),3)),t.fillStyle="#ffffff",t.fillRect(a-24+48*l-1,c-1,2,5),t.restore()}getAnimStateName(t){switch(t){case 0:default:return"idle";case 1:return"running";case 2:return"attacking";case 3:return"blocking";case 4:return"rolling";case 5:return"hurt";case 6:return"dead";case 7:return"jumping";case 8:return"doubleJumping";case 9:return"landing";case 10:return"wallSliding";case 11:return"dashing";case 12:return"chargingAttack"}}stateNameToNumber(t){switch(t){case"idle":default:return 0;case"running":return 1;case"attacking":return 2;case"blocking":return 3;case"rolling":return 4;case"hurt":return 5;case"dead":return 6;case"jumping":return 7;case"doubleJumping":return 8;case"landing":return 9;case"wallSliding":return 10;case"dashing":return 11;case"chargingAttack":return 12}}getAnimationInfo(){return{state:this.state,animation:this.animator.controller.currentAnimation?.name,frame:this.animator.controller.getCurrentFrame(),stateTimer:globalThis.wasmExports?.get_player_state_timer?.()??0,invulnerable:1===globalThis.wasmExports?.get_is_invulnerable?.(),proceduralData:this.currentTransform?.debug||null,skeletalData:this.currentTransform?.skeleton||null,secondaryMotion:this.currentTransform?.secondaryMotion||null,environmental:this.currentTransform?.environmental||null}}renderSecondaryMotion(t,e){e&&(t.save(),t.globalAlpha=.8,e.cloth&&(t.strokeStyle="#4A4A4A",t.lineWidth=2,t.beginPath(),e.cloth.forEach((e,i)=>{0===i?t.moveTo(e.position.x,e.position.y):t.lineTo(e.position.x,e.position.y)}),t.stroke()),e.hair&&(t.strokeStyle="#8B4513",t.lineWidth=3,t.lineCap="round",t.beginPath(),e.hair.forEach((e,i)=>{0===i?t.moveTo(e.position.x,e.position.y):t.lineTo(e.position.x,e.position.y)}),t.stroke()),e.equipment&&e.equipment.forEach(e=>{t.fillStyle="sword"===e.type?"#C0C0C0":"#8B4513",t.fillRect(e.position.x-2,e.position.y-1,4,2)}),t.restore())}renderSkeletalOverlay(t,e){if(!e)return;t.save(),t.strokeStyle="#00ff88",t.fillStyle="#ffff44",t.lineWidth=1,t.globalAlpha=.6,this.drawBone(t,e.torso,e.head),this.drawBone(t,e.torso,e.pelvis),this.drawBone(t,e.leftArm.shoulder,e.leftArm.elbow),this.drawBone(t,e.leftArm.elbow,e.leftArm.hand),this.drawBone(t,e.rightArm.shoulder,e.rightArm.elbow),this.drawBone(t,e.rightArm.elbow,e.rightArm.hand),this.drawBone(t,e.leftLeg.hip,e.leftLeg.knee),this.drawBone(t,e.leftLeg.knee,e.leftLeg.foot),this.drawBone(t,e.rightLeg.hip,e.rightLeg.knee),this.drawBone(t,e.rightLeg.knee,e.rightLeg.foot);[e.head,e.torso,e.pelvis,e.leftArm.shoulder,e.leftArm.elbow,e.leftArm.hand,e.rightArm.shoulder,e.rightArm.elbow,e.rightArm.hand,e.leftLeg.hip,e.leftLeg.knee,e.leftLeg.foot,e.rightLeg.hip,e.rightLeg.knee,e.rightLeg.foot].forEach(e=>{e&&void 0!==e.x&&void 0!==e.y&&(t.beginPath(),t.arc(e.x,e.y,2,0,2*Math.PI),t.fill())}),t.restore()}drawBone(t,e,i){e&&i&&void 0!==e.x&&void 0!==i.x&&(t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(i.x,i.y),t.stroke())}static createInputFromKeys(t){return{left:t.a||t.arrowleft,right:t.d||t.arrowright,up:t.w||t.arrowup,down:t.s||t.arrowdown,lightAttack:t.j||t[1],heavyAttack:t.k||t[2],block:t.shift||t[3],roll:t.control||t[4],special:t.l||t[5],attack:t.j||t[" "],jump:t.space||t.z}}jump(){globalThis.wasmExports?.on_jump?.(),this.particleSystem&&this.particleSystem.createDustCloud(this.x,this.y+this.height/2),this.soundSystem&&this.soundSystem.play("jump")}}g.attachDebugToggle=(t,e="F3")=>{if(!t||t.__debugToggleAttached)return;const i=(e||"F3").toLowerCase(),s=e=>{(e.key||"").toLowerCase()===i.toLowerCase()&&(t.debugMode=!t.debugMode)};try{addEventListener("keydown",s),t.__debugToggleAttached=!0}catch{}};export{g as AnimatedPlayer,g as default};