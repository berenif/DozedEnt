class e{constructor(e,t,i={}){this.x=e,this.y=t,this.vx=i.vx||0,this.vy=i.vy||0,this.ax=i.ax||0,this.ay=i.ay||0,this.life=i.life||1,this.maxLife=i.life||1,this.size=i.size||4,this.sizeDecay=i.sizeDecay||.98,this.color=i.color||{r:255,g:255,b:255},this.alpha=i.alpha||1,this.alphaDecay=i.alphaDecay||.98,this.rotation=i.rotation||0,this.rotationSpeed=i.rotationSpeed||0,this.trail=i.trail||!1,this.trailPositions=[],this.blendMode=i.blendMode||"source-over",this.glow=i.glow||!1,this.glowSize=i.glowSize||2,this.shape=i.shape||"circle",this.friction=i.friction||1,this.bounce=i.bounce||0,this.gravity=i.gravity||0,this.turbulence=i.turbulence||0,this.scaleWithVelocity=i.scaleWithVelocity||!1}update(e){if(this.vx*=this.friction,this.vy*=this.friction,this.vx+=this.ax*e,this.vy+=(this.ay+this.gravity)*e,this.turbulence>0){let e=Number((globalThis.runSeedForVisuals??1n)%2147483647n);e=48271*e%2147483647;const t=e/2147483647-.5;e=48271*e%2147483647;const i=e/2147483647-.5;this.vx+=t*this.turbulence,this.vy+=i*this.turbulence}return this.x+=this.vx*e,this.y+=this.vy*e,this.rotation+=this.rotationSpeed*e,this.trail&&(this.trailPositions.push({x:this.x,y:this.y,alpha:this.alpha}),this.trailPositions.length>10&&this.trailPositions.shift()),this.life-=e,this.size*=this.sizeDecay,this.alpha*=this.alphaDecay,this.bounce>0&&((this.x<0||this.x>1280)&&(this.vx*=-this.bounce,this.x=Math.max(0,Math.min(1280,this.x))),(this.y<0||this.y>720)&&(this.vy*=-this.bounce,this.y=Math.max(0,Math.min(720,this.y)))),this.life>0&&this.alpha>.01&&this.size>.1}render(e){if(e.save(),e.globalCompositeOperation=this.blendMode,e.globalAlpha=this.alpha,this.trail&&this.trailPositions.length>1&&(e.strokeStyle=`rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${.5*this.alpha})`,e.lineWidth=.5*this.size,e.lineCap="round",e.beginPath(),this.trailPositions.forEach((t,i)=>{0===i?e.moveTo(t.x,t.y):e.lineTo(t.x,t.y)}),e.stroke()),this.glow){const t=e.createRadialGradient(this.x,this.y,0,this.x,this.y,this.size*this.glowSize);t.addColorStop(0,`rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${this.alpha})`),t.addColorStop(1,`rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, 0)`),e.fillStyle=t,e.beginPath(),e.arc(this.x,this.y,this.size*this.glowSize,0,2*Math.PI),e.fill()}e.translate(this.x,this.y),e.rotate(this.rotation);let t=this.size;if(this.scaleWithVelocity){t*=1+.1*Math.sqrt(this.vx*this.vx+this.vy*this.vy)}switch(e.fillStyle=`rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${this.alpha})`,this.shape){case"square":e.fillRect(-t/2,-t/2,t,t);break;case"star":this.drawStar(e,0,0,5,t,.5*t);break;case"triangle":e.beginPath(),e.moveTo(0,-t),e.lineTo(.866*-t,.5*t),e.lineTo(.866*t,.5*t),e.closePath(),e.fill();break;default:e.beginPath(),e.arc(0,0,t,0,2*Math.PI),e.fill()}e.restore()}drawStar(e,t,i,a,o,l){let s,n,r=Math.PI/2*3;const h=Math.PI/a;e.beginPath(),e.moveTo(t,i-o);for(let c=0;c<a;c++)s=t+Math.cos(r)*o,n=i+Math.sin(r)*o,e.lineTo(s,n),r+=h,s=t+Math.cos(r)*l,n=i+Math.sin(r)*l,e.lineTo(s,n),r+=h;e.lineTo(t,i-o),e.closePath(),e.fill()}}class t{constructor(e,t,i={}){this.x=e,this.y=t,this.active=!0,this.emissionRate=i.emissionRate||10,this.emissionTimer=0,this.lifetime=i.lifetime||1/0,this.age=0,this.particleConfig=i.particleConfig||{},this.spread=i.spread||2*Math.PI,this.direction=i.direction||0,this.system=null}update(e){if(this.age+=e,this.age>=this.lifetime)return void(this.active=!1);this.emissionTimer+=e;const t=1/this.emissionRate;for(;this.emissionTimer>=t&&this.active;)this.emissionTimer-=t,this.emit()}emit(){if(!this.system)return;const t=this.direction+(Math.random()-.5)*this.spread,i={...this.particleConfig};i.speed&&(i.vx=Math.cos(t)*i.speed,i.vy=Math.sin(t)*i.speed,delete i.speed),this.system.addParticle(new e(this.x,this.y,i))}setPosition(e,t){this.x=e,this.y=t}stop(){this.active=!1}}class i{constructor(){this.particles=[],this.emitters=[]}update(e){this.particles=this.particles.filter(t=>t.update(e)),this.emitters=this.emitters.filter(t=>(t.update(e),t.active))}render(e){const t={};this.particles.forEach(e=>{t[e.blendMode]||(t[e.blendMode]=[]),t[e.blendMode].push(e)});for(const[,i]of Object.entries(t))i.forEach(t=>t.render(e))}addParticle(e){this.particles.push(e)}addEmitter(e){this.emitters.push(e),e.system=this}emit(t,i,a={}){const o=Math.max(1,Math.round((a.emitRate||4)/60)),l=a.emitAngle&&"number"==typeof a.emitAngle.min?a.emitAngle.min:0,s=a.emitAngle&&"number"==typeof a.emitAngle.max?a.emitAngle.max:2*Math.PI,n=a.particleSpeed&&"number"==typeof a.particleSpeed.min?a.particleSpeed.min:20,r=a.particleSpeed&&"number"==typeof a.particleSpeed.max?a.particleSpeed.max:60,h=a.particleSize&&"number"==typeof a.particleSize.min?a.particleSize.min:2,c=a.particleSize&&"number"==typeof a.particleSize.max?a.particleSize.max:5,d="number"==typeof a.particleLife?Math.max(.05,a.particleLife/1e3):.4;let m={r:200,g:200,b:200},f=.6;if("string"==typeof a.particleColor){const e=a.particleColor.match(/rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*([0-9.]+))?\)/i);e&&(m={r:Number(e[1]),g:Number(e[2]),b:Number(e[3])},f=void 0!==e[4]&&null!==e[4]?Number(e[4]):1)}let p=Number((globalThis.runSeedForVisuals??1n)%0xffffffffn)>>>0;for(let u=0;u<o;u++){p=1664525*p+1013904223>>>0;const o=p/4294967296;p=1664525*p+1013904223>>>0;const u=p/4294967296;p=1664525*p+1013904223>>>0;const y=l+o*(s-l),g=n+u*(r-n),b=h+p/4294967296*(c-h);this.addParticle(new e(t,i,{vx:Math.cos(y)*g,vy:Math.sin(y)*g,color:m,size:b,life:d,alpha:f,gravity:"number"==typeof a.gravity?a.gravity:0,alphaDecay:.96,sizeDecay:a.expanding?1.02:.98,glow:!!a.expanding,blendMode:a.expanding?"screen":"source-over"}))}}createBloodSplatter(t,i,a=null){let o=Number((globalThis.runSeedForVisuals??1n)%0xffffffffn)>>>0;const l=15+(o=1664525*o+1013904223>>>0,o/4294967296*10);for(let s=0;s<l;s++){o=1664525*o+1013904223>>>0;const l=o/4294967296;o=1664525*o+1013904223>>>0;const s=o/4294967296;o=1664525*o+1013904223>>>0;const n=a?a+(l-.5)*Math.PI*.5:l*Math.PI*2,r=150*(.5+.5*s),h=2+4*(o/4294967296);this.addParticle(new e(t,i,{vx:Math.cos(n)*r,vy:Math.sin(n)*r,color:{r:180+Math.floor(40*(o=1664525*o+1013904223>>>0,o/4294967296)),g:0,b:0},size:h,life:.5+.5*(o=1664525*o+1013904223>>>0,o/4294967296),gravity:300,friction:.95,bounce:.3,alphaDecay:.95,sizeDecay:.98,trail:h>3,blendMode:"multiply"}))}for(let a=0;a<5;a++)this.addParticle(new e(t,i,{vx:50*(Math.random()-.5),vy:50*(Math.random()-.5),color:{r:150,g:0,b:0},size:15+10*Math.random(),life:.8,alpha:.3,alphaDecay:.96,sizeDecay:1.01,blendMode:"multiply"}))}createHitSpark(t,i,a={r:255,g:200,b:100}){let o=Number((globalThis.runSeedForVisuals??1n)%0xffffffffn)>>>0;const l=8+8*(o=1664525*o+1013904223>>>0,o/4294967296);for(let s=0;s<l;s++){o=1664525*o+1013904223>>>0;const n=2*Math.PI*s/l+o/4294967296*.5;o=1664525*o+1013904223>>>0;const r=200+o/4294967296*150;this.addParticle(new e(t,i,{vx:Math.cos(n)*r,vy:Math.sin(n)*r,color:a,size:2+3*(o=1664525*o+1013904223>>>0,o/4294967296),life:.2+.3*(o=1664525*o+1013904223>>>0,o/4294967296),alphaDecay:.92,sizeDecay:.95,glow:!0,glowSize:3,shape:"star",blendMode:"screen",trail:!0}))}this.addParticle(new e(t,i,{color:{r:255,g:255,b:255},size:30,life:.1,alpha:.8,alphaDecay:.85,sizeDecay:1.15,glow:!0,glowSize:2,blendMode:"screen"}))}createDustCloud(t,i,a=30){const o=10+10*Math.random();for(let l=0;l<o;l++){const o=Math.random()*Math.PI*2,l=Math.random()*a,s=t+Math.cos(o)*l,n=i+Math.sin(o)*l;this.addParticle(new e(s,n,{vx:30*(Math.random()-.5),vy:50*-Math.random()-20,color:{r:150,g:130,b:100},size:10+15*Math.random(),life:.8+.4*Math.random(),alpha:.4,alphaDecay:.97,sizeDecay:1.01,turbulence:5,blendMode:"multiply"}))}}createRollDust(t,i,a){for(let o=0;o<5;o++){const l=10*(o-2.5);this.addParticle(new e(t-20*Math.cos(a),i-20*Math.sin(a)+l,{vx:50*-Math.cos(a)+20*(Math.random()-.5),vy:50*-Math.sin(a)+20*(Math.random()-.5),color:{r:180,g:160,b:140},size:8+4*Math.random(),life:.4,alpha:.5,alphaDecay:.95,sizeDecay:1.02,blendMode:"multiply"}))}}createBlockSpark(t,i,a){for(let o=0;o<12;o++){const o=a+(Math.random()-.5)*Math.PI*.3,l=250+150*Math.random();this.addParticle(new e(t,i,{vx:Math.cos(o)*l,vy:Math.sin(o)*l,color:{r:255,g:230,b:150},size:1+2*Math.random(),life:.3,alphaDecay:.9,friction:.92,glow:!0,glowSize:4,shape:Math.random()>.5?"star":"circle",blendMode:"screen",trail:!0,gravity:100}))}this.addParticle(new e(t,i,{color:{r:255,g:255,b:200},size:5,life:.2,alpha:.6,alphaDecay:.85,sizeDecay:1.25,shape:"circle",blendMode:"screen",glow:!0,glowSize:3}))}createPerfectParryFlash(t,i){this.addParticle(new e(t,i,{color:{r:100,g:200,b:255},size:100,life:.3,alpha:.8,alphaDecay:.9,sizeDecay:1.08,glow:!0,glowSize:2,blendMode:"screen"}));for(let a=0;a<16;a++){const o=2*Math.PI*a/16,l=300;this.addParticle(new e(t,i,{vx:Math.cos(o)*l,vy:Math.sin(o)*l,color:{r:150,g:200,b:255},size:4,life:.5,alphaDecay:.94,friction:.9,glow:!0,glowSize:3,shape:"star",blendMode:"screen",trail:!0}))}}createEnemyDeathExplosion(t,i){for(let a=0;a<30;a++){const a=Math.random()*Math.PI*2,o=100+200*Math.random();this.addParticle(new e(t,i,{vx:Math.cos(a)*o,vy:Math.sin(a)*o,color:{r:255,g:100+100*Math.random(),b:100*Math.random()},size:3+5*Math.random(),life:.5+.5*Math.random(),gravity:200,friction:.94,alphaDecay:.95,sizeDecay:.97,glow:!0,glowSize:2,blendMode:"screen"}))}for(let a=0;a<8;a++)this.addParticle(new e(t,i,{vx:50*(Math.random()-.5),vy:100*-Math.random()-50,color:{r:80,g:80,b:80},size:20+20*Math.random(),life:1,alpha:.5,alphaDecay:.97,sizeDecay:1.02,blendMode:"multiply"}))}createFootstep(t,i,a=1){for(let o=0;o<3;o++)this.addParticle(new e(t+10*(Math.random()-.5),i+5*(Math.random()-.5),{vx:20*(Math.random()-.5),vy:30*-Math.random()-10,color:{r:160,g:140,b:120},size:(3+2*Math.random())*a,life:.3,alpha:.3,alphaDecay:.94,sizeDecay:1.01,blendMode:"multiply"}))}clear(){this.particles=[],this.emitters=[]}createSlashEffect(t,i,a=1){for(let o=0;o<6;o++){const o=250+150*Math.random(),l=.4*(Math.random()-.5);this.addParticle(new e(t,i+20*(Math.random()-.5),{vx:a*o+60*(Math.random()-.5),vy:l*o*.2,color:{r:255,g:230,b:120},size:2+2*Math.random(),life:.25+.2*Math.random(),alphaDecay:.92,sizeDecay:.96,glow:!0,glowSize:3,shape:"star",blendMode:"screen",trail:!0}))}this.addParticle(new e(t+10*a,i,{color:{r:255,g:255,b:200},size:24,life:.12,alpha:.8,alphaDecay:.85,sizeDecay:1.18,glow:!0,glowSize:2,blendMode:"screen"}))}createShieldEffect(t,i){for(let a=0;a<12;a++){const o=2*Math.PI*a/12,l=120+80*Math.random();this.addParticle(new e(t,i,{vx:Math.cos(o)*l,vy:Math.sin(o)*l,color:{r:120,g:180,b:255},size:2,life:.25,alphaDecay:.92,sizeDecay:.98,glow:!0,glowSize:3,shape:"circle",blendMode:"screen"}))}this.addParticle(new e(t,i,{color:{r:180,g:220,b:255},size:30,life:.18,alpha:.5,alphaDecay:.9,sizeDecay:1.12,glow:!0,glowSize:2,blendMode:"screen"}))}createBlockImpact(e,t){this.createBlockSpark(e,t,0)}createBloodEffect(e,t){this.createBloodSplatter(e,t)}createDeathEffect(e,t){this.createEnemyDeathExplosion(e,t)}createRespawnEffect(t,i){this.createDustCloud(t,i,40),this.addParticle(new e(t,i,{color:{r:180,g:255,b:255},size:60,life:.4,alpha:.6,alphaDecay:.9,sizeDecay:1.1,glow:!0,glowSize:2,blendMode:"screen"}))}startChargingEffect(e,i){const a=new t(e,i,{emissionRate:20,lifetime:1.5,particleConfig:{color:{r:120,g:200,b:255},size:3,life:.4,alpha:.7,alphaDecay:.94,sizeDecay:.98,glow:!0,glowSize:2,shape:"circle",speed:30,rotationSpeed:3},spread:2*Math.PI,direction:0});return this.addEmitter(a),a}createChargedSlash(t,i,a=1,o=0){this.createSlashEffect(t,i,a);const l=Math.floor(6*Math.max(0,Math.min(1,o)));for(let o=0;o<l;o++)this.addParticle(new e(t,i+20*(Math.random()-.5),{vx:a*(300+200*Math.random()),vy:40*(Math.random()-.5),color:{r:255,g:255,b:180},size:3+2*Math.random(),life:.3,alphaDecay:.9,sizeDecay:.95,glow:!0,glowSize:3,shape:"star",blendMode:"screen",trail:!0}));this.addParticle(new e(t+15*a,i,{color:{r:255,g:255,b:220},size:30+20*o,life:.14+.1*o,alpha:.85,alphaDecay:.88,sizeDecay:1.2,glow:!0,glowSize:2,blendMode:"screen"}))}createDashTrail(t,i,a=1,o=0){const l=Math.sqrt(a*a+o*o)||1,s=a/l,n=o/l;for(let a=0;a<4;a++)this.addParticle(new e(t-s*(10+3*a),i-n*(10+3*a),{vx:80*-s+20*(Math.random()-.5),vy:80*-n+20*(Math.random()-.5),color:{r:200,g:220,b:255},size:3,life:.25,alpha:.5,alphaDecay:.9,sizeDecay:.98,glow:!0,glowSize:2,blendMode:"screen"}))}createLandingImpact(t,i,a=1){const o=30+40*Math.max(0,Math.min(1,a));this.createDustCloud(t,i,o),this.addParticle(new e(t,i,{color:{r:255,g:255,b:255},size:20*a,life:.12,alpha:.6,alphaDecay:.88,sizeDecay:1.2,glow:!0,glowSize:2,blendMode:"screen"}))}createSparkle(t,i){this.addParticle(new e(t,i,{color:{r:255,g:255,b:200},size:3+2*Math.random(),life:.3,alpha:.9,alphaDecay:.92,sizeDecay:.97,glow:!0,glowSize:3,shape:"star",blendMode:"screen"}))}}class a{constructor(){this.animations=new Map,this.proceduralAnimations=new Map,this.particleEffects=new Map,this._dt=0,this.wasmModule=null,this.initializeAnimations(),this.initializeProceduralAnimations(),this.initializeParticleEffects()}setWasmModule(e){this.wasmModule=e}_seedWolf(e){if(null===e._animSeed){const t=65535&Math.floor(1e3*(e.position?.x||0)),i=65535&Math.floor(1e3*(e.position?.y||0)),a=65535&Math.floor(1e6*(e.furPattern||.5));e._animSeed=(t<<16^i^a<<1)>>>0}null===e._animRngState&&(e._animRngState=e._animSeed>>>0)}_rand(e){this._seedWolf(e);let t=0|e._animRngState;return t^=t<<13,t^=t>>>17,t^=t<<5,e._animRngState=t>>>0,(4294967295&e._animRngState)/4294967296}_chance(e,t){return this._rand(e)<t}_lerp(e,t,i){return e+(t-e)*i}_smoothNumber(e,t,i){const a=this._dt||.016,o=Math.min(1,Math.max(0,i*a));return this._lerp(e,t,o)}_smoothProp(e,t,i,a=8){const o=null!==e[t]?e[t]:i;e[t]=this._smoothNumber(o,i,a)}_updateSmoothedVelocity(e){const t=e.velocity?.x||0,i=e.velocity?.y||0;e._smVelX=this._smoothNumber(e._smVelX||0,t,10),e._smVelY=this._smoothNumber(e._smVelY||0,i,10)}initializeAnimations(){this.animations.set("idle",{breathing:{amplitude:2,frequency:.002,offset:0},earTwitch:{probability:.001,duration:300,maxRotation:.2},tailSway:{amplitude:.1,frequency:.003},blinking:{probability:.002,duration:150}}),this.animations.set("walking",{legCycle:{frequency:.008,amplitude:8,phaseOffset:Math.PI},bodyBob:{amplitude:2,frequency:.016},headBob:{amplitude:1.5,frequency:.008},tailSway:{amplitude:.2,frequency:.008}}),this.animations.set("running",{legCycle:{frequency:.015,amplitude:12,phaseOffset:Math.PI,stretchFactor:1.2},bodyBob:{amplitude:4,frequency:.03},headBob:{amplitude:3,frequency:.015},tailStream:{amplitude:.4,frequency:.02,streamEffect:!0},earsPinned:!0}),this.animations.set("prowling",{legCycle:{frequency:.004,amplitude:5,phaseOffset:Math.PI,careful:!0},bodyLowered:{lowerAmount:10,sway:1},headLowered:{lowerAmount:5,scanning:!0,scanSpeed:.002},tailStill:{tipTwitch:.01,frequency:.005},earsForward:{rotation:-.3,alertness:1}}),this.animations.set("lunging",{bodyStretch:{stretchFactor:1.3,compressionStart:.8,extensionPeak:1.5},legsExtended:{frontExtension:20,rearExtension:15,clawsOut:!0},mouthOpen:{openAmount:.8,teethVisible:!0},earsBack:{rotation:.5},furRipple:{intensity:.3,speed:.02}}),this.animations.set("attacking",{biteSequence:[{jaw:0,duration:100},{jaw:.9,duration:50},{jaw:.7,duration:100},{jaw:0,duration:150}],headShake:{amplitude:5,frequency:.05},clawSwipe:{swipeSpeed:.03,swipeArc:Math.PI/3},bodyTense:{tensionLevel:.8}}),this.animations.set("howling",{headTilt:{startAngle:0,endAngle:-Math.PI/4,duration:1e3},mouthOpen:{openAmount:.6,vibration:.02},chestExpansion:{expansionAmount:1.2,frequency:.003},tailRaised:{angle:.3},soundWaves:{frequency:.01,amplitude:2,visible:!0}}),this.animations.set("hurt",{flinch:{intensity:10,duration:200,direction:"away"},earsFlat:{rotation:.6},tailTucked:{tuckAmount:.8},whimper:{mouthOpen:.2,duration:300},bodyShake:{amplitude:3,frequency:.1,dampening:.9}}),this.animations.set("death",{collapse:{stages:[{legs:"buckle",duration:300},{body:"fall",duration:400},{final:"limp",duration:500}]},fadeOut:{startDelay:1e3,duration:2e3}})}initializeProceduralAnimations(){this.proceduralAnimations.set("legIK",{calculateLegPosition:(e,t,i)=>{const a=this.animations.get(e.state);if(!a||!a.legCycle)return{x:0,y:0};const o=a.legCycle,l=t%2==0?0:o.phaseOffset,s=i*o.frequency+l,n=Math.sin(s)*o.amplitude*.5,r=Math.max(0,Math.sin(2*s))*o.amplitude;return o.careful?{x:.5*n,y:.7*r,placement:"careful"}:{x:n,y:r}}}),this.proceduralAnimations.set("tailPhysics",{segments:5,calculateTailCurve:(e,t)=>{const i=this.animations.get(e.state),a=[];for(let e=0;e<5;e++){const o=.1*e;let l=0;i?.tailSway?l=Math.sin(t*i.tailSway.frequency-o)*i.tailSway.amplitude*(1-.15*e):i?.tailStream?l=Math.sin(t*i.tailStream.frequency-o)*i.tailStream.amplitude*(1+.1*e):i?.tailTucked&&(l=i.tailTucked.tuckAmount*(1+.2*e)),a.push({angle:l,length:8-.5*e})}return a}}),this.proceduralAnimations.set("furDynamics",{calculateFurMovement(e,t,i=0){const a=Math.sqrt(e.velocity.x**2+e.velocity.y**2),o=Math.sin(.005*t)*i;return{ripple:a>200?.2*Math.sin(.02*t):0,flow:o+a/1e3,ruffled:"hurt"===e.state||"attacking"===e.state}}}),this.proceduralAnimations.set("breathing",{calculateBreathing(e,t){const i=.002*({idle:1,walking:1.2,running:2,prowling:.8,attacking:1.5,hurt:1.8,howling:1.3}[e.state]||1),a="running"===e.state?4:2;return{chestExpansion:Math.sin(t*i)*a,bellyExpansion:Math.sin(t*i-.2)*a*.7}}})}initializeParticleEffects(){this.particleEffects.set("runDust",{emitRate:5,particleLife:500,particleSpeed:{min:20,max:50},particleSize:{min:2,max:5},particleColor:"rgba(139, 115, 85, 0.4)",emitAngle:{min:.4*Math.PI,max:.6*Math.PI},gravity:50}),this.particleEffects.set("bloodSplatter",{emitRate:20,particleLife:800,particleSpeed:{min:100,max:200},particleSize:{min:1,max:3},particleColor:"rgba(139, 0, 0, 0.7)",emitAngle:{min:0,max:2*Math.PI},gravity:200}),this.particleEffects.set("attackFoam",{emitRate:8,particleLife:300,particleSpeed:{min:50,max:100},particleSize:{min:1,max:2},particleColor:"rgba(255, 255, 255, 0.6)",emitAngle:{min:-Math.PI/6,max:Math.PI/6},gravity:100}),this.particleEffects.set("soundWaves",{emitRate:2,particleLife:1500,particleSpeed:{min:100,max:100},particleSize:{min:20,max:40},particleColor:"rgba(255, 255, 255, 0.2)",emitAngle:{min:-Math.PI/8,max:Math.PI/8},gravity:0,expanding:!0})}applyAnimation(e,t){if(!this.wasmModule)return;this._dt=t;const i=e.id;if(!("function"==typeof this.wasmModule.get_wolf_anim_active&&this.wasmModule.get_wolf_anim_active(i)))return;const a="function"==typeof globalThis.wasmExports?.get_time_seconds?globalThis.wasmExports.get_time_seconds():performance.now()/1e3,o=e.state,l=this.animations.get(o);if(l){switch(e._lastAnimState!==o&&(e._lastAnimState=o,e._stateBlend=0),e._stateBlend=Math.min(1,(e._stateBlend||0)+6*t),this._updateSmoothedVelocity(e),this.applyProceduralAnimations(e,i,a),o){case"idle":this.applyIdleAnimation(e,l,a);break;case"walking":case"running":this.applyLocomotionAnimation(e,l,a);break;case"prowling":this.applyProwlingAnimation(e,l,a);break;case"lunging":this.applyLungingAnimation(e,l,a);break;case"attacking":this.applyAttackingAnimation(e,l,a);break;case"howling":this.applyHowlingAnimation(e,l,a);break;case"hurt":this.applyHurtAnimation(e,l,a)}this.updateParticleEffects(e,t)}}applyProceduralAnimations(e,t,i){if(!this.wasmModule)return;const a={active:"function"==typeof this.wasmModule.get_wolf_anim_active&&this.wasmModule.get_wolf_anim_active(t),leg_x:["function"==typeof this.wasmModule.get_wolf_anim_leg_x?this.wasmModule.get_wolf_anim_leg_x(t,0):0,"function"==typeof this.wasmModule.get_wolf_anim_leg_x?this.wasmModule.get_wolf_anim_leg_x(t,1):0,"function"==typeof this.wasmModule.get_wolf_anim_leg_x?this.wasmModule.get_wolf_anim_leg_x(t,2):0,"function"==typeof this.wasmModule.get_wolf_anim_leg_x?this.wasmModule.get_wolf_anim_leg_x(t,3):0],leg_y:["function"==typeof this.wasmModule.get_wolf_anim_leg_y?this.wasmModule.get_wolf_anim_leg_y(t,0):0,"function"==typeof this.wasmModule.get_wolf_anim_leg_y?this.wasmModule.get_wolf_anim_leg_y(t,1):0,"function"==typeof this.wasmModule.get_wolf_anim_leg_y?this.wasmModule.get_wolf_anim_leg_y(t,2):0,"function"==typeof this.wasmModule.get_wolf_anim_leg_y?this.wasmModule.get_wolf_anim_leg_y(t,3):0],spine_bend:"function"==typeof this.wasmModule.get_wolf_anim_spine_bend?this.wasmModule.get_wolf_anim_spine_bend(t):0,tail_angle:"function"==typeof this.wasmModule.get_wolf_anim_tail_angle?this.wasmModule.get_wolf_anim_tail_angle(t):0,head_pitch:"function"==typeof this.wasmModule.get_wolf_anim_head_pitch?this.wasmModule.get_wolf_anim_head_pitch(t):0,head_yaw:"function"==typeof this.wasmModule.get_wolf_anim_head_yaw?this.wasmModule.get_wolf_anim_head_yaw(t):0,ear_rotation:["function"==typeof this.wasmModule.get_wolf_anim_ear_rotation?this.wasmModule.get_wolf_anim_ear_rotation(t,0):0,"function"==typeof this.wasmModule.get_wolf_anim_ear_rotation?this.wasmModule.get_wolf_anim_ear_rotation(t,1):0],body_stretch:"function"==typeof this.wasmModule.get_wolf_anim_body_stretch?this.wasmModule.get_wolf_anim_body_stretch(t):1,body_offset_y:"function"==typeof this.wasmModule.get_wolf_anim_body_offset_y?this.wasmModule.get_wolf_anim_body_offset_y(t):0,fur_ruffle:"function"==typeof this.wasmModule.get_wolf_anim_fur_ruffle?this.wasmModule.get_wolf_anim_fur_ruffle(t):0};e.legPositions=a.leg_x.map((e,t)=>({x:e,y:a.leg_y[t]})),e.spineBend=a.spine_bend,e.tailPosition=a.tail_angle,e.headPitch=a.head_pitch,e.headYaw=a.head_yaw,e.earRotation=a.ear_rotation[0],e.bodyStretch=a.body_stretch,e.bodyBob=a.body_offset_y,e.furMovement={ripple:a.fur_ruffle,flow:0,ruffled:a.fur_ruffle>.05};const o=this.proceduralAnimations.get("breathing").calculateBreathing(e,i);e.breathingOffset=o.chestExpansion,e.bellyOffset=o.bellyExpansion}applyIdleAnimation(e,t,i){this._smoothProp(e,"earRotation",e.earRotation||0,8),this._chance(e,t.blinking.probability)&&(e.blinkTime=i,e.blinkDuration=t.blinking.duration),e.isBlinking=e.blinkTime&&i-e.blinkTime<e.blinkDuration}applyLocomotionAnimation(e,t,i){this._smoothProp(e,"bodyBob",e.bodyBob||0,10),this._smoothProp(e,"headBob",e.headBob||0,10),t.earsPinned&&this._smoothProp(e,"earRotation",e.earRotation||.4,12)}applyProwlingAnimation(e,t,i){this._smoothProp(e,"bodyLowered",1e3*(e.bodyBob||0),10),this._smoothProp(e,"bodySway",1*Math.sin(.002*i),10),t.headLowered.scanning&&(e.headScan=e.headYaw),this._smoothProp(e,"earRotation",e.earRotation||0,10),this._smoothProp(e,"earAlertness",e.earRotation?1:0,10)}applyLungingAnimation(e,t,i){this._smoothProp(e,"bodyStretch",e.bodyStretch||1,14),e.frontLegExtension=20*(e.bodyStretch-1),e.rearLegExtension=15*(e.bodyStretch-1),e.clawsOut=e.bodyStretch>1.1,e.mouthOpen=t.mouthOpen.openAmount,e.teethVisible=t.mouthOpen.teethVisible,e.furRipple=e.furMovement?.ripple||0}applyAttackingAnimation(e,t,i){e.biteSequenceIndex||(e.biteSequenceIndex=0),e.biteSequenceTime||(e.biteSequenceTime=i);const a=t.biteSequence[e.biteSequenceIndex];i-e.biteSequenceTime<a.duration?e.jawOpen=a.jaw:(e.biteSequenceIndex=(e.biteSequenceIndex+1)%t.biteSequence.length,e.biteSequenceTime=i),this._smoothProp(e,"headShake",Math.sin(i*t.headShake.frequency)*t.headShake.amplitude,18),e.bodyTension=t.bodyTense.tensionLevel}applyHowlingAnimation(e,t,i){e.howlStartTime||(e.howlStartTime=i),e.howlStartTime,t.headTilt.duration,e.headTilt=e.headPitch,e.mouthOpen=t.mouthOpen.openAmount,e.mouthVibration=Math.sin(.05*i)*t.mouthOpen.vibration,this._smoothProp(e,"chestExpansion",1+Math.sin(i*t.chestExpansion.frequency)*(t.chestExpansion.expansionAmount-1),10),t.soundWaves.visible&&(e.soundWavePhase=i*t.soundWaves.frequency,e.soundWaveAmplitude=t.soundWaves.amplitude)}applyHurtAnimation(e,t,i){e.hurtStartTime||(e.hurtStartTime=i);const a=i-e.hurtStartTime;if(a<t.flinch.duration){const i=a/t.flinch.duration;e.flinchOffset=t.flinch.intensity*(1-i)}const o=t.bodyShake.dampening**(a/100);this._smoothProp(e,"bodyShake",Math.sin(i*t.bodyShake.frequency)*t.bodyShake.amplitude*o,18),this._smoothProp(e,"earRotation",e.earRotation||t.earsFlat.rotation,14),this._smoothProp(e,"tailTucked",e.tailPosition||t.tailTucked.tuckAmount,14)}updateParticleEffects(e,t){if(e.particleSystem||(e.particleSystem=new i),"running"===e.state&&e.isGrounded){const t=this.particleEffects.get("runDust"),i=e.position.x-20*e.facing,a=e.position.y+e.height/2;"function"==typeof e.particleSystem.emit?e.particleSystem.emit(i,a,t):"function"==typeof e.particleSystem.createDustCloud&&e.particleSystem.createDustCloud(i,a,20)}if("howling"===e.state){const t=this.particleEffects.get("soundWaves"),i=e.position.x+30*e.facing,a=e.position.y-e.height/4;"function"==typeof e.particleSystem.emit?e.particleSystem.emit(i,a,t):"function"==typeof e.particleSystem.createSparkle&&e.particleSystem.createSparkle(i,a)}e.particleSystem.update(t)}renderAnimatedWolf(e,t,i){const a=Math.sqrt((t.position.x-i.x)**2+(t.position.y-i.y)**2);if(a>1500)return;const o=a<500,l=a<1e3;e.save();const s=t.position.x-i.x,n=t.position.y-i.y;e.translate(s,n);const r=t._smVelX||0,h=t._smVelY||0,c=Math.sqrt(r*r+h*h),d=t.spineBend||0;d&&e.rotate(d);const m=1+.05*Math.min(c/(t.maxSpeed||350),1),f=(t.bodyStretch||1)*m,p=2-f;e.scale(t.size*t.facing*f,t.size*p),t.bodyShake&&e.translate(t.bodyShake,0),t.flinchOffset&&e.translate(-t.facing*t.flinchOffset,.5*-t.flinchOffset),l&&this.drawAnimatedShadow(e,t),o?(this.drawAnimatedTail(e,t),this.drawAnimatedLegs(e,t,"hind"),this.drawAnimatedBody(e,t),this.drawAnimatedLegs(e,t,"front"),this.drawAnimatedNeck(e,t),this.drawAnimatedHead(e,t)):l?(this.drawAnimatedBody(e,t),this.drawAnimatedHead(e,t)):this.drawSimplifiedWolf(e,t),o&&t.particleSystem&&t.particleSystem.render(e,i),l&&this.drawWolfUI(e,t),e.restore()}drawSimplifiedWolf(e,t){e.fillStyle=t.color||"#8B4513",e.beginPath(),e.ellipse(0,0,20*t.size,12*t.size,0,0,2*Math.PI),e.fill(),e.beginPath(),e.ellipse(t.facing*t.size*15,8*-t.size,8*t.size,6*t.size,0,0,2*Math.PI),e.fill()}drawAnimatedShadow(e,t){const i=Math.sqrt((t._smVelX||0)**2+(t._smVelY||0)**2),a=1+.15*Math.min(i/(t.maxSpeed||350),1),o="lunging"===t.state?1.2*a:a,l=t.isGrounded?.32:.12;e.fillStyle=`rgba(0, 0, 0, ${l})`,e.beginPath(),e.ellipse(0,t.height/2+5,t.width/3*o,8,0,0,2*Math.PI),e.fill()}drawAnimatedTail(e,t){e.save();const i=.35*-t.width;let a=.1*-t.height;if(t.bodyLowered&&(a+=.5*t.bodyLowered),e.translate(i,a),t.tailSegments){let i=0,a=0,o=t.tailPosition||0;t.tailSegments.forEach((l,s)=>{e.save(),e.translate(i,a),e.rotate(o+l.angle);const n=8-1.2*s,r=l.length;e.fillStyle=s%2==0?t.colors.primary:t.colors.secondary,e.fillRect(0,-n/2,r,n),i+=Math.cos(o+l.angle)*r,a+=Math.sin(o+l.angle)*r,o+=l.angle,e.restore()})}else e.rotate(t.tailPosition||0),e.fillStyle=t.colors.primary,e.beginPath(),e.moveTo(0,0),e.quadraticCurveTo(-15,5,-25,15),e.quadraticCurveTo(-20,20,-10,18),e.quadraticCurveTo(-5,10,0,0),e.fill();e.restore()}drawAnimatedLegs(e,t,i){const a=t.legPositions||[],o="hind"===i,l=o?0:2;for(let i=l;i<l+2;i++){const l=a[i]||{x:0,y:0},s=o?-t.width*(.25-i%2*.1):t.width*(.15+i%2*.1),n=.2*t.height;if(e.save(),e.translate(s+100*l.x,n+100*l.y),e.fillStyle=t.colors.primary,e.fillRect(0,0,10,15-50*l.y),e.translate(0,15-50*l.y),e.rotate(.05*l.y),e.fillRect(0,0,8,10+50*l.y),e.translate(0,10+50*l.y),e.fillStyle=t.colors.secondary,e.fillRect(-1,0,10,5),t.clawsOut){e.fillStyle=t.colors.claws;for(let t=0;t<3;t++)e.fillRect(3*t,4,2,4)}e.restore()}}drawAnimatedBody(e,t){e.save(),t.bodyBob&&e.translate(0,100*t.bodyBob);const i=t.breathingOffset||0,a=t.chestExpansion||1;e.fillStyle=t.colors.primary,e.beginPath(),e.ellipse(0,i,.35*t.width*a*(t.bodyStretch||1),.25*t.height,0,0,2*Math.PI),e.fill();const o=i+(t.bellyOffset||0);e.fillStyle=t.colors.belly,e.beginPath(),e.ellipse(0,o+.1*t.height,.3*t.width*(t.bodyStretch||1),.15*t.height,0,0,Math.PI),e.fill(),t.furMovement&&this.drawAnimatedFur(e,t,0,i,.35*t.width,.25*t.height),e.restore()}drawAnimatedNeck(e,t){e.save(),t.bodyBob&&e.translate(0,50*t.bodyBob),e.fillStyle=t.colors.primary,e.beginPath(),e.moveTo(.15*t.width,.1*-t.height),e.quadraticCurveTo(.25*t.width,.05*-t.height,.3*t.width,.15*-t.height),e.quadraticCurveTo(.25*t.width,.05*t.height,.15*t.width,.1*t.height),e.fill(),e.restore()}drawAnimatedHead(e,t){e.save(),e.translate(.35*t.width,.15*-t.height),t.headPitch&&e.rotate(t.headPitch),t.headShake&&e.translate(t.headShake,0),t.headYaw&&e.rotate(t.headYaw),t.bodyBob&&e.translate(0,50*t.bodyBob),e.fillStyle=t.colors.primary,e.beginPath(),e.moveTo(0,0),e.quadraticCurveTo(10,-5,15,0),e.quadraticCurveTo(20,3,25,5),e.lineTo(28,8),e.quadraticCurveTo(25,10,20,10),e.quadraticCurveTo(10,8,0,10),e.quadraticCurveTo(-5,5,0,0),e.fill(),this.drawAnimatedEars(e,t),this.drawAnimatedMouth(e,t),this.drawAnimatedEyes(e,t),null!==t.soundWavePhase&&this.drawSoundWaves(e,t),e.restore()}drawAnimatedEars(e,t){const i=t.earRotation||0,a=t.earAlertness||0;e.save(),e.translate(5,-3),e.rotate(i-.1*a),e.fillStyle=t.colors.primary,e.beginPath(),e.moveTo(0,0),e.lineTo(-3,-8-2*a),e.lineTo(3,-8-2*a),e.closePath(),e.fill(),e.fillStyle=t.colors.belly,e.beginPath(),e.moveTo(0,-2),e.lineTo(-1,-6-a),e.lineTo(1,-6-a),e.closePath(),e.fill(),e.restore(),e.save(),e.translate(8,-2),e.rotate(i+.1*a),e.fillStyle=t.colors.secondary,e.beginPath(),e.moveTo(0,0),e.lineTo(-2,-7-2*a),e.lineTo(3,-7-2*a),e.closePath(),e.fill(),e.restore()}drawAnimatedMouth(e,t){const i=t.mouthOpen||t.jawOpen||0,a=t.mouthVibration||0;e.fillStyle=t.colors.secondary,e.beginPath(),e.moveTo(20,5),e.quadraticCurveTo(25,6,28,8),e.quadraticCurveTo(25,9+3*i,20,9+3*i),e.fill(),i>0&&(e.fillStyle="rgba(0, 0, 0, 0.7)",e.beginPath(),e.moveTo(20,9),e.quadraticCurveTo(24,9+5*i+a,28,9+3*i+a),e.quadraticCurveTo(24,11+5*i+a,20,11+5*i),e.fill(),(t.teethVisible||i>.5)&&(e.fillStyle="#ffffff",e.beginPath(),e.moveTo(22,9),e.lineTo(21,11+2*i),e.lineTo(23,11+2*i),e.closePath(),e.fill(),e.beginPath(),e.moveTo(25,9),e.lineTo(24,11+2*i),e.lineTo(26,11+2*i),e.closePath(),e.fill(),i>.7&&(e.beginPath(),e.moveTo(23,11+4*i),e.lineTo(22,9+4*i),e.lineTo(24,9+4*i),e.closePath(),e.fill())),i>.3&&"attacking"!==t.state&&(e.fillStyle="rgba(255, 100, 100, 0.8)",e.beginPath(),e.ellipse(24,10+3*i,3,2+2*i,.2,0,Math.PI),e.fill())),e.fillStyle=t.colors.nose,e.beginPath(),e.arc(28,8,2,0,2*Math.PI),e.fill()}drawAnimatedEyes(e,t){if(t.isBlinking)return e.strokeStyle=t.colors.secondary,e.lineWidth=2,e.beginPath(),e.moveTo(10,3),e.lineTo(16,3),void e.stroke();"prowling"!==t.state&&"lunging"!==t.state&&"attacking"!==t.state||(e.shadowColor=t.colors.eyes,e.shadowBlur=8),e.fillStyle="#ffffff",e.beginPath(),e.ellipse(12,3,4,3,-.2,0,2*Math.PI),e.fill();const i="attacking"===t.state?.7:"prowling"===t.state?.5:.3;e.fillStyle=t.colors.eyes,e.beginPath(),e.arc(13,3,2,0,2*Math.PI),e.fill(),e.fillStyle="#000000",e.beginPath(),e.arc(13.5,3,1*(1-i),0,2*Math.PI),e.fill(),e.fillStyle="rgba(255, 255, 255, 0.7)",e.beginPath(),e.arc(12,2,.5,0,2*Math.PI),e.fill(),e.shadowBlur=0}drawAnimatedFur(e,t,i,a,o,l){e.strokeStyle=t.colors.secondary,e.lineWidth=.5,e.globalAlpha=.4;const s=(t.furMovement?.ripple||0)+t.furRuffle,n=t.furMovement?.flow||0,r=t.furMovement?.ruffled||!1;for(let h=0;h<12;h++){const c=h/12*Math.PI*2,d=i+Math.cos(c)*o*.7,m=a+Math.sin(c)*l*.7,f=Math.sin(.01*t.animationTime+h)*s*10,p=Math.cos(.01*t.animationTime+h)*s*5;e.beginPath(),e.moveTo(d,m),r?e.lineTo(d+8*Math.cos(c)+f,m+8*Math.sin(c)+p):e.quadraticCurveTo(d+4*Math.cos(c)+.5*f,m+4*Math.sin(c)+.5*p,d+6*Math.cos(c+n)+f,m+6*Math.sin(c+n)+p),e.stroke()}e.globalAlpha=1}drawSoundWaves(e,t){e.save(),e.globalAlpha=.3,e.strokeStyle=t.colors.eyes,e.lineWidth=2;for(let i=0;i<3;i++){const a=t.soundWavePhase+i*Math.PI/3,o=10+Math.sin(a)*t.soundWaveAmplitude+15*i,l=.3-.1*i;e.globalAlpha=l,e.beginPath(),e.arc(30,5,o,-Math.PI/3,Math.PI/3),e.stroke()}e.restore()}drawWolfUI(e,t){if(t.isAlpha||t.health<t.maxHealth){e.save(),e.scale(1/t.size,1/t.size);const i=60,a=6,o=.5*-t.height-20;e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(-i/2,o,i,a);const l=t.health/t.maxHealth;e.fillStyle=l>.5?"#4caf50":l>.25?"#ff9800":"#f44336",e.fillRect(-i/2,o,i*l,a),e.strokeStyle=t.isAlpha?"#ffd700":"#ffffff",e.lineWidth=1,e.strokeRect(-i/2,o,i,a),t.isAlpha&&(e.font="12px Arial",e.textAlign="center",e.fillText("👑",0,o-5)),"prowling"===t.state?e.fillText("👁",-35,o+5):"howling"===t.state&&e.fillText("🔊",-35,o+5),e.restore()}if(t.lungeState?.charging){e.save(),e.globalAlpha=.7;const i=t.lungeState.chargeTime/t.lungeState.maxChargeTime,a=15;e.strokeStyle=`hsl(${60*i}, 100%, 50%)`,e.lineWidth=3,e.beginPath(),e.arc(0,.7*-t.height,a,-Math.PI/2,-Math.PI/2+2*Math.PI*i),e.stroke(),i>=1&&(e.globalAlpha=.3+.3*Math.sin(.01*t.animationTime),e.strokeStyle="#ff0000",e.beginPath(),e.arc(0,.7*-t.height,a+5,0,2*Math.PI),e.stroke()),e.restore()}}}export{a as WolfAnimationSystem,a as default};