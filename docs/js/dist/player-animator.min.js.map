{"version":3,"file":"player-animator.min.js.map","sources":["../src/animation/animation-system.js","../src/animation/realistic-procedural-animator.js","../src/animation/player-animator.js"],"sourcesContent":["// Advanced Animation System for Smooth Character and Object Animations\r\n// Provides sprite animations, procedural animations, and smooth transitions\r\n\r\nexport class AnimationFrame {\r\n    constructor(x, y, width, height, duration = 100) {\r\n        this.x = x\r\n        this.y = y\r\n        this.width = width\r\n        this.height = height\r\n        this.duration = duration // milliseconds\r\n    }\r\n}\r\n\r\nexport class Animation {\r\n    constructor(name, frames, options = {}) {\r\n        this.name = name\r\n        this.frames = frames\r\n        this.loop = options.loop !== null && options.loop !== void 0 ? options.loop : true\r\n        this.pingPong = options.pingPong || false\r\n        this.speed = options.speed || 1.0\r\n        this.onComplete = options.onComplete || null\r\n        this.onFrame = options.onFrame || null\r\n        \r\n        this.currentFrame = 0\r\n        this.elapsedTime = 0\r\n        this.direction = 1\r\n        this.isPlaying = false\r\n        this.hasCompleted = false\r\n    }\r\n\r\n    play() {\r\n        this.isPlaying = true\r\n        this.hasCompleted = false\r\n        this.currentFrame = 0\r\n        this.elapsedTime = 0\r\n        this.direction = 1\r\n    }\r\n\r\n    stop() {\r\n        this.isPlaying = false\r\n        this.reset()\r\n    }\r\n\r\n    pause() {\r\n        this.isPlaying = false\r\n    }\r\n\r\n    resume() {\r\n        this.isPlaying = true\r\n    }\r\n\r\n    reset() {\r\n        this.currentFrame = 0\r\n        this.elapsedTime = 0\r\n        this.direction = 1\r\n        this.hasCompleted = false\r\n    }\r\n\r\n    update(deltaTime) {\r\n        if (!this.isPlaying || this.frames.length === 0) {\r\n            return\r\n        }\r\n\r\n        this.elapsedTime += deltaTime * this.speed * 1000 // Convert to milliseconds\r\n\r\n        const currentFrameData = this.frames[this.currentFrame]\r\n\r\n        // Handle frames with non-positive duration as indefinite holds\r\n        if (currentFrameData && currentFrameData.duration <= 0) {\r\n            if (!this.loop && this.currentFrame === this.frames.length - 1) {\r\n                this.isPlaying = false\r\n                this.hasCompleted = true\r\n                if (this.onComplete) {this.onComplete()}\r\n            }\r\n            return\r\n        }\r\n\r\n        if (this.elapsedTime >= currentFrameData.duration) {\r\n            this.elapsedTime -= currentFrameData.duration\r\n            \r\n            const previousFrame = this.currentFrame\r\n            this.currentFrame += this.direction\r\n\r\n            if (this.pingPong) {\r\n                if (this.currentFrame >= this.frames.length || this.currentFrame < 0) {\r\n                    this.direction *= -1\r\n                    this.currentFrame += this.direction * 2\r\n                }\r\n            } else if (this.currentFrame >= this.frames.length) {\r\n                    if (this.loop) {\r\n                        this.currentFrame = 0\r\n                    } else {\r\n                        this.currentFrame = this.frames.length - 1\r\n                        this.isPlaying = false\r\n                        this.hasCompleted = true\r\n                        if (this.onComplete) {this.onComplete()}\r\n                    }\r\n                }\r\n\r\n            if (this.onFrame && this.currentFrame !== previousFrame) {\r\n                this.onFrame(this.currentFrame, this.frames[this.currentFrame])\r\n            }\r\n        }\r\n    }\r\n\r\n    getCurrentFrame() {\r\n        if (this.frames.length === 0) {return null}\r\n        if (this.currentFrame < 0 || this.currentFrame >= this.frames.length) {return null}\r\n        return this.frames[this.currentFrame]\r\n    }\r\n\r\n    getProgress() {\r\n        if (this.frames.length <= 1) {return 0}\r\n        return this.currentFrame / (this.frames.length - 1)\r\n    }\r\n\r\n    // Utility: get frame by index with bounds checking\r\n    getFrameAt(index) {\r\n        if (index < 0 || index >= this.frames.length) {return null}\r\n        return this.frames[index]\r\n    }\r\n}\r\n\r\nexport class AnimationController {\r\n    constructor() {\r\n        this.animations = new Map()\r\n        this.currentAnimation = null\r\n        this.transitions = new Map()\r\n        this.blendTime = 0\r\n        this.blendFrom = null\r\n        this.blendProgress = 0\r\n    }\r\n\r\n    addAnimation(nameOrAnimation, maybeAnimation) {\r\n        if (typeof nameOrAnimation === 'string' && maybeAnimation) {\r\n            this.animations.set(nameOrAnimation, maybeAnimation)\r\n            return\r\n        }\r\n        const animation = nameOrAnimation\r\n        this.animations.set(animation.name, animation)\r\n    }\r\n\r\n    play(animationName, options = {}) {\r\n        const animation = this.animations.get(animationName)\r\n        if (!animation) {\r\n            // Animation not found: ${animationName}\r\n            return\r\n        }\r\n\r\n        const transition = options.transition || 0\r\n        \r\n        if (transition > 0 && this.currentAnimation) {\r\n            this.blendFrom = this.currentAnimation\r\n            this.blendTime = transition\r\n            this.blendProgress = 0\r\n        }\r\n\r\n        this.currentAnimation = animation\r\n        animation.play()\r\n    }\r\n\r\n    stop() {\r\n        if (this.currentAnimation) {\r\n            this.currentAnimation.stop()\r\n        }\r\n    }\r\n\r\n    update(deltaTime) {\r\n        if (this.blendTime > 0) {\r\n            this.blendProgress += deltaTime\r\n            if (this.blendProgress >= this.blendTime) {\r\n                this.blendTime = 0\r\n                this.blendFrom = null\r\n                this.blendProgress = 0\r\n            }\r\n        }\r\n\r\n        if (this.currentAnimation) {\r\n            this.currentAnimation.update(deltaTime)\r\n        }\r\n    }\r\n\r\n    getCurrentFrame() {\r\n        if (!this.currentAnimation) {return null}\r\n        return this.currentAnimation.getCurrentFrame()\r\n    }\r\n\r\n    getBlendFrames() {\r\n        if (this.blendTime === 0 || !this.blendFrom) {\r\n            return { current: this.getCurrentFrame(), blend: null, blendFactor: 0 }\r\n        }\r\n\r\n        const blendFactor = this.blendProgress / this.blendTime\r\n        return {\r\n            current: this.currentAnimation.getCurrentFrame(),\r\n            blend: this.blendFrom.getCurrentFrame(),\r\n            blendFactor: blendFactor\r\n        }\r\n    }\r\n\r\n    isPlaying(animationName) {\r\n        return this.currentAnimation && \r\n               this.currentAnimation.name === animationName && \r\n               this.currentAnimation.isPlaying\r\n    }\r\n\r\n    setSpeed(speed) {\r\n        if (this.currentAnimation) {\r\n            this.currentAnimation.speed = speed\r\n        }\r\n    }\r\n}\r\n\r\nexport class ProceduralAnimator {\r\n    constructor() {\r\n        this.animations = new Map()\r\n    }\r\n\r\n    // Enhanced breathing animation with state-based modulation\r\n    createBreathingAnimation(options = {}) {\r\n        const {\r\n            baseScale = 1.0,\r\n            intensity = 0.015,\r\n            speed = 2.0,\r\n            asymmetry = 0.2\r\n        } = options\r\n\r\n        return {\r\n            time: 0,\r\n            phase: 0,\r\n            breathRate: speed,\r\n            currentIntensity: intensity,\r\n            depthMod: 1.0,\r\n            asymmetryOffset: 0,\r\n            _buf: {\r\n                scaleX: baseScale,\r\n                scaleY: baseScale,\r\n                offsetY: 0,\r\n                chestExpansion: 0,\r\n                phase: 0,\r\n                intensity: 0\r\n            },\r\n\r\n            // State-based modulation\r\n            modulateForState(state) {\r\n                switch(state) {\r\n                    case 'running':\r\n                        this.depthMod = 0.3\r\n                        this.breathRate = speed * 3.0\r\n                        break\r\n                    case 'attacking':\r\n                        this.depthMod = 0.5\r\n                        this.breathRate = speed * 1.8\r\n                        break\r\n                    case 'blocking':\r\n                        this.depthMod = 0.2\r\n                        this.breathRate = speed * 1.3\r\n                        break\r\n                    case 'hurt':\r\n                        this.depthMod = 0.1\r\n                        this.breathRate = speed * 0.5\r\n                        break\r\n                    case 'dead':\r\n                        this.depthMod = 0.0\r\n                        this.breathRate = 0.0\r\n                        break\r\n                    default: // idle, rolling\r\n                        this.depthMod = 1.0\r\n                        this.breathRate = speed\r\n                }\r\n            },\r\n\r\n            update(deltaTime) {\r\n                const res = this._buf\r\n\r\n                if (this.breathRate <= 0) {\r\n                    res.scaleX = baseScale\r\n                    res.scaleY = baseScale\r\n                    res.offsetY = 0\r\n                    res.chestExpansion = 0\r\n                    res.phase = 0\r\n                    res.intensity = 0\r\n                    return res\r\n                }\r\n\r\n                this.time += deltaTime * this.breathRate\r\n                this.phase = Math.sin(this.time)\r\n\r\n                // Calculate breathing with realistic parameters\r\n                const currentIntensity = this.currentIntensity * this.depthMod\r\n                const breathScaleX = baseScale + this.phase * currentIntensity\r\n                const breathScaleY = baseScale + this.phase * currentIntensity * 0.7\r\n\r\n                // Add slight asymmetry for more natural feel\r\n                const asymmetryFactor = Math.sin(this.time * 0.7) * asymmetry\r\n                const finalScaleX = breathScaleX + asymmetryFactor * currentIntensity * 0.3\r\n\r\n                // Chest expansion effect (subtle upward movement)\r\n                const chestExpansion = this.phase * currentIntensity * 2\r\n\r\n                // Smooth transitions\r\n                const smoothFactor = 1 - Math.exp(-deltaTime * 5)\r\n                this.currentIntensity = this.currentIntensity + (currentIntensity - this.currentIntensity) * smoothFactor\r\n\r\n                res.scaleX = finalScaleX\r\n                res.scaleY = breathScaleY\r\n                res.offsetY = -chestExpansion * 0.5\r\n                res.chestExpansion = chestExpansion\r\n                res.phase = this.phase\r\n                res.intensity = currentIntensity\r\n                return res\r\n            }\r\n        }\r\n    }\r\n\r\n    // Bobbing animation for floating objects\r\n    createBobbingAnimation(amplitude = 5, speed = 2) {\r\n        return {\r\n            time: 0,\r\n            _buf: { offsetY: 0, rotation: 0 },\r\n            update(deltaTime) {\r\n                this.time += deltaTime * speed\r\n                const res = this._buf\r\n                res.offsetY = Math.sin(this.time) * amplitude\r\n                res.rotation = Math.sin(this.time * 0.5) * 0.05\r\n                return res\r\n            }\r\n        }\r\n    }\r\n\r\n    // Squash and stretch for impacts and jumps\r\n    createSquashStretch(intensity = 0.3, duration = 0.2) {\r\n        return {\r\n            time: 0,\r\n            active: false,\r\n            _buf: { scaleX: 1, scaleY: 1 },\r\n            trigger() {\r\n                this.time = 0\r\n                this.active = true\r\n            },\r\n            update(deltaTime) {\r\n                const res = this._buf\r\n\r\n                if (!this.active) {\r\n                    res.scaleX = 1\r\n                    res.scaleY = 1\r\n                    return res\r\n                }\r\n\r\n                this.time += deltaTime\r\n                const progress = Math.min(this.time / duration, 1)\r\n\r\n                if (progress >= 1) {\r\n                    this.active = false\r\n                    res.scaleX = 1\r\n                    res.scaleY = 1\r\n                    return res\r\n                }\r\n\r\n                // Elastic easing\r\n                const t = progress\r\n                const p = 0.3\r\n                const s = p / 4\r\n                const postFix = 2**(-10 * t) * Math.sin((t - s) * (2 * Math.PI) / p) + 1\r\n\r\n                const squash = 1 - postFix * intensity\r\n                const stretch = 1 + postFix * intensity * 0.5\r\n\r\n                res.scaleX = progress < 0.5 ? stretch : squash\r\n                res.scaleY = progress < 0.5 ? squash : stretch\r\n                return res\r\n            }\r\n        }\r\n    }\r\n\r\n    // Wobble effect for jelly-like movement\r\n    createWobble(frequency = 10, damping = 0.8, intensity = 0.1) {\r\n        return {\r\n            velocity: 0,\r\n            displacement: 0,\r\n            _buf: { scaleX: 1, scaleY: 1, rotation: 0 },\r\n            update(deltaTime, force = 0) {\r\n                // Spring physics\r\n                const springForce = -frequency * this.displacement\r\n                const dampingForce = -damping * this.velocity\r\n\r\n                this.velocity += (springForce + dampingForce + force) * deltaTime\r\n                this.displacement += this.velocity * deltaTime\r\n\r\n                const res = this._buf\r\n                res.scaleX = 1 + this.displacement * intensity\r\n                res.scaleY = 1 - this.displacement * intensity * 0.5\r\n                res.rotation = this.displacement * 0.1\r\n                return res\r\n            },\r\n            impulse(force) {\r\n                this.velocity += force\r\n            }\r\n        }\r\n    }\r\n\r\n    // Anticipation animation for attacks\r\n    createAnticipation(duration = 0.3, intensity = 0.15) {\r\n        return {\r\n            time: 0,\r\n            active: false,\r\n            phase: 'idle', // idle, anticipation, action, recovery\r\n            _buf: { scaleX: 1, scaleY: 1, offsetX: 0 },\r\n            trigger() {\r\n                this.time = 0\r\n                this.active = true\r\n                this.phase = 'anticipation'\r\n            },\r\n            update(deltaTime) {\r\n                const res = this._buf\r\n                if (!this.active) {\r\n                    res.scaleX = 1\r\n                    res.scaleY = 1\r\n                    res.offsetX = 0\r\n                    return res\r\n                }\r\n\r\n                this.time += deltaTime\r\n\r\n                if (this.phase === 'anticipation') {\r\n                    const progress = Math.min(this.time / (duration * 0.4), 1)\r\n                    const eased = 1 - Math.cos(progress * Math.PI * 0.5)\r\n\r\n                    if (progress >= 1) {\r\n                        this.phase = 'action'\r\n                        this.time = 0\r\n                    }\r\n\r\n                    res.scaleX = 1 - eased * intensity\r\n                    res.scaleY = 1 + eased * intensity * 0.5\r\n                    res.offsetX = -eased * 10\r\n                    return res\r\n                } else if (this.phase === 'action') {\r\n                    const progress = Math.min(this.time / (duration * 0.2), 1)\r\n                    const eased = Math.sin(progress * Math.PI * 0.5)\r\n\r\n                    if (progress >= 1) {\r\n                        this.phase = 'recovery'\r\n                        this.time = 0\r\n                    }\r\n\r\n                    res.scaleX = 1 + eased * intensity * 2\r\n                    res.scaleY = 1 - eased * intensity\r\n                    res.offsetX = eased * 20\r\n                    return res\r\n                } else if (this.phase === 'recovery') {\r\n                    const progress = Math.min(this.time / (duration * 0.4), 1)\r\n                    const eased = 1 - (1 - progress)**3\r\n\r\n                    if (progress >= 1) {\r\n                        this.active = false\r\n                        this.phase = 'idle'\r\n                    }\r\n\r\n                    res.scaleX = 1 + (1 - eased) * intensity * 0.5\r\n                    res.scaleY = 1 - (1 - eased) * intensity * 0.25\r\n                    res.offsetX = (1 - eased) * 10\r\n                    return res\r\n                }\r\n\r\n                res.scaleX = 1\r\n                res.scaleY = 1\r\n                res.offsetX = 0\r\n                return res\r\n            }\r\n        }\r\n    }\r\n\r\n    // Advanced Inverse Kinematics for limbs and weapon positioning\r\n    createAdvancedIK(options = {}) {\r\n        const {\r\n            armLength = 25,\r\n            forearmLength = 20,\r\n            damping = 0.8,\r\n            stiffness = 0.5,\r\n            maxReach = 40\r\n        } = options\r\n\r\n        return {\r\n            shoulder: { x: 0, y: 0 },\r\n            elbow: { x: 0, y: 0 },\r\n            hand: { x: 0, y: 0 },\r\n            target: { x: 0, y: 0 },\r\n            targetVelocity: { x: 0, y: 0 },\r\n            _buf: {\r\n                shoulder: { x: 0, y: 0 },\r\n                elbow: { x: 0, y: 0 },\r\n                hand: { x: 0, y: 0 },\r\n                target: { x: 0, y: 0 },\r\n                reach: 0,\r\n                stiffness: 0\r\n            },\r\n\r\n            // Two-bone IK solver (CCD - Cyclic Coordinate Descent)\r\n            solveIK(targetX, targetY, shoulderX, shoulderY) {\r\n                this.target.x = targetX\r\n                this.target.y = targetY\r\n                this.shoulder.x = shoulderX\r\n                this.shoulder.y = shoulderY\r\n\r\n                // Calculate distance to target\r\n                const dx = targetX - shoulderX\r\n                const dy = targetY - shoulderY\r\n                const distance = Math.sqrt(dx * dx + dy * dy)\r\n\r\n                // Clamp to maximum reach\r\n                const clampedDistance = Math.min(distance, maxReach)\r\n                const scale = clampedDistance / distance\r\n                const clampedTargetX = shoulderX + dx * scale\r\n                const clampedTargetY = shoulderY + dy * scale\r\n\r\n                // Solve for elbow and hand positions\r\n                const totalLength = armLength + forearmLength\r\n                const cosAngle = Math.max(-1, Math.min(1, clampedDistance / totalLength))\r\n\r\n                // Law of cosines for elbow angle\r\n                const elbowAngle = Math.acos(cosAngle)\r\n                const shoulderAngle = Math.atan2(clampedTargetY - shoulderY, clampedTargetX - shoulderX)\r\n\r\n                // Position elbow\r\n                this.elbow.x = shoulderX + Math.cos(shoulderAngle - elbowAngle * 0.5) * armLength\r\n                this.elbow.y = shoulderY + Math.sin(shoulderAngle - elbowAngle * 0.5) * armLength\r\n\r\n                // Position hand\r\n                this.hand.x = this.elbow.x + Math.cos(shoulderAngle + elbowAngle * 0.5) * forearmLength\r\n                this.hand.y = this.elbow.y + Math.sin(shoulderAngle + elbowAngle * 0.5) * forearmLength\r\n\r\n                const res = this._buf\r\n                res.shoulder.x = this.shoulder.x\r\n                res.shoulder.y = this.shoulder.y\r\n                res.elbow.x = this.elbow.x\r\n                res.elbow.y = this.elbow.y\r\n                res.hand.x = this.hand.x\r\n                res.hand.y = this.hand.y\r\n                res.target.x = clampedTargetX\r\n                res.target.y = clampedTargetY\r\n                res.reach = clampedDistance / totalLength\r\n                return res\r\n            },\r\n\r\n            // Smooth IK with velocity prediction\r\n            update(deltaTime, targetX, targetY, shoulderX, shoulderY) {\r\n                // Predict target position based on velocity\r\n                const predictedTargetX = targetX + this.targetVelocity.x * deltaTime * 0.1\r\n                const predictedTargetY = targetY + this.targetVelocity.y * deltaTime * 0.1\r\n\r\n                // Update target velocity for smoothing\r\n                this.targetVelocity.x = (predictedTargetX - this.target.x) / deltaTime * damping\r\n                this.targetVelocity.y = (predictedTargetY - this.target.y) / deltaTime * damping\r\n\r\n                // Solve IK with damping\r\n                const solution = this.solveIK(predictedTargetX, predictedTargetY, shoulderX, shoulderY)\r\n\r\n                // Apply stiffness damping to joints\r\n                const stiffnessFactor = 1 - Math.exp(-stiffness * deltaTime)\r\n\r\n                const res = this._buf\r\n                res.shoulder.x = solution.shoulder.x\r\n                res.shoulder.y = solution.shoulder.y\r\n                res.elbow.x = solution.elbow.x\r\n                res.elbow.y = solution.elbow.y\r\n                res.hand.x = solution.hand.x\r\n                res.hand.y = solution.hand.y\r\n                res.target.x = solution.target.x\r\n                res.target.y = solution.target.y\r\n                res.reach = solution.reach\r\n                res.stiffness = stiffnessFactor\r\n                return res\r\n            }\r\n        }\r\n    }\r\n\r\n    // Secondary motion system for cloth, hair, and equipment\r\n    createSecondaryMotion(options = {}) {\r\n        const {\r\n            segments = 5,\r\n            length = 15,\r\n            damping = 0.85,\r\n            gravity = 0.5,\r\n            windStrength = 0.1\r\n        } = options\r\n\r\n        return {\r\n            segments: [],\r\n            anchorPoint: { x: 0, y: 0 },\r\n            windTime: 0,\r\n            _segBuf: [],\r\n\r\n            initialize(anchorX, anchorY) {\r\n                this.anchorPoint = { x: anchorX, y: anchorY }\r\n                this.segments = []\r\n\r\n                // Create chain segments\r\n                for (let i = 0; i < segments; i++) {\r\n                    this.segments.push({\r\n                        x: anchorX,\r\n                        y: anchorY + i * (length / segments),\r\n                        vx: 0,\r\n                        vy: 0,\r\n                        prevX: anchorX,\r\n                        prevY: anchorY + i * (length / segments)\r\n                    })\r\n                }\r\n            },\r\n\r\n            update(deltaTime, anchorX, anchorY, windDirection = 0) {\r\n                this.anchorPoint.x = anchorX\r\n                this.anchorPoint.y = anchorY\r\n                this.windTime += deltaTime\r\n\r\n                // Update anchor point\r\n                this.segments[0].x = anchorX\r\n                this.segments[0].y = anchorY\r\n\r\n                // Simulate chain physics\r\n                for (let i = 1; i < this.segments.length; i++) {\r\n                    const segment = this.segments[i]\r\n                    const prevSegment = this.segments[i - 1]\r\n\r\n                    // Calculate desired position (maintain distance from previous segment)\r\n                    const dx = segment.x - prevSegment.x\r\n                    const dy = segment.y - prevSegment.y\r\n                    const distance = Math.sqrt(dx * dx + dy * dy)\r\n                    const targetDistance = length / segments\r\n\r\n                    if (distance > 0) {\r\n                        const ratio = targetDistance / distance\r\n                        segment.x = prevSegment.x + dx * ratio\r\n                        segment.y = prevSegment.y + dy * ratio\r\n                    }\r\n\r\n                    // Apply gravity\r\n                    segment.vy += gravity * deltaTime\r\n\r\n                    // Apply wind\r\n                    const windX = Math.sin(this.windTime * 2 + windDirection) * windStrength\r\n                    const windY = Math.cos(this.windTime * 1.5 + windDirection) * windStrength * 0.5\r\n                    segment.vx += windX * deltaTime\r\n                    segment.vy += windY * deltaTime\r\n\r\n                    // Verlet integration for smooth movement\r\n                    const tempX = segment.x\r\n                    const tempY = segment.y\r\n                    segment.x += (segment.x - segment.prevX) * damping + segment.vx * deltaTime\r\n                    segment.y += (segment.y - segment.prevY) * damping + segment.vy * deltaTime\r\n                    segment.prevX = tempX\r\n                    segment.prevY = tempY\r\n\r\n                    // Dampen velocity\r\n                    segment.vx *= damping\r\n                    segment.vy *= damping\r\n                }\r\n\r\n                if (!this._segBuf || this._segBuf.length !== this.segments.length) {\r\n                    this._segBuf = new Array(this.segments.length)\r\n                }\r\n                for (let i = 0; i < this.segments.length; i++) {\r\n                    this._segBuf[i] = this.segments[i]\r\n                }\r\n                return this._segBuf\r\n            },\r\n\r\n            applyForce(forceX, forceY, segmentIndex = -1) {\r\n                if (segmentIndex === -1) {\r\n                    // Apply to all segments\r\n                    this.segments.forEach(segment => {\r\n                        segment.vx += forceX\r\n                        segment.vy += forceY\r\n                    })\r\n                } else if (segmentIndex < this.segments.length) {\r\n                    this.segments[segmentIndex].vx += forceX\r\n                    this.segments[segmentIndex].vy += forceY\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    // Momentum-based animation adjustments\r\n    createMomentumSystem(options = {}) {\r\n        const {\r\n            maxMomentum = 10,\r\n            momentumDecay = 0.9,\r\n            momentumInfluence = 0.3,\r\n            directionSmoothing = 0.8\r\n        } = options\r\n\r\n        return {\r\n            momentum: { x: 0, y: 0 },\r\n            smoothedDirection: { x: 0, y: 0 },\r\n            lastVelocity: { x: 0, y: 0 },\r\n            _buf: {\r\n                momentum: { x: 0, y: 0 },\r\n                smoothedDirection: { x: 0, y: 0 },\r\n                leanAngle: 0,\r\n                bounceFactor: 0,\r\n                stretchFactor: 0\r\n            },\r\n\r\n            update(deltaTime, velocityX, velocityY, isGrounded = true) {\r\n                // Calculate velocity change\r\n                const deltaVx = velocityX - this.lastVelocity.x\r\n                const deltaVy = velocityY - this.lastVelocity.y\r\n                this.lastVelocity = { x: velocityX, y: velocityY }\r\n\r\n                // Build momentum from acceleration\r\n                const acceleration = Math.sqrt(deltaVx * deltaVx + deltaVy * deltaVy)\r\n                if (acceleration > 0.1) {\r\n                    const momentumStrength = Math.min(acceleration * momentumInfluence, maxMomentum)\r\n                    const momentumDirX = deltaVx / acceleration\r\n                    const momentumDirY = deltaVy / acceleration\r\n\r\n                    this.momentum.x += momentumDirX * momentumStrength\r\n                    this.momentum.y += momentumDirY * momentumStrength\r\n                }\r\n\r\n                // Apply momentum decay\r\n                this.momentum.x *= momentumDecay\r\n                this.momentum.y *= momentumDecay\r\n\r\n                // Clamp momentum\r\n                const momentumMagnitude = Math.sqrt(this.momentum.x * this.momentum.x + this.momentum.y * this.momentum.y)\r\n                if (momentumMagnitude > maxMomentum) {\r\n                    this.momentum.x = (this.momentum.x / momentumMagnitude) * maxMomentum\r\n                    this.momentum.y = (this.momentum.y / momentumMagnitude) * maxMomentum\r\n                }\r\n\r\n                // Smooth direction changes\r\n                const currentDirection = { x: velocityX, y: velocityY }\r\n                const directionMagnitude = Math.sqrt(currentDirection.x * currentDirection.x + currentDirection.y * currentDirection.y)\r\n\r\n                if (directionMagnitude > 0.1) {\r\n                    const normalizedDir = {\r\n                        x: currentDirection.x / directionMagnitude,\r\n                        y: currentDirection.y / directionMagnitude\r\n                    }\r\n\r\n                    this.smoothedDirection.x = this.smoothedDirection.x * (1 - directionSmoothing) + normalizedDir.x * directionSmoothing\r\n                    this.smoothedDirection.y = this.smoothedDirection.y * (1 - directionSmoothing) + normalizedDir.y * directionSmoothing\r\n                }\r\n\r\n                const res = this._buf\r\n                res.momentum.x = this.momentum.x\r\n                res.momentum.y = this.momentum.y\r\n                res.smoothedDirection.x = this.smoothedDirection.x\r\n                res.smoothedDirection.y = this.smoothedDirection.y\r\n                res.leanAngle = isGrounded ? Math.atan2(this.momentum.x, Math.abs(this.momentum.y) + 1) * 0.3 : 0\r\n                res.bounceFactor = momentumMagnitude * 0.1\r\n                res.stretchFactor = Math.max(0, momentumMagnitude * 0.05)\r\n                return res\r\n            },\r\n\r\n            addImpulse(impulseX, impulseY) {\r\n                this.momentum.x += impulseX\r\n                this.momentum.y += impulseY\r\n            }\r\n        }\r\n    }\r\n\r\n    // Trail effect for fast movement\r\n    createTrailEffect(maxTrails = 5, fadeSpeed = 0.3) {\r\n        return {\r\n            trails: [],\r\n            lastPosition: null,\r\n            update(deltaTime, currentPosition) {\r\n                // Fade existing trails\r\n                this.trails = this.trails.filter(trail => {\r\n                    trail.alpha -= fadeSpeed * deltaTime\r\n                    return trail.alpha > 0\r\n                })\r\n\r\n                // Add new trail if moved enough\r\n                if (this.lastPosition) {\r\n                    const dx = currentPosition.x - this.lastPosition.x\r\n                    const dy = currentPosition.y - this.lastPosition.y\r\n                    const distance = Math.sqrt(dx * dx + dy * dy)\r\n\r\n                    if (distance > 10) {\r\n                        this.trails.push({\r\n                            x: this.lastPosition.x,\r\n                            y: this.lastPosition.y,\r\n                            alpha: 0.5,\r\n                            scale: 0.8\r\n                        })\r\n\r\n                        if (this.trails.length > maxTrails) {\r\n                            this.trails.shift()\r\n                        }\r\n\r\n                        this.lastPosition = { ...currentPosition }\r\n                    }\r\n                } else {\r\n                    this.lastPosition = { ...currentPosition }\r\n                }\r\n\r\n                return this.trails\r\n            },\r\n            clear() {\r\n                this.trails = []\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nexport class CharacterAnimator {\r\n    constructor() {\r\n        this.controller = new AnimationController()\r\n        this.procedural = new ProceduralAnimator()\r\n        \r\n        // Event system integration\r\n        this.eventSystem = null\r\n        this.eventListeners = new Map()\r\n\r\n        // Enhanced procedural animation instances\r\n        this.breathing = this.procedural.createBreathingAnimation({\r\n            intensity: 0.012,\r\n            speed: 1.8,\r\n            asymmetry: 0.15\r\n        })\r\n        this.squashStretch = this.procedural.createSquashStretch()\r\n        this.wobble = this.procedural.createWobble()\r\n        this.anticipation = this.procedural.createAnticipation()\r\n        this.trail = this.procedural.createTrailEffect()\r\n\r\n        // New advanced systems\r\n        this.advancedIK = this.procedural.createAdvancedIK({\r\n            armLength: 22,\r\n            forearmLength: 18,\r\n            damping: 0.75,\r\n            stiffness: 0.4\r\n        })\r\n        this.secondaryMotion = this.procedural.createSecondaryMotion({\r\n            segments: 4,\r\n            length: 12,\r\n            damping: 0.82,\r\n            stiffness: 0.25,\r\n            gravity: 0.3,\r\n            windStrength: 0.08\r\n        })\r\n        this.momentumSystem = this.procedural.createMomentumSystem({\r\n            maxMomentum: 8,\r\n            momentumDecay: 0.88,\r\n            momentumInfluence: 0.25,\r\n            directionSmoothing: 0.75\r\n        })\r\n        \r\n        // State\r\n        this.state = 0 // numeric state code; default to idle\r\n        this.stateName = 'idle'\r\n        this.facing = 'right'\r\n        this.moving = false\r\n        this.attacking = false\r\n        this.blocking = false\r\n        this.rolling = false\r\n        this.hurt = false\r\n        this.jumping = false\r\n        this.doubleJumping = false\r\n        this.wallSliding = false\r\n        this.dashing = false\r\n        this.charging = false\r\n        this.dead = false\r\n        this.landing = false\r\n        \r\n        // Animation blending\r\n        this.blendFactors = {\r\n            idle: 1,\r\n            running: 0,\r\n            attacking: 0,\r\n            blocking: 0,\r\n            rolling: 0,\r\n            hurt: 0,\r\n            jumping: 0,\r\n            doubleJumping: 0,\r\n            landing: 0,\r\n            wallSliding: 0,\r\n            dashing: 0,\r\n            chargingAttack: 0,\r\n            dead: 0\r\n        }\r\n        \r\n        this.targetBlendFactors = { ...this.blendFactors }\r\n        this.blendSpeed = 0.2\r\n\r\n        // Internal timers for temporary states\r\n        this.hurtTimer = 0\r\n        this.attackTimer = 0\r\n        this.rollTimer = 0\r\n    }\r\n\r\n    resetActionTimers() {\r\n        this.hurtTimer = 0\r\n        this.attackTimer = 0\r\n        this.rollTimer = 0\r\n    }\r\n\r\n    // Helper function to convert numeric WASM state to string for internal use\r\n    getAnimStateName(state) {\r\n        switch(state) {\r\n            case 0: return 'idle'\r\n            case 1: return 'running'\r\n            case 2: return 'attacking'\r\n            case 3: return 'blocking'\r\n            case 4: return 'rolling'\r\n            case 5: return 'hurt'\r\n            case 6: return 'dead'\r\n            case 7: return 'jumping'\r\n            case 8: return 'doubleJumping'\r\n            case 9: return 'landing'\r\n            case 10: return 'wallSliding'\r\n            case 11: return 'dashing'\r\n            case 12: return 'chargingAttack'\r\n            default: return 'idle'\r\n        }\r\n    }\r\n\r\n    setAnimState(newState) {\r\n        if (this.state === newState) {return}\r\n        this.resetActionTimers()\r\n\r\n        const previousState = this.state\r\n        const previousStateName = this.stateName\r\n        \r\n        this.state = newState\r\n        this.stateName = this.getAnimStateName(newState)\r\n        \r\n        // Emit state change event\r\n        this.emit('stateChange', {\r\n            fromState: previousState,\r\n            toState: newState,\r\n            fromStateName: previousStateName,\r\n            toStateName: this.stateName\r\n        })\r\n        \r\n        // Update target blend factors\r\n        Object.keys(this.targetBlendFactors).forEach(key => {\r\n            this.targetBlendFactors[key] = 0\r\n        })\r\n        this.targetBlendFactors[this.stateName] = 1\r\n        \r\n        // Play animation based on state\r\n        this.controller.play(this.stateName, { transition: 0.1 })\r\n        \r\n        // Trigger procedural animations\r\n        switch(newState) {\r\n            case 2: // Attacking\r\n                this.anticipation.trigger()\r\n                break\r\n            case 5: // Hurt\r\n                this.squashStretch.trigger()\r\n                this.wobble.impulse(10)\r\n                break\r\n            case 4: // Rolling\r\n                this.trail.clear()\r\n                break\r\n            case 7: // Jumping\r\n                this.squashStretch.trigger()\r\n                break\r\n            case 8: // DoubleJumping\r\n                this.wobble.impulse(5)\r\n                this.trail.clear()\r\n                break\r\n            case 9: // Landing\r\n                this.squashStretch.trigger()\r\n                this.wobble.impulse(15)\r\n                break\r\n            case 11: // Dashing\r\n                this.trail.clear()\r\n                break\r\n            case 12: // ChargingAttack\r\n                this.anticipation.trigger()\r\n                this.wobble.impulse(3)\r\n                break\r\n            case 6: // Death\r\n                this.squashStretch.trigger()\r\n                this.wobble.impulse(20)\r\n                break\r\n        }\r\n    }\r\n\r\n    update(deltaTime, position, velocity = { x: 0, y: 0 }, isGrounded = true) {\r\n        // Update state timers\r\n        if (this.hurtTimer > 0) {\r\n            this.hurtTimer -= deltaTime\r\n            if (this.hurtTimer <= 0 && this.state === 5) {\r\n                this.setAnimState(0) // Idle\r\n            }\r\n        }\r\n        if (this.attackTimer > 0) {\r\n            this.attackTimer -= deltaTime\r\n            if (this.attackTimer <= 0 && this.state === 2) {\r\n                this.setAnimState(0) // Idle\r\n            }\r\n        }\r\n        if (this.rollTimer > 0) {\r\n            this.rollTimer -= deltaTime\r\n            if (this.rollTimer <= 0 && this.state === 4) {\r\n                this.setAnimState(0) // Idle\r\n            }\r\n        }\r\n\r\n        // Update animation controller\r\n        this.controller.update(deltaTime)\r\n\r\n        // Update blend factors\r\n        Object.keys(this.blendFactors).forEach(key => {\r\n            const diff = this.targetBlendFactors[key] - this.blendFactors[key]\r\n            this.blendFactors[key] += diff * this.blendSpeed\r\n        })\r\n\r\n        // Update enhanced breathing with state modulation\r\n        this.breathing.modulateForState(this.stateName)\r\n        const breathing = this.breathing.update(deltaTime)\r\n\r\n        // Update momentum system\r\n        const momentumData = this.momentumSystem.update(deltaTime, velocity.x, velocity.y, isGrounded)\r\n\r\n        // Update secondary motion (initialize if needed)\r\n        if (this.secondaryMotion.segments.length === 0) {\r\n            this.secondaryMotion.initialize(position.x, position.y - 8)\r\n        }\r\n        const secondaryMotion = this.secondaryMotion.update(deltaTime, position.x, position.y - 8)\r\n\r\n        // Update other procedural animations\r\n        const squashStretch = this.squashStretch.update(deltaTime)\r\n        const wobble = this.wobble.update(deltaTime)\r\n        const anticipation = this.anticipation.update(deltaTime)\r\n        const trails = this.trail.update(deltaTime, position)\r\n\r\n        // Combine all transformations\r\n        const transform = {\r\n            scaleX: 1,\r\n            scaleY: 1,\r\n            rotation: 0,\r\n            offsetX: 0,\r\n            offsetY: 0,\r\n            trails: trails,\r\n            secondaryMotion: secondaryMotion,\r\n            momentum: momentumData,\r\n            ik: null // Will be set if weapon/arms are used\r\n        }\r\n\r\n        // Apply enhanced breathing\r\n        if (this.blendFactors.idle > 0 || this.blendFactors.running > 0) {\r\n            transform.scaleX *= breathing.scaleX\r\n            transform.scaleY *= breathing.scaleY\r\n            transform.offsetY += breathing.offsetY\r\n        }\r\n\r\n        // Apply momentum-based adjustments\r\n        transform.rotation += momentumData.leanAngle\r\n        transform.scaleY *= (1 + momentumData.stretchFactor)\r\n        transform.offsetY += momentumData.bounceFactor * Math.sin(Date.now() * 0.01)\r\n\r\n        // Apply squash/stretch\r\n        transform.scaleX *= squashStretch.scaleX\r\n        transform.scaleY *= squashStretch.scaleY\r\n\r\n        // Apply wobble\r\n        transform.scaleX *= wobble.scaleX\r\n        transform.scaleY *= wobble.scaleY\r\n        transform.rotation += wobble.rotation\r\n\r\n        // Apply anticipation\r\n        if (this.stateName === 'attacking' || this.stateName === 'chargingAttack') {\r\n            transform.scaleX *= anticipation.scaleX\r\n            transform.scaleY *= anticipation.scaleY\r\n            transform.offsetX += anticipation.offsetX\r\n        }\r\n\r\n        // Apply facing direction\r\n        if (this.facing === 'left') {\r\n            transform.scaleX *= -1\r\n        }\r\n\r\n        return transform\r\n    }\r\n\r\n    setFacing(direction) {\r\n        this.facing = direction\r\n    }\r\n    \r\n    // Event system integration\r\n    setEventSystem(eventSystem) {\r\n        this.eventSystem = eventSystem\r\n    }\r\n    \r\n    // Subscribe to animation events\r\n    on(eventName, callback, context = null) {\r\n        if (!this.eventListeners.has(eventName)) {\r\n            this.eventListeners.set(eventName, new Set())\r\n        }\r\n        \r\n        const listener = { callback, context, once: false }\r\n        this.eventListeners.get(eventName).add(listener)\r\n        \r\n        // Also subscribe to global event system if available\r\n        if (this.eventSystem) {\r\n            return this.eventSystem.on(eventName, callback, context)\r\n        }\r\n        \r\n        return () => this.off(eventName, callback)\r\n    }\r\n    \r\n    // Subscribe to one-time animation events\r\n    once(eventName, callback, context = null) {\r\n        if (!this.eventListeners.has(eventName)) {\r\n            this.eventListeners.set(eventName, new Set())\r\n        }\r\n        \r\n        const listener = { callback, context, once: true }\r\n        this.eventListeners.get(eventName).add(listener)\r\n        \r\n        // Also subscribe to global event system if available\r\n        if (this.eventSystem) {\r\n            return this.eventSystem.once(eventName, callback, context)\r\n        }\r\n        \r\n        return () => this.off(eventName, callback)\r\n    }\r\n    \r\n    // Unsubscribe from animation events\r\n    off(eventName, callback) {\r\n        if (!this.eventListeners.has(eventName)) {\r\n            return false\r\n        }\r\n        \r\n        const listeners = this.eventListeners.get(eventName)\r\n        for (const listener of listeners) {\r\n            if (listener.callback === callback) {\r\n                listeners.delete(listener)\r\n                break\r\n            }\r\n        }\r\n        \r\n        if (listeners.size === 0) {\r\n            this.eventListeners.delete(eventName)\r\n        }\r\n        \r\n        // Also unsubscribe from global event system if available\r\n        if (this.eventSystem) {\r\n            this.eventSystem.off(eventName, callback)\r\n        }\r\n        \r\n        return true\r\n    }\r\n    \r\n    // Emit animation events\r\n    emit(eventName, data = {}) {\r\n        // Emit to local listeners\r\n        if (this.eventListeners.has(eventName)) {\r\n            const listeners = Array.from(this.eventListeners.get(eventName))\r\n            \r\n            for (const listener of listeners) {\r\n                try {\r\n                    if (listener.context) {\r\n                        listener.callback.call(listener.context, data)\r\n                    } else {\r\n                        listener.callback(data)\r\n                    }\r\n                    \r\n                    if (listener.once) {\r\n                        this.eventListeners.get(eventName).delete(listener)\r\n                    }\r\n                } catch (error) {\r\n                    console.error(`Error in animation event listener for ${eventName}:`, error)\r\n                }\r\n            }\r\n        }\r\n        \r\n        // Emit to global event system if available\r\n        if (this.eventSystem) {\r\n            this.eventSystem.emit(eventName, data)\r\n        }\r\n    }\r\n\r\n    triggerHurt() {\r\n        this.setAnimState(5) // Hurt\r\n        this.hurtTimer = 300\r\n        this.emit('hurt', { timer: this.hurtTimer })\r\n    }\r\n\r\n    triggerAttack() {\r\n        this.setAnimState(2) // Attack\r\n        this.attackTimer = 400\r\n        this.emit('attack', { timer: this.attackTimer })\r\n    }\r\n\r\n    triggerRoll() {\r\n        this.setAnimState(4) // Roll\r\n        this.rollTimer = 400\r\n        this.emit('roll', { timer: this.rollTimer })\r\n    }\r\n\r\n    triggerBlock() {\r\n        this.setAnimState(3) // Block\r\n        this.emit('block')\r\n    }\r\n\r\n    releaseBlock() {\r\n        if (this.state === 3) { // Block\r\n            this.setAnimState(0) // Idle\r\n            this.emit('blockRelease')\r\n        }\r\n    }\r\n\r\n    setMoving(isMoving) {\r\n        this.moving = isMoving\r\n        if (isMoving && this.state === 0) { // Idle\r\n            this.setAnimState(1) // Run\r\n        } else if (!isMoving && this.state === 1) { // Run\r\n            this.setAnimState(0) // Idle\r\n        }\r\n    }\r\n}\r\n\r\n// Animation presets for common game objects\r\nexport const AnimationPresets = {\r\n    // Character animations\r\n    createPlayerAnimations() {\r\n        return {\r\n            idle: new Animation('idle', [\r\n                new AnimationFrame(0, 0, 32, 32, 200),\r\n                new AnimationFrame(32, 0, 32, 32, 200),\r\n                new AnimationFrame(64, 0, 32, 32, 200),\r\n                new AnimationFrame(96, 0, 32, 32, 200)\r\n            ]),\r\n            running: new Animation('running', [\r\n                new AnimationFrame(0, 32, 32, 32, 100),\r\n                new AnimationFrame(32, 32, 32, 32, 100),\r\n                new AnimationFrame(64, 32, 32, 32, 100),\r\n                new AnimationFrame(96, 32, 32, 32, 100),\r\n                new AnimationFrame(128, 32, 32, 32, 100),\r\n                new AnimationFrame(160, 32, 32, 32, 100)\r\n            ]),\r\n            attacking: new Animation('attacking', [\r\n                new AnimationFrame(0, 64, 32, 32, 50),\r\n                new AnimationFrame(32, 64, 32, 32, 50),\r\n                new AnimationFrame(64, 64, 32, 32, 100),\r\n                new AnimationFrame(96, 64, 32, 32, 50)\r\n            ], { loop: false }),\r\n            blocking: new Animation('blocking', [\r\n                new AnimationFrame(0, 96, 32, 32, 100)\r\n            ], { loop: false }),\r\n            rolling: new Animation('rolling', [\r\n                new AnimationFrame(0, 128, 32, 32, 50),\r\n                new AnimationFrame(32, 128, 32, 32, 50),\r\n                new AnimationFrame(64, 128, 32, 32, 50),\r\n                new AnimationFrame(96, 128, 32, 32, 50)\r\n            ], { loop: false }),\r\n            hurt: new Animation('hurt', [\r\n                new AnimationFrame(0, 160, 32, 32, 100),\r\n                new AnimationFrame(32, 160, 32, 32, 100)\r\n            ], { loop: false }),\r\n            dead: new Animation('dead', [\r\n                new AnimationFrame(0, 192, 32, 32, 100),\r\n                new AnimationFrame(32, 192, 32, 32, 100),\r\n                new AnimationFrame(64, 192, 32, 32, 100),\r\n                new AnimationFrame(96, 192, 32, 32, 200),\r\n                new AnimationFrame(128, 192, 32, 32, -1) // Final frame, holds indefinitely\r\n            ], { loop: false }),\r\n            jumping: new Animation('jumping', [\r\n                new AnimationFrame(0, 224, 32, 32, 100),\r\n                new AnimationFrame(32, 224, 32, 32, 100),\r\n                new AnimationFrame(64, 224, 32, 32, -1) // Hold in air\r\n            ], { loop: false }),\r\n            doubleJumping: new Animation('doubleJumping', [\r\n                new AnimationFrame(0, 256, 32, 32, 50),\r\n                new AnimationFrame(32, 256, 32, 32, 50),\r\n                new AnimationFrame(64, 256, 32, 32, 50),\r\n                new AnimationFrame(96, 256, 32, 32, 50),\r\n                new AnimationFrame(128, 256, 32, 32, 50),\r\n                new AnimationFrame(160, 256, 32, 32, 50),\r\n                new AnimationFrame(192, 256, 32, 32, 50),\r\n                new AnimationFrame(224, 256, 32, 32, -1) // Complete flip\r\n            ], { loop: false }),\r\n            landing: new Animation('landing', [\r\n                new AnimationFrame(0, 288, 32, 32, 50),\r\n                new AnimationFrame(32, 288, 32, 32, 50),\r\n                new AnimationFrame(64, 288, 32, 32, 100)\r\n            ], { loop: false }),\r\n            wallSliding: new Animation('wallSliding', [\r\n                new AnimationFrame(0, 320, 32, 32, 100),\r\n                new AnimationFrame(32, 320, 32, 32, 100)\r\n            ], { loop: true }),\r\n            dashing: new Animation('dashing', [\r\n                new AnimationFrame(0, 352, 32, 32, 50),\r\n                new AnimationFrame(32, 352, 32, 32, 50),\r\n                new AnimationFrame(64, 352, 32, 32, 100),\r\n                new AnimationFrame(96, 352, 32, 32, 50)\r\n            ], { loop: false }),\r\n            chargingAttack: new Animation('chargingAttack', [\r\n                new AnimationFrame(0, 384, 32, 32, 100),\r\n                new AnimationFrame(32, 384, 32, 32, 100),\r\n                new AnimationFrame(64, 384, 32, 32, 100),\r\n                new AnimationFrame(96, 384, 32, 32, 50),\r\n                new AnimationFrame(128, 384, 32, 32, 50),\r\n                new AnimationFrame(160, 384, 32, 32, 100)\r\n            ], { loop: false })\r\n        }\r\n    },\r\n\r\n    // Enemy animations\r\n    createWolfAnimations() {\r\n        return {\r\n            idle: new Animation('idle', [\r\n                new AnimationFrame(0, 0, 48, 32, 300),\r\n                new AnimationFrame(48, 0, 48, 32, 300)\r\n            ]),\r\n            prowl: new Animation('prowl', [\r\n                new AnimationFrame(0, 32, 48, 32, 150),\r\n                new AnimationFrame(48, 32, 48, 32, 150),\r\n                new AnimationFrame(96, 32, 48, 32, 150),\r\n                new AnimationFrame(144, 32, 48, 32, 150)\r\n            ]),\r\n            lunge: new Animation('lunge', [\r\n                new AnimationFrame(0, 64, 48, 32, 50),\r\n                new AnimationFrame(48, 64, 48, 32, 100),\r\n                new AnimationFrame(96, 64, 48, 32, 50)\r\n            ], { loop: false }),\r\n            hurt: new Animation('hurt', [\r\n                new AnimationFrame(0, 96, 48, 32, 100)\r\n            ], { loop: false }),\r\n            howl: new Animation('howl', [\r\n                new AnimationFrame(0, 128, 48, 32, 200),\r\n                new AnimationFrame(48, 128, 48, 32, 300),\r\n                new AnimationFrame(96, 128, 48, 32, 400),\r\n                new AnimationFrame(144, 128, 48, 32, 300),\r\n                new AnimationFrame(192, 128, 48, 32, 200)\r\n            ], { loop: false }),\r\n            death: new Animation('death', [\r\n                new AnimationFrame(0, 160, 48, 32, 100),\r\n                new AnimationFrame(48, 160, 48, 32, 100),\r\n                new AnimationFrame(96, 160, 48, 32, 100),\r\n                new AnimationFrame(144, 160, 48, 32, 200),\r\n                new AnimationFrame(192, 160, 48, 32, -1) // Final frame\r\n            ], { loop: false }),\r\n            packRun: new Animation('packRun', [\r\n                new AnimationFrame(0, 192, 48, 32, 80),\r\n                new AnimationFrame(48, 192, 48, 32, 80),\r\n                new AnimationFrame(96, 192, 48, 32, 80),\r\n                new AnimationFrame(144, 192, 48, 32, 80),\r\n                new AnimationFrame(192, 192, 48, 32, 80),\r\n                new AnimationFrame(240, 192, 48, 32, 80)\r\n            ], { loop: true })\r\n        }\r\n    },\r\n\r\n    // Effect animations\r\n    createEffectAnimations() {\r\n        return {\r\n            explosion: new Animation('explosion', [\r\n                new AnimationFrame(0, 0, 64, 64, 50),\r\n                new AnimationFrame(64, 0, 64, 64, 50),\r\n                new AnimationFrame(128, 0, 64, 64, 50),\r\n                new AnimationFrame(192, 0, 64, 64, 50),\r\n                new AnimationFrame(256, 0, 64, 64, 50)\r\n            ], { loop: false }),\r\n            spark: new Animation('spark', [\r\n                new AnimationFrame(0, 64, 32, 32, 30),\r\n                new AnimationFrame(32, 64, 32, 32, 30),\r\n                new AnimationFrame(64, 64, 32, 32, 30)\r\n            ], { loop: false }),\r\n            projectileSpawn: new Animation('projectileSpawn', [\r\n                new AnimationFrame(0, 128, 16, 16, 30),\r\n                new AnimationFrame(16, 128, 16, 16, 30),\r\n                new AnimationFrame(32, 128, 16, 16, 30)\r\n            ], { loop: false }),\r\n            projectileImpact: new Animation('projectileImpact', [\r\n                new AnimationFrame(0, 144, 32, 32, 40),\r\n                new AnimationFrame(32, 144, 32, 32, 40),\r\n                new AnimationFrame(64, 144, 32, 32, 40),\r\n                new AnimationFrame(96, 144, 32, 32, 40)\r\n            ], { loop: false }),\r\n            itemPickup: new Animation('itemPickup', [\r\n                new AnimationFrame(0, 176, 32, 32, 50),\r\n                new AnimationFrame(32, 176, 32, 32, 50),\r\n                new AnimationFrame(64, 176, 32, 32, 50),\r\n                new AnimationFrame(96, 176, 32, 32, 50),\r\n                new AnimationFrame(128, 176, 32, 32, 50)\r\n            ], { loop: false }),\r\n            powerUp: new Animation('powerUp', [\r\n                new AnimationFrame(0, 208, 64, 64, 60),\r\n                new AnimationFrame(64, 208, 64, 64, 60),\r\n                new AnimationFrame(128, 208, 64, 64, 60),\r\n                new AnimationFrame(192, 208, 64, 64, 60),\r\n                new AnimationFrame(256, 208, 64, 64, 60),\r\n                new AnimationFrame(320, 208, 64, 64, 60)\r\n            ], { loop: false })\r\n        }\r\n    }\r\n}\r\n\r\nexport class WolfAnimator {\r\n    constructor() {\r\n        this.controller = new AnimationController()\r\n        this.procedural = new ProceduralAnimator()\r\n        // ... other procedural animations for wolf\r\n        this.sniffing = this.procedural.createBreathingAnimation({intensity: 0.008, speed: 0.5});\r\n        this.howling = this.procedural.createAnticipation({duration: 0.5, intensity: 0.2});\r\n\r\n        this.state = 'idle';\r\n        this.facing = 'right';\r\n    }\r\n\r\n    setWolfState(newState) {\r\n        if (this.state === newState) {\r\n            return;\r\n        }\r\n        this.state = newState;\r\n        this.controller.play(newState);\r\n        // Trigger procedural effects specific to wolf\r\n        switch(newState) {\r\n            case 'lunge':\r\n                this.sniffing.modulateForState('attacking');\r\n                break;\r\n            case 'howl':\r\n                this.howling.trigger();\r\n                this.sniffing.modulateForState('idle'); // Breathing for howl anticipation\r\n                break;\r\n            case 'prowl':\r\n                this.sniffing.modulateForState('running');\r\n                break;\r\n            case 'hurt':\r\n                this.sniffing.modulateForState('hurt');\r\n                break;\r\n            case 'death':\r\n                this.sniffing.modulateForState('dead');\r\n                break;\r\n            default:\r\n                this.sniffing.modulateForState('idle');\r\n        }\r\n    }\r\n\r\n    update(deltaTime) {\r\n        this.controller.update(deltaTime);\r\n        \r\n        const breathing = this.sniffing.update(deltaTime);\r\n        const howling = this.howling.update(deltaTime);\r\n\r\n        const transform = {\r\n            scaleX: 1,\r\n            scaleY: 1,\r\n            rotation: 0,\r\n            offsetX: 0,\r\n            offsetY: 0\r\n        };\r\n\r\n        // Apply breathing\r\n        transform.scaleX *= breathing.scaleX;\r\n        transform.scaleY *= breathing.scaleY;\r\n        transform.offsetY += breathing.offsetY;\r\n\r\n        // Apply howling anticipation\r\n        transform.scaleX *= howling.scaleX;\r\n        transform.scaleY *= howling.scaleY;\r\n        transform.offsetX += howling.offsetX;\r\n\r\n        // Facing direction\r\n        if (this.facing === 'left') {\r\n            transform.scaleX *= -1;\r\n        }\r\n\r\n        return transform;\r\n    }\r\n\r\n    setFacing(direction) {\r\n        this.facing = direction;\r\n    }\r\n}\r\n\r\nexport default {\r\n    Animation,\r\n    AnimationController,\r\n    AnimationFrame,\r\n    ProceduralAnimator,\r\n    CharacterAnimator,\r\n    AnimationPresets,\r\n    WolfAnimator\r\n}","/**\r\n * Realistic Procedural Animation System\r\n * Advanced physics-based animation that integrates with WASM for realistic character movement\r\n * Features: IK, secondary motion, environmental responses, and anatomically correct movement\r\n */\r\n\r\nexport class RealisticProceduralAnimator {\r\n    constructor(options = {}) {\r\n        // Configuration\r\n        this.config = {\r\n            // IK System\r\n            ikEnabled: options.ikEnabled !== false,\r\n            armLength: options.armLength || 20,\r\n            forearmLength: options.forearmLength || 16,\r\n            thighLength: options.thighLength || 18,\r\n            shinLength: options.shinLength || 16,\r\n            \r\n            // Physics\r\n            gravity: options.gravity || 0.3,\r\n            damping: options.damping || 0.85,\r\n            stiffness: options.stiffness || 0.4,\r\n            \r\n            // Visual\r\n            renderSkeleton: options.renderSkeleton || false,\r\n            renderIKTargets: options.renderIKTargets || false,\r\n            renderSecondaryMotion: options.renderSecondaryMotion || false,\r\n            \r\n            // Performance\r\n            updateRate: options.updateRate || 60,\r\n            enableOptimizations: options.enableOptimizations !== false\r\n        };\r\n        \r\n        // Animation state\r\n        this.state = {\r\n            position: { x: 0, y: 0 },\r\n            velocity: { x: 0, y: 0 },\r\n            facing: 1,\r\n            isGrounded: true,\r\n            \r\n            // Body segments\r\n            head: { x: 0, y: -25, rotation: 0 },\r\n            torso: { x: 0, y: -15, rotation: 0 },\r\n            pelvis: { x: 0, y: 0, rotation: 0 },\r\n            \r\n            // Arms\r\n            leftShoulder: { x: -8, y: -20 },\r\n            leftElbow: { x: -12, y: -10 },\r\n            leftHand: { x: -15, y: 0 },\r\n            rightShoulder: { x: 8, y: -20 },\r\n            rightElbow: { x: 12, y: -10 },\r\n            rightHand: { x: 15, y: 0 },\r\n            \r\n            // Legs\r\n            leftHip: { x: -4, y: 0 },\r\n            leftKnee: { x: -6, y: 10 },\r\n            leftFoot: { x: -8, y: 20 },\r\n            rightHip: { x: 4, y: 0 },\r\n            rightKnee: { x: 6, y: 10 },\r\n            rightFoot: { x: 8, y: 20 }\r\n        };\r\n        \r\n        // IK Solver\r\n        this.ikSolver = new AdvancedIKSolver({\r\n            armLength: this.config.armLength,\r\n            forearmLength: this.config.forearmLength,\r\n            thighLength: this.config.thighLength,\r\n            shinLength: this.config.shinLength\r\n        });\r\n        \r\n        // Secondary motion systems\r\n        this.secondaryMotion = new SecondaryMotionSystem();\r\n        this.clothPhysics = new ClothPhysicsSystem();\r\n        this.facialAnimator = new FacialAnimationSystem();\r\n        \r\n        // Performance optimization\r\n        this.frameCount = 0;\r\n        this.lastUpdate = 0;\r\n        this.cachedTransforms = new Map();\r\n        \r\n        // Environmental response\r\n        this.environmentalResponses = new EnvironmentalResponseSystem();\r\n    }\r\n    \r\n    update(deltaTime, wasmData = {}) {\r\n        this.frameCount++;\r\n        const now = performance.now();\r\n        \r\n        // Performance throttling\r\n        if (this.config.enableOptimizations && (now - this.lastUpdate) < (1000 / this.config.updateRate)) {\r\n            return this.getCachedTransform();\r\n        }\r\n        this.lastUpdate = now;\r\n        \r\n        // Get enhanced animation data from WASM\r\n        const wasmAnimData = this.getWasmAnimationData(wasmData);\r\n        \r\n        // Update base position and orientation\r\n        this.updateBaseTransform(wasmAnimData, deltaTime);\r\n        \r\n        // Update skeletal system with IK\r\n        this.updateSkeletalSystem(wasmAnimData, deltaTime);\r\n        \r\n        // Apply secondary motion\r\n        this.updateSecondaryMotion(wasmAnimData, deltaTime);\r\n        \r\n        // Apply environmental responses\r\n        this.updateEnvironmentalResponses(wasmAnimData, deltaTime);\r\n        \r\n        // Generate final transform\r\n        const transform = this.generateTransform(wasmAnimData);\r\n        \r\n        // Cache for performance\r\n        this.cacheTransform(transform);\r\n        \r\n        return transform;\r\n    }\r\n    \r\n    getWasmAnimationData(_wasmData) {\r\n        // Extract enhanced animation data from WASM exports\r\n        const exports = globalThis.wasmExports || {};\r\n        \r\n        return {\r\n            // Base transform (existing)\r\n            scaleX: exports.get_anim_scale_x?.() || 1.0,\r\n            scaleY: exports.get_anim_scale_y?.() || 1.0,\r\n            rotation: exports.get_anim_rotation?.() || 0.0,\r\n            offsetX: exports.get_anim_offset_x?.() || 0.0,\r\n            offsetY: exports.get_anim_offset_y?.() || 0.0,\r\n            pelvisY: exports.get_anim_pelvis_y?.() || 0.0,\r\n            \r\n            // Enhanced animation data (new)\r\n            spineCurve: exports.get_anim_spine_curve?.() || 0.0,\r\n            shoulderRotation: exports.get_anim_shoulder_rotation?.() || 0.0,\r\n            headBobX: exports.get_anim_head_bob_x?.() || 0.0,\r\n            headBobY: exports.get_anim_head_bob_y?.() || 0.0,\r\n            armSwingLeft: exports.get_anim_arm_swing_left?.() || 0.0,\r\n            armSwingRight: exports.get_anim_arm_swing_right?.() || 0.0,\r\n            legLiftLeft: exports.get_anim_leg_lift_left?.() || 0.0,\r\n            legLiftRight: exports.get_anim_leg_lift_right?.() || 0.0,\r\n            torsoTwist: exports.get_anim_torso_twist?.() || 0.0,\r\n            breathingIntensity: exports.get_anim_breathing_intensity?.() || 1.0,\r\n            fatigueFactor: exports.get_anim_fatigue_factor?.() || 0.0,\r\n            momentumX: exports.get_anim_momentum_x?.() || 0.0,\r\n            momentumY: exports.get_anim_momentum_y?.() || 0.0,\r\n            \r\n            // Secondary motion\r\n            clothSway: exports.get_anim_cloth_sway?.() || 0.0,\r\n            hairBounce: exports.get_anim_hair_bounce?.() || 0.0,\r\n            equipmentJiggle: exports.get_anim_equipment_jiggle?.() || 0.0,\r\n            \r\n            // Environmental\r\n            windResponse: exports.get_anim_wind_response?.() || 0.0,\r\n            groundAdapt: exports.get_anim_ground_adapt?.() || 0.0,\r\n            temperatureShiver: exports.get_anim_temperature_shiver?.() || 0.0,\r\n            \r\n            // Game state\r\n            position: {\r\n                x: exports.get_x?.() || 0.5,\r\n                y: exports.get_y?.() || 0.5\r\n            },\r\n            velocity: {\r\n                x: exports.get_vel_x?.() || 0.0,\r\n                y: exports.get_vel_y?.() || 0.0\r\n            },\r\n            isGrounded: exports.get_is_grounded?.() === 1,\r\n            stamina: exports.get_stamina?.() || 1.0,\r\n            health: exports.get_hp?.() || 1.0,\r\n            animState: exports.get_player_anim_state?.() || 0\r\n        };\r\n    }\r\n    \r\n    updateBaseTransform(wasmData, _deltaTime) {\r\n        // Update base position and facing\r\n        this.state.position.x = wasmData.position.x;\r\n        this.state.position.y = wasmData.position.y;\r\n        this.state.velocity.x = wasmData.velocity.x;\r\n        this.state.velocity.y = wasmData.velocity.y;\r\n        this.state.isGrounded = wasmData.isGrounded;\r\n        \r\n        // Determine facing direction\r\n        if (Math.abs(wasmData.velocity.x) > 0.01) {\r\n            this.state.facing = wasmData.velocity.x > 0 ? 1 : -1;\r\n        }\r\n        \r\n        // Update core body segments with WASM data\r\n        this.state.torso.rotation = wasmData.torsoTwist;\r\n        this.state.pelvis.y = wasmData.pelvisY;\r\n        \r\n        // Head positioning with realistic constraints\r\n        this.state.head.x = wasmData.headBobX;\r\n        this.state.head.y = -25 + wasmData.headBobY;\r\n        this.state.head.rotation = wasmData.spineCurve * 0.3; // Head follows spine curve\r\n    }\r\n    \r\n    updateSkeletalSystem(wasmData, _deltaTime) {\r\n        if (!this.config.ikEnabled) {return;}\r\n        \r\n        // Calculate IK targets for arms based on WASM animation data\r\n        const leftArmTarget = this.calculateArmTarget('left', wasmData);\r\n        const rightArmTarget = this.calculateArmTarget('right', wasmData);\r\n        \r\n        // Solve IK for arms\r\n        const leftArmSolution = this.ikSolver.solveArm(\r\n            this.state.leftShoulder,\r\n            leftArmTarget,\r\n            this.config.armLength,\r\n            this.config.forearmLength\r\n        );\r\n        \r\n        const rightArmSolution = this.ikSolver.solveArm(\r\n            this.state.rightShoulder,\r\n            rightArmTarget,\r\n            this.config.armLength,\r\n            this.config.forearmLength\r\n        );\r\n        \r\n        // Apply arm solutions\r\n        if (leftArmSolution) {\r\n            this.state.leftElbow = leftArmSolution.elbow;\r\n            this.state.leftHand = leftArmSolution.hand;\r\n        }\r\n        \r\n        if (rightArmSolution) {\r\n            this.state.rightElbow = rightArmSolution.elbow;\r\n            this.state.rightHand = rightArmSolution.hand;\r\n        }\r\n        \r\n        // Calculate IK targets for legs\r\n        const leftLegTarget = this.calculateLegTarget('left', wasmData);\r\n        const rightLegTarget = this.calculateLegTarget('right', wasmData);\r\n        \r\n        // Solve IK for legs\r\n        const leftLegSolution = this.ikSolver.solveLeg(\r\n            this.state.leftHip,\r\n            leftLegTarget,\r\n            this.config.thighLength,\r\n            this.config.shinLength\r\n        );\r\n        \r\n        const rightLegSolution = this.ikSolver.solveLeg(\r\n            this.state.rightHip,\r\n            rightLegTarget,\r\n            this.config.thighLength,\r\n            this.config.shinLength\r\n        );\r\n        \r\n        // Apply leg solutions\r\n        if (leftLegSolution) {\r\n            this.state.leftKnee = leftLegSolution.knee;\r\n            this.state.leftFoot = leftLegSolution.foot;\r\n        }\r\n        \r\n        if (rightLegSolution) {\r\n            this.state.rightKnee = rightLegSolution.knee;\r\n            this.state.rightFoot = rightLegSolution.foot;\r\n        }\r\n    }\r\n    \r\n    calculateArmTarget(side, wasmData) {\r\n        const isLeft = side === 'left';\r\n        const sideMultiplier = isLeft ? -1 : 1;\r\n        const armSwing = isLeft ? wasmData.armSwingLeft : wasmData.armSwingRight;\r\n        \r\n        // Base arm position\r\n        let targetX = sideMultiplier * 12;\r\n        let targetY = 5;\r\n        \r\n        // Apply natural arm swing\r\n        targetX += Math.sin(armSwing) * 8;\r\n        targetY += Math.cos(armSwing) * 4 - 2; // Arms swing forward/back and up/down\r\n        \r\n        // Adjust for shoulder rotation\r\n        const shoulderOffset = wasmData.shoulderRotation * sideMultiplier;\r\n        targetX += shoulderOffset * 3;\r\n        \r\n        // Adjust for momentum\r\n        targetX += wasmData.momentumX * 0.3;\r\n        targetY += wasmData.momentumY * 0.2;\r\n        \r\n        // Add some natural variation based on breathing\r\n        targetY += Math.sin(Date.now() * 0.001 * wasmData.breathingIntensity) * 0.5;\r\n        \r\n        return { x: targetX, y: targetY };\r\n    }\r\n    \r\n    calculateLegTarget(side, wasmData) {\r\n        const isLeft = side === 'left';\r\n        const sideMultiplier = isLeft ? -1 : 1;\r\n        const legLift = isLeft ? wasmData.legLiftLeft : wasmData.legLiftRight;\r\n        \r\n        // Base leg position (foot placement)\r\n        let targetX = sideMultiplier * 6;\r\n        let targetY = 20; // Ground level\r\n        \r\n        // Apply leg lift for walking animation\r\n        targetY -= legLift * 8; // Lift foot during walk cycle\r\n        targetX += legLift * 2 * sideMultiplier; // Slight forward movement when lifted\r\n        \r\n        // Ground adaptation\r\n        targetY += wasmData.groundAdapt;\r\n        \r\n        // Momentum-based foot placement\r\n        targetX += wasmData.momentumX * 0.2;\r\n        \r\n        // Fatigue effect - less precise foot placement\r\n        // Apply a deterministic offset based on fatigue level\r\n        const fatigueOffset = wasmData.fatigueFactor * sideMultiplier * 0.5;\r\n        targetX += fatigueOffset;\r\n        \r\n        return { x: targetX, y: targetY };\r\n    }\r\n    \r\n    updateSecondaryMotion(wasmData, deltaTime) {\r\n        // Update cloth physics\r\n        this.clothPhysics.update(deltaTime, {\r\n            sway: wasmData.clothSway,\r\n            windResponse: wasmData.windResponse,\r\n            momentum: { x: wasmData.momentumX, y: wasmData.momentumY }\r\n        });\r\n        \r\n        // Update hair physics\r\n        this.secondaryMotion.updateHair(deltaTime, {\r\n            bounce: wasmData.hairBounce,\r\n            windResponse: wasmData.windResponse,\r\n            headMovement: { x: wasmData.headBobX, y: wasmData.headBobY }\r\n        });\r\n        \r\n        // Update equipment physics\r\n        this.secondaryMotion.updateEquipment(deltaTime, {\r\n            jiggle: wasmData.equipmentJiggle,\r\n            momentum: { x: wasmData.momentumX, y: wasmData.momentumY }\r\n        });\r\n    }\r\n    \r\n    updateEnvironmentalResponses(wasmData, _deltaTime) {\r\n        // Temperature response\r\n        if (wasmData.temperatureShiver > 0) {\r\n            this.environmentalResponses.applyShivering(this.state, wasmData.temperatureShiver);\r\n        }\r\n        \r\n        // Wind response\r\n        if (wasmData.windResponse !== 0) {\r\n            this.environmentalResponses.applyWindEffects(this.state, wasmData.windResponse);\r\n        }\r\n    }\r\n    \r\n    generateTransform(wasmData) {\r\n        return {\r\n            // Base transform from WASM\r\n            scaleX: wasmData.scaleX,\r\n            scaleY: wasmData.scaleY,\r\n            rotation: wasmData.rotation,\r\n            offsetX: wasmData.offsetX,\r\n            offsetY: wasmData.offsetY,\r\n            \r\n            // Enhanced skeletal data\r\n            skeleton: {\r\n                head: this.state.head,\r\n                torso: this.state.torso,\r\n                pelvis: this.state.pelvis,\r\n                leftArm: {\r\n                    shoulder: this.state.leftShoulder,\r\n                    elbow: this.state.leftElbow,\r\n                    hand: this.state.leftHand\r\n                },\r\n                rightArm: {\r\n                    shoulder: this.state.rightShoulder,\r\n                    elbow: this.state.rightElbow,\r\n                    hand: this.state.rightHand\r\n                },\r\n                leftLeg: {\r\n                    hip: this.state.leftHip,\r\n                    knee: this.state.leftKnee,\r\n                    foot: this.state.leftFoot\r\n                },\r\n                rightLeg: {\r\n                    hip: this.state.rightHip,\r\n                    knee: this.state.rightKnee,\r\n                    foot: this.state.rightFoot\r\n                }\r\n            },\r\n            \r\n            // Secondary motion data\r\n            secondaryMotion: {\r\n                cloth: this.clothPhysics.getState(),\r\n                hair: this.secondaryMotion.getHairState(),\r\n                equipment: this.secondaryMotion.getEquipmentState()\r\n            },\r\n            \r\n            // Environmental effects\r\n            environmental: {\r\n                windResponse: wasmData.windResponse,\r\n                temperatureShiver: wasmData.temperatureShiver,\r\n                groundAdapt: wasmData.groundAdapt\r\n            },\r\n            \r\n            // Debug information\r\n            debug: {\r\n                frameCount: this.frameCount,\r\n                animState: wasmData.animState,\r\n                fatigue: wasmData.fatigueFactor,\r\n                breathing: wasmData.breathingIntensity\r\n            }\r\n        };\r\n    }\r\n    \r\n    cacheTransform(transform) {\r\n        const cacheKey = `${this.frameCount}_${this.lastUpdate}`;\r\n        this.cachedTransforms.set(cacheKey, transform);\r\n        \r\n        // Limit cache size\r\n        if (this.cachedTransforms.size > 10) {\r\n            const firstKey = this.cachedTransforms.keys().next().value;\r\n            this.cachedTransforms.delete(firstKey);\r\n        }\r\n    }\r\n    \r\n    getCachedTransform() {\r\n        const keys = Array.from(this.cachedTransforms.keys());\r\n        const latestKey = keys[keys.length - 1];\r\n        return this.cachedTransforms.get(latestKey) || this.generateDefaultTransform();\r\n    }\r\n    \r\n    generateDefaultTransform() {\r\n        return {\r\n            scaleX: 1, scaleY: 1, rotation: 0, offsetX: 0, offsetY: 0,\r\n            skeleton: null, secondaryMotion: null, environmental: null, debug: null\r\n        };\r\n    }\r\n    \r\n    // Rendering method for debug visualization\r\n    renderDebug(ctx, x, y, scale = 1) {\r\n        if (!this.config.renderSkeleton) {return;}\r\n        \r\n        ctx.save();\r\n        ctx.translate(x, y);\r\n        ctx.scale(scale, scale);\r\n        \r\n        // Render skeleton\r\n        this.renderSkeleton(ctx);\r\n        \r\n        // Render IK targets\r\n        if (this.config.renderIKTargets) {\r\n            this.renderIKTargets(ctx);\r\n        }\r\n        \r\n        // Render secondary motion\r\n        if (this.config.renderSecondaryMotion) {\r\n            this.renderSecondaryMotion(ctx);\r\n        }\r\n        \r\n        ctx.restore();\r\n    }\r\n    \r\n    renderSkeleton(ctx) {\r\n        ctx.strokeStyle = '#00ff88';\r\n        ctx.lineWidth = 2;\r\n        \r\n        // Draw bones\r\n        this.drawBone(ctx, this.state.torso, this.state.head);\r\n        this.drawBone(ctx, this.state.torso, this.state.pelvis);\r\n        \r\n        // Arms\r\n        this.drawBone(ctx, this.state.leftShoulder, this.state.leftElbow);\r\n        this.drawBone(ctx, this.state.leftElbow, this.state.leftHand);\r\n        this.drawBone(ctx, this.state.rightShoulder, this.state.rightElbow);\r\n        this.drawBone(ctx, this.state.rightElbow, this.state.rightHand);\r\n        \r\n        // Legs\r\n        this.drawBone(ctx, this.state.leftHip, this.state.leftKnee);\r\n        this.drawBone(ctx, this.state.leftKnee, this.state.leftFoot);\r\n        this.drawBone(ctx, this.state.rightHip, this.state.rightKnee);\r\n        this.drawBone(ctx, this.state.rightKnee, this.state.rightFoot);\r\n        \r\n        // Draw joints\r\n        ctx.fillStyle = '#ffff44';\r\n        Object.values(this.state).forEach(joint => {\r\n            if (typeof joint.x !== \"undefined\" && typeof joint.y !== \"undefined\") {\r\n                ctx.beginPath();\r\n                ctx.arc(joint.x, joint.y, 2, 0, Math.PI * 2);\r\n                ctx.fill();\r\n            }\r\n        });\r\n    }\r\n    \r\n    drawBone(ctx, start, end) {\r\n        ctx.beginPath();\r\n        ctx.moveTo(start.x, start.y);\r\n        ctx.lineTo(end.x, end.y);\r\n        ctx.stroke();\r\n    }\r\n    \r\n    renderIKTargets(ctx) {\r\n        // Render IK target positions for debugging\r\n        ctx.fillStyle = '#ff4444';\r\n        // Implementation would show where IK is trying to reach\r\n    }\r\n    \r\n    renderSecondaryMotion(ctx) {\r\n        // Render cloth, hair, and equipment physics\r\n        this.clothPhysics.render(ctx);\r\n        this.secondaryMotion.renderHair(ctx);\r\n        this.secondaryMotion.renderEquipment(ctx);\r\n    }\r\n}\r\n\r\n// Advanced IK Solver for realistic limb movement\r\nclass AdvancedIKSolver {\r\n    constructor(options = {}) {\r\n        this.armLength = options.armLength || 20;\r\n        this.forearmLength = options.forearmLength || 16;\r\n        this.thighLength = options.thighLength || 18;\r\n        this.shinLength = options.shinLength || 16;\r\n        \r\n        // IK solving parameters\r\n        this.maxIterations = options.maxIterations || 10;\r\n        this.tolerance = options.tolerance || 0.1;\r\n        this.damping = options.damping || 0.8;\r\n    }\r\n    \r\n    solveArm(shoulder, target, upperLength, lowerLength) {\r\n        const distance = Math.sqrt(\r\n            (target.x - shoulder.x)**2 + \r\n            (target.y - shoulder.y)**2\r\n        );\r\n        \r\n        const maxReach = upperLength + lowerLength;\r\n        \r\n        // Check if target is reachable\r\n        if (distance > maxReach) {\r\n            // Stretch towards target at maximum reach\r\n            const angle = Math.atan2(target.y - shoulder.y, target.x - shoulder.x);\r\n            return {\r\n                elbow: {\r\n                    x: shoulder.x + Math.cos(angle) * upperLength,\r\n                    y: shoulder.y + Math.sin(angle) * upperLength\r\n                },\r\n                hand: {\r\n                    x: shoulder.x + Math.cos(angle) * maxReach,\r\n                    y: shoulder.y + Math.sin(angle) * maxReach\r\n                }\r\n            };\r\n        }\r\n        \r\n        // Two-bone IK solution using law of cosines\r\n        const a = upperLength;\r\n        const b = lowerLength;\r\n        const c = distance;\r\n        \r\n        // Calculate angles\r\n        const angleA = Math.acos((b * b + c * c - a * a) / (2 * b * c));\r\n        const angleB = Math.acos((a * a + c * c - b * b) / (2 * a * c));\r\n        \r\n        const targetAngle = Math.atan2(target.y - shoulder.y, target.x - shoulder.x);\r\n        \r\n        // Calculate elbow position\r\n        const elbowAngle = targetAngle + angleB;\r\n        const elbow = {\r\n            x: shoulder.x + Math.cos(elbowAngle) * upperLength,\r\n            y: shoulder.y + Math.sin(elbowAngle) * upperLength\r\n        };\r\n        \r\n        return {\r\n            elbow: elbow,\r\n            hand: target\r\n        };\r\n    }\r\n    \r\n    solveLeg(hip, target, upperLength, lowerLength) {\r\n        // Similar to arm IK but with different constraints for legs\r\n        return this.solveArm(hip, target, upperLength, lowerLength);\r\n    }\r\n}\r\n\r\n// Secondary motion system for cloth, hair, and equipment\r\nclass SecondaryMotionSystem {\r\n    constructor() {\r\n        this.hairSegments = [];\r\n        this.equipmentItems = [];\r\n        this.initializeHair();\r\n        this.initializeEquipment();\r\n    }\r\n    \r\n    initializeHair() {\r\n        // Create hair segments for physics simulation\r\n        for (let i = 0; i < 5; i++) {\r\n            this.hairSegments.push({\r\n                position: { x: 0, y: -25 - i * 3 },\r\n                velocity: { x: 0, y: 0 },\r\n                restLength: 3\r\n            });\r\n        }\r\n    }\r\n    \r\n    initializeEquipment() {\r\n        // Initialize equipment items (sword, pouch, etc.)\r\n        this.equipmentItems = [\r\n            { type: 'sword', position: { x: 8, y: 5 }, velocity: { x: 0, y: 0 } },\r\n            { type: 'pouch', position: { x: -6, y: 8 }, velocity: { x: 0, y: 0 } }\r\n        ];\r\n    }\r\n    \r\n    updateHair(deltaTime, forces) {\r\n        // Simple verlet integration for hair physics\r\n        this.hairSegments.forEach((segment, index) => {\r\n            if (index === 0) {return;} // Root segment is fixed to head\r\n            \r\n            // Apply forces\r\n            segment.velocity.x += forces.windResponse * 0.1;\r\n            segment.velocity.y += 0.1; // Gravity\r\n            \r\n            // Apply bounce from head movement\r\n            if (index === 1) {\r\n                segment.velocity.x += forces.headMovement.x * 0.05;\r\n                segment.velocity.y += forces.headMovement.y * 0.05;\r\n            }\r\n            \r\n            // Update position\r\n            segment.position.x += segment.velocity.x * deltaTime;\r\n            segment.position.y += segment.velocity.y * deltaTime;\r\n            \r\n            // Apply damping\r\n            segment.velocity.x *= 0.95;\r\n            segment.velocity.y *= 0.95;\r\n            \r\n            // Constraint to previous segment\r\n            if (index > 0) {\r\n                const prev = this.hairSegments[index - 1];\r\n                const dx = segment.position.x - prev.position.x;\r\n                const dy = segment.position.y - prev.position.y;\r\n                const distance = Math.sqrt(dx * dx + dy * dy);\r\n                \r\n                if (distance > segment.restLength) {\r\n                    const correction = (distance - segment.restLength) / distance * 0.5;\r\n                    segment.position.x -= dx * correction;\r\n                    segment.position.y -= dy * correction;\r\n                }\r\n            }\r\n        });\r\n    }\r\n    \r\n    updateEquipment(deltaTime, forces) {\r\n        this.equipmentItems.forEach(item => {\r\n            // ARCHITECTURAL VIOLATION FIXED: Jiggle forces should be deterministic from WASM\r\n            // Apply jiggle forces\r\n            // item.velocity.x += (Math.random() - 0.5) * forces.jiggle * 0.1;\r\n            // item.velocity.y += (Math.random() - 0.5) * forces.jiggle * 0.1;\r\n            \r\n            // Apply momentum\r\n            item.velocity.x += forces.momentum.x * 0.02;\r\n            item.velocity.y += forces.momentum.y * 0.02;\r\n            \r\n            // Update position\r\n            item.position.x += item.velocity.x * deltaTime;\r\n            item.position.y += item.velocity.y * deltaTime;\r\n            \r\n            // Apply damping\r\n            item.velocity.x *= 0.9;\r\n            item.velocity.y *= 0.9;\r\n        });\r\n    }\r\n    \r\n    getHairState() {\r\n        return this.hairSegments;\r\n    }\r\n    \r\n    getEquipmentState() {\r\n        return this.equipmentItems;\r\n    }\r\n    \r\n    renderHair(ctx) {\r\n        ctx.strokeStyle = '#8B4513';\r\n        ctx.lineWidth = 2;\r\n        ctx.beginPath();\r\n        this.hairSegments.forEach((segment, index) => {\r\n            if (index === 0) {\r\n                ctx.moveTo(segment.position.x, segment.position.y);\r\n            } else {\r\n                ctx.lineTo(segment.position.x, segment.position.y);\r\n            }\r\n        });\r\n        ctx.stroke();\r\n    }\r\n    \r\n    renderEquipment(ctx) {\r\n        this.equipmentItems.forEach(item => {\r\n            ctx.fillStyle = item.type === 'sword' ? '#C0C0C0' : '#8B4513';\r\n            ctx.fillRect(item.position.x - 2, item.position.y - 1, 4, 2);\r\n        });\r\n    }\r\n}\r\n\r\n// Cloth physics system\r\nclass ClothPhysicsSystem {\r\n    constructor() {\r\n        this.clothPoints = [];\r\n        this.constraints = [];\r\n        this.initializeCloth();\r\n    }\r\n    \r\n    initializeCloth() {\r\n        // Create a simple cloth simulation for capes/cloaks\r\n        const width = 3;\r\n        const height = 4;\r\n        \r\n        for (let y = 0; y < height; y++) {\r\n            for (let x = 0; x < width; x++) {\r\n                this.clothPoints.push({\r\n                    position: { x: x * 3 - 3, y: y * 3 + 5 },\r\n                    oldPosition: { x: x * 3 - 3, y: y * 3 + 5 },\r\n                    pinned: y === 0 // Pin top row\r\n                });\r\n            }\r\n        }\r\n        \r\n        // Create constraints between neighboring points\r\n        for (let y = 0; y < height; y++) {\r\n            for (let x = 0; x < width; x++) {\r\n                if (x < width - 1) {\r\n                    this.constraints.push({\r\n                        p1: y * width + x,\r\n                        p2: y * width + x + 1,\r\n                        restLength: 3\r\n                    });\r\n                }\r\n                if (y < height - 1) {\r\n                    this.constraints.push({\r\n                        p1: y * width + x,\r\n                        p2: (y + 1) * width + x,\r\n                        restLength: 3\r\n                    });\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    update(deltaTime, forces) {\r\n        // Verlet integration\r\n        this.clothPoints.forEach(point => {\r\n            if (point.pinned) {return;}\r\n            \r\n            const velX = point.position.x - point.oldPosition.x;\r\n            const velY = point.position.y - point.oldPosition.y;\r\n            \r\n            point.oldPosition.x = point.position.x;\r\n            point.oldPosition.y = point.position.y;\r\n            \r\n            // Apply forces\r\n            point.position.x += velX + forces.sway * 0.1 + forces.windResponse * 0.2;\r\n            point.position.y += velY + 0.2; // Gravity\r\n        });\r\n        \r\n        // Satisfy constraints\r\n        for (let i = 0; i < 2; i++) { // Multiple iterations for stability\r\n            this.constraints.forEach(constraint => {\r\n                const p1 = this.clothPoints[constraint.p1];\r\n                const p2 = this.clothPoints[constraint.p2];\r\n                \r\n                const dx = p2.position.x - p1.position.x;\r\n                const dy = p2.position.y - p1.position.y;\r\n                const distance = Math.sqrt(dx * dx + dy * dy);\r\n                const difference = constraint.restLength - distance;\r\n                const percent = difference / distance / 2;\r\n                \r\n                const offsetX = dx * percent;\r\n                const offsetY = dy * percent;\r\n                \r\n                if (!p1.pinned) {\r\n                    p1.position.x -= offsetX;\r\n                    p1.position.y -= offsetY;\r\n                }\r\n                if (!p2.pinned) {\r\n                    p2.position.x += offsetX;\r\n                    p2.position.y += offsetY;\r\n                }\r\n            });\r\n        }\r\n    }\r\n    \r\n    getState() {\r\n        return this.clothPoints;\r\n    }\r\n    \r\n    render(ctx) {\r\n        // Render cloth as a mesh\r\n        ctx.strokeStyle = '#4A4A4A';\r\n        ctx.lineWidth = 1;\r\n        \r\n        this.constraints.forEach(constraint => {\r\n            const p1 = this.clothPoints[constraint.p1];\r\n            const p2 = this.clothPoints[constraint.p2];\r\n            \r\n            ctx.beginPath();\r\n            ctx.moveTo(p1.position.x, p1.position.y);\r\n            ctx.lineTo(p2.position.x, p2.position.y);\r\n            ctx.stroke();\r\n        });\r\n    }\r\n}\r\n\r\n// Facial animation system\r\nclass FacialAnimationSystem {\r\n    constructor() {\r\n        this.expressions = {\r\n            neutral: { eyeOpenness: 1.0, mouthCurve: 0.0, eyebrowHeight: 0.0 },\r\n            happy: { eyeOpenness: 0.8, mouthCurve: 0.5, eyebrowHeight: 0.2 },\r\n            angry: { eyeOpenness: 0.6, mouthCurve: -0.3, eyebrowHeight: -0.4 },\r\n            surprised: { eyeOpenness: 1.2, mouthCurve: -0.2, eyebrowHeight: 0.6 },\r\n            tired: { eyeOpenness: 0.4, mouthCurve: -0.1, eyebrowHeight: -0.1 }\r\n        };\r\n        \r\n        this.currentExpression = 'neutral';\r\n        this.blendWeight = 0.0;\r\n    }\r\n    \r\n    setExpression(expression, blendTime = 0.5) {\r\n        this.targetExpression = expression;\r\n        this.blendTime = blendTime;\r\n        this.blendWeight = 0.0;\r\n    }\r\n    \r\n    update(deltaTime, emotionalState) {\r\n        // Determine expression based on game state\r\n        if (emotionalState.stamina < 0.3) {\r\n            this.setExpression('tired');\r\n        } else if (emotionalState.health < 0.5) {\r\n            this.setExpression('angry');\r\n        } else {\r\n            this.setExpression('neutral');\r\n        }\r\n        \r\n        // Blend towards target expression\r\n        if (this.blendWeight < 1.0) {\r\n            this.blendWeight += deltaTime / this.blendTime;\r\n            this.blendWeight = Math.min(this.blendWeight, 1.0);\r\n        }\r\n    }\r\n}\r\n\r\n// Environmental response system\r\nclass EnvironmentalResponseSystem {\r\n    applyShivering(state, _intensity) {\r\n        // ARCHITECTURAL VIOLATION FIXED: Shivering should be deterministic from WASM\r\n        // Apply small deterministic movements to simulate shivering\r\n        const shiver = 0; // Should be calculated deterministically in WASM\r\n        \r\n        Object.values(state).forEach(joint => {\r\n            if (typeof joint.x !== \"undefined\") {\r\n                joint.x += shiver * 0.5;\r\n                joint.y += shiver * 0.3;\r\n            }\r\n        });\r\n    }\r\n    \r\n    applyWindEffects(state, windStrength) {\r\n        // Apply wind forces to extremities\r\n        state.head.x += windStrength * 0.5;\r\n        state.leftHand.x += windStrength * 0.8;\r\n        state.rightHand.x += windStrength * 0.8;\r\n    }\r\n}\r\n\r\nexport default RealisticProceduralAnimator;\r\n","// Enhanced Player with Animation System Integration\r\n// Provides a complete player character with roll, attack, block, and hurt animations\r\n\r\nimport { CharacterAnimator, AnimationPresets } from './animation-system.js'\r\nimport RealisticProceduralAnimator from './realistic-procedural-animator.js'\r\n// SoundSystem and ParticleSystem imports removed - not used in this file\r\n\r\nexport class AnimatedPlayer {\r\n    constructor(x = 400, y = 300, options = {}) {\r\n        // Position - driven by WASM (normalized 0-1 coordinates)\r\n        this.x = x\r\n        this.y = y\r\n        this.facing = 1 // 1 for right, -1 for left\r\n        \r\n        // Player stats - WASM will manage the core stats\r\n        this.health = options.health || 100\r\n        this.maxHealth = options.maxHealth || 100\r\n        this.stamina = options.stamina || 100\r\n        this.maxStamina = options.maxStamina || 100\r\n        this.speed = options.speed || 250 // Base speed, actual speed is WASM-driven\r\n        this.rollSpeed = options.rollSpeed || 500 // Base roll speed, actual speed is WASM-driven\r\n        \r\n        // State management - now primarily WASM-driven, this is for JS animation state\r\n        this.state = 'idle' // idle, running, attacking, blocking, rolling, hurt, dead, jumping, doubleJumping, landing, wallSliding, dashing, chargingAttack\r\n        this.previousState = 'idle'\r\n        this.stateTimer = 0 // Managed by WASM now for core actions\r\n        this.stateTime = 0 // Managed by WASM now\r\n        this.stateDuration = 0 // Managed by WASM now\r\n        this._prevNormTime = 0 // Managed by WASM now\r\n        this._comboQueued = false // Logic related to combos will move to WASM\r\n        this._currentAttackType = 'light' // Managed by WASM now\r\n        this.invulnerable = false // Managed by WASM\r\n        this.invulnerabilityTimer = 0 // Managed by WASM\r\n        this.isGrounded = true // Driven by WASM\r\n        this.jumpCount = 0 // Driven by WASM\r\n        this.nearWall = false // Will be WASM-driven or removed\r\n        this.dashCooldown = 0 // Will be WASM-driven or removed\r\n        this.chargeTime = 0 // Will be WASM-driven or removed\r\n        this.maxChargeTime = 1.5 // Will be WASM-driven or removed\r\n\r\n        // Deterministic animation/event parameters - these are mostly cues for animation\r\n        this.params = {\r\n            roll: {\r\n                duration: 0.4,\r\n                iFrameStart: 0.08,\r\n                iFrameEnd: 0.36,\r\n                staminaCost: 25,\r\n                cooldown: 0.8\r\n            },\r\n            attackLight: {\r\n                duration: 0.4,\r\n                activeStart: 0.28,\r\n                activeEnd: 0.38,\r\n                staminaCost: 12,\r\n                cooldown: 0.5\r\n            },\r\n            attackHeavy: {\r\n                duration: 0.62,\r\n                activeStart: 0.32,\r\n                activeEnd: 0.48,\r\n                staminaCost: 24,\r\n                cooldown: 0.8\r\n            },\r\n            comboWindow: { start: 0.55, end: 0.75 },\r\n            parry: { duration: 0.22, window: 0.18, staminaCost: 10 }\r\n        }\r\n        \r\n        // Animation system\r\n        this.animator = new CharacterAnimator()\r\n        this.animations = AnimationPresets.createPlayerAnimations()\r\n        this.setupAnimations()\r\n        \r\n        // Realistic Procedural Animator - NEW!\r\n        this.proceduralAnimator = new RealisticProceduralAnimator({\r\n            ikEnabled: options.enableIK !== false,\r\n            renderSkeleton: options.debugMode || false,\r\n            renderIKTargets: options.debugMode || false,\r\n            renderSecondaryMotion: options.debugMode || false,\r\n            enableOptimizations: options.enableOptimizations !== false\r\n        })\r\n        \r\n        // Action cooldowns - now WASM-driven\r\n        this.attackCooldown = 0\r\n        this.rollCooldown = 0\r\n        this.blockHeld = false // WASM will manage the actual block state\r\n        \r\n        // Visual properties\r\n        this.width = options.width || 32\r\n        this.height = options.height || 32\r\n        this.color = options.color || '#00ff88'\r\n        this.sprite = options.sprite || null\r\n\r\n        // Load sprite sheet if not provided\r\n        if (!this.sprite) {\r\n            this.loadSpriteSheet()\r\n        }\r\n        \r\n        // Effects\r\n        this.particleSystem = options.particleSystem || null\r\n        this.soundSystem = options.soundSystem || null\r\n        \r\n        // Combat properties - now WASM-driven\r\n        this.attackDamage = options.attackDamage || 20\r\n        this.attackDamageHeavy = options.attackDamageHeavy || 35\r\n        this.attackRange = options.attackRange || 60\r\n        this.attackRangeHeavy = options.attackRangeHeavy || 80\r\n        this.blockDamageReduction = options.blockDamageReduction || 0.5\r\n\r\n        // Locomotion cadence and footsteps - these will be driven by WASM velocity feedback\r\n        this.stridePhase = 0\r\n        this.gaitRate = 1.4\r\n        this._lastFootFlag = 0 // 0 left, 1 right alternating\r\n        this.footstepIntervalBase = 0.28\r\n\r\n        // Minimal IK proxy values (pelvis bob and foot locks for readability) - driven by WASM\r\n        this.ik = {\r\n            pelvisY: 0,\r\n            pelvisRate: 10,\r\n            left: { locked: false, y: 0 },\r\n            right: { locked: false, y: 0 },\r\n            stepHeight: 2\r\n        }\r\n\r\n        // Debug flag\r\n        this.debugMode = false\r\n\r\n        // Optional WASM module injection support for testing/integration\r\n        try {\r\n            if (options.wasmModule && !globalThis.wasmExports) {\r\n                globalThis.wasmExports = options.wasmModule\r\n            }\r\n        } catch {\r\n            // Ignore WASM module loading errors - fallback handling elsewhere\r\n        }\r\n    }\r\n\r\n    loadSpriteSheet() {\r\n        // Try to load sprite sheet\r\n        this.sprite = new Image()\r\n        this.sprite.src = './src/images/player-sprites.png'\r\n\r\n        this.sprite.onload = () => {\r\n            console.log('Player sprite sheet loaded successfully')\r\n        }\r\n\r\n        this.sprite.onerror = () => {\r\n            console.warn('Player sprite sheet not found at ./src/images/player-sprites.png, using fallback rendering')\r\n            console.log('To fix this: Run \"node scripts/generate-sprite-sheet.js\" or use create-sprite-sheet.html')\r\n            this.sprite = null\r\n        }\r\n    }\r\n    \r\n    setupAnimations() {\r\n        // Add all animations to the controller\r\n        Object.values(this.animations).forEach(animation => {\r\n            this.animator.controller.addAnimation(animation)\r\n        })\r\n        \r\n        // Start with idle animation\r\n        this.animator.controller.play('idle')\r\n    }\r\n    \r\n    update(deltaTime, input = {}) {\r\n        // Update timers - WASM manages core game timers\r\n        this._prevNormTime = this.getNormalizedTime()\r\n        this.attackCooldown = Math.max(0, this.attackCooldown - deltaTime)\r\n        this.rollCooldown = Math.max(0, this.rollCooldown - deltaTime)\r\n        \r\n        // Update invulnerability\r\n        if (this.invulnerable) {\r\n            this.invulnerabilityTimer -= deltaTime // WASM manages invulnerability timer\r\n            if (this.invulnerabilityTimer <= 0) {\r\n                this.invulnerable = false\r\n            }\r\n        }\r\n        \r\n        // Handle state transitions\r\n        // this.handleStateTransitions(input) // WASM now handles state transitions\r\n        \r\n        // Update based on current state\r\n        // this.updateState(deltaTime, input) // WASM now handles state updates\r\n\r\n        // Deterministic state event windows (hitboxes, i-frames)\r\n        // this.applyStateEvents() // WASM now handles state events\r\n        \r\n        // Update simple IK before composing overlay\r\n        this.updateIK(deltaTime)\r\n\r\n        // 1. Forward inputs to WASM - 5-button combat system\r\n        let inputX = 0; let inputY = 0\r\n        if (input.left) {inputX -= 1}\r\n        if (input.right) {inputX += 1}\r\n        if (input.up) {inputY -= 1}\r\n        if (input.down) {inputY += 1}\r\n        \r\n        // New 5-button combat system: A1(light), A2(heavy), Block, Roll, Special\r\n        globalThis.wasmExports?.set_player_input?.(\r\n            inputX, inputY, \r\n            input.roll ? 1 : 0, \r\n            input.jump ? 1 : 0, \r\n            input.lightAttack ? 1 : 0, \r\n            input.heavyAttack ? 1 : 0, \r\n            input.block ? 1 : 0, \r\n            input.special ? 1 : 0\r\n        )\r\n\r\n        // 2. Read state for rendering\r\n        // Assuming 800x600 canvas for now. Convert WASM's 0-1 range to world coordinates.\r\n        // The game-renderer.js is responsible for this scaling when passing player position to render.\r\n        // For now, we'll directly set x and y, and let the renderer handle scaling.\r\n        // WASM provides normalized coordinates; guard against NaN/Infinity\r\n        const rx = globalThis.wasmExports?.get_x?.()\r\n        const ry = globalThis.wasmExports?.get_y?.()\r\n        this.x = (typeof rx === 'number' && Number.isFinite(rx)) ? rx : 0.5\r\n        this.y = (typeof ry === 'number' && Number.isFinite(ry)) ? ry : 0.5\r\n\r\n        this.isGrounded = (globalThis.wasmExports?.get_is_grounded?.() === 1);\r\n        this.jumpCount = globalThis.wasmExports?.get_jump_count?.();\r\n\r\n        // Update animation system and cache transform\r\n        // WASM will determine facing direction implicitly from movement and actions\r\n        // Infer facing from velocity if available; preserve when nearly still\r\n        const fx = globalThis.wasmExports?.get_vel_x?.()\r\n        const fy = globalThis.wasmExports?.get_vel_y?.()\r\n        if (typeof fx === 'number' && typeof fy === 'number') {\r\n            const speed = Math.hypot(fx, fy)\r\n            if (speed > 0.001) {\r\n                this.facing = fx >= 0 ? 1 : -1\r\n            }\r\n        }\r\n\r\n        if (this.animator && typeof this.animator.setFacing === 'function') {\r\n            this.animator.setFacing(this.facing >= 0 ? 'right' : 'left')\r\n        }\r\n        // Query WASM overlay values if available\r\n        const wx = (globalThis.wasmExports?.get_anim_offset_x?.() ?? 0)\r\n        const wy = (globalThis.wasmExports?.get_anim_offset_y?.() ?? 0)\r\n        const wsx = (globalThis.wasmExports?.get_anim_scale_x?.() ?? 1)\r\n        const wsy = (globalThis.wasmExports?.get_anim_scale_y?.() ?? 1)\r\n        const wrot = (globalThis.wasmExports?.get_anim_rotation?.() ?? 0)\r\n        const wpelvis = (globalThis.wasmExports?.get_anim_pelvis_y?.() ?? 0)\r\n        \r\n        // Get the animation state from WASM and set it in the CharacterAnimator\r\n        const wasmAnimState = globalThis.wasmExports?.get_player_anim_state?.()\r\n        if (typeof wasmAnimState === 'number') {\r\n            this.setState(this.getAnimStateName(wasmAnimState), true) // Pass true to indicate WASM-driven state\r\n        }\r\n\r\n        const baseTransform = this.animator.update(\r\n            deltaTime,\r\n            { x: this.x, y: this.y },\r\n            // Pass WASM-driven velocity to CharacterAnimator\r\n            { x: globalThis.wasmExports?.get_vel_x?.() ?? 0, y: globalThis.wasmExports?.get_vel_y?.() ?? 0 },\r\n            this.isGrounded\r\n        ) || { scaleX: 1, scaleY: 1, rotation: 0, offsetX: 0, offsetY: 0 }\r\n        \r\n        // Update realistic procedural animator with WASM data\r\n        const proceduralTransform = this.proceduralAnimator.update(deltaTime, {\r\n            // Pass any additional context the procedural animator might need\r\n            playerState: this.state,\r\n            inputState: input,\r\n            debugMode: this.debugMode\r\n        });\r\n        \r\n        // Prefer WASM-driven overlay when available; fallback to local\r\n        const overlay = (globalThis.wasmExports && typeof wx === 'number') ? {\r\n            scaleX: wsx,\r\n            scaleY: wsy,\r\n            rotation: wrot,\r\n            offsetX: wx,\r\n            offsetY: wy\r\n        } : this.computePoseOverlay(input)\r\n        \r\n        // Combine all transforms: base + procedural + overlay\r\n        this.currentTransform = {\r\n            scaleX: baseTransform.scaleX * overlay.scaleX * proceduralTransform.scaleX,\r\n            scaleY: baseTransform.scaleY * overlay.scaleY * proceduralTransform.scaleY,\r\n            rotation: baseTransform.rotation + overlay.rotation + proceduralTransform.rotation,\r\n            offsetX: baseTransform.offsetX + overlay.offsetX + proceduralTransform.offsetX,\r\n            offsetY: baseTransform.offsetY + overlay.offsetY + proceduralTransform.offsetY,\r\n            trails: baseTransform.trails || [],\r\n            \r\n            // Enhanced data from procedural animator\r\n            skeleton: proceduralTransform.skeleton,\r\n            secondaryMotion: proceduralTransform.secondaryMotion,\r\n            environmental: proceduralTransform.environmental,\r\n            debug: proceduralTransform.debug\r\n        }\r\n        \r\n        // Physics handled by WASM\r\n\r\n        // Stamina regeneration handled by WASM\r\n    }\r\n\r\n    // Returns a normalized [0,1] progress for the current player action/animation\r\n    // Prefer authoritative WASM timers; fallback to current animation controller progress\r\n    getNormalizedTime() {\r\n        try {\r\n            // If WASM provides an explicit attack state machine, derive normalized phase\r\n            const get = (fn) => (typeof globalThis.wasmExports?.[fn] === 'function') ? globalThis.wasmExports[fn]() : void 0\r\n            const attackState = get('get_attack_state') // 0 Idle, 1 Windup, 2 Active, 3 Recovery\r\n            const stateStartTime = get('get_attack_state_time')\r\n            const now = get('get_time_seconds')\r\n            if (typeof attackState === 'number' && typeof stateStartTime === 'number' && typeof now === 'number') {\r\n                const elapsed = Math.max(0, now - stateStartTime)\r\n                let duration = 0\r\n                if (attackState === 1) {duration = get('get_attack_windup_sec') ?? this.params.attackLight.duration}\r\n                else if (attackState === 2) {duration = get('get_attack_active_sec') ?? this.params.attackLight.duration}\r\n                else if (attackState === 3) {duration = get('get_attack_recovery_sec') ?? this.params.attackLight.duration}\r\n                if (duration && duration > 0) {\r\n                    return Math.max(0, Math.min(1, elapsed / duration))\r\n                }\r\n            }\r\n\r\n            // Rolling phase if available\r\n            const isRolling = get('get_is_rolling')\r\n            if (isRolling === 1) {\r\n                const rollDur = get('get_roll_duration') || this.params.roll.duration\r\n                const playerStateTimer = get('get_player_state_timer')\r\n                if (typeof playerStateTimer === 'number' && rollDur > 0) {\r\n                    return Math.max(0, Math.min(1, playerStateTimer / rollDur))\r\n                }\r\n            }\r\n\r\n            // Generic state timer normalization when duration is known locally\r\n            const playerStateTimer = get('get_player_state_timer')\r\n            if (typeof playerStateTimer === 'number') {\r\n                let duration = 0\r\n                switch (this.state) {\r\n                    case 'rolling': duration = this.params.roll.duration; break\r\n                    case 'attacking':\r\n                        duration = this._currentAttackType === 'heavy' ? this.params.attackHeavy.duration : this.params.attackLight.duration\r\n                        break\r\n                    default:\r\n                        duration = 0\r\n                }\r\n                if (duration > 0) {\r\n                    return Math.max(0, Math.min(1, playerStateTimer / duration))\r\n                }\r\n            }\r\n        } catch {\r\n            // Ignore WASM timing errors - fallback to animation controller\r\n        }\r\n\r\n        // Fallback: use current animation controller progress\r\n        try {\r\n            const anim = this.animator?.controller?.currentAnimation\r\n            if (anim && Array.isArray(anim.frames) && anim.frames.length > 1) {\r\n                // Use frame index over total as coarse progress\r\n                const coarse = anim.currentFrame / (anim.frames.length - 1)\r\n                return Math.max(0, Math.min(1, coarse))\r\n            }\r\n        } catch {\r\n            // Ignore animation controller errors - return default\r\n        }\r\n\r\n        return 0\r\n    }\r\n\r\n    startRoll(input) {\r\n        // Trigger WASM roll action and handle visual/audio effects\r\n        if (!globalThis.wasmExports?.on_roll_start?.()) {\r\n            // WASM determined roll could not start (e.g., stamina, cooldown)\r\n            return;\r\n        }\r\n\r\n        // Determine roll direction for local effects and WASM input\r\n        let dirX = 0; let dirY = 0\r\n        \r\n        if (input.left) {dirX -= 1}\r\n        if (input.right) {dirX += 1}\r\n        if (input.up) {dirY -= 1}\r\n        if (input.down) {dirY += 1}\r\n        \r\n        // If no direction input, roll in facing direction\r\n        if (dirX === 0 && dirY === 0) {\r\n            dirX = this.facing\r\n        }\r\n        \r\n        // Normalize direction\r\n        const length = Math.hypot(dirX, dirY)\r\n        if (length > 0) {\r\n            dirX /= length\r\n            dirY /= length\r\n        }\r\n        \r\n        this.rollDirection = { x: dirX, y: dirY }\r\n        // Visual and audio effects only - core logic handled by WASM\r\n        \r\n        // Create roll effect\r\n        if (this.particleSystem) {\r\n            this.particleSystem.createDustCloud(this.x, this.y)\r\n        }\r\n        \r\n        // Play roll sound\r\n        if (this.soundSystem) {\r\n            this.soundSystem.play('roll')\r\n        }\r\n    }\r\n    \r\n    startAttack(type = 'light') {\r\n        // Trigger WASM attack action and handle visual/audio effects\r\n        const p = type === 'heavy' ? this.params.attackHeavy : this.params.attackLight\r\n        this._currentAttackType = type\r\n\r\n        if (!globalThis.wasmExports?.on_attack?.(type === 'heavy' ? 1 : 0)) {\r\n            // WASM determined attack could not start (e.g., stamina, cooldown)\r\n            return;\r\n        }\r\n        \r\n        // Play attack sound\r\n        if (this.soundSystem) {\r\n            this.soundSystem.play('attack')\r\n        }\r\n    }\r\n\r\n    // Public input API helpers\r\n    queueAttack(type = 'light') {\r\n        // This logic is now handled in WASM\r\n        if (this.canAttack()) { // This check will still use local state, but the actual decision is WASM's\r\n            this.startAttack(type)\r\n        } else if (this.state === 'attacking') {\r\n            // This combo queuing needs to be moved to WASM if it affects gameplay\r\n            this._comboQueued = true\r\n        }\r\n    }\r\n\r\n    tryRoll(dir = null) {\r\n        // dir: {x,y} optional; if absent uses current input/facing via startRoll caller\r\n        // This logic is now handled by WASM, just call startRoll\r\n        const input = {}\r\n        if (dir && (dir.x || dir.y)) {\r\n            input.left = dir.x < -0.5\r\n            input.right = dir.x > 0.5\r\n            input.up = dir.y < -0.5\r\n            input.down = dir.y > 0.5\r\n        }\r\n        this.startRoll(input);\r\n    }\r\n\r\n    tryParry() {\r\n        // Parry logic is now handled in WASM\r\n        if (this.state === 'dead') { return }\r\n        // Stamina check is now done in WASM\r\n        // if (this.stamina < this.params.parry.staminaCost) { return }\r\n        // Enter a brief blocking-like state with a success window; integrate with combat later\r\n        // this.setState('blocking') // State is WASM-driven\r\n        // this.stateTimer = this.params.parry.duration // State timing is WASM-driven\r\n        // this.stateTime = 0 // State timing is WASM-driven\r\n        // this.stateDuration = this.params.parry.duration // State timing is WASM-driven\r\n        // this.stamina -= this.params.parry.staminaCost // Stamina cost is WASM-driven\r\n        if (!globalThis.wasmExports?.on_parry?.()) { // Assuming a new WASM on_parry function\r\n            return; // Parry failed in WASM\r\n        }\r\n        // Optional sfx\r\n        if (this.soundSystem) { this.soundSystem.play('parry') }\r\n    }\r\n    \r\n    executeAttack() {\r\n        // This method will be simplified as WASM handles attack logic.\r\n        // It will primarily be for visual effects and returning hit data for JS enemies.\r\n        const isHeavy = this._currentAttackType === 'heavy'\r\n        const range = isHeavy ? this.attackRangeHeavy : this.attackRange\r\n        const damage = isHeavy ? this.attackDamageHeavy : this.attackDamage\r\n        const hitboxX = this.x + (this.facing * range / 2)\r\n        const hitboxY = this.y\r\n        \r\n        // Create attack effect\r\n        if (this.particleSystem) {\r\n            if (isHeavy) {\r\n                this.particleSystem.createChargedSlash?.(hitboxX, hitboxY, this.facing, 1)\r\n            } else {\r\n                this.particleSystem.createSlashEffect(hitboxX, hitboxY, this.facing)\r\n            }\r\n        }\r\n        \r\n        // Return attack hitbox for collision detection (for JS-managed enemies)\r\n        return {\r\n            x: hitboxX,\r\n            y: hitboxY,\r\n            width: range,\r\n            height: this.height,\r\n            damage: damage\r\n        }\r\n    }\r\n    \r\n    startBlock() {\r\n        // This function now primarily triggers the WASM block action and handles local effects\r\n        if (!globalThis.wasmExports?.set_blocking?.(1, this.facing, 0)) {\r\n            return; // Block failed in WASM (e.g., stamina)\r\n        }\r\n        // this.setState('blocking') // State is WASM-driven\r\n        this.blockHeld = true\r\n        \r\n        // Create block effect\r\n        if (this.particleSystem) {\r\n            this.particleSystem.createShieldEffect(this.x, this.y)\r\n        }\r\n        \r\n        // Play block sound\r\n        if (this.soundSystem) {\r\n            this.soundSystem.play('block')\r\n        }\r\n    }\r\n    \r\n    stopBlock() {\r\n        // This function now primarily triggers the WASM block action\r\n        globalThis.wasmExports?.set_blocking?.(0, this.facing, 0);\r\n        // this.setState('idle') // State is WASM-driven\r\n        this.blockHeld = false\r\n    }\r\n    \r\n    takeDamage(damage, knockbackX = 0, knockbackY = 0) {\r\n        // Damage calculation is now primarily WASM-driven\r\n        // This function will be simplified or removed if WASM handles all damage and effects\r\n        if (this.invulnerable || this.state === 'dead') {return false} // Invulnerable state is WASM-driven\r\n\r\n        const actualDamage = damage\r\n        \r\n        // Reduce damage if blocking - WASM handles this logic\r\n        if (this.state === 'blocking') {\r\n            // actualDamage *= this.blockDamageReduction\r\n            \r\n            // Create block impact effect\r\n            if (this.particleSystem) {\r\n                this.particleSystem.createBlockImpact(this.x, this.y)\r\n            }\r\n            \r\n            // Play block impact sound\r\n            if (this.soundSystem) {\r\n                this.soundSystem.play('blockImpact')\r\n            }\r\n        } else {\r\n            // Not blocking, take full damage - visual/audio effects only\r\n            if (this.particleSystem) {\r\n                this.particleSystem.createBloodEffect(this.x, this.y)\r\n            }\r\n\r\n            if (this.soundSystem) {\r\n                this.soundSystem.play('hurt')\r\n            }\r\n        }\r\n\r\n        // Damage application and death check handled by WASM\r\n        \r\n        return true\r\n    }\r\n    \r\n    die() {\r\n        // Visual and audio effects only - death state handled by WASM\r\n        if (this.particleSystem) {\r\n            this.particleSystem.createDeathEffect(this.x, this.y)\r\n        }\r\n\r\n        if (this.soundSystem) {\r\n            this.soundSystem.play('death')\r\n        }\r\n    }\r\n    \r\n    respawn(_x, _y) {\r\n        // Visual and audio effects only - respawn logic handled by WASM\r\n        if (this.particleSystem) {\r\n            this.particleSystem.createRespawnEffect(this.x, this.y)\r\n        }\r\n\r\n        if (this.soundSystem) {\r\n            this.soundSystem.play('respawn')\r\n        }\r\n    }\r\n    \r\n    setState(newState, wasmDriven = false) { // Added wasmDriven parameter\r\n        if (this.state === newState) {return} // Prevent redundant state changes regardless of source\r\n\r\n        this.previousState = this.state\r\n        this.state = newState\r\n        this.stateTime = 0\r\n        this.stateDuration = 0\r\n        this._prevNormTime = 0\r\n\r\n        // Convert string state to numeric state for CharacterAnimator\r\n        const numericState = this.stateNameToNumber(newState)\r\n\r\n        // Update animation using CharacterAnimator's setAnimState method\r\n        this.animator.setAnimState(numericState)\r\n    }\r\n    \r\n    canAttack() {\r\n        // This check is now primarily WASM-driven, this local version is for UI/client-side prediction\r\n        const minCost = Math.min(this.params.attackLight.staminaCost, this.params.attackHeavy.staminaCost)\r\n        return this.attackCooldown <= 0 && \r\n               this.stamina >= minCost && // Stamina also comes from WASM\r\n               this.state !== 'dead' &&\r\n               this.state !== 'rolling' &&\r\n               this.state !== 'hurt'\r\n    }\r\n    \r\n    canRoll() {\r\n        // This check is now primarily WASM-driven, this local version is for UI/client-side prediction\r\n        return this.rollCooldown <= 0 && \r\n               this.stamina >= this.params.roll.staminaCost && // Stamina also comes from WASM\r\n               this.state !== 'dead' &&\r\n               this.state !== 'attacking' &&\r\n               this.state !== 'hurt'\r\n    }\r\n    \r\n    canBlock() {\r\n        // This check is now primarily WASM-driven, this local version is for UI/client-side prediction\r\n        return this.stamina > 0 && // Stamina also comes from WASM\r\n               this.state !== 'dead' &&\r\n               this.state !== 'rolling' &&\r\n               this.state !== 'attacking' &&\r\n               this.state !== 'hurt'\r\n    }\r\n    \r\n    render(ctx, camera = null) {\r\n        // Compute screen position from WASM-normalized coords using GameRenderer mapping if available\r\n        let screenX = 0\r\n        let screenY = 0\r\n        const camX = camera?.x || 0\r\n        const camY = camera?.y || 0\r\n        \r\n        // Debug logging for position tracking\r\n        const debugPositions = false; // Set to true for debugging\r\n        if (debugPositions && Math.random() < 0.01) { // Log occasionally to avoid spam\r\n            console.log('AnimatedPlayer.render:', {\r\n                playerPos: { x: this.x, y: this.y },\r\n                camera: { x: camX, y: camY },\r\n                hasGameRenderer: !!globalThis.gameRenderer,\r\n                hasWasmToWorld: !!(globalThis.gameRenderer?.wasmToWorld)\r\n            });\r\n        }\r\n        \r\n        if (globalThis.gameRenderer && typeof globalThis.gameRenderer.wasmToWorld === 'function') {\r\n            const pos = globalThis.gameRenderer.wasmToWorld(this.x || 0.5, this.y || 0.5)\r\n            screenX = pos.x - camX\r\n            screenY = pos.y - camY\r\n        } else {\r\n            // Fallback scaling if renderer mapping is unavailable\r\n            const worldWidth = 800\r\n            const worldHeight = 600\r\n            screenX = (this.x || 0) * worldWidth - camX\r\n            screenY = (this.y || 0) * worldHeight - camY\r\n        }\r\n        \r\n        ctx.save()\r\n        \r\n        // Apply invulnerability flashing - this will be driven by WASM\r\n        if (globalThis.wasmExports?.get_is_invulnerable?.() === 1) { // Assuming a WASM export for invulnerability\r\n            ctx.globalAlpha = 0.5 + Math.sin(Date.now() * 0.02) * 0.3\r\n        }\r\n        \r\n        // Get current animation frame\r\n        const frame = this.animator.controller.getCurrentFrame()\r\n        \r\n        if (this.sprite && frame) {\r\n            // Draw sprite animation with enhanced procedural transform\r\n            ctx.save()\r\n            const t = this.currentTransform || { scaleX: 1, scaleY: 1, rotation: 0, offsetX: 0, offsetY: 0 }\r\n            const centerX = screenX + t.offsetX\r\n            const centerY = screenY + t.offsetY\r\n            ctx.translate(centerX, centerY)\r\n            ctx.rotate(t.rotation)\r\n            ctx.scale(this.facing < 0 ? -t.scaleX : t.scaleX, t.scaleY)\r\n            \r\n            // Render secondary motion effects first (behind character)\r\n            if (t.secondaryMotion && this.debugMode) {\r\n                this.renderSecondaryMotion(ctx, t.secondaryMotion)\r\n            }\r\n            \r\n            // Draw main character sprite\r\n            ctx.drawImage(\r\n                this.sprite,\r\n                frame.x, frame.y, frame.width, frame.height,\r\n                -this.width/2, -this.height/2,\r\n                this.width, this.height\r\n            )\r\n            \r\n            // Render enhanced skeletal overlay if available and in debug mode\r\n            if (t.skeleton && this.debugMode) {\r\n                this.renderSkeletalOverlay(ctx, t.skeleton)\r\n            }\r\n            \r\n            ctx.restore()\r\n        } else {\r\n            // Fallback to colored rectangle - ensure it's always visible\r\n            ctx.fillStyle = this.color || '#4a90e2' // Default blue color\r\n            \r\n            // Apply state-based visual effects\r\n            if (this.state === 'hurt') {\r\n                ctx.fillStyle = '#ff4444'\r\n            } else if (this.state === 'blocking') {\r\n                ctx.fillStyle = '#4444ff'\r\n            } else if (this.state === 'rolling') {\r\n                ctx.fillStyle = '#ffff44'\r\n            }\r\n            \r\n            // Draw a more visible rectangle\r\n            const rectWidth = this.width || 32;\r\n            const rectHeight = this.height || 32;\r\n            \r\n            ctx.fillRect(\r\n                screenX - rectWidth/2,\r\n                screenY - rectHeight/2,\r\n                rectWidth,\r\n                rectHeight\r\n            );\r\n            \r\n            // Add a border to make it more visible\r\n            ctx.strokeStyle = '#ffffff';\r\n            ctx.lineWidth = 2;\r\n            ctx.strokeRect(\r\n                screenX - rectWidth/2,\r\n                screenY - rectHeight/2,\r\n                rectWidth,\r\n                rectHeight\r\n            );\r\n            \r\n            // Add a center dot to show exact position\r\n            ctx.fillStyle = '#ffffff';\r\n            ctx.beginPath();\r\n            ctx.arc(screenX, screenY, 3, 0, Math.PI * 2);\r\n            ctx.fill();\r\n        }\r\n        \r\n        // Draw health bar\r\n        const barWidth = 40\r\n        const barHeight = 4\r\n        const barY = screenY - this.height/2 - 10\r\n        \r\n        // Background\r\n        ctx.fillStyle = 'rgba(0, 0, 0, 0.5)'\r\n        ctx.fillRect(screenX - barWidth/2, barY, barWidth, barHeight)\r\n        \r\n        // Health - get from WASM\r\n        const currentHealth = globalThis.wasmExports?.get_hp?.() ?? globalThis.wasmExports?.get_health?.() ?? this.health;\r\n        const maxHealth = this.maxHealth; // Max health can still be local or WASM-driven if dynamic\r\n        const healthPercent = currentHealth / maxHealth\r\n        ctx.fillStyle = healthPercent > 0.5 ? '#00ff00' : \r\n                       healthPercent > 0.25 ? '#ffff00' : '#ff0000'\r\n        ctx.fillRect(screenX - barWidth/2, barY, barWidth * healthPercent, barHeight)\r\n        \r\n        // Stamina bar - get from WASM\r\n        const staminaY = barY + 5\r\n        ctx.fillStyle = 'rgba(0, 0, 0, 0.5)'\r\n        ctx.fillRect(screenX - barWidth/2, staminaY, barWidth, 2)\r\n        \r\n        const currentStamina = globalThis.wasmExports?.get_stamina?.() ?? this.stamina;\r\n        const maxStamina = this.maxStamina; // Max stamina can still be local or WASM-driven if dynamic\r\n        const staminaPercent = currentStamina / maxStamina\r\n        ctx.fillStyle = '#00aaff'\r\n        ctx.fillRect(screenX - barWidth/2, staminaY, barWidth * staminaPercent, 2)\r\n        \r\n        // Debug overlays\r\n        if (this.debugMode) {\r\n            this.renderDebug(ctx, camera, screenX, screenY)\r\n        }\r\n\r\n        ctx.restore()\r\n    }\r\n\r\n    computePoseOverlay(_input) {\r\n        // Simple procedural layers approximation for readability and responsiveness\r\n        // This can still be done in JS as it's purely visual\r\n        const t = this.getNormalizedTime() // This needs to be driven by WASM state timings\r\n        let scaleX = 1\r\n        let scaleY = 1\r\n        let rotation = 0\r\n        const offsetX = 0\r\n        let offsetY = this.ik?.pelvisY || 0\r\n\r\n        // Lean with velocity when running - velocity should come from WASM\r\n        // For now, using this.vx from CharacterAnimator.update's velocity parameter. This needs to be cleaned up.\r\n        // The CharacterAnimator.update is already being passed vx, vy, which are currently local.\r\n        // These local vx, vy are not updated from WASM, which is an issue.\r\n        // Need to pass WASM-driven velocity to CharacterAnimator.update as well.\r\n        // For now, let's assume CharacterAnimator is updated with correct velocity from WASM.\r\n        // We need an export for WASM player velocity (get_vel_x, get_vel_y)\r\n        const currentVx = globalThis.wasmExports?.get_vel_x?.() ?? 0;\r\n        const currentVy = globalThis.wasmExports?.get_vel_y?.() ?? 0;\r\n        const currentSpeed = Math.hypot(currentVx, currentVy);\r\n        const playerSpeed = globalThis.wasmExports?.get_speed?.() ?? this.speed; // Assuming WASM provides player speed\r\n\r\n        if (this.state === 'running') {\r\n            const lean = Math.max(-0.15, Math.min(0.15, (currentVx / (playerSpeed || 1)) * 0.25))\r\n            rotation += lean\r\n        }\r\n\r\n        // Block hunch\r\n        if (this.state === 'blocking') {\r\n            scaleY *= 0.98\r\n            offsetY += 1\r\n        }\r\n\r\n        // Roll tuck\r\n        if (this.state === 'rolling') {\r\n            const w = (t < 0.5 ? t * 2 : (1 - t) * 2)\r\n            scaleY *= 1 - 0.06 * w\r\n            scaleX *= 1 + 0.04 * w\r\n            rotation += (this.facing >= 0 ? 1 : -1) * 0.12 * w\r\n        }\r\n\r\n        // Attack slight forward push and recoil feel\r\n        // These will be driven by WASM attack state timings and forces\r\n        if (this.state === 'attacking') {\r\n            // Placeholder: These values should come from WASM's animation overlay exports\r\n            // if (t < 0.3) {\r\n            //     offsetX += this.facing * 2 * (t / 0.3)\r\n            // } else if (t > 0.6) {\r\n            //     offsetX -= this.facing * 2 * ((t - 0.6) / 0.4)\r\n            // }\r\n        }\r\n\r\n        return { scaleX, scaleY, rotation, offsetX, offsetY }\r\n    }\r\n\r\n    updateIK(deltaTime) {\r\n        // Pelvis bob from WASM overlay if available\r\n        const wasmPelvis = globalThis.wasmExports?.get_anim_pelvis_y?.()\r\n        if (typeof wasmPelvis === 'number') {\r\n            this.ik.pelvisY = wasmPelvis\r\n        } else {\r\n            this.ik.pelvisY = 0; // Fallback to 0 if WASM value not available\r\n        }\r\n\r\n        // Foot lock flags (alternating with steps) for future mask usage\r\n        // These should also be driven by WASM if precise synchronization is needed\r\n        const currentVx = globalThis.wasmExports?.get_vel_x?.() ?? 0;\r\n        const currentVy = globalThis.wasmExports?.get_vel_y?.() ?? 0;\r\n        const isMovingNow = Math.hypot(currentVx, currentVy) > 10\r\n        if (isMovingNow) {\r\n            // left foot considered planted near stridePhase ~ 0.0; right near ~0.5\r\n            // The stridePhase needs to be driven by WASM's locomotion state.\r\n            // For now, let's keep a local stridePhase but eventually it should be removed.\r\n            this.stridePhase = (this.stridePhase + deltaTime * this.gaitRate) % 1; // Keep local for now\r\n            const lf = (this.stridePhase < 0.25 || this.stridePhase > 0.75)\r\n            this.ik.left.locked = lf\r\n            this.ik.right.locked = !lf\r\n        } else {\r\n            this.ik.left.locked = false\r\n            this.ik.right.locked = false\r\n            this.stridePhase = 0; // Reset stride phase when idle\r\n        }\r\n    }\r\n\r\n    renderDebug(ctx, camera, screenX, screenY) {\r\n        const x = screenX\r\n        const y = screenY - this.height / 2 - 18\r\n        // Stride phase bar - needs to be updated based on WASM if stridePhase moves to WASM\r\n        ctx.save()\r\n        ctx.fillStyle = 'rgba(0,0,0,0.35)'\r\n        ctx.fillRect(x - 24, y, 48, 4)\r\n        ctx.fillStyle = '#00ffaa'\r\n        ctx.fillRect(x - 24, y, 48 * (this.stridePhase % 1), 4)\r\n\r\n        // Pelvis offset marker\r\n        ctx.strokeStyle = '#ffaa00'\r\n        ctx.beginPath()\r\n        ctx.moveTo(x + 30, y + 2)\r\n        ctx.lineTo(x + 30, y + 2 - (this.ik?.pelvisY || 0))\r\n        ctx.stroke()\r\n\r\n        // Event windows (attack/roll) - these timings are now WASM-driven\r\n        // This will require WASM exports for current attack/roll state durations and normalized times\r\n        const currentAttackState = globalThis.wasmExports?.get_attack_state?.() ?? 0; // Assuming a WASM export\r\n        const currentAttackStateTime = globalThis.wasmExports?.get_attack_state_time?.() ?? 0; // Assuming a WASM export\r\n        const totalGameTime = globalThis.wasmExports?.get_time_seconds?.() ?? 0; // Assuming a WASM export\r\n        \r\n        let norm = 0;\r\n        if (currentAttackState === 1) { // Windup\r\n            norm = (totalGameTime - currentAttackStateTime) / (globalThis.wasmExports?.get_attack_windup_sec?.() ?? this.params.attackLight.duration);\r\n        } else if (currentAttackState === 2) { // Active\r\n            norm = (totalGameTime - currentAttackStateTime) / (globalThis.wasmExports?.get_attack_active_sec?.() ?? this.params.attackLight.duration);\r\n        } else if (currentAttackState === 3) { // Recovery\r\n            norm = (totalGameTime - currentAttackStateTime) / (globalThis.wasmExports?.get_attack_recovery_sec?.() ?? this.params.attackLight.duration);\r\n        }\r\n\r\n        const barY = y + 8\r\n        ctx.fillStyle = 'rgba(0,0,0,0.35)'\r\n        ctx.fillRect(x - 24, barY, 48, 3)\r\n\r\n        // These ranges should be driven by WASM exports if precise\r\n        if (currentAttackState === 2) { // Active attack phase\r\n            ctx.fillStyle = '#ff4477'\r\n            // Placeholder: actual activeStart/End should come from WASM\r\n            ctx.fillRect(x - 24 + 48 * 0.28, barY, 48 * (0.38 - 0.28), 3)\r\n        }\r\n        if (globalThis.wasmExports?.get_is_rolling?.() === 1) { // If rolling\r\n            ctx.fillStyle = '#ffee55'\r\n            // Placeholder: iFrameStart/End should come from WASM\r\n            ctx.fillRect(x - 24 + 48 * 0.08, barY, 48 * (0.36 - 0.08), 3)\r\n        }\r\n        // Current norm marker\r\n        ctx.fillStyle = '#ffffff'\r\n        ctx.fillRect(x - 24 + 48 * norm - 1, barY - 1, 2, 5)\r\n\r\n        ctx.restore()\r\n    }\r\n    \r\n    // Helper function to convert numeric WASM state to string for internal use\r\n    getAnimStateName(state) {\r\n        switch(state) {\r\n            case 0: return 'idle'\r\n            case 1: return 'running'\r\n            case 2: return 'attacking'\r\n            case 3: return 'blocking'\r\n            case 4: return 'rolling'\r\n            case 5: return 'hurt'\r\n            case 6: return 'dead'\r\n            case 7: return 'jumping'\r\n            case 8: return 'doubleJumping'\r\n            case 9: return 'landing'\r\n            case 10: return 'wallSliding'\r\n            case 11: return 'dashing'\r\n            case 12: return 'chargingAttack'\r\n            default: return 'idle'\r\n        }\r\n    }\r\n\r\n    // Helper function to convert string state to numeric for CharacterAnimator\r\n    stateNameToNumber(stateName) {\r\n        switch(stateName) {\r\n            case 'idle': return 0\r\n            case 'running': return 1\r\n            case 'attacking': return 2\r\n            case 'blocking': return 3\r\n            case 'rolling': return 4\r\n            case 'hurt': return 5\r\n            case 'dead': return 6\r\n            case 'jumping': return 7\r\n            case 'doubleJumping': return 8\r\n            case 'landing': return 9\r\n            case 'wallSliding': return 10\r\n            case 'dashing': return 11\r\n            case 'chargingAttack': return 12\r\n            default: return 0\r\n        }\r\n    }\r\n    \r\n    // Get current animation info for debugging\r\n    getAnimationInfo() {\r\n        return {\r\n            state: this.state, // Now directly reflecting the local state derived from WASM\r\n            animation: this.animator.controller.currentAnimation?.name,\r\n            frame: this.animator.controller.getCurrentFrame(),\r\n            stateTimer: globalThis.wasmExports?.get_player_state_timer?.() ?? 0, // Assuming WASM exports player state timer\r\n            invulnerable: globalThis.wasmExports?.get_is_invulnerable?.() === 1,\r\n            \r\n            // Enhanced procedural animation info\r\n            proceduralData: this.currentTransform?.debug || null,\r\n            skeletalData: this.currentTransform?.skeleton || null,\r\n            secondaryMotion: this.currentTransform?.secondaryMotion || null,\r\n            environmental: this.currentTransform?.environmental || null\r\n        }\r\n    }\r\n    \r\n    // Render secondary motion effects (cloth, hair, equipment)\r\n    renderSecondaryMotion(ctx, secondaryMotion) {\r\n        if (!secondaryMotion) {return}\r\n        \r\n        ctx.save()\r\n        ctx.globalAlpha = 0.8\r\n        \r\n        // Render cloth physics\r\n        if (secondaryMotion.cloth) {\r\n            ctx.strokeStyle = '#4A4A4A'\r\n            ctx.lineWidth = 2\r\n            ctx.beginPath()\r\n            secondaryMotion.cloth.forEach((point, index) => {\r\n                if (index === 0) {\r\n                    ctx.moveTo(point.position.x, point.position.y)\r\n                } else {\r\n                    ctx.lineTo(point.position.x, point.position.y)\r\n                }\r\n            })\r\n            ctx.stroke()\r\n        }\r\n        \r\n        // Render hair physics\r\n        if (secondaryMotion.hair) {\r\n            ctx.strokeStyle = '#8B4513'\r\n            ctx.lineWidth = 3\r\n            ctx.lineCap = 'round'\r\n            ctx.beginPath()\r\n            secondaryMotion.hair.forEach((segment, index) => {\r\n                if (index === 0) {\r\n                    ctx.moveTo(segment.position.x, segment.position.y)\r\n                } else {\r\n                    ctx.lineTo(segment.position.x, segment.position.y)\r\n                }\r\n            })\r\n            ctx.stroke()\r\n        }\r\n        \r\n        // Render equipment physics\r\n        if (secondaryMotion.equipment) {\r\n            secondaryMotion.equipment.forEach(item => {\r\n                ctx.fillStyle = item.type === 'sword' ? '#C0C0C0' : '#8B4513'\r\n                ctx.fillRect(item.position.x - 2, item.position.y - 1, 4, 2)\r\n            })\r\n        }\r\n        \r\n        ctx.restore()\r\n    }\r\n    \r\n    // Render skeletal overlay for debugging and enhanced visualization\r\n    renderSkeletalOverlay(ctx, skeleton) {\r\n        if (!skeleton) {return}\r\n        \r\n        ctx.save()\r\n        ctx.strokeStyle = '#00ff88'\r\n        ctx.fillStyle = '#ffff44'\r\n        ctx.lineWidth = 1\r\n        ctx.globalAlpha = 0.6\r\n        \r\n        // Draw bones\r\n        this.drawBone(ctx, skeleton.torso, skeleton.head)\r\n        this.drawBone(ctx, skeleton.torso, skeleton.pelvis)\r\n        \r\n        // Draw arms\r\n        this.drawBone(ctx, skeleton.leftArm.shoulder, skeleton.leftArm.elbow)\r\n        this.drawBone(ctx, skeleton.leftArm.elbow, skeleton.leftArm.hand)\r\n        this.drawBone(ctx, skeleton.rightArm.shoulder, skeleton.rightArm.elbow)\r\n        this.drawBone(ctx, skeleton.rightArm.elbow, skeleton.rightArm.hand)\r\n        \r\n        // Draw legs\r\n        this.drawBone(ctx, skeleton.leftLeg.hip, skeleton.leftLeg.knee)\r\n        this.drawBone(ctx, skeleton.leftLeg.knee, skeleton.leftLeg.foot)\r\n        this.drawBone(ctx, skeleton.rightLeg.hip, skeleton.rightLeg.knee)\r\n        this.drawBone(ctx, skeleton.rightLeg.knee, skeleton.rightLeg.foot)\r\n        \r\n        // Draw joints\r\n        const joints = [\r\n            skeleton.head, skeleton.torso, skeleton.pelvis,\r\n            skeleton.leftArm.shoulder, skeleton.leftArm.elbow, skeleton.leftArm.hand,\r\n            skeleton.rightArm.shoulder, skeleton.rightArm.elbow, skeleton.rightArm.hand,\r\n            skeleton.leftLeg.hip, skeleton.leftLeg.knee, skeleton.leftLeg.foot,\r\n            skeleton.rightLeg.hip, skeleton.rightLeg.knee, skeleton.rightLeg.foot\r\n        ]\r\n        \r\n        joints.forEach(joint => {\r\n            if (joint && typeof joint.x !== \"undefined\" && typeof joint.y !== \"undefined\") {\r\n                ctx.beginPath()\r\n                ctx.arc(joint.x, joint.y, 2, 0, Math.PI * 2)\r\n                ctx.fill()\r\n            }\r\n        })\r\n        \r\n        ctx.restore()\r\n    }\r\n    \r\n    // Helper method to draw bones\r\n    drawBone(ctx, start, end) {\r\n        if (!start || !end || typeof start.x === \"undefined\" || typeof end.x === \"undefined\") {return}\r\n        \r\n        ctx.beginPath()\r\n        ctx.moveTo(start.x, start.y)\r\n        ctx.lineTo(end.x, end.y)\r\n        ctx.stroke()\r\n    }\r\n    \r\n    // Input helper to convert keyboard to player input - 5-button combat system\r\n    static createInputFromKeys(keys) {\r\n        return {\r\n            // Movement\r\n            left: keys.a || keys.arrowleft,\r\n            right: keys.d || keys.arrowright,\r\n            up: keys.w || keys.arrowup,\r\n            down: keys.s || keys.arrowdown,\r\n            \r\n            // 5-Button Combat System\r\n            lightAttack: keys.j || keys['1'],        // A1 = Light Attack\r\n            heavyAttack: keys.k || keys['2'],        // A2 = Heavy Attack  \r\n            block: keys.shift || keys['3'],          // Block = Hold to guard, tap to parry\r\n            roll: keys.control || keys['4'],         // Roll = Dodge with i-frames\r\n            special: keys.l || keys['5'],            // Special = Hero move\r\n            \r\n            // Legacy support\r\n            attack: keys.j || keys[' '],             // Maps to light attack\r\n            jump: keys.space || keys.z\r\n        }\r\n    }\r\n    \r\n    // New movement methods for enhanced animations\r\n    // These methods now just trigger actions, WASM will handle state changes\r\n    jump() {\r\n        // WASM will drive the jump state, so we just trigger the action\r\n        globalThis.wasmExports?.on_jump?.(); // New WASM function call for jumping\r\n        if (this.particleSystem) {\r\n            this.particleSystem.createDustCloud(this.x, this.y + this.height/2)\r\n        }\r\n        \r\n        if (this.soundSystem) {\r\n            this.soundSystem.play('jump')\r\n        }\r\n    }\r\n    \r\n}\r\n\r\nexport default AnimatedPlayer\r\n\r\n// Static helper: attach a key to toggle debug overlays for a given player instance\r\nAnimatedPlayer.attachDebugToggle = function(playerInstance, key = 'F3') {\r\n    if (!playerInstance || playerInstance.__debugToggleAttached) { return }\r\n    const targetKey = (key || 'F3').toLowerCase()\r\n    const handler = (e) => {\r\n        const k = (e.key || '').toLowerCase()\r\n        if (k === targetKey.toLowerCase()) {\r\n            playerInstance.debugMode = !playerInstance.debugMode\r\n        }\r\n    }\r\n    try {\r\n        addEventListener('keydown', handler)\r\n        playerInstance.__debugToggleAttached = true\r\n    } catch {\r\n        // Ignore debug handler attachment errors\r\n    }\r\n}"],"names":["AnimationFrame","constructor","x","y","width","height","duration","this","Animation","name","frames","options","loop","pingPong","speed","onComplete","onFrame","currentFrame","elapsedTime","direction","isPlaying","hasCompleted","play","stop","reset","pause","resume","update","deltaTime","length","currentFrameData","previousFrame","getCurrentFrame","getProgress","getFrameAt","index","AnimationController","animations","Map","currentAnimation","transitions","blendTime","blendFrom","blendProgress","addAnimation","nameOrAnimation","maybeAnimation","set","animation","animationName","get","transition","getBlendFrames","current","blend","blendFactor","setSpeed","ProceduralAnimator","createBreathingAnimation","baseScale","intensity","asymmetry","time","phase","breathRate","currentIntensity","depthMod","asymmetryOffset","_buf","scaleX","scaleY","offsetY","chestExpansion","modulateForState","state","res","Math","sin","breathScaleX","breathScaleY","finalScaleX","smoothFactor","exp","createBobbingAnimation","amplitude","rotation","createSquashStretch","active","trigger","progress","min","postFix","PI","p","squash","stretch","createWobble","frequency","damping","velocity","displacement","force","springForce","dampingForce","impulse","createAnticipation","offsetX","eased","cos","createAdvancedIK","armLength","forearmLength","stiffness","maxReach","shoulder","elbow","hand","target","targetVelocity","reach","solveIK","targetX","targetY","shoulderX","shoulderY","dx","dy","distance","sqrt","clampedDistance","scale","clampedTargetX","clampedTargetY","totalLength","elbowAngle","acos","max","shoulderAngle","atan2","predictedTargetX","predictedTargetY","solution","stiffnessFactor","createSecondaryMotion","segments","gravity","windStrength","anchorPoint","windTime","_segBuf","initialize","anchorX","anchorY","i","push","vx","vy","prevX","prevY","windDirection","segment","prevSegment","ratio","windX","windY","tempX","tempY","Array","applyForce","forceX","forceY","segmentIndex","forEach","createMomentumSystem","maxMomentum","momentumDecay","momentumInfluence","directionSmoothing","momentum","smoothedDirection","lastVelocity","leanAngle","bounceFactor","stretchFactor","velocityX","velocityY","isGrounded","deltaVx","deltaVy","acceleration","momentumStrength","momentumDirX","momentumDirY","momentumMagnitude","currentDirection","directionMagnitude","normalizedDir","abs","addImpulse","impulseX","impulseY","createTrailEffect","maxTrails","fadeSpeed","trails","lastPosition","currentPosition","filter","trail","alpha","shift","clear","CharacterAnimator","controller","procedural","eventSystem","eventListeners","breathing","squashStretch","wobble","anticipation","advancedIK","secondaryMotion","momentumSystem","stateName","facing","moving","attacking","blocking","rolling","hurt","jumping","doubleJumping","wallSliding","dashing","charging","dead","landing","blendFactors","idle","running","chargingAttack","targetBlendFactors","blendSpeed","hurtTimer","attackTimer","rollTimer","resetActionTimers","getAnimStateName","setAnimState","newState","previousState","previousStateName","emit","fromState","toState","fromStateName","toStateName","Object","keys","key","position","diff","momentumData","transform","ik","Date","now","setFacing","setEventSystem","on","eventName","callback","context","has","Set","listener","once","add","off","listeners","delete","size","data","from","call","error","console","triggerHurt","timer","triggerAttack","triggerRoll","triggerBlock","releaseBlock","setMoving","isMoving","AnimationPresets","createPlayerAnimations","createWolfAnimations","prowl","lunge","howl","death","packRun","createEffectAnimations","explosion","spark","projectileSpawn","projectileImpact","itemPickup","powerUp","RealisticProceduralAnimator","config","ikEnabled","thighLength","shinLength","renderSkeleton","renderIKTargets","renderSecondaryMotion","updateRate","enableOptimizations","head","torso","pelvis","leftShoulder","leftElbow","leftHand","rightShoulder","rightElbow","rightHand","leftHip","leftKnee","leftFoot","rightHip","rightKnee","rightFoot","ikSolver","AdvancedIKSolver","SecondaryMotionSystem","clothPhysics","ClothPhysicsSystem","facialAnimator","FacialAnimationSystem","frameCount","lastUpdate","cachedTransforms","environmentalResponses","EnvironmentalResponseSystem","wasmData","performance","getCachedTransform","wasmAnimData","getWasmAnimationData","updateBaseTransform","updateSkeletalSystem","updateSecondaryMotion","updateEnvironmentalResponses","generateTransform","cacheTransform","_wasmData","exports","globalThis","wasmExports","get_anim_scale_x","get_anim_scale_y","get_anim_rotation","get_anim_offset_x","get_anim_offset_y","pelvisY","get_anim_pelvis_y","spineCurve","get_anim_spine_curve","shoulderRotation","get_anim_shoulder_rotation","headBobX","get_anim_head_bob_x","headBobY","get_anim_head_bob_y","armSwingLeft","get_anim_arm_swing_left","armSwingRight","get_anim_arm_swing_right","legLiftLeft","get_anim_leg_lift_left","legLiftRight","get_anim_leg_lift_right","torsoTwist","get_anim_torso_twist","breathingIntensity","get_anim_breathing_intensity","fatigueFactor","get_anim_fatigue_factor","momentumX","get_anim_momentum_x","momentumY","get_anim_momentum_y","clothSway","get_anim_cloth_sway","hairBounce","get_anim_hair_bounce","equipmentJiggle","get_anim_equipment_jiggle","windResponse","get_anim_wind_response","groundAdapt","get_anim_ground_adapt","temperatureShiver","get_anim_temperature_shiver","get_x","get_y","get_vel_x","get_vel_y","get_is_grounded","stamina","get_stamina","health","get_hp","animState","get_player_anim_state","_deltaTime","leftArmTarget","calculateArmTarget","rightArmTarget","leftArmSolution","solveArm","rightArmSolution","leftLegTarget","calculateLegTarget","rightLegTarget","leftLegSolution","solveLeg","rightLegSolution","knee","foot","side","isLeft","sideMultiplier","armSwing","legLift","sway","updateHair","bounce","headMovement","updateEquipment","jiggle","applyShivering","applyWindEffects","skeleton","leftArm","rightArm","leftLeg","hip","rightLeg","cloth","getState","hair","getHairState","equipment","getEquipmentState","environmental","debug","fatigue","cacheKey","firstKey","next","value","latestKey","generateDefaultTransform","renderDebug","ctx","save","translate","restore","strokeStyle","lineWidth","drawBone","fillStyle","values","joint","beginPath","arc","fill","start","end","moveTo","lineTo","stroke","render","renderHair","renderEquipment","maxIterations","tolerance","upperLength","lowerLength","angle","angleB","hairSegments","equipmentItems","initializeHair","initializeEquipment","restLength","type","forces","prev","correction","item","fillRect","clothPoints","constraints","initializeCloth","oldPosition","pinned","p1","p2","point","velX","velY","constraint","percent","expressions","neutral","eyeOpenness","mouthCurve","eyebrowHeight","happy","angry","surprised","tired","currentExpression","blendWeight","setExpression","expression","targetExpression","emotionalState","_intensity","shiver","AnimatedPlayer","maxHealth","maxStamina","rollSpeed","stateTimer","stateTime","stateDuration","_prevNormTime","_comboQueued","_currentAttackType","invulnerable","invulnerabilityTimer","jumpCount","nearWall","dashCooldown","chargeTime","maxChargeTime","params","roll","iFrameStart","iFrameEnd","staminaCost","cooldown","attackLight","activeStart","activeEnd","attackHeavy","comboWindow","parry","window","animator","setupAnimations","proceduralAnimator","enableIK","debugMode","attackCooldown","rollCooldown","blockHeld","color","sprite","loadSpriteSheet","particleSystem","soundSystem","attackDamage","attackDamageHeavy","attackRange","attackRangeHeavy","blockDamageReduction","stridePhase","gaitRate","_lastFootFlag","footstepIntervalBase","pelvisRate","left","locked","right","stepHeight","wasmModule","Image","src","onload","onerror","warn","input","getNormalizedTime","updateIK","inputX","inputY","up","down","set_player_input","jump","lightAttack","heavyAttack","block","special","rx","ry","Number","isFinite","get_jump_count","fx","fy","hypot","wx","wy","wsx","wsy","wrot","wasmAnimState","setState","baseTransform","proceduralTransform","playerState","inputState","overlay","computePoseOverlay","currentTransform","fn","attackState","stateStartTime","elapsed","rollDur","playerStateTimer","anim","isArray","coarse","startRoll","on_roll_start","dirX","dirY","rollDirection","createDustCloud","startAttack","on_attack","queueAttack","canAttack","tryRoll","dir","tryParry","on_parry","executeAttack","isHeavy","range","damage","hitboxX","hitboxY","createChargedSlash","createSlashEffect","startBlock","set_blocking","createShieldEffect","stopBlock","takeDamage","knockbackX","knockbackY","createBlockImpact","createBloodEffect","die","createDeathEffect","respawn","_x","_y","createRespawnEffect","wasmDriven","numericState","stateNameToNumber","minCost","canRoll","canBlock","camera","screenX","screenY","camX","camY","gameRenderer","wasmToWorld","pos","worldWidth","worldHeight","get_is_invulnerable","globalAlpha","frame","t","centerX","centerY","rotate","drawImage","renderSkeletalOverlay","rectWidth","rectHeight","strokeRect","barWidth","barY","healthPercent","get_health","staminaY","staminaPercent","_input","currentVx","playerSpeed","get_speed","w","wasmPelvis","currentVy","lf","currentAttackState","get_attack_state","currentAttackStateTime","get_attack_state_time","totalGameTime","get_time_seconds","norm","get_attack_windup_sec","get_attack_active_sec","get_attack_recovery_sec","get_is_rolling","getAnimationInfo","get_player_state_timer","proceduralData","skeletalData","lineCap","createInputFromKeys","a","arrowleft","d","arrowright","arrowup","s","arrowdown","j","k","control","l","attack","space","z","on_jump","attachDebugToggle","playerInstance","__debugToggleAttached","targetKey","toLowerCase","handler","e","addEventListener"],"mappings":"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"}