<!-- cd6f2845-1fd8-44fb-90b1-9cae40230c45 4ead6059-b081-4522-801b-dde8f4f8002f -->
# Fix Skeleton Appearance and Animation (Demo + In‑Game)

### Scope

- Target: a) Demo `public/demos/skeleton/interactive-skeleton-physics.html` and b) In‑game WASM-driven skeleton.
- Fixes: proportions, animation feel (PD/IK), foot grounding/balance, and visuals (camera, thickness, colors, shadow).

### Approach

- Leverage existing WASM skeleton physics (foot contact, balance forces present) and expose a compact snapshot API for JS rendering.
- Stabilize PD integration and clamp dt in the WASM skeleton path; improve IK convergence and constraints; tune ground/foot friction; update visuals.
- Batch WASM reads once per frame via a snapshot API to avoid boundary overhead (simple getters v1, linear-memory bulk read v2 for performance).

### Files to Change (all under public/src/)

- Demo (JS fallback path):
  - `skeleton/human-proportions.js` — adjust anthropometrics for correct limb ratios.
  - `skeleton/human-model.js` — PD gains, dt clamp, joint limit enforcement, foot contact friction.
  - `controllers/skeleton/interaction-controller.js` — FABRIK iterations, drag smoothing, endpoint clamping.
  - `renderer/skeleton/canvas-renderer.js` — bone thickness, joint sizes, color palette, ground plane + soft shadow.
  - `skeleton/demo-init.js` — camera presets, consistent scale, frame-timed update.
  - `controllers/skeleton/ui-controller.js` — add a simple “Quality” preset selector (Low/Med/High) mapping to PD/visual presets.

- In‑Game (WASM + JS bridge + render):
  - WASM C++: `wasm/physics/SkeletonPhysics.h` — tune gains/limits/friction and add stable dt clamp.
  - WASM C++: `wasm/game_refactored.cpp` — add exports for skeleton snapshot (count, get_joint_xy(i), balance flags). Optionally add bulk snapshot to linear memory.
  - (If needed) WASM C++: `wasm/managers/PlayerManager.{h,cpp}` — ensure skeleton sync with player position/scale and expose balance fields used by exports.
  - JS state: `game/state/WasmCoreState.js` — add `getSkeletonSnapshot()` to batch-read joints once per frame; cache shape.
  - Renderer (new): `renderer/player/PlayerSkeletonRenderer.js` — draw simplified bones/joints + ground shadow.
  - Wire-up: `game/renderer/GameRenderer.js` — call `PlayerSkeletonRenderer` inside `renderPlayer` using `WasmCoreState` snapshot.
  - Coordinator: `game/coordinators/RenderingCoordinator.js` — already passes `WasmCoreState` to `GameRenderer`; no direct WASM access.

### Essential API additions (concise)

- In `game_refactored.cpp` (if not present):
```cpp
extern "C" {
  EMSCRIPTEN_KEEPALIVE int get_skeleton_joint_count();
  EMSCRIPTEN_KEEPALIVE float get_skeleton_joint_x(int i);
  EMSCRIPTEN_KEEPALIVE float get_skeleton_joint_y(int i);
  EMSCRIPTEN_KEEPALIVE float get_balance_quality();
  EMSCRIPTEN_KEEPALIVE int get_left_foot_grounded();
  EMSCRIPTEN_KEEPALIVE int get_right_foot_grounded();
}
```

- Optional v2 (performance):
```cpp
extern "C" {
  // Write packed xyxy... into linear memory at ptr; returns bytes written
  EMSCRIPTEN_KEEPALIVE int write_skeleton_joints_xy(float* ptr, int max_pairs);
}
```

- In `WasmCoreState.js`:
```javascript
getSkeletonSnapshot() {
  const ex = this.exports
  const n = typeof ex.get_skeleton_joint_count === 'function' ? ex.get_skeleton_joint_count() : 0
  const joints = new Array(n)
  for (let i = 0; i < n; i++) {
    const x = ex.get_skeleton_joint_x?.(i)
    const y = ex.get_skeleton_joint_y?.(i)
    joints[i] = [Number.isFinite(x) ? x : 0, Number.isFinite(y) ? y : 0]
  }
  return Object.freeze({
    joints,
    balanceQuality: ex.get_balance_quality?.() ?? 1,
    leftGrounded: !!ex.get_left_foot_grounded?.(),
    rightGrounded: !!ex.get_right_foot_grounded?.(),
  })
}
```

- In `PlayerSkeletonRenderer.js` (new):
```javascript
export class PlayerSkeletonRenderer {
  render(ctx, snapshot, camera) {
    // draw bones between known index pairs; draw joints as circles; ground shadow
  }
}
```


### Visual Defaults

- Bone thickness +25%, joint radius +20%.
- Neutral color palette with better contrast; add subtle ground shadow ellipse.
- Camera: slight top-down angle, zoom to fit height; consistent meters→pixels scale.

### Stability & Feel

- Clamp `deltaTime` in PD/Verlet on the WASM side (e.g., min 1/240, max 1/30). Raise `kd` slightly; lower `kp` for less jitter.
- Increase FABRIK iterations (2→4) and add endpoint clamping within joint limits.
- Tune foot friction (μ ~0.85) and contact threshold; ensure pelvis height set from leg length.

### Tests

- Unit: `test/unit/state/WasmCoreState.test.js` — snapshot length/shape, values are numbers; verify immutability.
- Unit: `test/unit/coordinators/RenderingCoordinator.test.js` — `RenderingCoordinator` calls `GameRenderer.renderPlayer` and snapshot is consumed.
- Integration: update `test/integration/*.js` to ensure no regressions.

### Rollout

- Phase 1 (Demo): proportions/PD/IK/visuals.
- Phase 2 (WASM): exports + tuning + renderer integration.
- Phase 3: UI toggle to show/hide skeleton overlay and balance indicators.

### One-shot additions

- Success criteria
  - 60 FPS target; JS render ≤ 0.5 ms, WASM snapshot ≤ 0.3 ms.
  - ≤ 3 WASM calls/frame in v1; ≤ 1 in v2 (bulk writer).
  - Snapshot has no NaNs; stable shape; overlay toggle persists.

- Exports & build wiring
  - Ensure these exports exist in `game_refactored.cpp` (EMSCRIPTEN_KEEPALIVE):
    - `get_skeleton_joint_count`, `get_skeleton_joint_x`, `get_skeleton_joint_y`,
      `get_balance_quality`, `get_left_foot_grounded`, `get_right_foot_grounded`,
      optional `write_skeleton_joints_xy`.
  - Build scripts include these in exported symbols and run a post-build export check.

- Feature flag & fallback
  - URL param `?skeleton=1` + localStorage persistence; hotkeys K (skeleton), B (balance), P (perf).
  - If any export missing or non-finite values observed, overlay silently disables for the session.

- Snapshot contract & versioning
  - Add `get_api_version()` (optional) or track version in `WASM_EXPORTS.json`.
  - Contract tests assert: joint count ≥ 10, numbers only, immutable object.

- Perf instrumentation
  - Time snapshot and render; rolling averages; enable via `?perf=1`.

- Rendering alignment
  - Use shared `METERS_TO_PIXELS` and camera transforms from existing topdown renderer utils.

- Testing & CI gates
  - Node smoke test calls skeleton exports.
  - Unit: contract tests; Coordinator uses snapshot once per frame.
  - Visual: single-frame tolerance check on demo.
  - CI fails if required exports missing.

### To-dos

- [ ] Adjust anthropometrics in skeleton/human-proportions.js for realistic ratios
- [ ] Stabilize PD and dt clamp in skeleton/human-model.js
- [ ] Improve FABRIK, drag smoothing, endpoint limits in interaction-controller.js
- [ ] Revamp canvas renderer visuals and camera presets
- [ ] Tune foot friction/contact in human-model.js
- [ ] Add skeleton snapshot exports in game_refactored.cpp (v1 getters)
- [ ] (Optional) Add bulk snapshot writer (linear memory) in game_refactored.cpp (v2)
- [ ] Retune limits/friction/dt clamp in SkeletonPhysics.h
- [ ] Sync skeleton scale with player in PlayerManager
- [ ] Add WasmCoreState.getSkeletonSnapshot() with batched reads (use this.exports)
- [ ] Create PlayerSkeletonRenderer.js
- [ ] Update GameRenderer.renderPlayer to draw skeleton overlay using snapshot
- [ ] RenderingCoordinator: ensure it passes WasmCoreState into GameRenderer (already present)
- [ ] Add UI toggle to show skeleton and balance overlay
- [ ] Unit tests for WasmCoreState skeleton snapshot
- [ ] Integration test ensures renderer receives snapshot
- [ ] Fine-tune gains/colors and verify in browsers