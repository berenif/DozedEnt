<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Room System Demo</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital@0;1&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Space Mono', monospace;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        #game-canvas {
            position: absolute;
            width: 1280px;
            height: 720px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid rgba(255, 255, 255, 0.35);
            border-radius: 12px;
            box-shadow:
                0 0 0 2px rgba(255, 255, 255, 0.12) inset,
                0 12px 32px rgba(0, 0, 0, 0.6),
                0 0 40px rgba(0, 128, 255, 0.22);
            background: rgba(0, 0, 0, 0.8);
        }
        
        #game-status {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            border-radius: 10px;
            border: 2px solid #fff;
            backdrop-filter: blur(10px);
        }
        
        #room-info {
            font-size: 1.4rem;
            color: #ccc;
            margin-bottom: 10px;
        }
        
        #player-count {
            font-size: 1.8rem;
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }
        
        #connection-status {
            font-size: 1.4rem;
            color: #ccc;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        #connection-status.connected {
            color: #00ff00;
        }
        
        #open-lobby-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            font-family: inherit;
            font-size: 1.6rem;
            font-weight: bold;
            color: #000;
            background: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 10;
        }
        
        #open-lobby-btn:hover {
            background: #00e676;
            box-shadow: 0 0 20px rgba(0, 230, 118, 0.5);
        }
        
        .player {
            position: absolute;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.8);
            transform: translate(-50%, -50%);
            transition: all 0.1s ease;
        }
        
        .player.self {
            background: #00e676;
            box-shadow: 0 0 10px rgba(0, 230, 118, 0.7);
        }
        
        .player.other {
            background: #2196f3;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.7);
        }
        
        .player .health-bar {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 36px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 2px;
        }
        
        .player .health-fill {
            height: 100%;
            background: #00e676;
            border-radius: 2px;
            transition: width 0.2s ease;
        }
        
        #controls-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            font-size: 1.2rem;
            color: #ccc;
        }
    </style>
</head>
<body>
    <div id="game-canvas"></div>
    
    <div id="game-status">
        <div id="room-info">Not in room</div>
        <div id="player-count">Players: 0</div>
        <div id="connection-status">Disconnected</div>
    </div>
    
    <button id="open-lobby-btn">Open Lobby</button>
    
    <div id="controls-info">
        <strong>Controls:</strong><br>
        WASD/Arrows - Move<br>
        Space - Attack<br>
        ESC - Open Lobby
    </div>
    
    <!-- Room lobby container -->
    <div id="room-lobby"></div>
    
    <script type="module">
        import RoomManager from '../src/room-manager.js'
        import HostAuthority from '../src/host-authority.js'
        import RoomLobbyUI from '../src/room-lobby-ui.js'
        
        // Game state
        let roomManager = null
        let hostAuthority = null
        let lobbyUI = null
        let gameState = null
        let selfPlayer = null
        let inputState = { dx: 0, dy: 0 }
        let keyState = {}
        
        // Initialize the system
        async function init() {
            // Create room manager with app configuration
            roomManager = new RoomManager('demo-game', {
                // You can specify relay URLs or other config here
            })
            
            // Create host authority system
            hostAuthority = new HostAuthority(roomManager)
            
            // Create lobby UI
            lobbyUI = new RoomLobbyUI('room-lobby')
            lobbyUI.setRoomManager(roomManager)
            
            // Set up event handlers
            setupEventHandlers()
            
            // Initialize WASM game (if host)
            roomManager.on('onRoomListUpdate', updateStatus)
            roomManager.on('onPlayerJoin', onPlayerJoin)
            roomManager.on('onPlayerLeave', onPlayerLeave)
            roomManager.on('onGameStateUpdate', onGameStateUpdate)
            
            // Set up game start handler
            lobbyUI.onStartGame = startGame
            
            // Show lobby on start
            lobbyUI.show()
            
            // Update status
            updateStatus()
        }
        
        function setupEventHandlers() {
            // Keyboard controls
            document.addEventListener('keydown', (e) => {
                keyState[e.key.toLowerCase()] = true
                
                if (e.key === 'Escape') {
                    lobbyUI.show()
                }
            })
            
            document.addEventListener('keyup', (e) => {
                keyState[e.key.toLowerCase()] = false
            })
            
            // Open lobby button
            document.getElementById('open-lobby-btn').addEventListener('click', () => {
                lobbyUI.show()
            })
            
            // Game loop for input
            setInterval(updateInput, 1000 / 60) // 60 FPS input polling
        }
        
        function updateInput() {
            if (!roomManager?.currentRoom) return
            
            // Calculate input direction
            let dx = 0, dy = 0
            
            if (keyState['w'] || keyState['arrowup']) dy = -1
            if (keyState['s'] || keyState['arrowdown']) dy = 1
            if (keyState['a'] || keyState['arrowleft']) dx = -1
            if (keyState['d'] || keyState['arrowright']) dx = 1
            
            // Only send if changed
            if (dx !== inputState.dx || dy !== inputState.dy) {
                inputState.dx = dx
                inputState.dy = dy
                
                hostAuthority.sendInput({
                    type: 'move',
                    dx: dx,
                    dy: dy,
                    timestamp: Date.now()
                })
            }
            
            // Attack on space
            if (keyState[' ']) {
                hostAuthority.sendInput({
                    type: 'attack',
                    timestamp: Date.now()
                })
                keyState[' '] = false // One shot
            }
        }
        
        async function startGame() {
            if (!roomManager.isHost) return
            
            // Load and initialize WASM game
            const wasmUrl = '/workspace/wasm/game-host.wasm'
            const initialized = await hostAuthority.initializeGame(wasmUrl, {
                maxPlayers: roomManager.currentRoom.maxPlayers
            })
            
            if (initialized) {
                hostAuthority.startGameLoop()
                console.log('Game started!')
            }
        }
        
        function onPlayerJoin(playerId) {
            console.log('Player joined:', playerId)
            updateStatus()
        }
        
        function onPlayerLeave(playerId) {
            console.log('Player left:', playerId)
            updateStatus()
            
            // Remove player element
            const playerEl = document.getElementById(`player-${playerId}`)
            if (playerEl) {
                playerEl.remove()
            }
        }
        
        function onGameStateUpdate(state) {
            gameState = state
            renderGameState()
        }
        
        function renderGameState() {
            if (!gameState) return
            
            const canvas = document.getElementById('game-canvas')
            
            // Render players
            if (gameState.players) {
                gameState.players.forEach(player => {
                    let playerEl = document.getElementById(`player-${player.id}`)
                    
                    if (!playerEl) {
                        // Create player element
                        playerEl = document.createElement('div')
                        playerEl.id = `player-${player.id}`
                        playerEl.className = 'player'
                        
                        // Add health bar
                        const healthBar = document.createElement('div')
                        healthBar.className = 'health-bar'
                        const healthFill = document.createElement('div')
                        healthFill.className = 'health-fill'
                        healthBar.appendChild(healthFill)
                        playerEl.appendChild(healthBar)
                        
                        canvas.appendChild(playerEl)
                    }
                    
                    // Update player class
                    const playerIndex = roomManager.currentRoom?.players.indexOf(roomManager.selfId)
                    if (player.id === playerIndex) {
                        playerEl.classList.add('self')
                        playerEl.classList.remove('other')
                        selfPlayer = player
                    } else {
                        playerEl.classList.add('other')
                        playerEl.classList.remove('self')
                    }
                    
                    // Update position
                    playerEl.style.left = `${player.x}px`
                    playerEl.style.top = `${player.y}px`
                    
                    // Update health bar
                    const healthFill = playerEl.querySelector('.health-fill')
                    if (healthFill) {
                        healthFill.style.width = `${(player.health / 100) * 100}%`
                    }
                })
            }
        }
        
        function updateStatus() {
            const roomInfo = document.getElementById('room-info')
            const playerCount = document.getElementById('player-count')
            const connectionStatus = document.getElementById('connection-status')
            
            if (roomManager?.currentRoom) {
                const room = roomManager.currentRoom
                roomInfo.textContent = `Room: ${room.name} (${room.id.substring(0, 8)}...)`
                playerCount.textContent = `Players: ${room.players.length}/${room.maxPlayers}`
                connectionStatus.textContent = roomManager.isHost ? 'Host' : 'Connected'
                connectionStatus.className = 'connected'
            } else {
                roomInfo.textContent = 'Not in room'
                playerCount.textContent = 'Players: 0'
                connectionStatus.textContent = 'Disconnected'
                connectionStatus.className = ''
            }
        }
        
        // Initialize on load
        window.addEventListener('load', init)
    </script>
</body>
</html>